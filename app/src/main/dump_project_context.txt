================================================================================
PROJET : /home/alan/AndroidStudioProjects/KittyTune/app/src/main
DATE   : mer. 31 dÃ©c. 2025 23:15:06 CET
================================================================================

RÃ‰SUMÃ‰ :
----------------------------------------
Dossiers scannÃ©s (approx) : 35
Fichiers texte trouvÃ©s    : 85

ARBORESCENCE :
----------------------------------------
.
â”œâ”€â”€ java
â”‚Â Â  â””â”€â”€ com
â”‚Â Â      â””â”€â”€ alananasss
â”‚Â Â          â””â”€â”€ kittytune
â”‚Â Â              â”œâ”€â”€ data
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ local
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AppDatabase.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Entities.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ PlayerPreferences.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ network
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LongIdAdapter.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LrcLibApi.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RetrofitClient.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ SoundCloudApi.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AchievementManager.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ BackupManager.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ DownloadManager.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ HistoryRepository.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ LikeRepository.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ LocalMediaRepository.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ MediaButtonReceiver.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ MusicManager.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ PlaybackService.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ SessionManager.kt
â”‚Â Â              â”‚Â Â  â””â”€â”€ TokenManager.kt
â”‚Â Â              â”œâ”€â”€ domain
â”‚Â Â              â”‚Â Â  â””â”€â”€ Models.kt
â”‚Â Â              â”œâ”€â”€ ui
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ common
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AchievementNotificationManager.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AchievementPopup.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Shimmer.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ UltimateCompletionOverlay.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ home
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ HomeScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ HomeViewModel.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TagScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ TagViewModel.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ library
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LibraryScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LibraryViewModel.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ PlaylistDetailScreen.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ login
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LoginScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ WelcomeScreen.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ navigation
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ Screen.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ player
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ audio
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ AudioProcessors.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ lyrics
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LyricsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ LyricsUtils.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ MiniPlayer.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ PlayerModels.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ PlayerScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ PlayerViewModel.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ profile
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AboutScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AchievementsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AppearanceSettingsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AudioSettingsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BackupRestoreScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BackupViewModel.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LicensesScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LocalMediaSettingsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LyricsSettingsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ProfileMenuSheet.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ProfileScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ProfileViewModel.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ SettingsScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ StorageScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ StorageViewModel.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ theme
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Color.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Theme.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ Type.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ track
â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TrackDetailScreen.kt
â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ TrackDetailViewModel.kt
â”‚Â Â              â”‚Â Â  â””â”€â”€ MainScreen.kt
â”‚Â Â              â”œâ”€â”€ utils
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AppUtils.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ Config.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ LocaleUtils.kt
â”‚Â Â              â”‚Â Â  â”œâ”€â”€ NetworkUtils.kt
â”‚Â Â              â”‚Â Â  â””â”€â”€ TimeUtils.kt
â”‚Â Â              â””â”€â”€ MainActivity.kt
â”œâ”€â”€ keystore
â”œâ”€â”€ res
â”‚Â Â  â”œâ”€â”€ drawable
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_heart_filled.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_heart_outline.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_background.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_monochrome.xml
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_notification.xml
â”‚Â Â  â”œâ”€â”€ mipmap-anydpi-v26
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.xml
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.xml
â”‚Â Â  â”œâ”€â”€ mipmap-hdpi
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.webp
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.webp
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.webp
â”‚Â Â  â”œâ”€â”€ mipmap-mdpi
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.webp
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.webp
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.webp
â”‚Â Â  â”œâ”€â”€ mipmap-xhdpi
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.webp
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.webp
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.webp
â”‚Â Â  â”œâ”€â”€ mipmap-xxhdpi
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.webp
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.webp
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.webp
â”‚Â Â  â”œâ”€â”€ mipmap-xxxhdpi
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_foreground.webp
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_round.webp
â”‚Â Â  â”‚Â Â  â””â”€â”€ ic_launcher.webp
â”‚Â Â  â”œâ”€â”€ values
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ colors.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ic_launcher_background.xml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ strings.xml
â”‚Â Â  â”‚Â Â  â””â”€â”€ themes.xml
â”‚Â Â  â”œâ”€â”€ values-fr
â”‚Â Â  â”‚Â Â  â””â”€â”€ strings.xml
â”‚Â Â  â”œâ”€â”€ values-hu
â”‚Â Â  â”‚Â Â  â””â”€â”€ strings.xml
â”‚Â Â  â””â”€â”€ xml
â”‚Â Â      â”œâ”€â”€ backup_rules.xml
â”‚Â Â      â””â”€â”€ data_extraction_rules.xml
â”œâ”€â”€ AndroidManifest.xml
â””â”€â”€ ic_launcher-playstore.png

CONTENU DES FICHIERS :
----------------------------------------
================================================================================
FICHIER : ./AndroidManifest.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <manifest xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools">
    
        <uses-permission android:name="android.permission.INTERNET" />
        <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
        <uses-permission android:name="android.permission.WAKE_LOCK" />
        <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
        <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
        <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    
        <application
            android:allowBackup="true"
            android:dataExtractionRules="@xml/data_extraction_rules"
            android:fullBackupContent="@xml/backup_rules"
            android:icon="@mipmap/ic_launcher"
            android:label="@string/app_name"
            android:roundIcon="@mipmap/ic_launcher_round"
            android:supportsRtl="true"
            android:theme="@style/Theme.SoundTune"
            tools:targetApi="31">
    
            <activity
                android:name=".MainActivity"
                android:exported="true"
                android:label="@string/app_name"
                android:launchMode="singleTask"
                android:configChanges="orientation|screenSize|screenLayout|keyboardHidden|mnc|colorMode|density|smallestScreenSize"
                android:theme="@style/Theme.SoundTune">
                <intent-filter>
                    <action android:name="android.intent.action.MAIN" />
                    <category android:name="android.intent.category.LAUNCHER" />
                </intent-filter>
            </activity>
    
            <service
                android:name=".data.PlaybackService"
                android:enabled="true"
                android:exported="true"
                android:foregroundServiceType="mediaPlayback">
                <intent-filter>
                    <action android:name="androidx.media3.session.MediaSessionService" />
                </intent-filter>
    
                <meta-data
                    android:name="androidx.media3.session.DefaultMediaNotificationProvider.SmallIcon"
                    android:resource="@drawable/ic_notification" />
            </service>
    
            <receiver android:name="androidx.media.session.MediaButtonReceiver"
                android:exported="true">
                <intent-filter>
                    <action android:name="android.intent.action.MEDIA_BUTTON" />
                </intent-filter>
            </receiver>
    
        </application>
    
    </manifest>

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/AchievementManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.content.SharedPreferences
    import androidx.annotation.StringRes
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.ui.common.AchievementNotification
    import com.alananasss.kittytune.ui.common.AchievementNotificationManager
    import kotlinx.coroutines.CoroutineScope
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.asStateFlow
    import kotlinx.coroutines.flow.update
    import kotlinx.coroutines.launch
    import java.util.Calendar
    import java.util.concurrent.TimeUnit
    
    data class Achievement(
        val id: String,
        val category: AchievementCategory,
        @StringRes val titleResId: Int,
        @StringRes val descriptionResId: Int,
        val iconEmoji: String,
        val targetValue: Int,
        val isSecret: Boolean = false,
        val xpReward: Int = 10
    )
    
    enum class AchievementCategory(@StringRes val titleResId: Int) {
        TIME(R.string.ach_cat_time),
        VOLUME(R.string.ach_cat_volume),
        LOYALTY(R.string.ach_cat_loyalty),
        COLLECTION(R.string.ach_cat_collection),
        PLAYER(R.string.ach_cat_player),
        HARDCORE(R.string.ach_cat_hardcore),
        SECRET(R.string.ach_cat_secret)
    }
    
    data class AchievementProgress(
        val id: String,
        val currentValue: Int,
        val isUnlocked: Boolean,
        val unlockedAt: Long = 0
    )
    
    object AchievementManager {
        private const val PREFS_NAME = "achievements_prefs"
        private lateinit var prefs: SharedPreferences
        private lateinit var context: Context
        private val scope = CoroutineScope(Dispatchers.Main)
    
        val definitions = listOf(
            Achievement("time_1h", AchievementCategory.TIME, R.string.ach_time_1h_title, R.string.ach_time_1h_desc, "ğŸ§", 3600, xpReward = 10),
            Achievement("time_24h", AchievementCategory.TIME, R.string.ach_time_24h_title, R.string.ach_time_24h_desc, "ğŸŒ™", 86400, xpReward = 100),
            Achievement("time_100h", AchievementCategory.TIME, R.string.ach_time_100h_title, R.string.ach_time_100h_desc, "ğŸ”¥", 360000, xpReward = 500),
            Achievement("time_500h", AchievementCategory.TIME, R.string.ach_time_500h_title, R.string.ach_time_500h_desc, "âš¡", 1800000, xpReward = 2000),
            Achievement("time_1000h", AchievementCategory.TIME, R.string.ach_time_1000h_title, R.string.ach_time_1000h_desc, "ğŸ–ï¸", 3600000, xpReward = 5000),
            Achievement("time_2500h", AchievementCategory.TIME, R.string.ach_time_2500h_title, R.string.ach_time_2500h_desc, "ğŸ§˜", 9000000, xpReward = 15000),
            Achievement("time_5000h", AchievementCategory.TIME, R.string.ach_time_5000h_title, R.string.ach_time_5000h_desc, "ğŸŒŒ", 18000000, xpReward = 50000),
            Achievement("time_10000h", AchievementCategory.TIME, R.string.ach_time_10000h_title, R.string.ach_time_10000h_desc, "ğŸ§ ", 36000000, xpReward = 100000),
            Achievement("plays_1", AchievementCategory.VOLUME, R.string.ach_plays_1_title, R.string.ach_plays_1_desc, "ğŸµ", 1, xpReward = 5),
            Achievement("plays_100", AchievementCategory.VOLUME, R.string.ach_plays_100_title, R.string.ach_plays_100_desc, "ğŸ’¿", 100, xpReward = 50),
            Achievement("plays_1000", AchievementCategory.VOLUME, R.string.ach_plays_1000_title, R.string.ach_plays_1000_desc, "ğŸ§­", 1000, xpReward = 500),
            Achievement("plays_5000", AchievementCategory.VOLUME, R.string.ach_plays_5000_title, R.string.ach_plays_5000_desc, "ğŸŒŠ", 5000, xpReward = 2000),
            Achievement("plays_10000", AchievementCategory.VOLUME, R.string.ach_plays_10000_title, R.string.ach_plays_10000_desc, "ğŸ¤–", 10000, xpReward = 5000),
            Achievement("plays_20000", AchievementCategory.VOLUME, R.string.ach_plays_20000_title, R.string.ach_plays_20000_desc, "ğŸ‘ï¸", 20000, xpReward = 10000),
            Achievement("plays_50000", AchievementCategory.VOLUME, R.string.ach_plays_50000_title, R.string.ach_plays_50000_desc, "ğŸ”®", 50000, xpReward = 25000),
            Achievement("plays_100000", AchievementCategory.VOLUME, R.string.ach_plays_100000_title, R.string.ach_plays_100000_desc, "ğŸ‘‘", 100000, xpReward = 100000),
            Achievement("streak_7", AchievementCategory.LOYALTY, R.string.ach_streak_7_title, R.string.ach_streak_7_desc, "ğŸ—“ï¸", 7, xpReward = 100),
            Achievement("streak_30", AchievementCategory.LOYALTY, R.string.ach_streak_30_title, R.string.ach_streak_30_desc, "ğŸ“…", 30, xpReward = 500),
            Achievement("streak_100", AchievementCategory.LOYALTY, R.string.ach_streak_100_title, R.string.ach_streak_100_desc, "ğŸ’¯", 100, xpReward = 2000),
            Achievement("streak_200", AchievementCategory.LOYALTY, R.string.ach_streak_200_title, R.string.ach_streak_200_desc, "âš”ï¸", 200, xpReward = 5000),
            Achievement("streak_365", AchievementCategory.LOYALTY, R.string.ach_streak_365_title, R.string.ach_streak_365_desc, "ğŸ†", 365, xpReward = 20000),
            Achievement("streak_500", AchievementCategory.LOYALTY, R.string.ach_streak_500_title, R.string.ach_streak_500_desc, "ğŸ›¡ï¸", 500, xpReward = 50000),
            Achievement("early_bird", AchievementCategory.LOYALTY, R.string.ach_early_bird_title, R.string.ach_early_bird_desc, "ğŸŒ…", 10, xpReward = 100),
            Achievement("night_owl", AchievementCategory.LOYALTY, R.string.ach_night_owl_title, R.string.ach_night_owl_desc, "ğŸ¦‰", 10, xpReward = 100),
            Achievement("lunch_break", AchievementCategory.LOYALTY, R.string.ach_lunch_break_title, R.string.ach_lunch_break_desc, "ğŸ”", 10, xpReward = 100),
            Achievement("liker_50", AchievementCategory.COLLECTION, R.string.ach_liker_50_title, R.string.ach_liker_50_desc, "ğŸ’–", 50, xpReward = 100),
            Achievement("liker_1000", AchievementCategory.COLLECTION, R.string.ach_liker_1000_title, R.string.ach_liker_1000_desc, "ğŸ†", 1000, xpReward = 2000),
            Achievement("liker_5000", AchievementCategory.COLLECTION, R.string.ach_liker_5000_title, R.string.ach_liker_5000_desc, "â™¾ï¸", 5000, xpReward = 10000),
            Achievement("playlist_creator", AchievementCategory.COLLECTION, R.string.ach_playlist_creator_title, R.string.ach_playlist_creator_desc, "ğŸ’¾", 5, xpReward = 100),
            Achievement("playlist_god", AchievementCategory.COLLECTION, R.string.ach_playlist_god_title, R.string.ach_playlist_god_desc, "ğŸ—ï¸", 50, xpReward = 2500),
            Achievement("download_100", AchievementCategory.COLLECTION, R.string.ach_download_100_title, R.string.ach_download_100_desc, "ğŸ“¦", 100, xpReward = 500),
            Achievement("download_1000", AchievementCategory.COLLECTION, R.string.ach_download_1000_title, R.string.ach_download_1000_desc, "ğŸ—„ï¸", 1000, xpReward = 5000),
            Achievement("skipper_100", AchievementCategory.PLAYER, R.string.ach_skipper_100_title, R.string.ach_skipper_100_desc, "â­ï¸", 100, xpReward = 100),
            Achievement("skipper_1000", AchievementCategory.PLAYER, R.string.ach_skipper_1000_title, R.string.ach_skipper_1000_desc, "ğŸ™…", 1000, xpReward = 1000),
            Achievement("bass_addict", AchievementCategory.PLAYER, R.string.ach_bass_addict_title, R.string.ach_bass_addict_desc, "ğŸ¤¯", 36000, xpReward = 2000),
            Achievement("speed_demon", AchievementCategory.PLAYER, R.string.ach_speed_demon_title, R.string.ach_speed_demon_desc, "ğŸï¸", 3600, xpReward = 500),
            Achievement("social_star", AchievementCategory.PLAYER, R.string.ach_social_star_title, R.string.ach_social_star_desc, "ğŸŒ", 50, xpReward = 1000),
            Achievement("obsessed_50", AchievementCategory.HARDCORE, R.string.ach_obsessed_50_title, R.string.ach_obsessed_50_desc, "ğŸ”„", 50, xpReward = 1000),
            Achievement("obsessed_200", AchievementCategory.HARDCORE, R.string.ach_obsessed_200_title, R.string.ach_obsessed_200_desc, "ğŸ˜µâ€ğŸ’«", 200, xpReward = 10000),
            Achievement("night_shift_pro", AchievementCategory.HARDCORE, R.string.ach_night_shift_pro_title, R.string.ach_night_shift_pro_desc, "ğŸ§›", 1800000, xpReward = 15000),
            Achievement("marathon", AchievementCategory.HARDCORE, R.string.ach_marathon_title, R.string.ach_marathon_desc, "ğŸƒ", 28800, xpReward = 5000),
            Achievement("no_skip_50", AchievementCategory.HARDCORE, R.string.ach_no_skip_50_title, R.string.ach_no_skip_50_desc, "ğŸ§˜", 50, xpReward = 1000),
            Achievement("developer", AchievementCategory.SECRET, R.string.ach_developer_title, R.string.ach_secret_desc, "ğŸ’»", 10, isSecret = true, xpReward = 1000),
            Achievement("weekend_warrior", AchievementCategory.SECRET, R.string.ach_weekend_warrior_title, R.string.ach_secret_desc, "ğŸ‰", 2, isSecret = true, xpReward = 200),
            Achievement("ghost", AchievementCategory.SECRET, R.string.ach_ghost_title, R.string.ach_secret_desc, "ğŸ‘»", 86400, isSecret = true, xpReward = 5000),
            Achievement("lucky7", AchievementCategory.SECRET, R.string.ach_lucky7_title, R.string.ach_secret_desc, "ğŸ°", 7, isSecret = true, xpReward = 7777),
            Achievement("glitch", AchievementCategory.SECRET, R.string.ach_glitch_title, R.string.ach_secret_desc, "ğŸ‘¾", 1, isSecret = true, xpReward = 1337)
        )
    
        private val _isAllUnlocked = MutableStateFlow(false)
        val isAllUnlocked = _isAllUnlocked.asStateFlow()
    
        private val _progressFlow = MutableStateFlow<Map<String, AchievementProgress>>(emptyMap())
        val progressFlow = _progressFlow.asStateFlow()
    
        fun init(context: Context) {
            this.context = context.applicationContext
            prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
            loadProgress()
            checkCompletion()
        }
    
        private fun loadProgress() {
            val newMap = mutableMapOf<String, AchievementProgress>()
            definitions.forEach { def ->
                val current = prefs.getInt("curr_${def.id}", 0)
                val unlocked = prefs.getBoolean("unlocked_${def.id}", false)
                val time = prefs.getLong("time_${def.id}", 0)
                newMap[def.id] = AchievementProgress(def.id, current, unlocked, time)
            }
            _progressFlow.value = newMap
        }
    
        fun resetAll() {
            prefs.edit().clear().apply()
            _isAllUnlocked.value = false
            loadProgress()
        }
    
        fun increment(id: String, amount: Int = 1) {
            val def = definitions.find { it.id == id } ?: return
            val currentProgress = _progressFlow.value[id] ?: AchievementProgress(id, 0, false)
            if (currentProgress.isUnlocked) return
            val newValue = currentProgress.currentValue + amount
            if (newValue >= def.targetValue) {
                unlock(id)
            } else {
                prefs.edit().putInt("curr_$id", newValue).apply()
                updateFlow(id, currentProgress.copy(currentValue = newValue))
            }
        }
    
        fun addPlayTime(seconds: Int, isGuest: Boolean, speed: Float) {
            definitions.filter { it.category == AchievementCategory.TIME }.forEach { increment(it.id, seconds) }
            if (isGuest) increment("ghost", seconds)
            val hour = Calendar.getInstance().get(Calendar.HOUR_OF_DAY)
            if (hour >= 22 || hour <= 6) increment("night_shift_pro", seconds)
            increment("marathon", seconds)
            if (speed >= 1.2f) increment("speed_demon", seconds)
        }
    
        fun checkDailyStreak() {
            val now = Calendar.getInstance()
            val currentDayOfYear = now.get(Calendar.DAY_OF_YEAR)
            val currentYear = now.get(Calendar.YEAR)
    
            val lastDayOfYear = prefs.getInt("last_streak_day_of_year", -1)
            val lastYear = prefs.getInt("last_streak_year", -1)
    
            var currentStreak = prefs.getInt("current_streak_count", 0)
            val isNewDay = currentYear != lastYear || currentDayOfYear != lastDayOfYear
    
            if (isNewDay) {
                val yesterday = Calendar.getInstance().apply { add(Calendar.DAY_OF_YEAR, -1) }
                val isConsecutive = (lastYear == yesterday.get(Calendar.YEAR) && lastDayOfYear == yesterday.get(Calendar.DAY_OF_YEAR))
    
                currentStreak = if (isConsecutive) currentStreak + 1 else 1
    
                prefs.edit()
                    .putInt("last_streak_day_of_year", currentDayOfYear)
                    .putInt("last_streak_year", currentYear)
                    .putInt("current_streak_count", currentStreak)
                    .apply()
    
                scope.launch {
                    val popupPrefs = PlayerPreferences(context)
                    if (popupPrefs.getAchievementPopupsEnabled()) {
                        AchievementNotificationManager.showNotification(
                            AchievementNotification(
                                title = context.getString(R.string.streak_popup_title),
                                subtitle = context.getString(R.string.streak_popup_subtitle, currentStreak),
                                iconEmoji = "ğŸ”¥",
                                xpReward = null
                            )
                        )
                    }
                }
    
                val dayOfWeek = now.get(Calendar.DAY_OF_WEEK)
                if (dayOfWeek == Calendar.SATURDAY || dayOfWeek == Calendar.SUNDAY) {
                    increment("weekend_warrior")
                }
            }
    
            val streakDefs = definitions.filter { it.category == AchievementCategory.LOYALTY && it.id.startsWith("streak_") }
            streakDefs.forEach { def ->
                if (_progressFlow.value[def.id]?.isUnlocked == false) {
                    // Sauvegarde la progression pour la persistance
                    prefs.edit().putInt("curr_${def.id}", currentStreak).apply()
                    // Met Ã  jour l'interface pour la session actuelle
                    updateFlow(def.id, AchievementProgress(def.id, currentStreak, false))
                }
                // VÃ©rifie si le succÃ¨s doit Ãªtre dÃ©verrouillÃ©
                if (currentStreak >= def.targetValue) {
                    unlock(def.id)
                }
            }
        }
    
        fun checkTrackNameSecret(title: String) {
            if (title.contains("777") || title.contains("Lucky", ignoreCase = true)) increment("lucky7", 1)
            if (title.contains("Error") || title.contains("Glitch", ignoreCase = true)) increment("glitch", 1)
        }
    
        fun trackSkipped() {
            prefs.edit().putInt("curr_no_skip_50", 0).apply()
            updateFlow("no_skip_50", AchievementProgress("no_skip_50", 0, false))
        }
    
        private fun unlock(id: String) {
            if (_progressFlow.value[id]?.isUnlocked == true) return
            val now = System.currentTimeMillis()
            val def = definitions.find { it.id == id } ?: return
    
            scope.launch {
                val playerPrefs = PlayerPreferences(context)
                if (playerPrefs.getAchievementPopupsEnabled()) {
                    AchievementNotificationManager.showNotification(
                        AchievementNotification(
                            title = context.getString(R.string.achievement_unlocked),
                            subtitle = context.getString(def.titleResId),
                            iconEmoji = def.iconEmoji,
                            xpReward = def.xpReward
                        )
                    )
                }
            }
    
            prefs.edit()
                .putInt("curr_$id", def.targetValue)
                .putBoolean("unlocked_$id", true)
                .putLong("time_$id", now)
                .apply()
    
            val newProgress = AchievementProgress(id, def.targetValue, true, now)
            updateFlow(id, newProgress)
            checkCompletion()
        }
    
        private fun updateFlow(id: String, progress: AchievementProgress) {
            _progressFlow.update { it.toMutableMap().apply { put(id, progress) } }
        }
    
        private fun checkCompletion() {
            val unlockedCount = _progressFlow.value.values.count { it.isUnlocked }
            val totalCount = definitions.size
            if (unlockedCount >= totalCount && !_isAllUnlocked.value) {
                _isAllUnlocked.value = true
            }
        }
    
        fun getLevelInfo(): Triple<Int, Int, Int> {
            val totalXp = _progressFlow.value.values.filter { it.isUnlocked }.sumOf { prog ->
                definitions.find { it.id == prog.id }?.xpReward ?: 0
            }
            var level = 1
            var xpForNext = 1000
            var xpAccumulated = 0
            while (totalXp >= xpAccumulated + xpForNext) {
                xpAccumulated += xpForNext
                level++
                xpForNext = (xpForNext * 1.2).toInt()
            }
            return Triple(level, totalXp - xpAccumulated, xpForNext)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/BackupManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.net.Uri
    import com.alananasss.kittytune.data.local.*
    import com.alananasss.kittytune.domain.Track
    import com.google.gson.Gson
    import com.google.gson.reflect.TypeToken
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.flow.first
    import kotlinx.coroutines.withContext
    import java.io.BufferedReader
    import java.io.InputStreamReader
    import java.text.SimpleDateFormat
    import java.util.Date
    import java.util.Locale
    
    // Global backup model
    data class FullBackupData(
        val version: Int = 1,
        val timestamp: Long = System.currentTimeMillis(),
        val localTracks: List<LocalTrack>,
        val localPlaylists: List<LocalPlaylist>,
        val playlistRefs: List<PlaylistTrackCrossRef>,
        val savedArtists: List<LocalArtist>,
        val history: List<HistoryItem>,
        val likedTracks: List<Track>,
        val achievements: Map<String, Any?>,
        val playerPrefs: Map<String, Any?>
    )
    
    object BackupManager {
        private val gson = Gson()
    
        suspend fun createBackup(context: Context, uri: Uri) {
            withContext(Dispatchers.IO) {
                val db = AppDatabase.getDatabase(context).downloadDao()
                val tracks = db.getAllTracks().first()
                val playlists = db.getAllPlaylists().first()
                val allRefs = mutableListOf<PlaylistTrackCrossRef>()
                playlists.forEach { playlist ->
                    val tracksInPlaylist = db.getTracksForPlaylistSync(playlist.id)
                    tracksInPlaylist.forEach { track ->
                        val ref = db.getRef(playlist.id, track.id)
                        if (ref != null) allRefs.add(ref)
                    }
                }
    
                val artists = db.getAllSavedArtists().first()
                val history = db.getHistory().first()
                val likes = LikeRepository.likedTracks.value
                val achievementPrefs = context.getSharedPreferences("achievements_prefs", Context.MODE_PRIVATE).all
                val playerPrefsMap = context.getSharedPreferences("player_state", Context.MODE_PRIVATE).all
    
                val backupData = FullBackupData(
                    localTracks = tracks,
                    localPlaylists = playlists,
                    playlistRefs = allRefs,
                    savedArtists = artists,
                    history = history,
                    likedTracks = likes,
                    achievements = achievementPrefs,
                    playerPrefs = playerPrefsMap
                )
    
                val jsonString = gson.toJson(backupData)
                context.contentResolver.openOutputStream(uri)?.use { output ->
                    output.write(jsonString.toByteArray())
                }
            }
        }
    
        suspend fun restoreBackup(context: Context, uri: Uri) {
            withContext(Dispatchers.IO) {
                val db = AppDatabase.getDatabase(context).downloadDao()
                val contentResolver = context.contentResolver
    
                val jsonString = contentResolver.openInputStream(uri)?.use { inputStream ->
                    BufferedReader(InputStreamReader(inputStream)).readText()
                } ?: throw Exception("Impossible de lire le fichier")
    
                val data: FullBackupData = gson.fromJson(jsonString, FullBackupData::class.java)
    
    
                // Tracks
                data.localTracks.forEach { db.insertTrack(it) }
    
                // Playlists
                data.localPlaylists.forEach { db.insertPlaylist(it) }
    
                // Refs
                data.playlistRefs.forEach { db.insertPlaylistTrackRef(it) }
    
                // Artists
                data.savedArtists.forEach { db.insertArtist(it) }
    
                // History
                data.history.forEach { db.insertHistory(it) }
    
                LikeRepository.replaceAllLikes(data.likedTracks)
    
                // 4. Restauration Preferences
                restorePrefs(context, "achievements_prefs", data.achievements)
                restorePrefs(context, "player_state", data.playerPrefs)
    
                // 5. Re-initializing managers to take changes into account
                withContext(Dispatchers.Main) {
                    AchievementManager.init(context)
                }
            }
        }
    
        private fun restorePrefs(context: Context, prefName: String, map: Map<String, Any?>) {
            val prefs = context.getSharedPreferences(prefName, Context.MODE_PRIVATE)
            val editor = prefs.edit()
            editor.clear()
    
            map.forEach { (key, value) ->
                when (value) {
                    is Boolean -> editor.putBoolean(key, value)
                    is Float -> editor.putFloat(key, value)
                    is Int -> editor.putInt(key, value.toInt())
                    is Double -> {
                        if (key.contains("time") || key.contains("date") || key.contains("position")) {
                            editor.putLong(key, value.toLong())
                        } else {
                            editor.putInt(key, value.toInt())
                        }
                    }
                    is String -> editor.putString(key, value)
                    is Long -> editor.putLong(key, value)
                }
            }
            editor.commit()
        }
    
        fun getBackupFileName(): String {
            val date = SimpleDateFormat("yyyyMMdd_HHmm", Locale.getDefault()).format(Date())
            return "SoundTune_Backup_$date.backup"
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/DownloadManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.graphics.Bitmap
    import android.graphics.drawable.BitmapDrawable
    import android.net.Uri
    import android.util.Log
    import androidx.documentfile.provider.DocumentFile
    import coil.ImageLoader
    import coil.request.ImageRequest
    import coil.request.SuccessResult
    import com.alananasss.kittytune.data.local.*
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.data.network.SoundCloudApi
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.utils.Config
    import com.mpatric.mp3agic.ID3v24Tag
    import com.mpatric.mp3agic.Mp3File
    import kotlinx.coroutines.CoroutineScope
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.Job
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.asStateFlow
    import kotlinx.coroutines.flow.first
    import kotlinx.coroutines.flow.update
    import kotlinx.coroutines.launch
    import okhttp3.OkHttpClient
    import okhttp3.Request
    import org.json.JSONObject
    import java.io.File
    import java.io.FileInputStream
    import java.io.FileOutputStream
    import java.io.OutputStream
    
    object DownloadManager {
        private lateinit var context: Context
        private lateinit var database: AppDatabase
        private lateinit var prefs: PlayerPreferences
    
        private val api: SoundCloudApi by lazy { RetrofitClient.create(context) }
        private val scope = CoroutineScope(Dispatchers.IO)
        private val client = OkHttpClient()
    
        private val _downloadProgress = MutableStateFlow<Map<Long, Int>>(emptyMap())
        val downloadProgress = _downloadProgress.asStateFlow()
    
        private val _storageTrigger = MutableStateFlow(0)
        val storageTrigger = _storageTrigger.asStateFlow()
    
        private val activeJobs = mutableMapOf<Long, Job>()
    
        fun init(ctx: Context) {
            context = ctx.applicationContext
            database = AppDatabase.getDatabase(context)
            prefs = PlayerPreferences(context)
        }
    
        // --- UTILITY FILE NAME ---
        private fun sanitizeFilename(name: String): String {
            // Remplace les caractÃ¨res interdits par des underscores
            return name.replace(Regex("[\\\\/:*?\"<>|]"), "_").trim()
        }
    
        // --- FILE MANAGEMENT (Internal vs External) ---
        private fun getOutputStreamForFile(fileName: String, mimeType: String): Pair<OutputStream, String> {
            val customUriStr = prefs.getDownloadLocation()
    
            if (customUriStr != null) {
                try {
                    val treeUri = Uri.parse(customUriStr)
                    val rootDoc = DocumentFile.fromTreeUri(context, treeUri)
                        ?: throw Exception("Impossible d'accÃ©der au dossier externe")
    
                    // If the file already exists, we delete it and recreate it properly
                    val existing = rootDoc.findFile(fileName)
                    if (existing != null) existing.delete()
    
                    val targetDoc = rootDoc.createFile(mimeType, fileName)
                        ?: throw Exception("Impossible de crÃ©er le fichier externe")
    
                    val stream = context.contentResolver.openOutputStream(targetDoc.uri)
                        ?: throw Exception("Impossible d'ouvrir le flux externe")
    
                    return Pair(stream, targetDoc.uri.toString())
                } catch (e: Exception) {
                    e.printStackTrace()
                    throw e
                }
            } else {
                // Public internal storage (App's Music folder or FilesDir)
                val file = File(context.filesDir, fileName)
                return Pair(FileOutputStream(file), file.absolutePath)
            }
        }
    
        private fun deleteFileByPath(path: String) {
            if (path.isEmpty()) return
    
            try {
                if (path.startsWith("content://")) {
                    val uri = Uri.parse(path)
                    DocumentFile.fromSingleUri(context, uri)?.delete()
                } else {
                    val file = File(path)
                    if (file.exists()) file.delete()
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    
        // --- CLEANING ---
        fun removeAllContent(includeAudio: Boolean, includeImages: Boolean) {
            scope.launch {
                val allTracks = database.downloadDao().getAllTracks().first()
    
                allTracks.forEach { track ->
                    var updatedTrack = track
                    var changed = false
    
                    if (includeAudio && track.localAudioPath.isNotEmpty()) {
                        deleteFileByPath(track.localAudioPath)
                        updatedTrack = updatedTrack.copy(localAudioPath = "")
                        changed = true
                    }
    
                    if (includeImages && track.localArtworkPath.isNotEmpty()) {
                        deleteFileByPath(track.localArtworkPath)
                        updatedTrack = updatedTrack.copy(localArtworkPath = "")
                        changed = true
                    }
    
                    if (changed) {
                        database.downloadDao().updateTrack(updatedTrack)
                    }
                }
                _storageTrigger.update { it + 1 }
            }
        }
    
        // --- PLAYLISTS & DB ---
        fun createUserPlaylist(name: String): Long {
            val newId = -(System.currentTimeMillis())
            val playlist = LocalPlaylist(id = newId, title = name, artist = "Moi", artworkUrl = "", trackCount = 0, isUserCreated = true)
            scope.launch { database.downloadDao().insertPlaylist(playlist) }
            return newId
        }
        fun addTrackToPlaylist(playlistId: Long, track: Track) {
            scope.launch {
                val dao = database.downloadDao()
                val existingTrack = dao.getTrack(track.id)
                if (existingTrack == null) {
                    val localTrack = LocalTrack(id = track.id, title = track.title ?: "Sans titre", artist = track.user?.username ?: "Inconnu", artworkUrl = track.fullResArtwork, duration = track.durationMs ?: 0L, localAudioPath = "", localArtworkPath = "")
                    dao.insertTrack(localTrack)
                }
                dao.insertPlaylistTrackRef(PlaylistTrackCrossRef(playlistId, track.id))
                val playlist = dao.getPlaylist(playlistId)
                if (playlist != null) dao.updatePlaylist(playlist.copy(trackCount = playlist.trackCount + 1))
            }
        }
        fun removeTrackFromPlaylist(playlistId: Long, trackId: Long) {
            scope.launch {
                val dao = database.downloadDao()
                dao.removeTrackFromPlaylist(playlistId, trackId)
                val playlist = dao.getPlaylist(playlistId)
                if (playlist != null) dao.updatePlaylist(playlist.copy(trackCount = (playlist.trackCount - 1).coerceAtLeast(0)))
            }
        }
        fun swapTrackOrder(playlistId: Long, trackId1: Long, trackId2: Long) {
            scope.launch {
                val dao = database.downloadDao()
                val ref1 = dao.getRef(playlistId, trackId1); val ref2 = dao.getRef(playlistId, trackId2)
                if (ref1 != null && ref2 != null) { dao.updatePlaylistTrackRef(ref1.copy(addedAt = ref2.addedAt)); dao.updatePlaylistTrackRef(ref2.copy(addedAt = ref1.addedAt)) }
            }
        }
        fun updatePlaylistCover(playlistId: Long, uri: Uri) {
            scope.launch { try { val inputStream = context.contentResolver.openInputStream(uri); val file = File(context.filesDir, "playlist_cover_${playlistId}.jpg"); inputStream?.use { input -> FileOutputStream(file).use { output -> input.copyTo(output) } }; val playlist = database.downloadDao().getPlaylist(playlistId); if (playlist != null) database.downloadDao().updatePlaylist(playlist.copy(localCoverPath = file.absolutePath)) } catch (e: Exception) { e.printStackTrace() } }
        }
        fun renamePlaylist(playlistId: Long, newTitle: String) { scope.launch { database.downloadDao().updatePlaylistTitle(playlistId, newTitle) } }
        fun getAllPlaylistsFlow() = database.downloadDao().getAllPlaylists()
        fun getUserPlaylistsFlow() = database.downloadDao().getUserPlaylists()
        fun isPlaylistInLibraryFlow(playlistId: Long) = database.downloadDao().getPlaylistFlow(playlistId)
        fun importPlaylistToLibrary(playlist: Playlist, tracks: List<Track>) {
            scope.launch {
                val localPlaylist = LocalPlaylist(id = playlist.id, title = playlist.title ?: "Sans titre", artist = playlist.user?.username ?: "Inconnu", artworkUrl = playlist.fullResArtwork, trackCount = tracks.size, isUserCreated = false)
                database.downloadDao().insertPlaylist(localPlaylist)
                tracks.forEach { addTrackToPlaylist(playlist.id, it) }
            }
        }
        fun deletePlaylist(playlistId: Long) {
            scope.launch {
                val dao = database.downloadDao(); dao.deletePlaylist(playlistId); dao.deletePlaylistRefs(playlistId); HistoryRepository.removeFromHistory(playlistId)
                val orphans = dao.getOrphanTracksList()
                orphans.forEach { track -> deleteFileByPath(track.localAudioPath); deleteFileByPath(track.localArtworkPath); dao.deleteTrack(track.id) }
                _storageTrigger.update { it + 1 }
            }
        }
        fun removePlaylistDownloads(playlistId: Long) {
            scope.launch {
                val tracks = database.downloadDao().getTracksForPlaylistSync(playlistId)
                tracks.forEach { track -> deleteFileByPath(track.localAudioPath); deleteFileByPath(track.localArtworkPath); database.downloadDao().updateTrack(track.copy(localAudioPath = "", localArtworkPath = "")) }
                _storageTrigger.update { it + 1 }
            }
        }
        fun toggleSaveArtist(user: User) { scope.launch { val dao = database.downloadDao(); if (dao.getArtist(user.id) != null) dao.deleteArtist(user.id) else dao.insertArtist(LocalArtist(user.id, user.username ?: "Artiste", user.avatarUrl ?: "", user.trackCount)) } }
        fun isArtistSavedFlow(artistId: Long) = database.downloadDao().getArtistFlow(artistId)
        fun getSavedArtists() = database.downloadDao().getAllSavedArtists()
        fun downloadPlaylist(playlist: Playlist, tracks: List<Track>) { importPlaylistToLibrary(playlist, tracks); scope.launch { tracks.forEach { downloadTrack(it) } } }
    
        fun downloadTrack(track: Track) {
            if (activeJobs.containsKey(track.id)) return
            scope.launch {
                val existing = database.downloadDao().getTrack(track.id)
                if (existing != null && existing.localAudioPath.isNotEmpty()) { return@launch }
                startDownloadJob(track)
            }
        }
    
        // --- HEART OF THE DOWNLOAD WITH METADATA & PROPER NAME ---
        private fun startDownloadJob(track: Track) {
            val job = scope.launch {
                // Temporary files in the cache (invisible to the user)
                val tempAudioFile = File(context.cacheDir, "temp_${track.id}.mp3")
                val tempImageFile = File(context.cacheDir, "temp_art_${track.id}.jpg")
                val taggedAudioFile = File(context.cacheDir, "tagged_${track.id}.mp3")
    
                // Internal image file (For display in the app only)
                val internalArtFile = File(context.filesDir, "art_${track.id}.jpg")
    
                try {
                    _downloadProgress.update { it + (track.id to 0) }
                    val streamUrl = resolveStreamUrl(track)
    
                    // 1. Download the raw audio temporarily
                    downloadFileToStream(streamUrl, FileOutputStream(tempAudioFile)) { p ->
                        _downloadProgress.update { c -> c + (track.id to p) }
                    }
    
                    // 2. Download the raw image temporarily
                    downloadFileToStream(track.fullResArtwork, FileOutputStream(tempImageFile)) { _ -> }
    
                    // 3. Save the image INTERNALLY for the app (to avoid cluttering the gallery)
                    if (tempImageFile.exists()) {
                        tempImageFile.copyTo(internalArtFile, overwrite = true)
                    }
    
                    // 4. INJECTION OF METADATA (ID3 Tags) via mp3agic
                    try {
                        val mp3file = Mp3File(tempAudioFile)
                        val id3v2Tag = if (mp3file.hasId3v2Tag()) mp3file.id3v2Tag else ID3v24Tag()
                        mp3file.id3v2Tag = id3v2Tag
    
                        // Metadata
                        id3v2Tag.title = track.title ?: "Titre Inconnu"
                        id3v2Tag.artist = track.user?.username ?: "Artiste Inconnu"
                        id3v2Tag.album = "SoundTune"
                        id3v2Tag.comment = "TÃ©lÃ©chargÃ© avec KittyTune"
    
                        // Injecting the album art into the MP3
                        val imageBytes = tempImageFile.readBytes()
                        id3v2Tag.setAlbumImage(imageBytes, "image/jpeg")
    
                        mp3file.save(taggedAudioFile.absolutePath)
                    } catch (e: Exception) {
                        Log.e("DownloadManager", "Erreur tagging ID3: ${e.message}")
                        tempAudioFile.copyTo(taggedAudioFile, overwrite = true)
                    }
    
                    // 5. Copy to final destination (Public)
    
                    // Creating a clean filename: "Artist - Title.mp3"
                    val cleanArtist = sanitizeFilename(track.user?.username ?: "Artiste")
                    val cleanTitle = sanitizeFilename(track.title ?: "Titre")
                    val finalFileName = "$cleanArtist - $cleanTitle.mp3"
    
                    val (audioStream, audioPath) = getOutputStreamForFile(finalFileName, "audio/mpeg")
    
                    // Copy of the final (tagged) file to user storage
                    FileInputStream(taggedAudioFile).use { input ->
                        audioStream.use { output ->
                            input.copyTo(output)
                        }
                    }
                    val localTrack = LocalTrack(
                        id = track.id,
                        title = track.title ?: "?",
                        artist = track.user?.username ?: "?",
                        artworkUrl = track.fullResArtwork,
                        duration = track.durationMs ?: 0L,
                        localAudioPath = audioPath,
                        localArtworkPath = internalArtFile.absolutePath // Chemin interne cachÃ©
                    )
    
                    val dao = database.downloadDao()
                    if (dao.getTrack(track.id) == null) dao.insertTrack(localTrack)
                    else dao.updateTrack(localTrack)
    
                    _storageTrigger.update { it + 1 }
    
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    // Nettoyage cache
                    try {
                        if (tempAudioFile.exists()) tempAudioFile.delete()
                        if (tempImageFile.exists()) tempImageFile.delete()
                        if (taggedAudioFile.exists()) taggedAudioFile.delete()
                    } catch (e: Exception) {}
    
                    _downloadProgress.update { it - track.id }
                    activeJobs.remove(track.id)
                }
            }
            activeJobs[track.id] = job
        }
    
        private fun downloadFileToStream(url: String, outputStream: OutputStream, onProgress: (Int) -> Unit) {
            val request = Request.Builder().url(url).build()
            val response = client.newCall(request).execute()
            val body = response.body ?: throw Exception("Body null")
            val total = body.contentLength()
    
            body.byteStream().use { input ->
                outputStream.use { output ->
                    val buffer = ByteArray(8 * 1024)
                    var copied = 0L
                    var read: Int
                    while (input.read(buffer).also { read = it } >= 0) {
                        output.write(buffer, 0, read)
                        copied += read
                        if (total > 0) onProgress(((copied * 100) / total).toInt())
                    }
                    output.flush()
                }
            }
        }
    
        private suspend fun resolveStreamUrl(track: Track): String {
            var trackToUse = track
            if (track.media == null || track.media.transcodings.isNullOrEmpty()) {
                try {
                    val fetchedList = api.getTracksByIds(track.id.toString())
                    if (fetchedList.isNotEmpty()) trackToUse = fetchedList[0]
                    else throw Exception("Impossible de rÃ©cupÃ©rer les infos")
                } catch (e: Exception) { throw Exception("Erreur API: ${e.message}") }
            }
            val tokenManager = TokenManager(context)
            val accessToken = tokenManager.getAccessToken()
            val transcodings = trackToUse.media?.transcodings ?: throw Exception("Pas de mÃ©dia disponible")
    
            val qualityPref = prefs.getAudioQuality()
    
            val target = if (qualityPref == "HIGH") {
                transcodings.find { it.format?.protocol == "progressive" }
                    ?: transcodings.find { it.format?.protocol == "hls" }
            } else {
                transcodings.find { it.format?.mimeType?.contains("opus") == true }
                    ?: transcodings.find { it.format?.protocol == "hls" }
                    ?: transcodings.find { it.format?.protocol == "progressive" }
            } ?: throw Exception("Aucun format supportÃ©")
    
            val urlWithId = if (target.url.contains("?")) "${target.url}&client_id=${Config.CLIENT_ID}" else "${target.url}?client_id=${Config.CLIENT_ID}"
            val builder = Request.Builder().url(urlWithId).header("User-Agent", Config.USER_AGENT)
            if (!accessToken.isNullOrEmpty()) builder.header("Authorization", "OAuth $accessToken")
    
            val response = client.newCall(builder.build()).execute()
            if (!response.isSuccessful) throw Exception("Erreur Stream: ${response.code}")
            val body = response.body?.string() ?: throw Exception("RÃ©ponse vide")
            return JSONObject(body).getString("url")
        }
    
        fun deleteTrack(trackId: Long) {
            scope.launch {
                val track = database.downloadDao().getTrack(trackId)
                if (track != null) {
                    deleteFileByPath(track.localAudioPath)
                    deleteFileByPath(track.localArtworkPath) // Supprime l'image cachÃ©e interne
                    database.downloadDao().updateTrack(track.copy(localAudioPath = "", localArtworkPath = ""))
                }
                _storageTrigger.update { it + 1 }
            }
        }
    
        fun cancelDownload(trackId: Long) {
            activeJobs[trackId]?.cancel()
            activeJobs.remove(trackId)
            _downloadProgress.update { it - trackId }
            // Nettoyage potentiel
            try { File(context.cacheDir, "temp_${trackId}.mp3").delete() } catch(e: Exception){}
            _storageTrigger.update { it + 1 }
        }
    
        fun isTrackDownloading(trackId: Long): Boolean = activeJobs.containsKey(trackId)
        suspend fun getLocalTrack(id: Long): LocalTrack? = database.downloadDao().getTrack(id)
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/HistoryRepository.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import com.alananasss.kittytune.data.local.AppDatabase
    import com.alananasss.kittytune.data.local.HistoryItem
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import kotlinx.coroutines.CoroutineScope
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.launch
    
    object HistoryRepository {
        private lateinit var database: AppDatabase
        private val scope = CoroutineScope(Dispatchers.IO)
    
        fun init(context: Context) {
            database = AppDatabase.getDatabase(context)
        }
    
        fun addToHistory(track: Track) {
            scope.launch {
                val item = HistoryItem(
                    id = "track:${track.id}",
                    numericId = track.id,
                    title = track.title ?: "Sans titre",
                    subtitle = track.user?.username ?: "Inconnu",
                    imageUrl = track.fullResArtwork,
                    type = "TRACK"
                )
                database.downloadDao().insertHistory(item)
            }
        }
    
        fun addToHistory(playlist: Playlist, isStation: Boolean = false, isProfile: Boolean = false) {
            scope.launch {
                val (stringId, type) = when {
                    isProfile -> "profile:${playlist.id}" to "PROFILE"
                    isStation -> "station:${playlist.id}" to "STATION"
                    playlist.id == -1L -> "likes" to "PLAYLIST"
                    playlist.id == -2L -> "downloads" to "PLAYLIST"
                    // Pour les playlists locales (ID < 0), on utilise le prÃ©fixe standard ou spÃ©cifique selon besoin.
                    // Ici on garde "playlist:" pour matcher la logique de navigation
                    playlist.id < 0 -> "playlist:${playlist.id}" to "PLAYLIST"
                    else -> "playlist:${playlist.id}" to "PLAYLIST"
                }
    
                val finalSubtitle = when {
                    isProfile -> "Artiste"
                    isStation -> playlist.user?.username ?: "Station"
                    playlist.id < 0 -> "Playlist Locale"
                    else -> playlist.user?.username ?: "SoundCloud"
                }
    
                val item = HistoryItem(
                    id = stringId,
                    numericId = playlist.id,
                    title = playlist.title ?: "Playlist",
                    subtitle = finalSubtitle,
                    imageUrl = playlist.fullResArtwork,
                    type = type
                )
                database.downloadDao().insertHistory(item)
            }
        }
    
        // NOUVEAU : Supprimer un Ã©lÃ©ment de l'historique
        fun removeFromHistory(playlistId: Long) {
            scope.launch {
                // On tente de supprimer les variantes possibles
                database.downloadDao().deleteHistoryItem("playlist:$playlistId")
                database.downloadDao().deleteHistoryItem("station:$playlistId")
                // Note: pour les playlists locales (ex: -123), l'ID est "playlist:-123"
            }
        }
    
        fun getHistory() = database.downloadDao().getHistory()
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/LikeRepository.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.content.SharedPreferences
    import android.util.Log
    import com.alananasss.kittytune.domain.Track
    import com.google.gson.Gson
    import com.google.gson.reflect.TypeToken
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.StateFlow
    import kotlinx.coroutines.flow.asStateFlow
    import kotlinx.coroutines.flow.update
    
    object LikeRepository {
        private const val PREF_NAME = "soundtune_likes_v3"
        private const val KEY_LIKED_TRACKS = "liked_tracks_full"
        private const val KEY_PRIORITY_IDS = "saved_priority_ids"
        private const val KEY_DELETED_IDS = "saved_deleted_ids"
    
        private lateinit var prefs: SharedPreferences
        private val gson = Gson()
    
        private val _likedTracks = MutableStateFlow<List<Track>>(emptyList())
        val likedTracks: StateFlow<List<Track>> = _likedTracks.asStateFlow()
    
        private val _isSyncing = MutableStateFlow(false)
        val isSyncing = _isSyncing.asStateFlow()
    
        private val priorityIds = mutableSetOf<Long>()
        private val deletedIds = mutableSetOf<Long>()
    
        fun init(context: Context) {
            prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
            loadFromPrefs()
        }
    
        fun addLike(track: Track) {
            deletedIds.remove(track.id)
            priorityIds.add(track.id)
            // Added immediately to the top of the list for the UI
            _likedTracks.update { current ->
                listOf(track.copy(isLiked = true)) + current.filterNot { it.id == track.id }
            }
            saveToPrefs()
        }
    
        fun removeLike(trackId: Long) {
            priorityIds.remove(trackId)
            deletedIds.add(trackId)
            // Immediate removal for the UI
            _likedTracks.update { current ->
                current.filterNot { it.id == trackId }
            }
            saveToPrefs()
        }
    
        fun isTrackLiked(trackId: Long): Boolean {
            return _likedTracks.value.any { it.id == trackId }
        }
    
        // This function no longer updates the Flow on every page.
        // It replaces EVERYTHING once it's finished.
        fun replaceAllLikes(serverTracks: List<Track>) {
            val serverIds = serverTracks.map { it.id }.toSet()
    
            // 1. We clean up our local priorities if the server knows them
            val syncedVips = priorityIds.filter { serverIds.contains(it) }
            if (syncedVips.isNotEmpty()) {
                priorityIds.removeAll(syncedVips.toSet())
            }
    
            // 2. We rebuild the final list
            // First, recent local likes (Priority)
            val localVips = _likedTracks.value.filter { priorityIds.contains(it.id) }
    
            // Then the server tracks (removing those that were deleted locally)
            val validServerTracks = serverTracks.filterNot { deletedIds.contains(it.id) }
                .map { it.copy(isLiked = true) }
    
            // 3. Atomic Update
            val finalList = localVips + validServerTracks
    
            _likedTracks.value = finalList
            saveToPrefs()
            _isSyncing.value = false
        }
    
        fun setSyncing(isSync: Boolean) {
            _isSyncing.value = isSync
        }
    
        private fun saveToPrefs() {
            val listToSave = _likedTracks.value
            val prioritiesToSave = priorityIds.map { it.toString() }.toSet()
            val deletedsToSave = deletedIds.map { it.toString() }.toSet()
    
            Thread {
                try {
                    val editor = prefs.edit()
                    val json = gson.toJson(listToSave)
                    editor.putString(KEY_LIKED_TRACKS, json)
                    editor.putStringSet(KEY_PRIORITY_IDS, prioritiesToSave)
                    editor.putStringSet(KEY_DELETED_IDS, deletedsToSave)
                    editor.apply()
                } catch (e: Exception) { e.printStackTrace() }
            }.start()
        }
    
        private fun loadFromPrefs() {
            try {
                val json = prefs.getString(KEY_LIKED_TRACKS, null)
                if (json != null) {
                    val type = object : TypeToken<List<Track>>() {}.type
                    _likedTracks.value = gson.fromJson(json, type)
                }
                val savedPriorities = prefs.getStringSet(KEY_PRIORITY_IDS, emptySet()) ?: emptySet()
                val savedDeleteds = prefs.getStringSet(KEY_DELETED_IDS, emptySet()) ?: emptySet()
    
                priorityIds.clear()
                priorityIds.addAll(savedPriorities.mapNotNull { it.toLongOrNull() })
    
                deletedIds.clear()
                deletedIds.addAll(savedDeleteds.mapNotNull { it.toLongOrNull() })
            } catch (e: Exception) { e.printStackTrace() }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/local/AppDatabase.kt
================================================================================
    package com.alananasss.kittytune.data.local
    
    import android.content.Context
    import androidx.room.Dao
    import androidx.room.Database
    import androidx.room.Insert
    import androidx.room.OnConflictStrategy
    import androidx.room.Query
    import androidx.room.Room
    import androidx.room.RoomDatabase
    import androidx.room.Transaction
    import androidx.room.Update
    import kotlinx.coroutines.flow.Flow
    
    @Dao
    interface DownloadDao {
        // --- TRACKS ---
        @Insert(onConflict = OnConflictStrategy.IGNORE)
        suspend fun insertTrack(track: LocalTrack)
    
        @Update
        suspend fun updateTrack(track: LocalTrack)
    
        @Query("SELECT * FROM downloaded_tracks WHERE id = :trackId")
        suspend fun getTrack(trackId: Long): LocalTrack?
    
        @Query("DELETE FROM downloaded_tracks WHERE id = :trackId")
        suspend fun deleteTrack(trackId: Long)
    
        // We only return tracks with a valid (non-empty) audio path.
        // This prevents tracks added to playlists from appearing in "Downloads" if they haven't been downloaded.
        @Query("SELECT * FROM downloaded_tracks WHERE localAudioPath != ''")
        fun getAllTracks(): Flow<List<LocalTrack>>
    
        // --- PLAYLISTS ---
        @Insert(onConflict = OnConflictStrategy.REPLACE)
        suspend fun insertPlaylist(playlist: LocalPlaylist)
    
        @Update
        suspend fun updatePlaylist(playlist: LocalPlaylist)
    
        @Insert(onConflict = OnConflictStrategy.IGNORE)
        suspend fun insertPlaylistTrackRef(ref: PlaylistTrackCrossRef)
    
        @Update
        suspend fun updatePlaylistTrackRef(ref: PlaylistTrackCrossRef)
    
        @Query("SELECT * FROM playlist_track_cross_ref WHERE playlistId = :playlistId AND trackId = :trackId")
        suspend fun getRef(playlistId: Long, trackId: Long): PlaylistTrackCrossRef?
    
        @Query("DELETE FROM downloaded_playlists WHERE id = :playlistId")
        suspend fun deletePlaylist(playlistId: Long)
    
        @Query("DELETE FROM playlist_track_cross_ref WHERE playlistId = :playlistId")
        suspend fun deletePlaylistRefs(playlistId: Long)
    
        @Query("DELETE FROM playlist_track_cross_ref WHERE playlistId = :playlistId AND trackId = :trackId")
        suspend fun removeTrackFromPlaylist(playlistId: Long, trackId: Long)
    
        @Query("SELECT * FROM downloaded_playlists")
        fun getAllPlaylists(): Flow<List<LocalPlaylist>>
    
        @Query("SELECT * FROM downloaded_playlists WHERE isUserCreated = 1")
        fun getUserPlaylists(): Flow<List<LocalPlaylist>>
    
        @Query("SELECT * FROM downloaded_playlists WHERE id = :playlistId")
        suspend fun getPlaylist(playlistId: Long): LocalPlaylist?
    
        @Query("SELECT * FROM downloaded_playlists WHERE id = :playlistId")
        fun getPlaylistFlow(playlistId: Long): Flow<LocalPlaylist?>
    
        @Query("UPDATE downloaded_playlists SET title = :newTitle WHERE id = :playlistId")
        suspend fun updatePlaylistTitle(playlistId: Long, newTitle: String)
    
        @Query("SELECT * FROM downloaded_tracks WHERE id NOT IN (SELECT trackId FROM playlist_track_cross_ref)")
        suspend fun getOrphanTracksList(): List<LocalTrack>
    
        // --- RELATIONSHIPS ---
        @Transaction
        @Query("""
            SELECT downloaded_tracks.* FROM downloaded_tracks 
            INNER JOIN playlist_track_cross_ref ON downloaded_tracks.id = playlist_track_cross_ref.trackId 
            WHERE playlist_track_cross_ref.playlistId = :playlistId
            ORDER BY playlist_track_cross_ref.addedAt ASC
        """)
        fun getTracksForPlaylist(playlistId: Long): Flow<List<LocalTrack>>
    
        // --- ARTISTS ---
        @Insert(onConflict = OnConflictStrategy.REPLACE)
        suspend fun insertArtist(artist: LocalArtist)
    
        @Query("DELETE FROM saved_artists WHERE id = :artistId")
        suspend fun deleteArtist(artistId: Long)
    
        @Query("SELECT * FROM saved_artists WHERE id = :artistId")
        suspend fun getArtist(artistId: Long): LocalArtist?
    
        @Query("SELECT * FROM saved_artists WHERE id = :artistId")
        fun getArtistFlow(artistId: Long): Flow<LocalArtist?>
    
        @Query("SELECT * FROM saved_artists ORDER BY savedAt DESC")
        fun getAllSavedArtists(): Flow<List<LocalArtist>>
    
        // --- HISTORY ---
        @Insert(onConflict = OnConflictStrategy.REPLACE)
        suspend fun insertHistory(item: HistoryItem)
    
        @Query("SELECT * FROM play_history ORDER BY timestamp DESC LIMIT 20")
        fun getHistory(): Flow<List<HistoryItem>>
    
        @Query("DELETE FROM play_history WHERE id = :itemId")
        suspend fun deleteHistoryItem(itemId: String)
    
        @Query("""
        SELECT downloaded_tracks.* FROM downloaded_tracks 
        INNER JOIN playlist_track_cross_ref ON downloaded_tracks.id = playlist_track_cross_ref.trackId 
        WHERE playlist_track_cross_ref.playlistId = :playlistId
    """)
        suspend fun getTracksForPlaylistSync(playlistId: Long): List<LocalTrack>
    
        @Query("DELETE FROM play_history")
        suspend fun clearHistory()
    }
    
    @Database(entities = [LocalTrack::class, LocalPlaylist::class, PlaylistTrackCrossRef::class, HistoryItem::class, LocalArtist::class], version = 5, exportSchema = false)
    abstract class AppDatabase : RoomDatabase() {
        abstract fun downloadDao(): DownloadDao
    
        companion object {
            @Volatile private var INSTANCE: AppDatabase? = null
            fun getDatabase(context: Context): AppDatabase {
                return INSTANCE ?: synchronized(this) {
                    val instance = Room.databaseBuilder(
                        context.applicationContext,
                        AppDatabase::class.java,
                        "soundtune_db"
                    )
                        .fallbackToDestructiveMigration()
                        .build()
                    INSTANCE = instance
                    instance
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/local/Entities.kt
================================================================================
    package com.alananasss.kittytune.data.local
    
    import androidx.room.Entity
    import androidx.room.PrimaryKey
    
    @Entity(tableName = "downloaded_tracks")
    data class LocalTrack(
        @PrimaryKey val id: Long,
        val title: String,
        val artist: String,
        val artworkUrl: String,
        val duration: Long,
        val localAudioPath: String,
        val localArtworkPath: String,
        val downloadedAt: Long = System.currentTimeMillis()
    )
    
    @Entity(tableName = "downloaded_playlists")
    data class LocalPlaylist(
        @PrimaryKey val id: Long,
        val title: String,
        val artist: String,
        val artworkUrl: String,
        val trackCount: Int,
        val isUserCreated: Boolean = false,
        val localCoverPath: String? = null,
        val addedAt: Long = System.currentTimeMillis()
    )
    
    @Entity(tableName = "playlist_track_cross_ref", primaryKeys = ["playlistId", "trackId"])
    data class PlaylistTrackCrossRef(
        val playlistId: Long,
        val trackId: Long,
        val addedAt: Long = System.currentTimeMillis()
    )
    
    @Entity(tableName = "saved_artists")
    data class LocalArtist(
        @PrimaryKey val id: Long,
        val username: String,
        val avatarUrl: String,
        val trackCount: Int,
        val savedAt: Long = System.currentTimeMillis()
    )
    
    @Entity(tableName = "play_history")
    data class HistoryItem(
        @PrimaryKey val id: String,
        val numericId: Long,
        val title: String,
        val subtitle: String,
        val imageUrl: String,
        val type: String,
        val timestamp: Long = System.currentTimeMillis()
    )

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/LocalMediaRepository.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.media.MediaMetadataRetriever
    import android.net.Uri
    import androidx.documentfile.provider.DocumentFile
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.AppDatabase
    import com.alananasss.kittytune.data.local.LocalTrack
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.asStateFlow
    import kotlinx.coroutines.withContext
    import java.io.File
    import java.io.FileOutputStream
    
    object LocalMediaRepository {
    
        // observable states for the ui
        private val _isScanning = MutableStateFlow(false)
        val isScanning = _isScanning.asStateFlow()
    
        private val _scanProgress = MutableStateFlow("")
        val scanProgress = _scanProgress.asStateFlow()
    
        suspend fun scanLocalMedia(context: Context) {
            if (_isScanning.value) return
            _isScanning.value = true
            _scanProgress.value = context.getString(R.string.pref_local_scan_status_prep)
    
            withContext(Dispatchers.IO) {
                try {
                    val prefs = PlayerPreferences(context)
                    val uriSet = prefs.getLocalMediaUris()
    
                    // check if the user actually selected some folders
                    if (uriSet.isEmpty()) {
                        _scanProgress.value = context.getString(R.string.pref_local_scan_status_no_folder)
                        _isScanning.value = false
                        return@withContext
                    }
    
                    val db = AppDatabase.getDatabase(context).downloadDao()
                    val foundFiles = mutableListOf<DocumentFile>()
    
                    _scanProgress.value = context.getString(R.string.pref_local_scan_status_searching)
    
                    // dig through the folders recursively
                    uriSet.forEach { uriStr ->
                        try {
                            val treeUri = Uri.parse(uriStr)
                            val rootDir = DocumentFile.fromTreeUri(context, treeUri)
                            if (rootDir != null && rootDir.exists()) {
                                collectAudioFiles(rootDir, foundFiles)
                            }
                        } catch (e: Exception) {
                            e.printStackTrace()
                        }
                    }
    
                    if (foundFiles.isEmpty()) {
                        _scanProgress.value = context.getString(R.string.pref_local_scan_status_no_files)
                        _isScanning.value = false
                        return@withContext
                    }
    
                    _scanProgress.value = context.getString(R.string.pref_local_scan_status_found, foundFiles.size)
    
                    val tracksToInsert = mutableListOf<LocalTrack>()
                    var processed = 0
    
                    // now process each file to get metadata
                    foundFiles.forEach { file ->
                        processed++
                        if (processed % 10 == 0) {
                            _scanProgress.value = context.getString(R.string.pref_local_scan_status_analyzing, processed, foundFiles.size)
                        }
    
                        try {
                            val track = processFile(context, file)
                            if (track != null) {
                                tracksToInsert.add(track)
                            }
                        } catch (e: Exception) {
                            e.printStackTrace()
                        }
                    }
    
                    _scanProgress.value = context.getString(R.string.pref_local_scan_status_saving)
                    tracksToInsert.forEach { track ->
                        db.insertTrack(track)
                    }
    
                    _scanProgress.value = context.getString(R.string.pref_local_scan_status_done)
                } catch (e: Exception) {
                    e.printStackTrace()
                    _scanProgress.value = context.getString(R.string.pref_local_scan_status_error, e.message ?: "")
                } finally {
                    _isScanning.value = false
                }
            }
        }
    
        // recursive helper to find audio files
        private fun collectAudioFiles(dir: DocumentFile, list: MutableList<DocumentFile>) {
            dir.listFiles()?.forEach { file ->
                if (file.isDirectory) {
                    collectAudioFiles(file, list)
                } else {
                    val type = file.type ?: ""
                    val name = file.name?.lowercase() ?: ""
    
                    val isAudioMime = type.startsWith("audio/")
    
                    // check extensions manually just in case
                    val isAudioExtension = name.endsWith(".mp3") ||
                            name.endsWith(".flac") ||
                            name.endsWith(".wav") ||
                            name.endsWith(".m4a") ||
                            name.endsWith(".aac") ||
                            name.endsWith(".ogg") ||
                            name.endsWith(".wma") ||
                            name.endsWith(".opus") ||
                            name.endsWith(".amr") ||
                            name.endsWith(".mp4")
    
                    if (isAudioMime || isAudioExtension) {
                        list.add(file)
                    }
                }
            }
        }
    
        private fun processFile(context: Context, file: DocumentFile): LocalTrack? {
            val uri = file.uri
            val retriever = MediaMetadataRetriever()
    
            return try {
                retriever.setDataSource(context, uri)
    
                // extract title, artist, cover art...
                val title = retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_TITLE)
                    ?: file.name?.substringBeforeLast(".")
                    ?: context.getString(R.string.untitled_track)
    
                val artist = retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_ARTIST)
                    ?: context.getString(R.string.unknown_artist)
    
                val durationStr = retriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_DURATION)
                val duration = durationStr?.toLongOrNull() ?: 0L
    
                val artworkBytes = retriever.embeddedPicture
                var artworkPath = ""
    
                // save embedded art to disk so glide can load it
                if (artworkBytes != null) {
                    val fileName = "local_art_${file.name.hashCode()}.jpg"
                    val artFile = File(context.filesDir, fileName)
                    if (!artFile.exists()) {
                        FileOutputStream(artFile).use { it.write(artworkBytes) }
                    }
                    artworkPath = artFile.absolutePath
                }
    
                // generate a unique negative id for local tracks
                var id = uri.toString().hashCode().toLong()
                if (id > 0) id *= -1
                if (id == 0L) id = -1L
    
                LocalTrack(
                    id = id,
                    title = title,
                    artist = artist,
                    artworkUrl = artworkPath,
                    duration = duration,
                    localAudioPath = uri.toString(),
                    localArtworkPath = artworkPath
                )
    
            } catch (e: Exception) {
                null
            } finally {
                try { retriever.release() } catch (e: Exception) {}
            }
        }
    
        fun isLocalTrack(id: Long): Boolean {
            // local tracks have negative ids
            return id < 0 && id > -9000000000000000000
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/local/PlayerPreferences.kt
================================================================================
    package com.alananasss.kittytune.data.local
    
    import android.content.Context
    import android.content.SharedPreferences
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.ui.player.AudioEffectsState
    import com.alananasss.kittytune.ui.player.PlaybackContext
    import com.alananasss.kittytune.ui.player.RepeatMode
    import com.google.gson.Gson
    import com.google.gson.reflect.TypeToken
    
    enum class AppThemeMode { SYSTEM, LIGHT, DARK }
    enum class PlayerBackgroundStyle { THEME, GRADIENT, BLUR }
    enum class StartDestination { HOME, LIBRARY }
    enum class LyricsAlignment { LEFT, CENTER, RIGHT }
    
    enum class AppLanguage(val code: String) {
        SYSTEM("system"),
        FRENCH("fr"),
        ENGLISH("en"),
        HUNGARIAN("hu")
    }
    
    class PlayerPreferences(context: Context) {
        private val prefs: SharedPreferences = context.getSharedPreferences("player_state", Context.MODE_PRIVATE)
        private val gson = Gson()
    
        companion object {
            private const val KEY_TRACK_JSON = "last_track_json"
            private const val KEY_POSITION = "last_position"
            private const val KEY_QUEUE_JSON = "last_queue_full_json"
            private const val KEY_EFFECTS = "audio_effects"
            private const val KEY_CONTEXT_JSON = "last_context_json"
            private const val KEY_SHUFFLE_MODE = "shuffle_mode_enabled"
            private const val KEY_REPEAT_MODE = "repeat_mode_state"
            private const val KEY_DOWNLOAD_DIR = "download_directory_uri"
            private const val KEY_AUTOPLAY_STATION = "autoplay_station_enabled"
            private const val KEY_AUDIO_QUALITY = "audio_quality_pref"
            private const val KEY_PERSISTENT_QUEUE = "persistent_queue_enabled"
            private const val KEY_START_DESTINATION = "start_destination_pref"
            private const val KEY_DYNAMIC_THEME = "dynamic_theme_enabled"
            private const val KEY_THEME_MODE = "app_theme_mode"
            private const val KEY_PURE_BLACK = "pure_black_enabled"
            private const val KEY_PLAYER_STYLE = "player_background_style"
            private const val KEY_LOCAL_MEDIA_ENABLED = "local_media_enabled"
            private const val KEY_LOCAL_MEDIA_URIS_SET = "local_media_uris_set_v2"
            private const val KEY_LYRICS_PREFER_LOCAL = "lyrics_prefer_local"
            private const val KEY_LYRICS_ALIGNMENT = "lyrics_alignment"
            private const val KEY_LYRICS_FONT_SIZE = "lyrics_font_size"
            private const val KEY_APP_LANGUAGE = "app_language_code"
            private const val KEY_ACHIEVEMENT_POPUPS = "achievement_popups_enabled"
        }
    
        fun getAchievementPopupsEnabled(): Boolean = prefs.getBoolean(KEY_ACHIEVEMENT_POPUPS, false) // dÃ©sactivÃ© par dÃ©faut
        fun setAchievementPopupsEnabled(enabled: Boolean) = prefs.edit().putBoolean(KEY_ACHIEVEMENT_POPUPS, enabled).apply()
    
        // --- LANGUAGE MANAGEMENT ---
        fun getAppLanguage(): AppLanguage {
            val code = prefs.getString(KEY_APP_LANGUAGE, AppLanguage.SYSTEM.code)
            return AppLanguage.entries.find { it.code == code } ?: AppLanguage.SYSTEM
        }
    
        fun setAppLanguage(language: AppLanguage) {
            prefs.edit().putString(KEY_APP_LANGUAGE, language.code).apply()
        }
    
        // --- LYRICS ---
    
        fun getLyricsPreferLocal(): Boolean = prefs.getBoolean(KEY_LYRICS_PREFER_LOCAL, false)
        fun setLyricsPreferLocal(enabled: Boolean) = prefs.edit().putBoolean(KEY_LYRICS_PREFER_LOCAL, enabled).apply()
    
        fun getLyricsAlignment(): LyricsAlignment {
            val name = prefs.getString(KEY_LYRICS_ALIGNMENT, LyricsAlignment.CENTER.name)
            return try { LyricsAlignment.valueOf(name!!) } catch (e: Exception) { LyricsAlignment.CENTER }
        }
        fun setLyricsAlignment(align: LyricsAlignment) = prefs.edit().putString(KEY_LYRICS_ALIGNMENT, align.name).apply()
    
        // Default size: 26f (sp)
        fun getLyricsFontSize(): Float = prefs.getFloat(KEY_LYRICS_FONT_SIZE, 26f)
        fun setLyricsFontSize(size: Float) = prefs.edit().putFloat(KEY_LYRICS_FONT_SIZE, size).apply()
        fun getLocalMediaEnabled(): Boolean = prefs.getBoolean(KEY_LOCAL_MEDIA_ENABLED, false)
        fun setLocalMediaEnabled(enabled: Boolean) = prefs.edit().putBoolean(KEY_LOCAL_MEDIA_ENABLED, enabled).apply()
        fun getLocalMediaUris(): Set<String> = prefs.getStringSet(KEY_LOCAL_MEDIA_URIS_SET, emptySet()) ?: emptySet()
        fun addLocalMediaUri(uri: String) { val c = getLocalMediaUris().toMutableSet(); c.add(uri); prefs.edit().putStringSet(KEY_LOCAL_MEDIA_URIS_SET, c).apply() }
        fun removeLocalMediaUri(uri: String) { val c = getLocalMediaUris().toMutableSet(); c.remove(uri); prefs.edit().putStringSet(KEY_LOCAL_MEDIA_URIS_SET, c).apply() }
        fun getStartDestination(): StartDestination { val n = prefs.getString(KEY_START_DESTINATION, StartDestination.HOME.name); return try { StartDestination.valueOf(n!!) } catch (e: Exception) { StartDestination.HOME } }
        fun setStartDestination(dest: StartDestination) = prefs.edit().putString(KEY_START_DESTINATION, dest.name).apply()
        fun getDynamicTheme(): Boolean = prefs.getBoolean(KEY_DYNAMIC_THEME, true)
        fun setDynamicTheme(enabled: Boolean) = prefs.edit().putBoolean(KEY_DYNAMIC_THEME, enabled).apply()
        fun getThemeMode(): AppThemeMode { val n = prefs.getString(KEY_THEME_MODE, AppThemeMode.SYSTEM.name); return try { AppThemeMode.valueOf(n!!) } catch (e: Exception) { AppThemeMode.SYSTEM } }
        fun setThemeMode(mode: AppThemeMode) = prefs.edit().putString(KEY_THEME_MODE, mode.name).apply()
        fun getPureBlack(): Boolean = prefs.getBoolean(KEY_PURE_BLACK, false)
        fun setPureBlack(enabled: Boolean) = prefs.edit().putBoolean(KEY_PURE_BLACK, enabled).apply()
        fun getPlayerStyle(): PlayerBackgroundStyle { val n = prefs.getString(KEY_PLAYER_STYLE, PlayerBackgroundStyle.BLUR.name); return try { PlayerBackgroundStyle.valueOf(n!!) } catch (e: Exception) { PlayerBackgroundStyle.BLUR } }
        fun setPlayerStyle(style: PlayerBackgroundStyle) = prefs.edit().putString(KEY_PLAYER_STYLE, style.name).apply()
        fun getAutoplayEnabled(): Boolean = prefs.getBoolean(KEY_AUTOPLAY_STATION, true)
        fun setAutoplayEnabled(enabled: Boolean) = prefs.edit().putBoolean(KEY_AUTOPLAY_STATION, enabled).apply()
        fun getAudioQuality(): String = prefs.getString(KEY_AUDIO_QUALITY, "HIGH") ?: "HIGH"
        fun setAudioQuality(quality: String) = prefs.edit().putString(KEY_AUDIO_QUALITY, quality).apply()
        fun getPersistentQueueEnabled(): Boolean = prefs.getBoolean(KEY_PERSISTENT_QUEUE, true)
        fun setPersistentQueueEnabled(enabled: Boolean) = prefs.edit().putBoolean(KEY_PERSISTENT_QUEUE, enabled).apply()
        fun savePlaybackState(track: Track?, position: Long, queue: List<Track>, context: PlaybackContext?, shuffleEnabled: Boolean, repeatMode: RepeatMode) {
            if (!getPersistentQueueEnabled()) {
                val editor = prefs.edit()
                editor.putBoolean(KEY_SHUFFLE_MODE, shuffleEnabled); editor.putString(KEY_REPEAT_MODE, repeatMode.name)
                editor.remove(KEY_TRACK_JSON); editor.remove(KEY_QUEUE_JSON); editor.remove(KEY_POSITION); editor.remove(KEY_CONTEXT_JSON)
                editor.apply(); return
            }
            val editor = prefs.edit()
            if (track != null) editor.putString(KEY_TRACK_JSON, gson.toJson(track))
            if (queue.isNotEmpty()) editor.putString(KEY_QUEUE_JSON, gson.toJson(queue))
            editor.putString(KEY_CONTEXT_JSON, gson.toJson(context))
            editor.putLong(KEY_POSITION, position)
            editor.putBoolean(KEY_SHUFFLE_MODE, shuffleEnabled)
            editor.putString(KEY_REPEAT_MODE, repeatMode.name)
            editor.apply()
        }
        fun saveEffects(state: AudioEffectsState) { prefs.edit().putString(KEY_EFFECTS, gson.toJson(state)).apply() }
        fun saveDownloadLocation(uriString: String?) { val editor = prefs.edit(); if (uriString != null) editor.putString(KEY_DOWNLOAD_DIR, uriString) else editor.remove(KEY_DOWNLOAD_DIR); editor.apply() }
        fun getDownloadLocation(): String? = prefs.getString(KEY_DOWNLOAD_DIR, null)
        fun getLastTrack(): Track? { if (!getPersistentQueueEnabled()) return null; val json = prefs.getString(KEY_TRACK_JSON, null) ?: return null; return try { gson.fromJson(json, Track::class.java) } catch (e: Exception) { null } }
        fun getLastPosition(): Long = prefs.getLong(KEY_POSITION, 0L)
        fun getLastQueue(): List<Track> { if (!getPersistentQueueEnabled()) return emptyList(); val json = prefs.getString(KEY_QUEUE_JSON, null) ?: return emptyList(); val type = object : TypeToken<List<Track>>() {}.type; return try { gson.fromJson(json, type) ?: emptyList() } catch (e: Exception) { emptyList() } }
        fun getLastContext(): PlaybackContext? { if (!getPersistentQueueEnabled()) return null; val json = prefs.getString(KEY_CONTEXT_JSON, null) ?: return null; return try { gson.fromJson(json, PlaybackContext::class.java) } catch (e: Exception) { null } }
        fun getLastShuffleEnabled(): Boolean = prefs.getBoolean(KEY_SHUFFLE_MODE, false)
        fun getLastRepeatMode(): RepeatMode { val modeName = prefs.getString(KEY_REPEAT_MODE, RepeatMode.NONE.name); return try { RepeatMode.valueOf(modeName ?: RepeatMode.NONE.name) } catch (e: Exception) { RepeatMode.NONE } }
        fun getLastEffects(): AudioEffectsState { val json = prefs.getString(KEY_EFFECTS, null) ?: return AudioEffectsState(); return try { gson.fromJson(json, AudioEffectsState::class.java) } catch (e: Exception) { AudioEffectsState() } }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/MediaButtonReceiver.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.BroadcastReceiver
    import android.content.Context
    import android.content.Intent
    
    class MediaButtonReceiver : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            val player = MusicManager.player
    
            when (intent.action) {
                "ACTION_PLAY" -> {
                    player.play()
                }
                "ACTION_PAUSE" -> {
                    player.pause()
                }
                "ACTION_NEXT" -> {
                    if (player.hasNextMediaItem()) {
                        player.seekToNext()
                    }
                }
                "ACTION_PREVIOUS" -> {
                    // smart previous logic
                    // restart song if we are more than 3s in
                    if (player.currentPosition > 3000) {
                        player.seekTo(0)
                    } else if (player.hasPreviousMediaItem()) {
                        player.seekToPrevious()
                    } else {
                        player.seekTo(0)
                    }
                }
                "ACTION_STOP" -> {
                    player.pause()
                    // could also kill the service here but pause is fine for now
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/MusicManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import androidx.media3.common.AudioAttributes
    import androidx.media3.common.C
    import androidx.media3.common.PlaybackParameters
    import androidx.media3.exoplayer.DefaultRenderersFactory
    import androidx.media3.exoplayer.ExoPlayer
    import androidx.media3.exoplayer.audio.AudioSink
    import androidx.media3.exoplayer.audio.DefaultAudioSink
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.ui.player.AudioEffectsState
    import com.alananasss.kittytune.ui.player.audio.EightDAudioProcessor
    import com.alananasss.kittytune.ui.player.audio.FxAudioProcessor
    import com.alananasss.kittytune.ui.player.audio.ReverbAudioProcessor
    
    object MusicManager {
        private var _player: ExoPlayer? = null
    
        val player: ExoPlayer
            get() {
                if (_player == null) {
                    throw IllegalStateException("MusicManager not initialized! Call init() first.")
                }
                return _player!!
            }
    
        // need to store the current track here so the service can access it
        var currentTrack: Track? = null
    
        private val eightDProcessor = EightDAudioProcessor()
        private val fxProcessor = FxAudioProcessor()
        private val reverbProcessor = ReverbAudioProcessor()
    
        var onNextClick: (() -> Unit)? = null
        var onPreviousClick: (() -> Unit)? = null
    
        fun init(context: Context) {
            if (_player != null) return
    
            _player = ExoPlayer.Builder(context)
                .setRenderersFactory(
                    object : DefaultRenderersFactory(context) {
                        override fun buildAudioSink(
                            context: Context,
                            enableFloatOutput: Boolean,
                            enableAudioTrackPlaybackParams: Boolean
                        ): AudioSink {
                            // hook up our custom processors chain here
                            return DefaultAudioSink.Builder(context)
                                .setAudioProcessors(arrayOf(fxProcessor, reverbProcessor, eightDProcessor))
                                .setEnableFloatOutput(enableFloatOutput)
                                .setEnableAudioTrackPlaybackParams(enableAudioTrackPlaybackParams)
                                .build()
                        }
                    }
                )
                .setAudioAttributes(
                    AudioAttributes.Builder()
                        .setUsage(C.USAGE_MEDIA)
                        .setContentType(C.AUDIO_CONTENT_TYPE_MUSIC)
                        .build(),
                    true
                )
                .setHandleAudioBecomingNoisy(true) // pause when headphones are unplugged
                .setWakeMode(C.WAKE_MODE_NETWORK)
                .build()
        }
    
        fun applyEffects(state: AudioEffectsState) {
            if (_player == null) return
    
            // if pitch is enabled (nightcore style), it follows speed
            val pitch = if (state.isPitchEnabled) state.speed else 1f
            _player?.playbackParameters = PlaybackParameters(state.speed, pitch)
    
            eightDProcessor.setEnabled(state.is8DEnabled)
            fxProcessor.setEffects(state.isMuffledEnabled, state.isBassBoostEnabled)
            reverbProcessor.setEnabled(state.isReverbEnabled)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/network/LongIdAdapter.kt
================================================================================
    package com.alananasss.kittytune.data.network
    
    import com.google.gson.TypeAdapter
    import com.google.gson.stream.JsonReader
    import com.google.gson.stream.JsonToken
    import com.google.gson.stream.JsonWriter
    import java.io.IOException
    
    class LongIdAdapter : TypeAdapter<Long>() {
        @Throws(IOException::class)
        override fun write(out: JsonWriter, value: Long?) {
            if (value == null) {
                out.nullValue()
            } else {
                out.value(value)
            }
        }
    
        @Throws(IOException::class)
        override fun read(reader: JsonReader): Long {
            if (reader.peek() == JsonToken.NULL) {
                reader.nextNull()
                return 0L
            }
    
            if (reader.peek() == JsonToken.NUMBER) {
                return reader.nextLong()
            }
    
            if (reader.peek() == JsonToken.STRING) {
                val str = reader.nextString()
                val simpleLong = str.toLongOrNull()
                if (simpleLong != null) return simpleLong
                if (str.contains(":")) {
                    val parts = str.split(":")
                    return parts.lastOrNull()?.toLongOrNull() ?: 0L
                }
            }
    
            reader.skipValue()
            return 0L
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/network/LrcLibApi.kt
================================================================================
    package com.alananasss.kittytune.data.network
    
    import com.google.gson.annotations.SerializedName
    import retrofit2.Retrofit
    import retrofit2.converter.gson.GsonConverterFactory
    import retrofit2.http.GET
    import retrofit2.http.Query
    
    data class LrcLibResponse(
        val id: Long,
        val name: String,
        @SerializedName("artistName") val artistName: String,
        @SerializedName("albumName") val albumName: String?,
        @SerializedName("duration") val duration: Double,
        @SerializedName("plainLyrics") val plainLyrics: String?,
        @SerializedName("syncedLyrics") val syncedLyrics: String?
    )
    
    interface LrcLibApiService {
        @GET("get")
        suspend fun getLyrics(
            @Query("track_name") trackName: String,
            @Query("artist_name") artistName: String,
            @Query("duration") duration: Long
        ): LrcLibResponse
    
        @GET("search")
        suspend fun searchLyrics(
            @Query("q") query: String
        ): List<LrcLibResponse>
    }
    
    object LrcLibClient {
        private const val BASE_URL = "https://lrclib.net/api/"
    
        val api: LrcLibApiService by lazy {
            Retrofit.Builder()
                .baseUrl(BASE_URL)
                .addConverterFactory(GsonConverterFactory.create())
                .build()
                .create(LrcLibApiService::class.java)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/network/RetrofitClient.kt
================================================================================
    package com.alananasss.kittytune.data.network
    
    import android.content.Context
    import com.alananasss.kittytune.data.TokenManager
    import com.alananasss.kittytune.utils.Config
    import okhttp3.OkHttpClient
    import okhttp3.logging.HttpLoggingInterceptor
    import retrofit2.Retrofit
    import retrofit2.converter.gson.GsonConverterFactory
    import java.util.concurrent.TimeUnit
    
    object RetrofitClient {
        private var okHttpClient: OkHttpClient? = null
    
        fun create(context: Context): SoundCloudApi {
            val tokenManager = TokenManager(context)
    
            val authInterceptor = okhttp3.Interceptor { chain ->
                val originalRequest = chain.request()
                val token = tokenManager.getAccessToken()
    
                // Using Config.CLIENT_ID
                val newUrl = originalRequest.url.newBuilder()
                    .addQueryParameter("client_id", Config.CLIENT_ID)
                    .build()
    
                val requestBuilder = originalRequest.newBuilder()
                    .url(newUrl)
                    .header("User-Agent", Config.USER_AGENT)
                    .header("Accept", "application/json")
    
                if (!token.isNullOrEmpty() && token != "null") {
                    requestBuilder.header("Authorization", "OAuth $token")
                }
    
                chain.proceed(requestBuilder.build())
            }
    
            if (okHttpClient == null) {
                okHttpClient = OkHttpClient.Builder()
                    .addInterceptor(authInterceptor)
                    .addInterceptor(HttpLoggingInterceptor().apply { level = HttpLoggingInterceptor.Level.BASIC })
                    .connectTimeout(30, TimeUnit.SECONDS)
                    .readTimeout(30, TimeUnit.SECONDS)
                    .writeTimeout(30, TimeUnit.SECONDS)
                    .build()
            }
    
            return Retrofit.Builder()
                .baseUrl(Config.BASE_URL)
                .client(okHttpClient!!)
                .addConverterFactory(GsonConverterFactory.create())
                .build()
                .create(SoundCloudApi::class.java)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/network/SoundCloudApi.kt
================================================================================
    package com.alananasss.kittytune.data.network
    
    import com.alananasss.kittytune.domain.*
    import retrofit2.http.Body
    import retrofit2.http.GET
    import retrofit2.http.POST
    import retrofit2.http.PUT
    import retrofit2.http.Path
    import retrofit2.http.Query
    import retrofit2.http.Url
    import retrofit2.http.DELETE
    
    interface SoundCloudApi {
        @GET("me")
        suspend fun getMe(): User
    
        // --- HOME & DISCOVERY ---
        @GET("charts")
        suspend fun getCharts(
            @Query("kind") kind: String = "top",
            @Query("genre") genre: String = "soundcloud:genres:all-music",
            @Query("limit") limit: Int = 20,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): ChartsResponse
    
        // The subscription stream
        @GET("stream")
        suspend fun getMyStream(
            @Query("limit") limit: Int = 20,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): StreamResponse
    
        // --- TRACK DETAILS ---
        @GET("tracks/{trackId}/likers")
        suspend fun getTrackLikers(
            @Path("trackId") trackId: Long,
            @Query("limit") limit: Int = 50
        ): LikerCollection
    
        @GET("tracks/{trackId}/reposters")
        suspend fun getTrackReposters(
            @Path("trackId") trackId: Long,
            @Query("limit") limit: Int = 50
        ): ReposterCollection
    
        @GET("tracks/{trackId}/playlists")
        suspend fun getTrackInPlaylists(
            @Path("trackId") trackId: Long,
            @Query("limit") limit: Int = 50
        ): InPlaylistCollection
    
        // --- GENERIC PAGINATION ---
        @GET
        suspend fun getLikersNextPage(@Url url: String): LikerCollection
    
        @GET
        suspend fun getRepostersNextPage(@Url url: String): ReposterCollection
    
        @GET
        suspend fun getInPlaylistsNextPage(@Url url: String): InPlaylistCollection
    
        @GET
        suspend fun getRelatedTracksNextPage(@Url url: String): BasicTrackCollection
    
        @PUT("me")
        suspend fun updateMe(@Body body: UpdateProfileRequest): User
    
        // --- REPOSTS ---
        @GET("stream/users/{userId}")
        suspend fun getUserReposts(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 30,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): RepostCollection
    
        @GET
        suspend fun getRepostsNextPage(@Url url: String): RepostCollection
    
        // --- RESEARCH ---
        @GET("search/tracks")
        suspend fun searchTracks(
            @Query("q") query: String,
            @Query("limit") limit: Int = 20
        ): BasicTrackCollection
    
        @GET("search/tracks")
        suspend fun searchTracks(
            @Query("q") query: String,
            @Query("limit") limit: Int = 50,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): BasicTrackCollection
    
        @GET("search/tracks")
        suspend fun searchTracksStrict(
            @Query("q") query: String = "*",
            @Query("filter.genre_or_tag") tag: String,
            @Query("sort") sort: String,
            @Query("limit") limit: Int = 50,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): BasicTrackCollection
    
        @GET
        suspend fun getSearchTracksNextPage(@Url url: String): BasicTrackCollection
    
        @GET("search/users")
        suspend fun searchUsers(
            @Query("q") query: String,
            @Query("limit") limit: Int = 20
        ): UserCollection
    
        @GET("search/playlists")
        suspend fun searchPlaylists(
            @Query("q") query: String,
            @Query("limit") limit: Int = 20
        ): UserPlaylistsResponse
    
        @GET("search/albums")
        suspend fun searchAlbums(
            @Query("q") query: String,
            @Query("limit") limit: Int = 20
        ): UserPlaylistsResponse
    
        // --- FAVORITES ---
        @GET("users/{userId}/track_likes")
        suspend fun getUserTrackLikes(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 100,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): TrackLikesResponse
    
        @GET
        suspend fun getTrackLikesNextPage(@Url url: String): TrackLikesResponse
    
        @GET("users/{userId}/playlist_likes")
        suspend fun getUserPlaylistLikes(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 50
        ): PlaylistLikesResponse
    
        @GET("users/{userId}/playlists")
        suspend fun getUserCreatedPlaylists(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 50
        ): UserPlaylistsResponse
    
        @GET("playlists/{playlistId}")
        suspend fun getPlaylist(@Path("playlistId") playlistId: Long): Playlist
    
        @GET("tracks")
        suspend fun getTracksByIds(@Query("ids") ids: String): List<Track>
    
        @GET
        suspend fun getStreamUrl(@Url url: String): StreamUrlResponse
    
        // --- STATIONS ---
        @GET("system-playlists/soundcloud:system-playlists:track-stations:{trackId}")
        suspend fun getTrackStation(@Path("trackId") trackId: Long): Playlist
    
        @GET("system-playlists/soundcloud:system-playlists:artist-stations:{userId}")
        suspend fun getArtistStation(@Path("userId") userId: Long): Playlist
    
        @GET("tracks/{trackId}/related")
        suspend fun getRelatedTracks(
            @Path("trackId") trackId: Long,
            @Query("limit") limit: Int = 10
        ): BasicTrackCollection
    
        @GET("users/{userId}")
        suspend fun getUser(@Path("userId") userId: Long): User
    
        @GET("users/{userId}/tracks")
        suspend fun getUserTracks(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 20,
            @Query("linked_partitioning") linkedPartitioning: Int = 1
        ): BasicTrackCollection
    
        @GET
        suspend fun getUserTracksNextPage(@Url url: String): BasicTrackCollection
    
        @GET("users/{userId}/toptracks")
        suspend fun getUserTopTracks(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 10
        ): BasicTrackCollection
    
        @GET("users/{userId}/albums")
        suspend fun getUserAlbums(
            @Path("userId") userId: Long,
            @Query("limit") limit: Int = 20
        ): UserPlaylistsResponse
    
        // --- COMMENTS ---
        @GET("tracks/{trackId}/comments")
        suspend fun getTrackComments(
            @Path("trackId") trackId: Long,
            @Query("limit") limit: Int = 50,
            @Query("linked_partitioning") linkedPartitioning: Int = 1,
            @Query("threaded") threaded: Int = 0,
            @Query("filter_replies") filterReplies: Int = 0,
            @Query("representation") representation: String = "full"
        ): CommentCollection
    
        @GET
        suspend fun getCommentsNextPage(@Url url: String): CommentCollection
    
        @POST("comments/{commentId}/likes")
        suspend fun likeComment(@Path("commentId") commentId: Long): retrofit2.Response<Unit>
    
        @GET("resolve")
        suspend fun resolveUrl(@Query("url") url: String): User
    
        @DELETE("comments/{commentId}/likes")
        suspend fun unlikeComment(@Path("commentId") commentId: Long): retrofit2.Response<Unit>
    
        @POST("tracks/{trackId}/comments")
        suspend fun postComment(
            @Path("trackId") trackId: Long,
            @Body request: PostCommentRequest
        ): Comment
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/PlaybackService.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.app.Notification
    import android.app.NotificationChannel
    import android.app.NotificationManager
    import android.app.PendingIntent
    import android.content.Context
    import android.content.Intent
    import android.graphics.BitmapFactory
    import android.os.Build
    import android.os.Bundle
    import android.support.v4.media.MediaMetadataCompat
    import android.support.v4.media.session.MediaSessionCompat
    import android.support.v4.media.session.PlaybackStateCompat
    import androidx.annotation.OptIn
    import androidx.core.app.NotificationCompat
    import androidx.media.app.NotificationCompat.MediaStyle
    import androidx.media.session.MediaButtonReceiver
    import androidx.media3.common.Player
    import androidx.media3.common.util.UnstableApi
    import androidx.media3.session.MediaSession
    import androidx.media3.session.MediaSessionService
    import com.alananasss.kittytune.MainActivity
    import com.alananasss.kittytune.R
    import kotlinx.coroutines.CoroutineScope
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.launch
    
    class PlaybackService : MediaSessionService() {
    
        companion object {
            private const val NOTIFICATION_ID = 1001
            private const val CHANNEL_ID = "soundtune_playback_channel"
            private const val ACTION_CUSTOM_LIKE = "ACTION_CUSTOM_LIKE"
            // added: action to force a refresh
            const val ACTION_FORCE_UPDATE = "com.alananasss.kittytune.ACTION_FORCE_UPDATE"
        }
    
        private var mediaSession: MediaSession? = null
        private lateinit var mediaSessionCompat: MediaSessionCompat
    
        private val serviceScope = CoroutineScope(Dispatchers.Main)
    
        private val sessionCallback = object : MediaSessionCompat.Callback() {
            override fun onPlay() { MusicManager.player.play() }
            override fun onPause() { MusicManager.player.pause() }
            override fun onStop() { MusicManager.player.stop(); stopSelf() }
            override fun onSkipToNext() { MusicManager.onNextClick?.invoke() }
            override fun onSkipToPrevious() {
                if (MusicManager.player.currentPosition > 3000) MusicManager.player.seekTo(0)
                else MusicManager.onPreviousClick?.invoke()
            }
            override fun onSeekTo(pos: Long) { MusicManager.player.seekTo(pos) }
    
            override fun onCustomAction(action: String?, extras: Bundle?) {
                if (action == ACTION_CUSTOM_LIKE) {
                    handleLikeToggle()
                }
            }
        }
    
        // command handler
        override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
            if (intent?.action == ACTION_FORCE_UPDATE) {
                // viewmodel told us it's ready, show the panel
                updateNotification()
            }
            if (intent != null) {
                MediaButtonReceiver.handleIntent(mediaSessionCompat, intent)
            }
            return super.onStartCommand(intent, flags, startId)
        }
    
        private fun handleLikeToggle() {
            val track = MusicManager.currentTrack ?: return
            val isLiked = LikeRepository.isTrackLiked(track.id)
    
            if (isLiked) {
                LikeRepository.removeLike(track.id)
            } else {
                LikeRepository.addLike(track)
            }
            // update immediately
            updateNotification()
        }
    
        @OptIn(UnstableApi::class)
        override fun onCreate() {
            super.onCreate()
            MusicManager.init(this)
            createNotificationChannel()
    
            val sessionIntent = Intent(this, MainActivity::class.java).apply {
                flags = Intent.FLAG_ACTIVITY_SINGLE_TOP or Intent.FLAG_ACTIVITY_CLEAR_TOP
            }
            val pendingIntent = PendingIntent.getActivity(
                this, 0, sessionIntent,
                PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
            )
    
            mediaSession = MediaSession.Builder(this, MusicManager.player)
                .setId("KittyTuneSession")
                .setSessionActivity(pendingIntent)
                .build()
    
            mediaSessionCompat = MediaSessionCompat(this, "KittyTuneCompat").apply {
                isActive = true
                setSessionActivity(pendingIntent)
                setCallback(sessionCallback)
            }
    
            MusicManager.player.addListener(object : Player.Listener {
                override fun onPlaybackStateChanged(playbackState: Int) { updateNotification() }
                override fun onIsPlayingChanged(isPlaying: Boolean) { updateNotification() }
                override fun onMediaItemTransition(mediaItem: androidx.media3.common.MediaItem?, reason: Int) { updateNotification() }
            })
    
            // basic init
            updateCompatState()
            updateCompatMetadata()
            startForeground(NOTIFICATION_ID, buildNotification())
        }
    
        private fun updateNotification() {
            if (!::mediaSessionCompat.isInitialized) return
            updateCompatState()
            updateCompatMetadata()
    
            // important: notify the system
            val manager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
            manager.notify(NOTIFICATION_ID, buildNotification())
        }
    
        private fun updateCompatState() {
            val player = MusicManager.player
            val state = if (player.isPlaying) PlaybackStateCompat.STATE_PLAYING else PlaybackStateCompat.STATE_PAUSED
    
            val currentId = player.currentMediaItem?.mediaId?.toLongOrNull() ?: 0L
            val isLiked = LikeRepository.isTrackLiked(currentId)
    
            val likeIcon = if (isLiked) R.drawable.ic_heart_filled else R.drawable.ic_heart_outline
            val likeLabel = if (isLiked) "Unlike" else "Like"
    
            val playbackStateBuilder = PlaybackStateCompat.Builder()
                .setActions(
                    PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE or
                            PlaybackStateCompat.ACTION_STOP or PlaybackStateCompat.ACTION_SKIP_TO_NEXT or
                            PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS or PlaybackStateCompat.ACTION_SEEK_TO
                )
                .setState(state, player.currentPosition, player.playbackParameters.speed)
                .addCustomAction(
                    PlaybackStateCompat.CustomAction.Builder(
                        ACTION_CUSTOM_LIKE,
                        likeLabel,
                        likeIcon
                    ).build()
                )
    
            mediaSessionCompat.setPlaybackState(playbackStateBuilder.build())
        }
    
        private fun updateCompatMetadata() {
            val player = MusicManager.player
            val currentMedia = player.currentMediaItem?.mediaMetadata ?: return
    
            val builder = MediaMetadataCompat.Builder()
                .putString(MediaMetadataCompat.METADATA_KEY_TITLE, currentMedia.title.toString())
                .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, currentMedia.artist.toString())
                .putLong(MediaMetadataCompat.METADATA_KEY_DURATION, player.duration.coerceAtLeast(0))
    
            currentMedia.artworkData?.let { bytes ->
                try {
                    val bitmap = BitmapFactory.decodeByteArray(bytes, 0, bytes.size)
                    builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, bitmap)
                } catch (e: Exception) { e.printStackTrace() }
            }
    
            mediaSessionCompat.setMetadata(builder.build())
        }
    
        private fun buildNotification(): Notification {
            val player = MusicManager.player
            val metadata = player.mediaMetadata
            val isPlaying = player.isPlaying
    
            val openAppIntent = Intent(this, MainActivity::class.java).apply {
                flags = Intent.FLAG_ACTIVITY_SINGLE_TOP or Intent.FLAG_ACTIVITY_CLEAR_TOP
            }
            val pendingOpenIntent = PendingIntent.getActivity(
                this, 0, openAppIntent,
                PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
            )
    
            val builder = NotificationCompat.Builder(this, CHANNEL_ID)
                .setSmallIcon(R.drawable.ic_notification)
                .setContentTitle(metadata.title ?: "SoundTune")
                .setContentText(metadata.artist ?: "Lecture en cours")
                .setOngoing(isPlaying)
                .setOnlyAlertOnce(true)
                .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
                .setPriority(NotificationCompat.PRIORITY_LOW)
                .setContentIntent(pendingOpenIntent)
    
                .addAction(NotificationCompat.Action(android.R.drawable.ic_media_previous, "PrÃ©cÃ©dent", MediaButtonReceiver.buildMediaButtonPendingIntent(this, PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS)))
    
            if (isPlaying) {
                builder.addAction(NotificationCompat.Action(android.R.drawable.ic_media_pause, "Pause", MediaButtonReceiver.buildMediaButtonPendingIntent(this, PlaybackStateCompat.ACTION_PAUSE)))
            } else {
                builder.addAction(NotificationCompat.Action(android.R.drawable.ic_media_play, "Jouer", MediaButtonReceiver.buildMediaButtonPendingIntent(this, PlaybackStateCompat.ACTION_PLAY)))
            }
    
            builder.addAction(NotificationCompat.Action(android.R.drawable.ic_media_next, "Suivant", MediaButtonReceiver.buildMediaButtonPendingIntent(this, PlaybackStateCompat.ACTION_SKIP_TO_NEXT)))
    
            builder.setStyle(
                MediaStyle()
                    .setMediaSession(mediaSessionCompat.sessionToken)
                    .setShowActionsInCompactView(0, 1, 2)
                    .setShowCancelButton(true)
                    .setCancelButtonIntent(MediaButtonReceiver.buildMediaButtonPendingIntent(this, PlaybackStateCompat.ACTION_STOP))
            )
    
            metadata.artworkData?.let { bytes ->
                try {
                    val bitmap = BitmapFactory.decodeByteArray(bytes, 0, bytes.size)
                    builder.setLargeIcon(bitmap)
                } catch (e: Exception) { e.printStackTrace() }
            }
    
            return builder.build()
        }
    
        private fun createNotificationChannel() {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val channel = NotificationChannel(CHANNEL_ID, "Lecteur Musique", NotificationManager.IMPORTANCE_LOW).apply {
                    description = "ContrÃ´les du lecteur"
                    setShowBadge(false)
                    setSound(null, null)
                }
                getSystemService(NotificationManager::class.java)?.createNotificationChannel(channel)
            }
        }
    
        override fun onGetSession(controllerInfo: MediaSession.ControllerInfo): MediaSession? = mediaSession
    
        override fun onDestroy() {
            mediaSession?.run { release(); mediaSession = null }
            if (::mediaSessionCompat.isInitialized) mediaSessionCompat.release()
            super.onDestroy()
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/SessionManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.annotation.SuppressLint
    import android.content.Context
    import android.net.Uri
    import android.util.Log
    import android.webkit.CookieManager
    import android.webkit.WebResourceRequest
    import android.webkit.WebResourceResponse
    import android.webkit.WebView
    import android.webkit.WebViewClient
    import com.alananasss.kittytune.utils.Config
    import kotlinx.coroutines.MainScope
    import kotlinx.coroutines.delay
    import kotlinx.coroutines.flow.MutableStateFlow
    import kotlinx.coroutines.flow.asStateFlow
    import kotlinx.coroutines.launch
    
    @SuppressLint("StaticFieldLeak")
    object SessionManager {
        private const val TAG = "SESSION_GHOST"
        private const val REFRESH_INTERVAL = 20 * 60 * 1000L
    
        private var ghostWebView: WebView? = null
    
        // track if we actually have a valid id yet
        private val _isClientIdValid = MutableStateFlow(false)
        val isClientIdValid = _isClientIdValid.asStateFlow()
    
        fun attachGhost(webView: WebView, context: Context) {
            ghostWebView = webView
            setupWebView(webView, context)
            CookieManager.getInstance().flush()
            Log.d(TAG, "ğŸ‘» Navigateur FantÃ´me attachÃ©.")
    
            // check if we already have a good id at startup
            checkIdValidity()
    
            // start immediately
            reloadSession()
            startKeepAliveCycle()
        }
    
        private fun checkIdValidity() {
            // if id isn't the fallback one, assume it's good enough for now
            _isClientIdValid.value = Config.CLIENT_ID != Config.FALLBACK_ID
        }
    
        @SuppressLint("SetJavaScriptEnabled")
        private fun setupWebView(webView: WebView, context: Context) {
            val settings = webView.settings
            settings.javaScriptEnabled = true
            settings.domStorageEnabled = true
            settings.databaseEnabled = true
            settings.userAgentString = Config.USER_AGENT
    
            webView.webViewClient = object : WebViewClient() {
                override fun shouldInterceptRequest(view: WebView?, request: WebResourceRequest?): WebResourceResponse? {
                    val url = request?.url?.toString() ?: ""
    
                    if (url.contains("client_id=")) {
                        try {
                            val uri = Uri.parse(url)
                            val capturedId = uri.getQueryParameter("client_id")
                            if (!capturedId.isNullOrEmpty()) {
                                // if it's a new id, update it
                                if (capturedId != Config.CLIENT_ID) {
                                    Config.updateClientId(context, capturedId)
                                }
                                // signal that we're good to go
                                _isClientIdValid.value = true
                            }
                        } catch (e: Exception) {
                            e.printStackTrace()
                        }
                    }
                    return super.shouldInterceptRequest(view, request)
                }
    
                override fun onPageFinished(view: WebView?, url: String?) {
                    harvestCookie(url, context)
                }
            }
        }
    
        private fun harvestCookie(url: String?, context: Context) {
            val cookieManager = CookieManager.getInstance()
            val cookies = cookieManager.getCookie(url)
    
            if (cookies != null && cookies.contains("oauth_token")) {
                val newToken = extractValue(cookies, "oauth_token")
                if (!newToken.isNullOrEmpty()) {
                    val tokenManager = TokenManager(context)
                    val currentToken = tokenManager.getAccessToken()
    
                    if (newToken != currentToken) {
                        Log.d(TAG, "âš¡ SUPER-REFRESH: Nouveau token capturÃ© !")
                        tokenManager.saveTokens(newToken, "ghost_refresh")
                    }
                    cookieManager.flush()
                }
            }
        }
    
        private fun startKeepAliveCycle() {
            MainScope().launch {
                while (true) {
                    delay(REFRESH_INTERVAL)
                    reloadSession()
                }
            }
        }
    
        fun reloadSession() {
            Log.d(TAG, "ğŸ”„ Refresh Session / Scraping ID...")
            ghostWebView?.loadUrl("https://m.soundcloud.com/discover")
        }
    
        private fun extractValue(cookies: String, key: String): String? {
            return cookies.split(";")
                .map { it.trim() }
                .find { it.startsWith("$key=") }
                ?.substringAfter("$key=")
                ?.replace("\"", "")
                ?.trim()
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/data/TokenManager.kt
================================================================================
    package com.alananasss.kittytune.data
    
    import android.content.Context
    import android.content.SharedPreferences
    
    class TokenManager(context: Context) {
        private val prefs: SharedPreferences = context.getSharedPreferences("soundtune_auth", Context.MODE_PRIVATE)
    
        companion object {
            private const val KEY_ACCESS_TOKEN = "access_token"
            private const val KEY_REFRESH_TOKEN = "refresh_token"
            private const val KEY_TOKEN_TIMESTAMP = "token_timestamp"
            private const val KEY_IS_GUEST_MODE = "is_guest_mode"
            // consider token stale after 30 mins
            private const val TOKEN_VALIDITY_MS = 30 * 60 * 1000L
        }
    
        fun saveTokens(accessToken: String, refreshToken: String) {
            prefs.edit()
                .putString(KEY_ACCESS_TOKEN, accessToken)
                .putString(KEY_REFRESH_TOKEN, refreshToken)
                .putLong(KEY_TOKEN_TIMESTAMP, System.currentTimeMillis())
                .putBoolean(KEY_IS_GUEST_MODE, false) // not a guest anymore if we have tokens
                .apply()
        }
    
        fun setGuestMode(isGuest: Boolean) {
            prefs.edit()
                .putBoolean(KEY_IS_GUEST_MODE, isGuest)
                .apply()
        }
    
        fun isGuestMode(): Boolean = prefs.getBoolean(KEY_IS_GUEST_MODE, false)
    
        fun getAccessToken(): String? = prefs.getString(KEY_ACCESS_TOKEN, null)
        fun getRefreshToken(): String? = prefs.getString(KEY_REFRESH_TOKEN, null)
    
        fun isTokenExpired(): Boolean {
            val timestamp = prefs.getLong(KEY_TOKEN_TIMESTAMP, 0)
            val now = System.currentTimeMillis()
            // check if timestamp is missing or too old
            return timestamp == 0L || (now - timestamp) > TOKEN_VALIDITY_MS
        }
    
        fun clearTokens() {
            prefs.edit().clear().apply()
        }
    
        fun logout() {
            // clean slate
            prefs.edit()
                .remove(KEY_ACCESS_TOKEN)
                .remove(KEY_REFRESH_TOKEN)
                .remove(KEY_TOKEN_TIMESTAMP)
                .putBoolean(KEY_IS_GUEST_MODE, false) // reset guest flag to force a choice/login again
                .apply()
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/domain/Models.kt
================================================================================
    package com.alananasss.kittytune.domain
    
    import com.alananasss.kittytune.data.network.LongIdAdapter
    import com.google.gson.annotations.JsonAdapter
    import com.google.gson.annotations.SerializedName
    
    // track details stuff
    data class LikerCollection(val collection: List<User>, val next_href: String?)
    data class ReposterCollection(val collection: List<User>, val next_href: String?)
    data class InPlaylistCollection(val collection: List<Playlist>, val next_href: String?)
    
    // advanced home models (charts & stream)
    data class ChartsResponse(
        val collection: List<ChartItem>,
        val next_href: String?
    )
    
    data class ChartItem(
        val track: Track?,
        val score: Double?
    )
    
    data class StreamResponse(
        val collection: List<StreamItem>,
        val next_href: String?
    )
    
    data class StreamItem(
        val type: String, // "track", "track-repost", "playlist", "playlist-repost"
        val track: Track?,
        val playlist: Playlist?,
        val user: User?, // who posted or reposted this
        @SerializedName("created_at") val createdAt: String?
    )
    
    // comments section
    data class CommentCollection(
        val collection: List<Comment>,
        val next_href: String?
    )
    
    data class Comment(
        val id: Long,
        val body: String,
        @SerializedName("created_at") val createdAt: String,
        @SerializedName("timestamp") val trackTimestamp: Long?,
        val user: User?,
    
        @SerializedName("likes_count", alternate = ["like_count", "favoritings_count", "reposts_count"])
        val likesCount: Int = 0,
    
        @SerializedName("user_favorite") val isLiked: Boolean = false
    )
    
    data class PostCommentRequest(
        val comment: CommentBody
    )
    data class CommentBody(
        val body: String,
        val timestamp: Long // current position in ms
    )
    
    // the main track model
    data class Track(
        val id: Long,
        val title: String?,
        @SerializedName("artwork_url") val artworkUrl: String?,
        @SerializedName("duration") val durationMs: Long?,
        val user: User?,
        val media: Media? = null,
        @SerializedName("user_favorite") val isLiked: Boolean = false,
        @SerializedName("genre") val genre: String? = null,
        @SerializedName("permalink_url") val permalinkUrl: String? = null,
    
        @SerializedName("description") val description: String? = null,
        @SerializedName("tag_list") val tagList: String? = null,
        @SerializedName("created_at") val createdAt: String? = null,
        @SerializedName("release_date") val releaseDate: String? = null,
        @SerializedName("playback_count") val playbackCount: Int = 0,
        @SerializedName("likes_count") val likesCount: Int = 0,
        @SerializedName("reposts_count") val repostsCount: Int = 0,
        @SerializedName("comment_count") val commentCount: Int = 0
    ) {
        val fullResArtwork: String
            get() {
                // try to get better quality art
                if (artworkUrl != null) return artworkUrl.replace("large", "t500x500")
                if (user != null && user.avatarUrl != null) return user.avatarUrl.replace("large", "t500x500")
                return "https://picsum.photos/200"
            }
    }
    
    // other random models
    data class TrackLikesResponse(val collection: List<TrackLikeItem>, val next_href: String?)
    data class TrackLikeItem(val track: Track)
    data class PlaylistLikesResponse(val collection: List<PlaylistLikeItem>, val next_href: String?)
    data class PlaylistLikeItem(val playlist: Playlist, @SerializedName("created_at") val likedAt: String?)
    data class UserPlaylistsResponse(val collection: List<Playlist>, val next_href: String?)
    data class UserCollection(val collection: List<User>, val next_href: String?)
    data class BasicTrackCollection(val collection: List<Track>, val next_href: String?)
    data class RepostCollection(val collection: List<RepostItem>, val next_href: String?)
    data class RepostItem(val type: String, @SerializedName("created_at") val createdAt: String?, val track: Track?, val playlist: Playlist?)
    data class UpdateProfileRequest(val username: String?, val description: String?, val city: String?, @SerializedName("country_code") val countryCode: String?, @SerializedName("first_name") val firstName: String? = null, @SerializedName("last_name") val lastName: String? = null)
    
    data class Playlist(@JsonAdapter(LongIdAdapter::class) val id: Long, val title: String?, @SerializedName("artwork_url") val artworkUrl: String?, @SerializedName("calculated_artwork_url") val calculatedArtworkUrl: String?, @SerializedName("track_count") val trackCount: Int?, val user: User?, val tracks: List<Track>? = null, @SerializedName("is_album") val isAlbum: Boolean = false, @SerializedName("permalink_url") val permalinkUrl: String? = null, @SerializedName("created_at") val createdAt: String? = null, @SerializedName("last_modified") val lastModified: String? = null) {
        // logic to find best available cover art
        val fullResArtwork: String get() { if (!artworkUrl.isNullOrEmpty()) return artworkUrl.replace("large", "t500x500"); if (!calculatedArtworkUrl.isNullOrEmpty()) return calculatedArtworkUrl.replace("large", "t500x500"); if (!tracks.isNullOrEmpty()) { val firstTrackArt = tracks[0].fullResArtwork; if (!firstTrackArt.contains("picsum")) return firstTrackArt }; return user?.avatarUrl?.replace("large", "t500x500") ?: "https://picsum.photos/200" }
    }
    
    data class User(val id: Long, val username: String?, @SerializedName("avatar_url") val avatarUrl: String?, val city: String? = null, @SerializedName("country_code") val countryCode: String? = null, @SerializedName("followers_count") val followersCount: Int = 0, @SerializedName("followings_count") val followingsCount: Int = 0, @SerializedName("track_count") val trackCount: Int = 0, @SerializedName("description") val description: String? = null, @SerializedName("permalink_url") val permalinkUrl: String? = null, val visuals: Visuals? = null, @SerializedName("public_favorites_count") private val _publicFavoritesCount: Int? = 0, @SerializedName("likes_count") private val _likesCount: Int? = 0, @SerializedName("favorites_count") private val _favoritesCount: Int? = 0) {
        // api returns different field names for likes sometimes
        val likesCount: Int get() = when { (_publicFavoritesCount ?: 0) > 0 -> _publicFavoritesCount!!; (_likesCount ?: 0) > 0 -> _likesCount!!; (_favoritesCount ?: 0) > 0 -> _favoritesCount!!; else -> 0 }
        val bannerUrl: String? get() = visuals?.visuals?.firstOrNull()?.visualUrl
    }
    
    data class Visuals(val visuals: List<VisualItem>?)
    data class VisualItem(@SerializedName("visual_url") val visualUrl: String)
    data class Media(val transcodings: List<Transcoding>?)
    data class Transcoding(val url: String, val preset: String, val format: Format?)
    data class Format(val protocol: String?, @SerializedName("mime_type") val mimeType: String?)
    data class StreamUrlResponse(val url: String?)

================================================================================
FICHIER : ./java/com/alananasss/kittytune/MainActivity.kt
================================================================================
    package com.alananasss.kittytune
    
    import android.Manifest
    import android.content.Context
    import android.content.SharedPreferences
    import android.os.Build
    import android.os.Bundle
    import androidx.activity.ComponentActivity
    import com.alananasss.kittytune.data.AchievementManager
    import androidx.activity.SystemBarStyle
    import androidx.activity.compose.setContent
    import androidx.activity.enableEdgeToEdge
    import androidx.activity.result.contract.ActivityResultContracts
    import androidx.compose.foundation.layout.fillMaxSize
    import androidx.compose.material3.MaterialTheme
    import androidx.compose.material3.Surface
    import androidx.compose.runtime.*
    import androidx.compose.ui.Modifier
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.HistoryRepository
    import com.alananasss.kittytune.data.LikeRepository
    import com.alananasss.kittytune.data.local.AppThemeMode
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.ui.MainScreen
    import com.alananasss.kittytune.ui.theme.SoundTuneTheme
    import com.alananasss.kittytune.utils.Config
    import com.alananasss.kittytune.utils.LocaleUtils
    
    class MainActivity : ComponentActivity() {
    
        // --- setup language ---
        // called before onCreate, this is where we force the locale
        override fun attachBaseContext(newBase: Context) {
            super.attachBaseContext(LocaleUtils.updateBaseContextLocale(newBase))
        }
    
        private val requestPermissionLauncher = registerForActivityResult(
            ActivityResultContracts.RequestPermission()
        ) { isGranted: Boolean -> }
    
        // listen for pref changes to update theme instantly
        private val prefsListener = SharedPreferences.OnSharedPreferenceChangeListener { _, key ->
            if (key == "dynamic_theme_enabled" || key == "app_theme_mode" || key == "pure_black_enabled") {
                refreshThemeState()
            }
        }
    
        private lateinit var preferences: PlayerPreferences
        private lateinit var sharedPrefs: SharedPreferences
    
        // observable states to trigger theme recomposition
        private var themeModeState by mutableStateOf(AppThemeMode.SYSTEM)
        private var dynamicColorState by mutableStateOf(true)
        private var pureBlackState by mutableStateOf(false)
    
        override fun onCreate(savedInstanceState: Bundle?) {
            super.onCreate(savedInstanceState)
    
            enableEdgeToEdge(
                statusBarStyle = SystemBarStyle.auto(android.graphics.Color.TRANSPARENT, android.graphics.Color.TRANSPARENT),
                navigationBarStyle = SystemBarStyle.auto(android.graphics.Color.TRANSPARENT, android.graphics.Color.TRANSPARENT)
            )
    
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                window.isStatusBarContrastEnforced = false
                window.isNavigationBarContrastEnforced = false
            }
    
            // --- init stuff ---
            Config.init(applicationContext)
            LikeRepository.init(applicationContext)
            DownloadManager.init(applicationContext)
            HistoryRepository.init(applicationContext)
            AchievementManager.init(applicationContext)
    
            // init prefs and listener
            preferences = PlayerPreferences(applicationContext)
            sharedPrefs = applicationContext.getSharedPreferences("player_state", Context.MODE_PRIVATE)
            sharedPrefs.registerOnSharedPreferenceChangeListener(prefsListener)
    
            // load initial state
            refreshThemeState()
    
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                requestPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
            }
    
            setContent {
                // pass states to the theme
                SoundTuneTheme(
                    themeMode = themeModeState,
                    dynamicColor = dynamicColorState,
                    pureBlack = pureBlackState
                ) {
                    Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {
                        MainScreen()
                    }
                }
            }
        }
    
        private fun refreshThemeState() {
            themeModeState = preferences.getThemeMode()
            dynamicColorState = preferences.getDynamicTheme()
            pureBlackState = preferences.getPureBlack()
        }
    
        override fun onDestroy() {
            sharedPrefs.unregisterOnSharedPreferenceChangeListener(prefsListener)
            super.onDestroy()
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/common/AchievementNotificationManager.kt
================================================================================
    package com.alananasss.kittytune.ui.common
    
    import kotlinx.coroutines.flow.MutableSharedFlow
    import kotlinx.coroutines.flow.asSharedFlow
    
    data class AchievementNotification(
        val title: String,
        val subtitle: String,
        val iconEmoji: String?,
        val xpReward: Int? = null
    )
    
    object AchievementNotificationManager {
        private val _notifications = MutableSharedFlow<AchievementNotification>(replay = 0)
        val notifications = _notifications.asSharedFlow()
    
        suspend fun showNotification(notification: AchievementNotification) {
            _notifications.emit(notification)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/common/AchievementPopup.kt
================================================================================
    package com.alananasss.kittytune.ui.common
    
    import androidx.compose.foundation.Canvas
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.material3.Card
    import androidx.compose.material3.CardDefaults
    import androidx.compose.material3.MaterialTheme
    import androidx.compose.material3.Text
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.drawscope.Stroke
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import com.alananasss.kittytune.R
    
    @Composable
    fun AchievementPopup(notification: AchievementNotification) {
        Card(
            shape = CircleShape,
            colors = CardDefaults.cardColors(containerColor = Color(0xFF2E2E2E).copy(alpha = 0.9f)),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Row(
                modifier = Modifier.padding(horizontal = 12.dp, vertical = 8.dp).height(48.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Box(contentAlignment = Alignment.Center, modifier = Modifier.size(36.dp)) {
                    val circleColor = Color(0xFF50C878)
                    Canvas(modifier = Modifier.fillMaxSize()) {
                        drawArc(
                            color = circleColor,
                            startAngle = -90f,
                            sweepAngle = 360f,
                            useCenter = false,
                            style = Stroke(width = 6f)
                        )
                    }
                    if(notification.iconEmoji != null) {
                        Text(text = notification.iconEmoji, fontSize = 16.sp)
                    }
                }
    
                Spacer(Modifier.width(12.dp))
    
                Column(modifier = Modifier.padding(end = 12.dp)) {
                    Text(
                        text = notification.title,
                        color = Color.White,
                        style = MaterialTheme.typography.labelMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        if (notification.xpReward != null) {
                            Text(
                                text = stringResource(id = R.string.achievement_xp, notification.xpReward),
                                color = Color(0xFFD4AF37),
                                style = MaterialTheme.typography.bodySmall,
                                fontWeight = FontWeight.Bold
                            )
                            Text(
                                text = " - ",
                                color = Color.White.copy(alpha = 0.7f),
                                style = MaterialTheme.typography.bodySmall
                            )
                        }
                        Text(
                            text = notification.subtitle,
                            color = Color.White.copy(alpha = 0.9f),
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/common/Shimmer.kt
================================================================================
    package com.alananasss.kittytune.ui.common
    
    import androidx.compose.animation.core.animateFloat
    import androidx.compose.animation.core.infiniteRepeatable
    import androidx.compose.animation.core.rememberInfiniteTransition
    import androidx.compose.animation.core.tween
    import androidx.compose.foundation.background
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material3.MaterialTheme
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.composed
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.geometry.Offset
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.unit.dp
    
    // the magic gradient that moves across the screen
    @Composable
    private fun ShimmerBrush(targetValue: Float = 1000f): Brush {
        val shimmerColors = listOf(
            MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.6f),
            MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.2f),
            MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.6f)
        )
    
        val transition = rememberInfiniteTransition(label = "shimmer")
        val translateAnimation = transition.animateFloat(
            initialValue = 0f,
            targetValue = targetValue,
            animationSpec = infiniteRepeatable(
                animation = tween(durationMillis = 1000)
            ), label = "shimmer_translate"
        )
    
        return Brush.linearGradient(
            colors = shimmerColors,
            start = Offset.Zero,
            end = Offset(x = translateAnimation.value, y = translateAnimation.value)
        )
    }
    
    // easy extension to slap the shimmer on any composable
    fun Modifier.shimmerBackground(shape: androidx.compose.ui.graphics.Shape): Modifier = composed {
        this
            .background(ShimmerBrush(), shape)
            .clip(shape)
    }
    
    // --- basic building blocks ---
    
    // just looks like a line of text
    @Composable
    fun ShimmerLine(modifier: Modifier = Modifier) {
        Box(
            modifier = modifier
                .height(16.dp)
                .shimmerBackground(RoundedCornerShape(8.dp))
        )
    }
    
    // generic box placeholder
    @Composable
    fun ShimmerBox(modifier: Modifier = Modifier) {
        Box(
            modifier = modifier.shimmerBackground(RoundedCornerShape(12.dp))
        )
    }
    
    
    // --- specific skeletons ---
    
    // pretend this is a song row in a list
    @Composable
    fun TrackListItemShimmer(modifier: Modifier = Modifier) {
        Row(
            modifier = modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 8.dp)
                .height(72.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            ShimmerBox(
                modifier = Modifier
                    .size(56.dp)
                    .clip(RoundedCornerShape(8.dp))
            )
            Spacer(Modifier.width(16.dp))
            Column(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                ShimmerLine(modifier = Modifier.fillMaxWidth(0.7f))
                ShimmerLine(modifier = Modifier.fillMaxWidth(0.4f))
            }
        }
    }
    
    // square card placeholder (playlists/albums)
    @Composable
    fun SquareCardShimmer(modifier: Modifier = Modifier) {
        Column(modifier = modifier.width(140.dp)) {
            ShimmerBox(
                modifier = Modifier
                    .size(140.dp)
                    .clip(RoundedCornerShape(12.dp))
            )
            Spacer(Modifier.height(8.dp))
            ShimmerLine(modifier = Modifier.fillMaxWidth(0.8f).height(14.dp))
            Spacer(Modifier.height(4.dp))
            ShimmerLine(modifier = Modifier.fillMaxWidth(0.5f).height(12.dp))
        }
    }
    
    // round placeholder for artist profiles
    @Composable
    fun ArtistCircleShimmer(modifier: Modifier = Modifier) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            modifier = modifier.width(120.dp)
        ) {
            ShimmerBox(
                modifier = Modifier
                    .size(120.dp)
                    .clip(CircleShape)
            )
            Spacer(Modifier.height(8.dp))
            ShimmerLine(modifier = Modifier.fillMaxWidth(0.7f))
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/common/UltimateCompletionOverlay.kt
================================================================================
    package com.alananasss.kittytune.ui.common
    
    import androidx.compose.animation.AnimatedVisibility
    import androidx.compose.animation.core.*
    import androidx.compose.animation.fadeIn
    import androidx.compose.animation.fadeOut
    import androidx.compose.foundation.Canvas
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.interaction.MutableInteractionSource
    import androidx.compose.foundation.layout.*
    import androidx.compose.material3.MaterialTheme
    import androidx.compose.material3.Text
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.scale
    import androidx.compose.ui.geometry.Offset
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.drawscope.Stroke
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import com.alananasss.kittytune.R
    import kotlinx.coroutines.delay
    import kotlin.math.cos
    import kotlin.math.sin
    
    @Composable
    fun UltimateCompletionOverlay(onDismiss: () -> Unit) {
        var phase by remember { mutableStateOf(0) } // 0: animation, 1: thank you message
    
        // timer to switch to phase 2 after animation
        LaunchedEffect(Unit) {
            delay(8000) // let it run for 8 seconds
            phase = 1
        }
    
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(Color.Black.copy(alpha = 0.98f))
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) { onDismiss() },
            contentAlignment = Alignment.Center
        ) {
            // --- PHASE 1: ANIMATION ---
            AnimatedVisibility(visible = phase == 0, enter = fadeIn(), exit = fadeOut()) {
                Box(contentAlignment = Alignment.Center) {
                    // light rays
                    val infiniteTransition = rememberInfiniteTransition(label = "rays")
                    val rotation by infiniteTransition.animateFloat(
                        initialValue = 0f,
                        targetValue = 360f,
                        animationSpec = infiniteRepeatable(tween(20000, easing = LinearEasing)),
                        label = "rotation"
                    )
    
                    Canvas(modifier = Modifier.fillMaxSize()) {
                        val center = this.center
                        val gradient = Brush.sweepGradient(
                            colors = listOf(Color(0xFFD4AF37), Color(0xFFFFD700), Color(0xFFD4AF37), Color.Transparent),
                            center = center
                        )
    
                        for (i in 0 until 12) {
                            val angle = rotation + (i * 30f)
                            val endX = center.x + (size.width * 1.5f * cos(Math.toRadians(angle.toDouble()))).toFloat()
                            val endY = center.y + (size.height * 1.5f * sin(Math.toRadians(angle.toDouble()))).toFloat()
    
                            drawLine(
                                brush = gradient,
                                start = center,
                                end = Offset(endX, endY),
                                strokeWidth = 100f,
                                alpha = 0.08f
                            )
                        }
                    }
    
                    // golden record
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Box(contentAlignment = Alignment.Center) {
                            val scale by infiniteTransition.animateFloat(
                                initialValue = 1f, targetValue = 1.05f,
                                animationSpec = infiniteRepeatable(tween(2000, easing = EaseInOut), RepeatMode.Reverse),
                                label = "scale"
                            )
    
                            Canvas(modifier = Modifier.size(200.dp).scale(scale)) {
                                drawCircle(Brush.radialGradient(listOf(Color(0xFFFFE599), Color(0xFFB8860B))))
                                drawCircle(Color.Black, radius = size.width * 0.1f)
                                drawCircle(Color.Black.copy(0.3f), style = Stroke(2f), radius = size.width * 0.3f)
                                drawCircle(Color.Black.copy(0.3f), style = Stroke(2f), radius = size.width * 0.4f)
                            }
                        }
    
                        Spacer(Modifier.height(32.dp))
    
                        Text(
                            stringResource(R.string.completion_legend),
                            color = Color(0xFFFFD700),
                            fontSize = 40.sp,
                            fontWeight = FontWeight.Black,
                            letterSpacing = 4.sp
                        )
                        Text(
                            stringResource(R.string.completion_message),
                            color = Color.White.copy(0.8f),
                            style = MaterialTheme.typography.titleMedium
                        )
                    }
                }
            }
    
            // --- PHASE 2: THANKS ---
            AnimatedVisibility(visible = phase == 1, enter = fadeIn(animationSpec = tween(1000))) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    modifier = Modifier.padding(32.dp)
                ) {
                    Text(
                        stringResource(R.string.completion_thanks),
                        color = Color(0xFFFFD700),
                        style = MaterialTheme.typography.displayMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Spacer(Modifier.height(24.dp))
                    Text(
                        stringResource(R.string.completion_thanks_message),
                        color = Color.White.copy(0.8f),
                        style = MaterialTheme.typography.bodyLarge,
                        textAlign = TextAlign.Center,
                        lineHeight = 24.sp
                    )
                    Spacer(Modifier.height(48.dp))
                    Text(
                        stringResource(R.string.completion_continue),
                        color = Color.White.copy(0.5f),
                        style = MaterialTheme.typography.labelSmall
                    )
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/home/HomeScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.home
    
    import androidx.activity.compose.BackHandler
    import androidx.compose.animation.*
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.LazyRow
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.text.KeyboardActions
    import androidx.compose.foundation.text.KeyboardOptions
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.focus.FocusRequester
    import androidx.compose.ui.focus.focusRequester
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalFocusManager
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.input.ImeAction
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.local.HistoryItem
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.ui.common.ArtistCircleShimmer
    import com.alananasss.kittytune.ui.common.ShimmerBox
    import com.alananasss.kittytune.ui.common.ShimmerLine
    import com.alananasss.kittytune.ui.common.SquareCardShimmer
    import com.alananasss.kittytune.ui.library.DynamicPlaylistCard
    import com.alananasss.kittytune.ui.library.TrackListItem
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import com.alananasss.kittytune.ui.profile.ArtistAvatar
    import com.alananasss.kittytune.ui.profile.SquareCard
    import java.io.File
    
    @OptIn(ExperimentalMaterial3Api::class, ExperimentalLayoutApi::class)
    @Composable
    fun HomeScreen(
        playerViewModel: PlayerViewModel,
        homeViewModel: HomeViewModel,
        onNavigate: (String) -> Unit
    ) {
        val history by homeViewModel.historyFlow.collectAsState(initial = emptyList())
        val userProfile = homeViewModel.userProfile
        val focusManager = LocalFocusManager.current
    
        val isKeyboardOpen = WindowInsets.isImeVisible
    
        BackHandler(enabled = homeViewModel.isSearching) {
            if (isKeyboardOpen) {
                focusManager.clearFocus()
            } else {
                homeViewModel.clearSearch()
                focusManager.clearFocus()
            }
        }
    
        Scaffold(
            topBar = {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(MaterialTheme.colorScheme.background)
                        .statusBarsPadding()
                        .padding(bottom = 8.dp)
                ) {
                    HomeSearchBar(
                        query = homeViewModel.searchQuery,
                        onQueryChange = homeViewModel::onSearchQueryChanged,
                        isSearching = homeViewModel.isSearching,
                        onSearchFocus = { homeViewModel.activateSearch() },
                        onBackClick = {
                            homeViewModel.clearSearch()
                            focusManager.clearFocus()
                        },
                        avatarUrl = userProfile?.avatarUrl,
                        onProfileClick = {
                            if (userProfile != null) {
                                onNavigate("my_profile_menu")
                            } else {
                                onNavigate("login_required")
                            }
                        }
                    )
    
                    AnimatedVisibility(visible = homeViewModel.isSearching) {
                        SearchFilters(
                            activeFilter = homeViewModel.activeFilter,
                            onFilterSelected = homeViewModel::onFilterChanged
                        )
                    }
                }
            },
            containerColor = MaterialTheme.colorScheme.background
        ) { innerPadding ->
    
            Box(modifier = Modifier.padding(innerPadding).fillMaxSize()) {
                if (homeViewModel.isSearching) {
                    if (homeViewModel.isSearchLoading) {
                        Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                            CircularProgressIndicator()
                        }
                    } else {
                        SearchResultsList(
                            homeViewModel = homeViewModel,
                            playerViewModel = playerViewModel,
                            onNavigate = onNavigate
                        )
                    }
                } else if (homeViewModel.homeSections.isEmpty()) {
                    HomeScreenShimmer()
                } else {
                    HomeContent(
                        homeViewModel = homeViewModel,
                        playerViewModel = playerViewModel,
                        history = history,
                        onNavigate = onNavigate
                    )
                }
            }
        }
    }
    
    @Composable
    fun HomeContent(
        homeViewModel: HomeViewModel,
        playerViewModel: PlayerViewModel,
        history: List<HistoryItem>,
        onNavigate: (String) -> Unit
    ) {
        LazyColumn(contentPadding = PaddingValues(bottom = 120.dp), modifier = Modifier.fillMaxSize()) {
    
            if (history.isNotEmpty()) {
                item {
                    SectionHeader(stringResource(R.string.home_recently_played))
                    LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                        items(history) { item ->
                            HistoryCard(item) {
                                when {
                                    item.id == "likes" -> onNavigate("likes")
                                    item.id == "downloads" -> onNavigate("downloads")
                                    item.type == "STATION" -> onNavigate(item.id)
                                    item.type == "PROFILE" -> onNavigate(item.id)
                                    item.type == "PLAYLIST" -> onNavigate(item.id.replace("playlist:", ""))
                                    item.type == "TRACK" -> {
                                        val trackToPlay = Track(
                                            id = item.numericId,
                                            title = item.title,
                                            artworkUrl = item.imageUrl,
                                            durationMs = 0L,
                                            user = User(0L, item.subtitle, null)
                                        )
                                        playerViewModel.playPlaylist(listOf(trackToPlay), 0)
                                    }
                                }
                            }
                        }
                    }
                    Spacer(Modifier.height(32.dp))
                }
            }
    
            items(homeViewModel.homeSections) { section ->
                SectionHeader(section.title, section.subtitle)
                LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                    when (section.type) {
                        SectionType.STATIONS_ROW -> {
                            val playlists = section.content.filterIsInstance<Playlist>()
                            items(playlists) { playlist ->
                                val isRealStation = playlist.title?.startsWith("Station:") == true
                                val navId = if (isRealStation) "station:${playlist.id}" else playlist.id.toString()
                                StationCard(playlist) { onNavigate(navId) }
                            }
                        }
                        SectionType.TRACKS_ROW -> {
                            val tracks = section.content.filterIsInstance<Track>()
                            items(tracks) { track ->
                                TrackCardBig(track) { playerViewModel.playPlaylist(listOf(track), 0, null) }
                            }
                        }
                        SectionType.ARTISTS_ROW -> {
                            val artists = section.content.filterIsInstance<User>()
                            items(artists) { artist ->
                                ArtistCircle(artist) { onNavigate("profile:${artist.id}") }
                            }
                        }
                    }
                }
                Spacer(Modifier.height(40.dp))
            }
        }
    }
    
    @Composable
    fun StationCard(playlist: Playlist, onClick: () -> Unit) {
        val isRadio = playlist.title?.startsWith("Station:") == true
        val displayTitle = if (isRadio) playlist.title?.removePrefix("Station: ") ?: stringResource(R.string.radio) else playlist.title ?: stringResource(R.string.app_name)
        val subtitle = if(isRadio) stringResource(R.string.home_section_similar, playlist.user?.username ?: "?") else playlist.user?.username ?: stringResource(R.string.lib_playlists)
    
        Column(modifier = Modifier.width(160.dp).clickable { onClick() }) {
            Box {
                AsyncImage(
                    model = playlist.fullResArtwork, contentDescription = null, contentScale = ContentScale.Crop,
                    modifier = Modifier.size(160.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant)
                )
                Box(modifier = Modifier.align(Alignment.BottomStart).padding(8.dp).background(Color.Black.copy(alpha = 0.7f), RoundedCornerShape(4.dp)).padding(4.dp)) {
                    Icon(if (isRadio) Icons.Default.Radio else Icons.Default.QueueMusic, null, tint = Color.White, modifier = Modifier.size(16.dp))
                }
            }
            Spacer(Modifier.height(8.dp))
            Text(text = displayTitle, style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold), maxLines = 1, overflow = TextOverflow.Ellipsis)
            Text(text = subtitle, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1)
        }
    }
    
    @Composable
    fun SectionHeader(title: String, subtitle: String? = null) {
        Column(modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp)) {
            Text(text = title, style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold))
            if (subtitle != null) {
                Text(text = subtitle, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis)
            }
        }
    }
    
    @Composable
    fun HistoryCard(item: HistoryItem, onClick: () -> Unit) {
        val imageShape = if (item.type == "PROFILE") CircleShape else RoundedCornerShape(12.dp)
    
        Column(modifier = Modifier.width(140.dp).clickable { onClick() }) {
            Box {
                AsyncImage(
                    model = item.imageUrl,
                    contentDescription = null,
                    contentScale = ContentScale.Crop,
                    modifier = Modifier
                        .size(140.dp)
                        .clip(imageShape)
                        .background(MaterialTheme.colorScheme.surfaceVariant)
                )
                if (item.type == "STATION" || item.type == "PLAYLIST") {
                    Box(modifier = Modifier.align(Alignment.BottomStart).padding(8.dp).background(Color.Black.copy(alpha = 0.6f), RoundedCornerShape(4.dp)).padding(4.dp)) {
                        Icon(if(item.type=="STATION") Icons.Default.Radio else Icons.Filled.PlayArrow, null, tint = Color.White, modifier = Modifier.size(16.dp))
                    }
                }
            }
            Spacer(Modifier.height(8.dp))
            Text(text = item.title, style = MaterialTheme.typography.titleMedium, maxLines = 1, overflow = TextOverflow.Ellipsis)
            Text(text = item.subtitle, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis)
        }
    }
    
    @Composable
    fun TrackCardBig(track: Track, onClick: () -> Unit) {
        Column(modifier = Modifier.width(160.dp).clickable { onClick() }) {
            Box(contentAlignment = Alignment.Center) {
                AsyncImage(
                    model = track.fullResArtwork, contentDescription = null, contentScale = ContentScale.Crop,
                    modifier = Modifier.size(160.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant)
                )
            }
            Spacer(Modifier.height(8.dp))
            Text(text = track.title ?: stringResource(R.string.untitled_track), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold), maxLines = 1, overflow = TextOverflow.Ellipsis)
            Text(text = track.user?.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis)
        }
    }
    
    @Composable
    fun ArtistCircle(user: User, onClick: () -> Unit) {
        Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.width(120.dp).clickable { onClick() }) {
            ArtistAvatar(
                avatarUrl = user.avatarUrl,
                modifier = Modifier
                    .size(120.dp)
                    .clip(CircleShape)
            )
            Spacer(Modifier.height(8.dp))
            Text(text = user.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold), maxLines = 1, overflow = TextOverflow.Ellipsis, textAlign = TextAlign.Center)
        }
    }
    
    @Composable
    fun HomeSearchBar(
        query: String,
        onQueryChange: (String) -> Unit,
        isSearching: Boolean,
        onSearchFocus: () -> Unit,
        onBackClick: () -> Unit,
        avatarUrl: String?,
        onProfileClick: () -> Unit
    ) {
        val focusRequester = remember { FocusRequester() }
        val focusManager = LocalFocusManager.current
    
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 8.dp)
                .height(56.dp)
                .clip(RoundedCornerShape(28.dp))
                .background(MaterialTheme.colorScheme.surfaceContainerHigh)
                .padding(horizontal = 4.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            if (isSearching) {
                IconButton(onClick = onBackClick) {
                    Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_close), tint = MaterialTheme.colorScheme.onSurface)
                }
            } else {
                IconButton(onClick = {
                    onSearchFocus()
                    focusRequester.requestFocus()
                }) {
                    Icon(Icons.Default.Search, stringResource(R.string.search_hint), tint = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
    
            TextField(
                value = query,
                onValueChange = {
                    if (!isSearching) onSearchFocus()
                    onQueryChange(it)
                },
                placeholder = { Text(stringResource(R.string.search_hint), maxLines = 1, overflow = TextOverflow.Ellipsis) },
                colors = TextFieldDefaults.colors(
                    focusedContainerColor = Color.Transparent,
                    unfocusedContainerColor = Color.Transparent,
                    focusedIndicatorColor = Color.Transparent,
                    unfocusedIndicatorColor = Color.Transparent,
                    cursorColor = MaterialTheme.colorScheme.primary
                ),
                singleLine = true,
                modifier = Modifier
                    .weight(1f)
                    .focusRequester(focusRequester),
                keyboardOptions = KeyboardOptions(imeAction = ImeAction.Search),
                keyboardActions = KeyboardActions(onSearch = { focusManager.clearFocus() })
            )
    
            if (query.isNotEmpty()) {
                IconButton(onClick = { onQueryChange("") }) {
                    Icon(Icons.Default.Close, stringResource(R.string.btn_close), tint = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            } else {
                IconButton(onClick = onProfileClick) {
                    if (avatarUrl != null) {
                        ArtistAvatar(
                            avatarUrl = avatarUrl,
                            modifier = Modifier
                                .size(32.dp)
                                .clip(CircleShape)
                        )
                    } else {
                        Icon(
                            Icons.Default.AccountCircle,
                            contentDescription = stringResource(R.string.guest_user),
                            tint = MaterialTheme.colorScheme.onSurfaceVariant,
                            modifier = Modifier.size(32.dp)
                        )
                    }
                }
            }
        }
    }
    
    @Composable
    fun SearchFilters(
        activeFilter: SearchFilter,
        onFilterSelected: (SearchFilter) -> Unit
    ) {
        LazyRow(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 8.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically,
            contentPadding = PaddingValues(horizontal = 16.dp)
        ) {
            items(SearchFilter.entries) { filter ->
                val label = when(filter) {
                    SearchFilter.ALL -> stringResource(R.string.all_filters)
                    SearchFilter.TRACKS -> stringResource(R.string.profile_tracks)
                    SearchFilter.ARTISTS -> stringResource(R.string.lib_artists)
                    SearchFilter.PLAYLISTS -> stringResource(R.string.lib_playlists)
                }
                FilterChip(
                    selected = activeFilter == filter,
                    onClick = { onFilterSelected(filter) },
                    label = { Text(label, maxLines = 1) },
                    shape = RoundedCornerShape(20.dp),
                    colors = FilterChipDefaults.filterChipColors(
                        selectedContainerColor = MaterialTheme.colorScheme.primaryContainer,
                        selectedLabelColor = MaterialTheme.colorScheme.onPrimaryContainer
                    ),
                    border = null
                )
            }
        }
    }
    
    @Composable
    fun SearchResultsList(
        homeViewModel: HomeViewModel,
        playerViewModel: PlayerViewModel,
        onNavigate: (String) -> Unit
    ) {
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
    
        LazyColumn(
            contentPadding = PaddingValues(bottom = 120.dp),
            modifier = Modifier.fillMaxSize()
        ) {
            if (homeViewModel.searchResultsArtists.isNotEmpty()) {
                if (homeViewModel.activeFilter == SearchFilter.ALL) {
                    item { Text(stringResource(R.string.lib_artists), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold), modifier = Modifier.padding(16.dp)) }
                }
    
                if (homeViewModel.activeFilter == SearchFilter.ARTISTS) {
                    items(homeViewModel.searchResultsArtists) { artist ->
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .clickable { onNavigate("profile:${artist.id}") }
                                .padding(16.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            ArtistAvatar(
                                avatarUrl = artist.avatarUrl,
                                modifier = Modifier
                                    .size(56.dp)
                                    .clip(CircleShape)
                            )
                            Spacer(Modifier.width(16.dp))
                            Column {
                                Text(artist.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.bodyLarge, fontWeight = FontWeight.SemiBold)
                                Text(stringResource(R.string.profile_followers, artist.followersCount), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
                            }
                        }
                    }
                } else {
                    item {
                        LazyRow(
                            contentPadding = PaddingValues(horizontal = 16.dp),
                            horizontalArrangement = Arrangement.spacedBy(16.dp)
                        ) {
                            items(homeViewModel.searchResultsArtists) { artist ->
                                ArtistCircle(artist) { onNavigate("profile:${artist.id}") }
                            }
                        }
                    }
                }
            }
    
            if (homeViewModel.searchResultsTracks.isNotEmpty()) {
                if (homeViewModel.activeFilter == SearchFilter.ALL) {
                    item { Text(stringResource(R.string.profile_tracks), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold), modifier = Modifier.padding(start = 16.dp, top = 24.dp, bottom = 8.dp)) }
                }
                itemsIndexed(homeViewModel.searchResultsTracks) { index, track ->
                    TrackListItem(
                        track = track,
                        currentlyPlayingTrack = playerViewModel.currentTrack,
                        index = index,
                        isDownloading = downloadProgress[track.id] != null,
                        isDownloaded = File(LocalContext.current.filesDir, "track_${track.id}.mp3").exists(),
                        downloadProgress = downloadProgress[track.id] ?: 0,
                        onClick = { playerViewModel.playPlaylist(homeViewModel.searchResultsTracks, index) },
                        onOptionClick = { playerViewModel.showTrackOptions(track) }
                    )
                }
            }
    
            if (homeViewModel.searchResultsPlaylists.isNotEmpty()) {
                if (homeViewModel.activeFilter == SearchFilter.ALL) {
                    item { Text(stringResource(R.string.lib_playlists), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold), modifier = Modifier.padding(start = 16.dp, top = 24.dp, bottom = 8.dp)) }
                }
    
                if (homeViewModel.activeFilter == SearchFilter.PLAYLISTS) {
                    items(homeViewModel.searchResultsPlaylists) { playlist ->
                        DynamicPlaylistCard(playlist, isGrid = false) { onNavigate(playlist.id.toString()) }
                    }
                } else {
                    item {
                        LazyRow(
                            contentPadding = PaddingValues(horizontal = 16.dp),
                            horizontalArrangement = Arrangement.spacedBy(16.dp)
                        ) {
                            items(homeViewModel.searchResultsPlaylists) { playlist ->
                                SquareCard(playlist) { onNavigate(playlist.id.toString()) }
                            }
                        }
                    }
                }
            }
    
            if (homeViewModel.searchResultsTracks.isEmpty() && homeViewModel.searchResultsArtists.isEmpty() && homeViewModel.searchResultsPlaylists.isEmpty()) {
                item {
                    Box(modifier = Modifier.fillParentMaxSize(), contentAlignment = Alignment.Center) {
                        Text(stringResource(R.string.no_results), color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
            }
        }
    }
    
    @Composable
    fun HomeScreenShimmer() {
        LazyColumn(
            modifier = Modifier.fillMaxSize(),
            userScrollEnabled = false
        ) {
            item {
                Spacer(modifier = Modifier.height(28.dp))
                ShimmerLine(modifier = Modifier.padding(horizontal = 16.dp).width(200.dp).height(24.dp))
                Spacer(modifier = Modifier.height(16.dp))
                LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp), userScrollEnabled = false) { items(5) { SquareCardShimmer() } }
                Spacer(Modifier.height(32.dp))
            }
            item {
                ShimmerLine(modifier = Modifier.padding(horizontal = 16.dp).width(250.dp).height(24.dp))
                Spacer(modifier = Modifier.height(16.dp))
                LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp), userScrollEnabled = false) { items(5) { SquareCardShimmer() } }
                Spacer(Modifier.height(40.dp))
            }
            item {
                ShimmerLine(modifier = Modifier.padding(horizontal = 16.dp).width(180.dp).height(24.dp))
                Spacer(modifier = Modifier.height(16.dp))
                LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp), userScrollEnabled = false) { items(5) { ArtistCircleShimmer() } }
                Spacer(Modifier.height(40.dp))
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/home/HomeViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.home
    
    import android.app.Application
    import android.content.Context
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateListOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.HistoryRepository
    import com.alananasss.kittytune.data.LikeRepository
    import com.alananasss.kittytune.data.TokenManager
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.google.gson.Gson
    import com.google.gson.reflect.TypeToken
    import kotlinx.coroutines.Job
    import kotlinx.coroutines.async
    import kotlinx.coroutines.coroutineScope
    import kotlinx.coroutines.delay
    import kotlinx.coroutines.flow.first
    import kotlinx.coroutines.launch
    
    // ui models
    data class HomeSection(
        val title: String,
        val subtitle: String? = null,
        val content: List<Any>,
        val type: SectionType
    )
    
    enum class SectionType {
        TRACKS_ROW, ARTISTS_ROW, STATIONS_ROW
    }
    
    // cache stuff
    data class HomeCacheData(
        val user: User?,
        val sections: List<HomeSectionCache>
    )
    
    data class HomeSectionCache(
        val title: String,
        val subtitle: String?,
        val type: SectionType,
        val tracks: List<Track> = emptyList(),
        val playlists: List<Playlist> = emptyList(),
        val users: List<User> = emptyList()
    )
    
    // search modes
    enum class SearchFilter {
        ALL, TRACKS, ARTISTS, PLAYLISTS
    }
    
    class HomeViewModel(application: Application) : AndroidViewModel(application) {
        private val api = RetrofitClient.create(application)
        private val prefs = application.getSharedPreferences("home_cache", Context.MODE_PRIVATE)
        private val gson = Gson()
        private val tokenManager = TokenManager(application)
    
        // helper to get strings easily
        private fun getString(resId: Int): String = getApplication<Application>().getString(resId)
        private fun getString(resId: Int, vararg args: Any): String = getApplication<Application>().getString(resId, *args)
    
        var userProfile by mutableStateOf<User?>(null)
    
        // main home data
        val homeSections = mutableStateListOf<HomeSection>()
        val historyFlow = HistoryRepository.getHistory()
    
        // --- search state ---
        var isSearching by mutableStateOf(false)
        var searchQuery by mutableStateOf("")
        var activeFilter by mutableStateOf(SearchFilter.ALL)
        var isSearchLoading by mutableStateOf(false)
    
        // search results
        val searchResultsTracks = mutableStateListOf<Track>()
        val searchResultsArtists = mutableStateListOf<User>()
        val searchResultsPlaylists = mutableStateListOf<Playlist>()
    
        private var searchJob: Job? = null
    
        init {
            loadFromCache()
            loadData()
        }
    
        // --- search logic ---
        fun onSearchQueryChanged(query: String) {
            searchQuery = query
            if (query.isBlank()) { clearSearchResults(); return }
            searchJob?.cancel()
            // debounce logic
            searchJob = viewModelScope.launch { delay(500); performSearch(query) }
        }
        fun activateSearch() { isSearching = true }
        fun clearSearch() { searchQuery = ""; isSearching = false; clearSearchResults() }
        fun onFilterChanged(filter: SearchFilter) { activeFilter = filter; if (searchQuery.isNotBlank()) { searchJob?.cancel(); searchJob = viewModelScope.launch { performSearch(searchQuery) } } }
        private fun clearSearchResults() { searchResultsTracks.clear(); searchResultsArtists.clear(); searchResultsPlaylists.clear() }
    
        private suspend fun performSearch(query: String) {
            isSearchLoading = true; clearSearchResults()
            try {
                coroutineScope {
                    when (activeFilter) {
                        SearchFilter.ALL -> {
                            // parallel requests for all types
                            val tracksDef = async { try { api.searchTracks(query, limit = 5).collection } catch (e: Exception) { emptyList() } }
                            val usersDef = async { try { api.searchUsers(query, limit = 5).collection } catch (e: Exception) { emptyList() } }
                            val playlistsDef = async { try { api.searchPlaylists(query, limit = 5).collection } catch (e: Exception) { emptyList() } }
                            searchResultsTracks.addAll(tracksDef.await())
                            searchResultsArtists.addAll(usersDef.await())
                            searchResultsPlaylists.addAll(playlistsDef.await())
                        }
                        SearchFilter.TRACKS -> searchResultsTracks.addAll(api.searchTracks(query, limit = 30).collection)
                        SearchFilter.ARTISTS -> searchResultsArtists.addAll(api.searchUsers(query, limit = 30).collection)
                        SearchFilter.PLAYLISTS -> searchResultsPlaylists.addAll(api.searchPlaylists(query, limit = 30).collection)
                    }
                }
            } catch (e: Exception) { e.printStackTrace() } finally { isSearchLoading = false }
        }
    
        // --- cache handling ---
        private fun loadFromCache() {
            try {
                val json = prefs.getString("cached_home_data", null)
                if (json != null) {
                    val data: HomeCacheData = gson.fromJson(json, object : TypeToken<HomeCacheData>() {}.type)
                    userProfile = data.user
                    if (data.sections.isNotEmpty()) {
                        homeSections.clear()
                        // rebuild section objects from cache
                        data.sections.forEach { section ->
                            val content: List<Any> = when (section.type) {
                                SectionType.TRACKS_ROW -> section.tracks
                                SectionType.STATIONS_ROW -> section.playlists
                                SectionType.ARTISTS_ROW -> section.users
                            }
                            if (content.isNotEmpty()) homeSections.add(HomeSection(section.title, section.subtitle, content, section.type))
                        }
                    }
                }
            } catch (e: Exception) { e.printStackTrace() }
        }
    
        private fun saveToCache() {
            viewModelScope.launch {
                try {
                    // flatten everything for gson
                    val sectionsCache = homeSections.map { section -> HomeSectionCache(section.title, section.subtitle, section.type, section.content.filterIsInstance<Track>(), section.content.filterIsInstance<Playlist>(), section.content.filterIsInstance<User>()) }
                    val data = HomeCacheData(userProfile, sectionsCache)
                    prefs.edit().putString("cached_home_data", gson.toJson(data)).apply()
                } catch (e: Exception) { e.printStackTrace() }
            }
        }
    
        // --- loading stuff ---
        fun loadData() {
            viewModelScope.launch {
                val token = tokenManager.getAccessToken()
                // check if we are logged in or just a guest
                if (token.isNullOrEmpty()) loadGuestData() else loadAuthenticatedData()
            }
        }
    
        // --- smart recommendations based on history ---
        private suspend fun fetchHistoryBasedSection(): HomeSection? {
            return try {
                val history = HistoryRepository.getHistory().first()
                val recentTracks = history.filter { it.type == "TRACK" }.take(10)
                if (recentTracks.isEmpty()) return null
    
                // pick a random recent track and find similar stuff
                val seedItem = recentTracks.random()
                val related = api.getRelatedTracks(seedItem.numericId, limit = 15).collection
    
                if (related.isNotEmpty()) {
                    HomeSection(
                        title = getString(R.string.home_section_similar, seedItem.title),
                        subtitle = getString(R.string.home_section_similar_sub),
                        content = related,
                        type = SectionType.TRACKS_ROW
                    )
                } else null
            } catch (e: Exception) { null }
        }
    
        private suspend fun fetchPersonalizedSections(sourceTracks: List<Track>, username: String): List<HomeSection> {
            val sections = mutableListOf<HomeSection>()
            if (sourceTracks.isEmpty()) return sections
    
            try {
                coroutineScope {
                    // fake radio stations
                    val stationSeeds = sourceTracks.shuffled().take(6)
                    val stationItems = stationSeeds.map { track -> Playlist(track.id, "Station: ${track.title}", track.fullResArtwork, null, 0, track.user, null) }
                    if (stationItems.isNotEmpty()) sections.add(HomeSection(getString(R.string.home_section_similar, username), null, stationItems, SectionType.STATIONS_ROW))
    
                    // more tracks you might like
                    val seed1 = sourceTracks.take(10).randomOrNull() ?: sourceTracks.first()
                    val relatedDef1 = async { try { api.getRelatedTracks(seed1.id, limit = 15).collection } catch (e: Exception) { emptyList() } }
    
                    // discovery artists
                    val newCrewDef = async {
                        val artists = sourceTracks.mapNotNull { it.user }.distinctBy { it.id }.shuffled().take(8)
                        val similarArtists = try {
                            val randomLike = sourceTracks.shuffled().first()
                            api.getRelatedTracks(randomLike.id, limit=10).collection.mapNotNull { it.user }
                        } catch(e:Exception) { emptyList() }
                        (artists + similarArtists).distinctBy { it.id }.shuffled().take(10)
                    }
    
                    val related1 = relatedDef1.await()
                    if (related1.isNotEmpty()) sections.add(HomeSection(getString(R.string.home_section_similar, seed1.title ?: ""), getString(R.string.home_section_similar_sub), related1, SectionType.TRACKS_ROW))
    
                    val newCrew = newCrewDef.await()
                    if (newCrew.isNotEmpty()) sections.add(HomeSection(getString(R.string.home_section_new_crew), getString(R.string.home_section_new_crew_sub), newCrew, SectionType.ARTISTS_ROW))
                }
            } catch (e: Exception) { e.printStackTrace() }
            return sections
        }
    
        private suspend fun loadGuestData() {
            try {
                userProfile = null
                val localLikes = LikeRepository.likedTracks.value
                val allSections = mutableListOf<HomeSection>()
    
                coroutineScope {
                    val genericSectionsDef = async { fetchGenericGuestSections() }
                    val personalSectionsDef = async {
                        // if they liked stuff locally, we can still personalize
                        if (localLikes.isNotEmpty()) fetchPersonalizedSections(localLikes, getString(R.string.guest_user)) else emptyList()
                    }
                    val historySectionDef = async { fetchHistoryBasedSection() }
    
                    val genericSections = genericSectionsDef.await()
                    val personalSections = personalSectionsDef.await()
                    val historySection = historySectionDef.await()
    
                    if (historySection != null) allSections.add(historySection)
                    allSections.addAll(personalSections)
                    allSections.addAll(genericSections)
                }
    
                if (allSections.isNotEmpty()) {
                    homeSections.clear(); homeSections.addAll(allSections); saveToCache()
                } else {
                    // retry if failed first time
                    delay(2000)
                    if (homeSections.isEmpty()) loadGuestData()
                }
            } catch (e: Exception) { e.printStackTrace() }
        }
    
        private suspend fun fetchGenericGuestSections(): List<HomeSection> {
            val sections = mutableListOf<HomeSection>()
            try {
                // standard soundcloud charts
                coroutineScope {
                    val trendingDef = async { try { api.getCharts(kind = "trending", genre = "soundcloud:genres:all-music").collection.mapNotNull { it.track } } catch(e:Exception){ emptyList() } }
                    val globalChartsDef = async { try { api.searchPlaylists("Billboard Hot 100", limit = 10).collection } catch(e:Exception){ emptyList() } }
                    val hiphopDef = async { try { api.getCharts(kind = "trending", genre = "soundcloud:genres:hiphoprap").collection.mapNotNull { it.track } } catch(e:Exception){ emptyList() } }
                    val electroDef = async { try { api.searchPlaylists("Electro House 2025", limit = 10).collection } catch(e:Exception){ emptyList() } }
                    val artistsDef = async { try { val l1 = api.searchUsers("Billboard", limit = 5).collection; val l2 = api.searchUsers("Official Music", limit = 5).collection; (l1+l2).distinctBy{it.id}.shuffled() } catch(e:Exception){ emptyList() } }
                    val popDef = async { try { api.getCharts(kind = "trending", genre = "soundcloud:genres:pop").collection.mapNotNull { it.track } } catch(e:Exception){ emptyList() } }
    
                    val trending = trendingDef.await()
                    if (trending.isNotEmpty()) sections.add(HomeSection(getString(R.string.home_trending), null, trending, SectionType.TRACKS_ROW))
                    val globalCharts = globalChartsDef.await()
                    if (globalCharts.isNotEmpty()) sections.add(HomeSection(getString(R.string.home_charts), null, globalCharts, SectionType.STATIONS_ROW))
                    val hiphop = hiphopDef.await()
                    if (hiphop.isNotEmpty()) sections.add(HomeSection("Hip-Hop & Rap US", null, hiphop, SectionType.TRACKS_ROW))
                    val techno = electroDef.await()
                    if (techno.isNotEmpty()) sections.add(HomeSection("Electro House", null, techno, SectionType.STATIONS_ROW))
                    val artists = artistsDef.await()
                    if (artists.isNotEmpty()) sections.add(HomeSection(getString(R.string.lib_artists), null, artists, SectionType.ARTISTS_ROW))
                    val pop = popDef.await()
                    if (pop.isNotEmpty()) sections.add(HomeSection("Pop", null, pop, SectionType.TRACKS_ROW))
                }
            } catch (e: Exception) { e.printStackTrace() }
            return sections
        }
    
        private suspend fun loadAuthenticatedData() {
            try {
                val me = api.getMe()
                userProfile = me
                val allSections = mutableListOf<HomeSection>()
    
                coroutineScope {
                    // get the user stream (feed)
                    val streamDef = async {
                        try {
                            api.getMyStream(limit = 20).collection
                                .filter { it.type == "track" || it.type == "track-repost" }
                                .mapNotNull { it.track }
                                .distinctBy { it.id }
                        } catch (e: Exception) { emptyList() }
                    }
    
                    // get likes from api or local if plenty
                    val localLikes = LikeRepository.likedTracks.value
                    val sourceLikes = if (localLikes.size > 20) localLikes else {
                        try { api.getUserTrackLikes(me.id, limit = 50).collection.map { it.track } } catch(e:Exception) { emptyList() }
                    }
    
                    val historySectionDef = async { fetchHistoryBasedSection() }
    
                    val streamTracks = streamDef.await()
                    if (streamTracks.isNotEmpty()) {
                        allSections.add(HomeSection("Stream", null, streamTracks, SectionType.TRACKS_ROW))
                    }
    
                    val historySection = historySectionDef.await()
                    if (historySection != null) allSections.add(historySection)
    
                    if (sourceLikes.isNotEmpty()) {
                        val personalSections = fetchPersonalizedSections(sourceLikes, me.username ?: "User")
                        allSections.addAll(personalSections)
                    }
                }
    
                if (allSections.isNotEmpty()) {
                    homeSections.clear()
                    homeSections.addAll(allSections)
                    saveToCache()
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/home/TagScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.home
    
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material3.*
    import androidx.compose.runtime.Composable
    import androidx.compose.runtime.LaunchedEffect
    import androidx.compose.runtime.collectAsState
    import androidx.compose.runtime.getValue
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.ui.library.TrackListItem
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import java.io.File
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun TagScreen(
        tagName: String,
        onBackClick: () -> Unit,
        playerViewModel: PlayerViewModel,
        tagViewModel: TagViewModel = viewModel()
    ) {
        val context = LocalContext.current
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
    
        LaunchedEffect(tagName) {
            tagViewModel.loadTag(tagName)
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = {
                        Text(
                            "#${tagName.uppercase()}",
                            style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                        )
                    },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_close))
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = MaterialTheme.colorScheme.surface
                    )
                )
            }
        ) { innerPadding ->
            Box(modifier = Modifier.padding(innerPadding).fillMaxSize()) {
                when (tagViewModel.uiState) {
                    "LOADING" -> {
                        CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))
                    }
                    "EMPTY" -> {
                        Text(stringResource(R.string.no_results), modifier = Modifier.align(Alignment.Center))
                    }
                    "ERROR" -> {
                        Text(stringResource(R.string.error_generic), modifier = Modifier.align(Alignment.Center))
                    }
                    "SUCCESS" -> {
                        LazyColumn(
                            contentPadding = PaddingValues(bottom = 120.dp)
                        ) {
                            itemsIndexed(tagViewModel.tracks) { index, track ->
                                if (index >= tagViewModel.tracks.size - 3) {
                                    LaunchedEffect(Unit) {
                                        tagViewModel.loadMore()
                                    }
                                }
    
                                val progress = downloadProgress[track.id]
                                val isDownloaded = File(context.filesDir, "track_${track.id}.mp3").exists()
    
                                TrackListItem(
                                    track = track,
                                    currentlyPlayingTrack = playerViewModel.currentTrack,
                                    index = index,
                                    isDownloading = progress != null,
                                    isDownloaded = isDownloaded,
                                    downloadProgress = progress ?: 0,
                                    onClick = {
                                        playerViewModel.playPlaylist(tagViewModel.tracks.toList(), index, context = null)
                                    },
                                    onOptionClick = { playerViewModel.showTrackOptions(track) }
                                )
                            }
    
                            item {
                                Spacer(Modifier.height(16.dp))
                            }
                        }
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/home/TagViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.home
    
    import android.app.Application
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateListOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.Track
    import kotlinx.coroutines.launch
    
    class TagViewModel(application: Application) : AndroidViewModel(application) {
        private val api = RetrofitClient.create(application)
    
        val tracks = mutableStateListOf<Track>()
        var uiState by mutableStateOf("LOADING")
    
        private var nextHref: String? = null
        private var isLoadingMore = false
        private var currentTagName: String = ""
    
        fun loadTag(tagName: String) {
            currentTagName = tagName
            refreshData()
        }
    
        private fun refreshData() {
            if (currentTagName.isBlank()) return
    
            uiState = "LOADING"
            tracks.clear()
            nextHref = null
    
            viewModelScope.launch {
                try {
                    val cleanTag = currentTagName.replace("#", "").trim()
    
                    // simple call: force "recent" sort to get new stuff
                    val result = api.searchTracksStrict(
                        query = cleanTag,
                        tag = cleanTag,
                        sort = "recent"
                    )
    
                    nextHref = result.next_href
    
                    val verifiedTracks = filterTracksByTag(result.collection, cleanTag)
                    tracks.addAll(verifiedTracks)
    
                    uiState = if (tracks.isEmpty()) "EMPTY" else "SUCCESS"
                } catch (e: Exception) {
                    e.printStackTrace()
                    uiState = "ERROR"
                }
            }
        }
    
        fun loadMore() {
            if (isLoadingMore || nextHref == null) return
    
            isLoadingMore = true
            val cleanTag = currentTagName.replace("#", "").trim()
    
            viewModelScope.launch {
                try {
                    val result = api.getSearchTracksNextPage(nextHref!!)
                    nextHref = result.next_href
    
                    val verifiedTracks = filterTracksByTag(result.collection, cleanTag)
                    tracks.addAll(verifiedTracks)
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    isLoadingMore = false
                }
            }
        }
    
        private fun filterTracksByTag(rawTracks: List<Track>, tag: String): List<Track> {
            return rawTracks.filter { track ->
                val rawTags = track.tagList ?: ""
                val genre = track.genre ?: ""
                // double check that the track actually matches the tag
                rawTags.contains(tag, ignoreCase = true) ||
                        genre.contains(tag, ignoreCase = true)
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/library/LibraryScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.library
    
    import android.content.Context
    import android.net.ConnectivityManager
    import android.net.Network
    import android.net.NetworkCapabilities
    import android.net.NetworkRequest
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.grid.GridCells
    import androidx.compose.foundation.lazy.grid.GridItemSpan
    import androidx.compose.foundation.lazy.grid.LazyGridState
    import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
    import androidx.compose.foundation.lazy.grid.items
    import androidx.compose.foundation.lazy.grid.rememberLazyGridState
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.filled.GridView
    import androidx.compose.material.icons.filled.SdStorage
    import androidx.compose.material.icons.filled.Search
    import androidx.compose.material.icons.filled.ViewList
    import androidx.compose.material.icons.outlined.ExitToApp
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.Lifecycle
    import androidx.lifecycle.LifecycleEventObserver
    import androidx.lifecycle.compose.LocalLifecycleOwner
    import androidx.lifecycle.viewmodel.compose.viewModel
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.TokenManager
    import com.alananasss.kittytune.data.local.LocalArtist
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.ui.common.SquareCardShimmer
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import com.alananasss.kittytune.ui.profile.ArtistAvatar
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LibraryScreen(
        onLoginClick: () -> Unit,
        onPlaylistClick: (String) -> Unit,
        onLikedTracksClick: () -> Unit,
        onLogoutClick: () -> Unit,
        playerViewModel: PlayerViewModel,
        libraryViewModel: LibraryViewModel = viewModel()
    ) {
        val context = LocalContext.current
        val lifecycleOwner = LocalLifecycleOwner.current
    
        val listState = rememberLazyGridState()
        // collapse fab text when scrolling
        val fabExpanded by remember {
            derivedStateOf {
                listState.firstVisibleItemIndex == 0
            }
        }
    
        // keep an eye on network status
        DisposableEffect(context) {
            val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
            val networkCallback = object : ConnectivityManager.NetworkCallback() {
                override fun onAvailable(network: Network) {
                    if (libraryViewModel.isOfflineMode || libraryViewModel.userProfile?.id == 0L) {
                        libraryViewModel.loadData(forceRefresh = true)
                    }
                }
                override fun onLost(network: Network) {
                    libraryViewModel.isOfflineMode = true
                }
            }
            val request = NetworkRequest.Builder().addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET).build()
            try { connectivityManager.registerNetworkCallback(request, networkCallback) } catch (e: Exception) { e.printStackTrace() }
            onDispose { try { connectivityManager.unregisterNetworkCallback(networkCallback) } catch (e: Exception) {} }
        }
    
        LaunchedEffect(Unit) {
            libraryViewModel.loadData()
        }
    
        // refresh when coming back to the screen
        DisposableEffect(lifecycleOwner) {
            val observer = LifecycleEventObserver { _, event ->
                if (event == Lifecycle.Event.ON_RESUME) {
                    libraryViewModel.loadData(forceRefresh = false)
                }
            }
            lifecycleOwner.lifecycle.addObserver(observer)
            onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }
        }
    
        var showCreateDialog by remember { mutableStateOf(false) }
        var newPlaylistName by remember { mutableStateOf("") }
        var showLogoutDialog by remember { mutableStateOf(false) }
    
        if (showCreateDialog) {
            AlertDialog(
                onDismissRequest = { showCreateDialog = false },
                title = { Text(stringResource(R.string.lib_create_playlist_title)) },
                text = {
                    OutlinedTextField(
                        value = newPlaylistName,
                        onValueChange = { newPlaylistName = it },
                        label = { Text(stringResource(R.string.lib_create_playlist_hint)) },
                        singleLine = true
                    )
                },
                confirmButton = {
                    TextButton(onClick = {
                        if (newPlaylistName.isNotBlank()) {
                            val id = DownloadManager.createUserPlaylist(newPlaylistName)
                            showCreateDialog = false
                            newPlaylistName = ""
                            onPlaylistClick("local_playlist:$id")
                        }
                    }) { Text(stringResource(R.string.btn_create)) }
                },
                dismissButton = { TextButton(onClick = { showCreateDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showLogoutDialog) {
            AlertDialog(
                onDismissRequest = { showLogoutDialog = false },
                title = { Text(stringResource(R.string.dialog_logout_title)) },
                text = { Text(stringResource(R.string.dialog_logout_msg)) },
                confirmButton = {
                    TextButton(onClick = {
                        showLogoutDialog = false
                        val tokenManager = TokenManager(context)
                        tokenManager.logout()
                        onLogoutClick()
                    }) { Text(stringResource(R.string.profile_menu_logout), color = MaterialTheme.colorScheme.error) }
                },
                dismissButton = { TextButton(onClick = { showLogoutDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        val showLogin = libraryViewModel.userProfile == null && !libraryViewModel.isLoading && !libraryViewModel.isOfflineMode
        val isGuest = libraryViewModel.isGuestUser
    
        // if not logged in and not a guest, block access
        if (showLogin && !isGuest) {
            Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Column(horizontalAlignment = Alignment.CenterHorizontally) {
                    Text(stringResource(R.string.welcome_title), style = MaterialTheme.typography.titleLarge)
                    Spacer(Modifier.height(16.dp))
                    Button(onClick = onLoginClick) { Text(stringResource(R.string.login_soundcloud)) }
                }
            }
            return
        }
    
        Scaffold(
            topBar = {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(MaterialTheme.colorScheme.background)
                        .statusBarsPadding()
                        .padding(top = 16.dp, bottom = 8.dp)
                ) {
                    // offline banner
                    if (libraryViewModel.isOfflineMode) {
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(horizontal = 16.dp, vertical = 8.dp)
                                .clip(RoundedCornerShape(8.dp))
                                .background(MaterialTheme.colorScheme.errorContainer)
                                .padding(8.dp),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.Center
                        ) {
                            Icon(Icons.Rounded.WifiOff, null, tint = MaterialTheme.colorScheme.onErrorContainer, modifier = Modifier.size(16.dp))
                            Spacer(modifier = Modifier.width(8.dp))
                            Text(stringResource(R.string.lib_offline_mode), style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.onErrorContainer)
                        }
                    }
    
                    // guest banner
                    if (isGuest && !libraryViewModel.isOfflineMode) {
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(horizontal = 16.dp, vertical = 8.dp)
                                .clip(RoundedCornerShape(8.dp))
                                .background(MaterialTheme.colorScheme.primaryContainer)
                                .clickable { onLoginClick() }
                                .padding(8.dp),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.Center
                        ) {
                            Icon(Icons.Rounded.Person, null, tint = MaterialTheme.colorScheme.onPrimaryContainer, modifier = Modifier.size(16.dp))
                            Spacer(modifier = Modifier.width(8.dp))
                            Text(stringResource(R.string.lib_guest_mode), style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.onPrimaryContainer)
                        }
                    }
    
                    SearchBarHeader(
                        query = libraryViewModel.searchQuery,
                        onQueryChange = { libraryViewModel.searchQuery = it },
                        avatarUrl = libraryViewModel.userProfile?.avatarUrl,
                        onLogoutClick = { showLogoutDialog = true },
                        isGuest = isGuest
                    )
    
                    FilterChipsRow(libraryViewModel)
                }
            },
            floatingActionButton = {
                // bump up fab so miniplayer doesn't cover it
                val miniPlayerHeight = if (playerViewModel.currentTrack != null) 64.dp else 0.dp
    
                ExtendedFloatingActionButton(
                    onClick = { showCreateDialog = true },
                    icon = { Icon(Icons.Rounded.Add, stringResource(R.string.lib_create_playlist_title)) },
                    text = { Text(stringResource(R.string.lib_create_playlist_title)) },
                    expanded = fabExpanded,
                    containerColor = MaterialTheme.colorScheme.primaryContainer,
                    contentColor = MaterialTheme.colorScheme.onPrimaryContainer,
                    modifier = Modifier.padding(bottom = miniPlayerHeight)
                )
            }
        ) { innerPadding ->
            Column(modifier = Modifier.padding(innerPadding)) {
                SortAndLayoutControls(libraryViewModel)
    
                if (libraryViewModel.isLoading && libraryViewModel.displayedItems.isEmpty()) {
                    LibraryShimmerGrid(isGridLayout = libraryViewModel.isGridLayout)
                } else {
                    LibraryContentGrid(
                        listState = listState,
                        viewModel = libraryViewModel,
                        onLikedTracksClick = onLikedTracksClick,
                        onPlaylistClick = onPlaylistClick,
                        onArtistClick = { artistId -> onPlaylistClick("profile:$artistId") },
                        isGuest = isGuest
                    )
                }
            }
        }
    }
    
    @Composable
    fun LibraryContentGrid(
        listState: LazyGridState,
        viewModel: LibraryViewModel,
        onLikedTracksClick: () -> Unit,
        onPlaylistClick: (String) -> Unit,
        onArtistClick: (Long) -> Unit,
        isGuest: Boolean
    ) {
        val columns = if (viewModel.isGridLayout) GridCells.Fixed(2) else GridCells.Fixed(1)
        val isSyncing by viewModel.isSyncing.collectAsState()
    
        // grab strings here before using them in logic
        val playlistsFilter = stringResource(R.string.lib_playlists)
        val shouldShowPlaylists = viewModel.selectedFilter == null || viewModel.selectedFilter == playlistsFilter
    
        LazyVerticalGrid(
            state = listState,
            columns = columns,
            contentPadding = PaddingValues(start = 16.dp, end = 16.dp, bottom = 100.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            if (shouldShowPlaylists) {
                item(span = { GridItemSpan(1) }) {
                    val subtitle = if (isGuest) stringResource(R.string.lib_liked_subtitle_local)
                    else if(isSyncing) stringResource(R.string.lib_liked_subtitle_syncing)
                    else stringResource(R.string.lib_liked_subtitle)
                    StaticLibraryCard(
                        title = stringResource(R.string.lib_liked_tracks),
                        subtitle = subtitle,
                        icon = Icons.Rounded.Favorite,
                        isGrid = viewModel.isGridLayout,
                        onClick = onLikedTracksClick,
                        isLoading = isSyncing
                    )
                }
    
                item(span = { GridItemSpan(1) }) {
                    StaticLibraryCard(
                        title = stringResource(R.string.lib_downloads),
                        subtitle = stringResource(R.string.lib_downloads_subtitle),
                        icon = Icons.Rounded.Folder,
                        isGrid = viewModel.isGridLayout,
                        onClick = { onPlaylistClick("downloads") },
                        isLoading = false
                    )
                }
    
                if (viewModel.showLocalMedia) {
                    item(span = { GridItemSpan(1) }) {
                        StaticLibraryCard(
                            title = stringResource(R.string.lib_local_media),
                            subtitle = stringResource(R.string.lib_local_media_subtitle),
                            icon = Icons.Default.SdStorage,
                            isGrid = viewModel.isGridLayout,
                            onClick = { onPlaylistClick("local_files") },
                            isLoading = false
                        )
                    }
                }
            }
    
            items(viewModel.displayedItems) { item ->
                when (item) {
                    is LibraryItem.PlaylistItem -> {
                        // local playlists have negative ids
                        val id = if(item.playlist.id < 0) "local_playlist:${item.playlist.id}" else item.playlist.id.toString()
                        DynamicPlaylistCard(
                            playlist = item.playlist,
                            isGrid = viewModel.isGridLayout,
                            onClick = { onPlaylistClick(id) }
                        )
                    }
                    is LibraryItem.ArtistItem -> {
                        ArtistLibraryCard(
                            artist = item.artist,
                            isGrid = viewModel.isGridLayout,
                            onClick = { onArtistClick(item.artist.id) }
                        )
                    }
                }
            }
        }
    }
    
    @Composable
    fun LibraryShimmerGrid(isGridLayout: Boolean) {
        val columns = if (isGridLayout) GridCells.Fixed(2) else GridCells.Fixed(1)
        LazyVerticalGrid(
            columns = columns,
            contentPadding = PaddingValues(start = 16.dp, end = 16.dp, bottom = 100.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp),
            userScrollEnabled = false
        ) {
            items(10) {
                SquareCardShimmer()
            }
        }
    }
    
    @Composable
    fun SearchBarHeader(
        query: String,
        onQueryChange: (String) -> Unit,
        avatarUrl: String?,
        onLogoutClick: () -> Unit,
        isGuest: Boolean
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp)
                .height(56.dp)
                .clip(RoundedCornerShape(28.dp))
                .background(MaterialTheme.colorScheme.surfaceContainerHigh)
                .padding(horizontal = 16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(Icons.Default.Search, stringResource(R.string.search_library_hint), tint = MaterialTheme.colorScheme.onSurfaceVariant)
            Spacer(modifier = Modifier.width(12.dp))
            Box(modifier = Modifier.weight(1f)) {
                if (query.isEmpty()) { Text(stringResource(R.string.search_library_hint), color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis) }
                androidx.compose.foundation.text.BasicTextField(
                    value = query, onValueChange = onQueryChange,
                    textStyle = MaterialTheme.typography.bodyLarge.copy(color = MaterialTheme.colorScheme.onSurface),
                    singleLine = true, modifier = Modifier.fillMaxWidth()
                )
            }
    
            Box(modifier = Modifier.clickable { onLogoutClick() }) {
                if (isGuest) {
                    Icon(Icons.Outlined.ExitToApp, stringResource(R.string.logout_guest), tint = MaterialTheme.colorScheme.onSurfaceVariant)
                } else if (avatarUrl != null) {
                    ArtistAvatar(avatarUrl = avatarUrl, modifier = Modifier.size(32.dp).clip(CircleShape))
                } else {
                    ArtistAvatar(avatarUrl = null, modifier = Modifier.size(32.dp).clip(CircleShape))
                }
            }
        }
    }
    
    @Composable
    fun FilterChipsRow(viewModel: LibraryViewModel) {
        val playlistsLabel = stringResource(R.string.lib_playlists)
        val artistsLabel = stringResource(R.string.lib_artists)
    
        // moved after stringResource calls
        val filters = remember(playlistsLabel, artistsLabel) {
            listOf(playlistsLabel, artistsLabel)
        }
    
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(top = 12.dp, start = 16.dp, end = 16.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            filters.forEach { label ->
                FilterChip(
                    selected = viewModel.selectedFilter == label,
                    onClick = { viewModel.selectedFilter = if (viewModel.selectedFilter == label) null else label },
                    label = { Text(label) },
                    colors = FilterChipDefaults.filterChipColors(
                        containerColor = MaterialTheme.colorScheme.surfaceContainer,
                        selectedContainerColor = MaterialTheme.colorScheme.primaryContainer
                    ),
                    border = null,
                    shape = RoundedCornerShape(12.dp)
                )
            }
        }
    }
    
    @Composable
    fun SortAndLayoutControls(viewModel: LibraryViewModel) {
        Row(
            modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(
                modifier = Modifier.clip(RoundedCornerShape(8.dp)).clickable { viewModel.isSortDescending = !viewModel.isSortDescending }.padding(4.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(text = stringResource(R.string.sort_date_added), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.primary)
                Spacer(modifier = Modifier.width(4.dp))
                Icon(
                    imageVector = if (viewModel.isSortDescending) Icons.Rounded.ArrowDownward else Icons.Rounded.ArrowUpward,
                    contentDescription = stringResource(R.string.sort_date_added), modifier = Modifier.size(16.dp), tint = MaterialTheme.colorScheme.primary
                )
            }
            IconButton(onClick = { viewModel.isGridLayout = !viewModel.isGridLayout }) {
                Icon(
                    imageVector = if (viewModel.isGridLayout) Icons.Default.ViewList else Icons.Default.GridView,
                    contentDescription = stringResource(R.string.btn_options), tint = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
    
    @Composable
    fun StaticLibraryCard(title: String, subtitle: String, icon: ImageVector, isGrid: Boolean, isLoading: Boolean, onClick: () -> Unit) {
        val height = if (isGrid) 160.dp else 80.dp
        Card(
            onClick = onClick, shape = RoundedCornerShape(12.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainer),
            modifier = Modifier.height(height).fillMaxWidth()
        ) {
            Box(modifier = Modifier.fillMaxSize()) {
                if (isGrid) {
                    Column(modifier = Modifier.fillMaxSize().padding(16.dp), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally) {
                        Icon(imageVector = icon, contentDescription = null, modifier = Modifier.size(48.dp), tint = MaterialTheme.colorScheme.onSurfaceVariant)
                        Spacer(modifier = Modifier.height(16.dp))
                        Text(text = title, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, maxLines = 1, overflow = TextOverflow.Ellipsis)
                        Text(text = subtitle, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                } else {
                    Row(modifier = Modifier.fillMaxSize().padding(16.dp), verticalAlignment = Alignment.CenterVertically) {
                        Box(modifier = Modifier.size(48.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceContainerHigh), contentAlignment = Alignment.Center) {
                            Icon(imageVector = icon, contentDescription = null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                        Spacer(modifier = Modifier.width(16.dp))
                        Column {
                            Text(text = title, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                            Text(text = subtitle, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
                }
                // fix applied here
                if (isLoading) {
                    Box(modifier = Modifier.align(Alignment.BottomCenter)) {
                        LinearProgressIndicator(
                            modifier = Modifier.fillMaxWidth().height(4.dp),
                            color = MaterialTheme.colorScheme.primary,
                            trackColor = Color.Transparent
                        )
                    }
                }
            }
        }
    }
    
    @Composable
    fun DynamicPlaylistCard(playlist: Playlist, isGrid: Boolean, onClick: () -> Unit) {
        val art = if(playlist.artworkUrl.isNullOrEmpty()) playlist.fullResArtwork else playlist.artworkUrl
        if (isGrid) {
            Column(modifier = Modifier.clickable(onClick = onClick).fillMaxWidth()) {
                AsyncImage(model = art, contentDescription = null, contentScale = ContentScale.Crop, modifier = Modifier.fillMaxWidth().aspectRatio(1f).clip(RoundedCornerShape(12.dp)).background(MaterialTheme.colorScheme.surfaceVariant))
                Spacer(modifier = Modifier.height(8.dp))
                Text(text = playlist.title ?: stringResource(R.string.app_name), style = MaterialTheme.typography.bodyLarge, fontWeight = FontWeight.SemiBold, maxLines = 1, overflow = TextOverflow.Ellipsis)
                Text(text = playlist.user?.username ?: stringResource(R.string.me_artist), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis)
            }
        } else {
            Row(modifier = Modifier.fillMaxWidth().height(80.dp).clip(RoundedCornerShape(12.dp)).clickable(onClick = onClick).padding(8.dp), verticalAlignment = Alignment.CenterVertically) {
                AsyncImage(model = art, contentDescription = null, contentScale = ContentScale.Crop, modifier = Modifier.size(64.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant))
                Spacer(modifier = Modifier.width(16.dp))
                Column {
                    Text(text = playlist.title ?: stringResource(R.string.app_name), style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.SemiBold, maxLines = 1)
                    Text(text = stringResource(R.string.playlist_num_tracks, playlist.trackCount ?: 0) + " â€¢ " + (playlist.user?.username ?: stringResource(R.string.me_artist)), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
        }
    }
    
    @Composable
    fun ArtistLibraryCard(artist: LocalArtist, isGrid: Boolean, onClick: () -> Unit) {
        if (isGrid) {
            Column(modifier = Modifier.clickable(onClick = onClick).fillMaxWidth(), horizontalAlignment = Alignment.CenterHorizontally) {
                ArtistAvatar(
                    avatarUrl = artist.avatarUrl,
                    modifier = Modifier
                        .fillMaxWidth()
                        .aspectRatio(1f)
                        .clip(CircleShape)
                )
                Spacer(modifier = Modifier.height(8.dp))
                Text(text = artist.username, style = MaterialTheme.typography.bodyLarge, fontWeight = FontWeight.SemiBold, maxLines = 1, overflow = TextOverflow.Ellipsis)
                Text(text = stringResource(R.string.menu_go_artist), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
        } else {
            Row(modifier = Modifier.fillMaxWidth().height(80.dp).clip(RoundedCornerShape(12.dp)).clickable(onClick = onClick).padding(8.dp), verticalAlignment = Alignment.CenterVertically) {
                ArtistAvatar(
                    avatarUrl = artist.avatarUrl,
                    modifier = Modifier
                        .size(64.dp)
                        .clip(CircleShape)
                )
                Spacer(modifier = Modifier.width(16.dp))
                Column {
                    Text(text = artist.username, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.SemiBold, maxLines = 1)
                    Text(text = stringResource(R.string.menu_go_artist) + " â€¢ " + stringResource(R.string.playlist_num_tracks, artist.trackCount), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/library/LibraryViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.library
    
    import android.app.Application
    import android.content.Context
    import android.util.Log
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateListOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.compose.runtime.snapshotFlow
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.LikeRepository
    import com.alananasss.kittytune.data.TokenManager
    import com.alananasss.kittytune.data.local.AppDatabase
    import com.alananasss.kittytune.data.local.LocalArtist
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.utils.NetworkUtils
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.async
    import kotlinx.coroutines.coroutineScope
    import kotlinx.coroutines.flow.first
    import kotlinx.coroutines.launch
    import java.text.SimpleDateFormat
    import java.util.Locale
    
    sealed class LibraryItem(open val timestamp: Long) {
        data class PlaylistItem(val playlist: Playlist, override val timestamp: Long) : LibraryItem(timestamp)
        data class ArtistItem(val artist: LocalArtist, override val timestamp: Long) : LibraryItem(timestamp)
    }
    
    class LibraryViewModel(application: Application) : AndroidViewModel(application) {
    
        private val app = application
        private val prefs = application.getSharedPreferences("library_prefs", Context.MODE_PRIVATE)
        private val tokenManager = TokenManager(application)
    
        var userProfile by mutableStateOf<User?>(null)
        val likedTracks = mutableStateListOf<Track>()
    
        private val _allItems = mutableStateListOf<LibraryItem>()
        val savedArtists = mutableStateListOf<LocalArtist>()
    
        var isLoading by mutableStateOf(false)
        var isOfflineMode by mutableStateOf(false)
        var searchQuery by mutableStateOf("")
    
        var isGuestUser by mutableStateOf(false)
    
        var showLocalMedia by mutableStateOf(false)
    
        val isSyncing = LikeRepository.isSyncing
    
        var selectedFilter by mutableStateOf<String?>(null)
        var isGridLayout by mutableStateOf(prefs.getBoolean("is_grid_layout", true))
        var isSortDescending by mutableStateOf(true)
    
        private var isHydratingLikes = false
        private val isoParser = SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'", Locale.US)
    
        val displayedItems: List<LibraryItem>
            get() {
                val playlistsLabel = app.getString(R.string.lib_playlists)
                val artistsLabel = app.getString(R.string.lib_artists)
    
                val items = _allItems.filter { item ->
                    when (item) {
                        is LibraryItem.PlaylistItem -> {
                            val matchesSearch = if (searchQuery.isBlank()) true else {
                                item.playlist.title?.contains(searchQuery, ignoreCase = true) == true ||
                                        item.playlist.user?.username?.contains(searchQuery, ignoreCase = true) == true
                            }
                            val matchesType = selectedFilter == null || selectedFilter == playlistsLabel
                            matchesSearch && matchesType
                        }
                        is LibraryItem.ArtistItem -> {
                            val matchesSearch = if (searchQuery.isBlank()) true else {
                                item.artist.username.contains(searchQuery, ignoreCase = true)
                            }
                            val matchesType = selectedFilter == null || selectedFilter == artistsLabel
                            matchesSearch && matchesType
                        }
                    }
                }
                return if (isSortDescending) items.sortedByDescending { it.timestamp } else items.sortedBy { it.timestamp }
            }
    
        private val api = RetrofitClient.create(application)
        private val db = AppDatabase.getDatabase(application).downloadDao()
    
        init {
            viewModelScope.launch {
                snapshotFlow { isGridLayout }.collect { isGrid ->
                    prefs.edit().putBoolean("is_grid_layout", isGrid).apply()
                }
            }
    
            viewModelScope.launch {
                LikeRepository.likedTracks.collect { tracksFromRepo ->
                    likedTracks.clear()
                    likedTracks.addAll(tracksFromRepo)
                }
            }
    
            viewModelScope.launch {
                db.getAllPlaylists().collect { localPlaylists ->
                    val localItems = localPlaylists.map { local ->
                        val p = Playlist(local.id, local.title, local.artworkUrl, null, local.trackCount, User(0, local.artist, null), null)
                        LibraryItem.PlaylistItem(p, local.addedAt)
                    }
                    val localIds = localPlaylists.map { it.id }.toSet()
    
                    val currentOnlineItems = _allItems.filter { item ->
                        if (item is LibraryItem.PlaylistItem) !localIds.contains(item.playlist.id) else false
                    }
                    val currentArtists = _allItems.filterIsInstance<LibraryItem.ArtistItem>()
    
                    _allItems.clear()
                    _allItems.addAll(currentOnlineItems)
                    _allItems.addAll(localItems)
                    _allItems.addAll(currentArtists)
                }
            }
    
            viewModelScope.launch {
                DownloadManager.getSavedArtists().collect { artists ->
                    val artistItems = artists.map { LibraryItem.ArtistItem(it, it.savedAt) }
                    _allItems.removeAll { it is LibraryItem.ArtistItem }
                    _allItems.addAll(artistItems)
                }
            }
        }
    
        fun loadData(forceRefresh: Boolean = false) {
            if (isLoading && !forceRefresh) return
    
            val playerPrefs = PlayerPreferences(getApplication<Application>())
            showLocalMedia = playerPrefs.getLocalMediaEnabled()
    
            isGuestUser = tokenManager.isGuestMode()
    
            if (isGuestUser) {
                userProfile = User(0, app.getString(R.string.guest_user), null)
                isOfflineMode = false
                isLoading = false
                return
            }
    
            viewModelScope.launch {
                isLoading = true
                if (NetworkUtils.isInternetAvailable(getApplication())) {
                    try {
                        isOfflineMode = false
                        val user = api.getMe()
                        userProfile = user
                        loadOnlineData(user)
                    } catch (e: Exception) {
                        Log.e("LibraryVM", "Erreur en ligne ou Non ConnectÃ©", e)
                        isLoading = false
                    }
                } else {
                    isOfflineMode = true
                    isLoading = false
                }
            }
        }
    
        private fun loadOnlineData(user: User) {
            viewModelScope.launch {
                try {
                    coroutineScope {
                        val likedPlaylistsDeferred = async { api.getUserPlaylistLikes(user.id) }
                        val createdPlaylistsDeferred = async { api.getUserCreatedPlaylists(user.id) }
    
                        val likedResponse = likedPlaylistsDeferred.await()
                        val createdResponse = createdPlaylistsDeferred.await()
    
                        val newOnlineItems = mutableListOf<LibraryItem>()
    
                        likedResponse.collection.forEach { item ->
                            val date = try { item.likedAt?.let { isoParser.parse(it)?.time } ?: 0L } catch (e: Exception) { 0L }
                            newOnlineItems.add(LibraryItem.PlaylistItem(item.playlist, date))
                        }
    
                        createdResponse.collection.forEach { playlist ->
                            val date = try {
                                val dateStr = playlist.lastModified ?: playlist.createdAt
                                dateStr?.let { isoParser.parse(it)?.time } ?: 0L
                            } catch (e: Exception) { 0L }
                            newOnlineItems.add(LibraryItem.PlaylistItem(playlist, date))
                        }
    
                        val dbPlaylists = db.getAllPlaylists().first()
                        val dbIds = dbPlaylists.map { it.id }.toSet()
    
                        val uniqueOnlineItems = newOnlineItems.filter { item ->
                            if (item is LibraryItem.PlaylistItem) !dbIds.contains(item.playlist.id) else true
                        }
    
                        _allItems.removeAll { item ->
                            if (item is LibraryItem.PlaylistItem) !dbIds.contains(item.playlist.id) else false
                        }
                        _allItems.addAll(uniqueOnlineItems)
    
                        if (!isHydratingLikes) {
                            isHydratingLikes = true
                            LikeRepository.setSyncing(true)
    
                            launch(Dispatchers.IO) {
                                try {
                                    val allCollectedLikes = mutableListOf<Track>()
                                    var nextUrl: String? = null
    
                                    val firstPage = api.getUserTrackLikes(user.id, limit = 200)
                                    allCollectedLikes.addAll(firstPage.collection.map { it.track })
                                    nextUrl = firstPage.next_href
    
                                    while (nextUrl != null) {
                                        val page = api.getTrackLikesNextPage(nextUrl!!)
                                        allCollectedLikes.addAll(page.collection.map { it.track })
                                        nextUrl = page.next_href
                                    }
    
                                    LikeRepository.replaceAllLikes(allCollectedLikes)
    
                                } catch (e: Exception) {
                                    e.printStackTrace()
                                } finally {
                                    isHydratingLikes = false
                                    isLoading = false
                                    LikeRepository.setSyncing(false)
                                }
                            }
                        } else {
                            isLoading = false
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                    isLoading = false
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/library/PlaylistDetailScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.library
    
    import android.content.Intent
    import android.view.HapticFeedbackConstants
    import androidx.activity.compose.rememberLauncherForActivityResult
    import androidx.activity.result.PickVisualMediaRequest
    import androidx.activity.result.contract.ActivityResultContracts
    import androidx.compose.animation.core.animateDpAsState
    import androidx.compose.animation.core.animateFloatAsState
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.gestures.detectDragGesturesAfterLongPress
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.grid.GridCells
    import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
    import androidx.compose.foundation.lazy.grid.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.*
    import androidx.compose.material.icons.outlined.Edit
    import androidx.compose.material.icons.outlined.FavoriteBorder
    import androidx.compose.material.icons.outlined.Image
    import androidx.compose.material.icons.outlined.Share
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.blur
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.draw.shadow
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.graphicsLayer
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.input.pointer.pointerInput
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalView
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.zIndex
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.LikeRepository
    import com.alananasss.kittytune.data.local.AppDatabase
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.ui.common.TrackListItemShimmer
    import com.alananasss.kittytune.ui.player.PlaybackContext
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import kotlinx.coroutines.delay
    import kotlinx.coroutines.flow.first
    import kotlinx.coroutines.launch
    import java.io.File
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun PlaylistDetailScreen(
        playlistId: String,
        onBackClick: () -> Unit,
        playerViewModel: PlayerViewModel
    ) {
        val context = LocalContext.current
        val view = LocalView.current
        val scope = rememberCoroutineScope()
    
        val tracks = remember { mutableStateListOf<Track>() }
        val likedTracksRepo by LikeRepository.likedTracks.collectAsState()
    
        var playlistTitle by remember { mutableStateOf("") }
        var playlistCover by remember { mutableStateOf<String?>(null) }
        var playlistUser by remember { mutableStateOf<User?>(null) }
        var isLoading by remember { mutableStateOf(true) }
        var defaultIcon by remember { mutableStateOf<ImageVector?>(null) }
    
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
        val storageTrigger by DownloadManager.storageTrigger.collectAsState()
        var localDownloadRefreshKey by remember { mutableIntStateOf(0) }
    
        // extract numeric id from compound strings
        val cleanIdStr = playlistId.replace("station_artist:", "")
            .replace("station:", "")
            .replace("local_playlist:", "")
        val currentIdLong = cleanIdStr.toLongOrNull() ?: 0L
    
        val playlistInDb by DownloadManager.isPlaylistInLibraryFlow(currentIdLong).collectAsState(initial = null)
    
        var isUserCreated by remember { mutableStateOf(false) }
        var isLocalPlaylist by remember { mutableStateOf(false) }
        var showPlaylistOptionsSheet by remember { mutableStateOf(false) }
    
        val shareUrl = remember(playlistId, currentIdLong) {
            when {
                playlistId.startsWith("station_artist:") -> "https://soundcloud.com/discover/stations/artist/$currentIdLong"
                playlistId.startsWith("station:") -> "https://soundcloud.com/discover/stations/track/$currentIdLong"
                playlistId == "likes" -> "https://soundcloud.com/you/likes"
                playlistId == "downloads" -> ""
                currentIdLong > 0 -> "https://soundcloud.com/playlists/$currentIdLong"
                else -> ""
            }
        }
    
        LaunchedEffect(playlistInDb) {
            if (playlistInDb != null) {
                isLocalPlaylist = true
                isUserCreated = playlistInDb!!.isUserCreated || currentIdLong < 0
                playlistTitle = playlistInDb!!.title
                playlistCover = playlistInDb!!.localCoverPath ?: playlistInDb!!.artworkUrl
            } else {
                isLocalPlaylist = currentIdLong < 0
                isUserCreated = currentIdLong < 0
            }
        }
    
        val photoPickerLauncher = rememberLauncherForActivityResult(
            contract = ActivityResultContracts.PickVisualMedia(),
            onResult = { uri -> if (uri != null && currentIdLong != 0L) DownloadManager.updatePlaylistCover(currentIdLong, uri) }
        )
    
        var showDeleteDialog by remember { mutableStateOf(false) }
        var showRemoveDownloadDialog by remember { mutableStateOf(false) }
        var showRenameDialog by remember { mutableStateOf(false) }
        var newPlaylistName by remember { mutableStateOf("") }
    
        var isFullyDownloaded by remember { mutableStateOf(false) }
    
        val tracksToDisplay = if (playlistId == "likes") likedTracksRepo else tracks
    
        LaunchedEffect(tracksToDisplay.size, downloadProgress, localDownloadRefreshKey, storageTrigger) {
            if (tracksToDisplay.isNotEmpty()) {
                isFullyDownloaded = tracksToDisplay.all { track -> File(context.filesDir, "track_${track.id}.mp3").exists() }
            } else {
                isFullyDownloaded = false
            }
        }
    
        // --- MAIN DATA LOADING ---
        LaunchedEffect(playlistId) {
            isLoading = true
            tracks.clear()
            try {
                val api = RetrofitClient.create(context)
                val db = AppDatabase.getDatabase(context).downloadDao()
    
                when {
                    playlistId == "likes" -> {
                        playlistTitle = context.getString(R.string.lib_liked_tracks)
                        defaultIcon = Icons.Rounded.Favorite
                        try {
                            val user = api.getMe()
                            playlistUser = user
                        } catch (e: Exception) {
                            playlistUser = User(0, context.getString(R.string.me_artist), null) // fallback
                        }
                        isLoading = false
                    }
                    playlistId == "downloads" -> {
                        playlistTitle = context.getString(R.string.lib_downloads)
                        defaultIcon = Icons.Rounded.Folder
                        isLocalPlaylist = false
                        val localTracks = db.getAllTracks().first()
                        tracks.addAll(localTracks.map { local ->
                            Track(local.id, local.title, local.artworkUrl, local.duration, User(0, local.artist, null), isLiked = true)
                        })
                        isLoading = false
                    }
                    playlistId == "local_files" -> {
                        playlistTitle = context.getString(R.string.lib_local_media)
                        defaultIcon = Icons.Default.SdStorage
                        isLocalPlaylist = false
    
                        val allTracks = db.getAllTracks().first()
                        // only grab files with negative ids (local scans)
                        val localFileTracks = allTracks.filter { it.id < 0 }
    
                        tracks.addAll(localFileTracks.map { local ->
                            Track(
                                id = local.id,
                                title = local.title,
                                artworkUrl = local.artworkUrl,
                                durationMs = local.duration,
                                user = User(0, local.artist, null),
                                description = "Fichier local: ${local.localAudioPath}"
                            )
                        })
                        isLoading = false
                    }
                    else -> {
                        val localPlaylist = if (currentIdLong != 0L) db.getPlaylist(currentIdLong) else null
                        if (localPlaylist != null) {
                            // LOAD FROM DB
                            playlistTitle = localPlaylist.title
                            playlistCover = localPlaylist.localCoverPath ?: localPlaylist.artworkUrl
                            playlistUser = User(0, localPlaylist.artist, null)
                            isUserCreated = localPlaylist.isUserCreated || currentIdLong < 0
                            isLocalPlaylist = true
    
                            launch {
                                db.getTracksForPlaylist(currentIdLong).collect { playlistTracks ->
                                    tracks.clear()
                                    tracks.addAll(playlistTracks.map { local ->
                                        Track(local.id, local.title, local.artworkUrl, local.duration, User(0, local.artist, null))
                                    })
                                    isLoading = false
                                }
                            }
                        } else {
                            // LOAD FROM NETWORK
                            if (currentIdLong > 0L) {
                                val isArtistStation = playlistId.startsWith("station_artist:")
                                val isTrackStation = playlistId.startsWith("station:")
                                val playlistObj = when {
                                    isArtistStation -> api.getArtistStation(currentIdLong)
                                    isTrackStation -> api.getTrackStation(currentIdLong)
                                    else -> api.getPlaylist(currentIdLong)
                                }
                                playlistTitle = playlistObj.title.takeIf { !it.isNullOrBlank() } ?: context.getString(R.string.radio)
                                playlistCover = playlistObj.fullResArtwork
                                playlistUser = playlistObj.user
                                val rawTracks = playlistObj.tracks ?: emptyList()
    
                                // soundcloud sometimes returns incomplete track objects in playlists
                                // we need to fetch full details for those
                                val incompleteIds = rawTracks.filter { it.title.isNullOrBlank() || it.user == null }.map { it.id }
                                if (incompleteIds.isNotEmpty()) {
                                    val fetchedTracksMap = mutableMapOf<Long, Track>()
                                    val chunks = incompleteIds.chunked(50)
                                    chunks.forEach { batchIds ->
                                        try {
                                            val fetched = api.getTracksByIds(batchIds.joinToString(","))
                                            fetched.forEach { fetchedTracksMap[it.id] = it }
                                        } catch (e: Exception) {
                                            e.printStackTrace()
                                        }
                                    }
                                    val hydratedList = rawTracks.map { track ->
                                        if (track.title.isNullOrBlank() || track.user == null) fetchedTracksMap[track.id] ?: track else track
                                    }
                                    tracks.addAll(hydratedList)
                                } else {
                                    tracks.addAll(rawTracks)
                                }
                                isLoading = false
                            }
                        }
                    }
                }
            } catch (e: Exception) { e.printStackTrace(); isLoading = false }
        }
    
        if (showDeleteDialog) {
            AlertDialog(
                onDismissRequest = { showDeleteDialog = false },
                title = { Text(stringResource(if (isUserCreated) R.string.dialog_delete_playlist_title else R.string.dialog_delete_playlist_from_lib_title)) },
                text = { Text(stringResource(R.string.dialog_delete_playlist_msg)) },
                confirmButton = {
                    TextButton(onClick = {
                        if (currentIdLong != 0L) { DownloadManager.deletePlaylist(currentIdLong); onBackClick() }
                        showDeleteDialog = false
                    }) { Text(stringResource(R.string.btn_confirm), color = MaterialTheme.colorScheme.error) }
                },
                dismissButton = { TextButton(onClick = { showDeleteDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showRemoveDownloadDialog) {
            AlertDialog(
                onDismissRequest = { showRemoveDownloadDialog = false },
                title = { Text(stringResource(R.string.dialog_remove_download_title)) },
                text = { Text(stringResource(R.string.dialog_remove_download_msg)) },
                confirmButton = {
                    TextButton(onClick = {
                        if (currentIdLong != 0L) {
                            DownloadManager.removePlaylistDownloads(currentIdLong)
                            scope.launch { delay(100); localDownloadRefreshKey++ }
                        }
                        showRemoveDownloadDialog = false
                    }) { Text(stringResource(R.string.btn_delete), color = MaterialTheme.colorScheme.error) }
                },
                dismissButton = { TextButton(onClick = { showRemoveDownloadDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showRenameDialog) {
            AlertDialog(
                onDismissRequest = { showRenameDialog = false },
                title = { Text(stringResource(R.string.dialog_rename_playlist_title)) },
                text = { OutlinedTextField(value = newPlaylistName, onValueChange = { newPlaylistName = it }, label = { Text(stringResource(R.string.dialog_rename_playlist_hint)) }, singleLine = true) },
                confirmButton = { TextButton(onClick = { if (currentIdLong != 0L && newPlaylistName.isNotBlank()) DownloadManager.renamePlaylist(currentIdLong, newPlaylistName); showRenameDialog = false }) { Text(stringResource(R.string.btn_save)) } },
                dismissButton = { TextButton(onClick = { showRenameDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        val playbackContext = remember(playlistId, playlistTitle, playlistCover) {
            when {
                playlistId == "likes" -> PlaybackContext(context.getString(R.string.context_playlist, context.getString(R.string.lib_liked_tracks)), "likes", playlistCover)
                playlistId == "downloads" -> PlaybackContext(context.getString(R.string.context_playlist, context.getString(R.string.lib_downloads)), "downloads", playlistCover)
                playlistId.startsWith("station") -> PlaybackContext(context.getString(R.string.context_station, playlistTitle), playlistId, playlistCover)
                else -> PlaybackContext(context.getString(R.string.context_playlist, playlistTitle), playlistId, playlistCover)
            }
        }
    
        val backgroundColor = MaterialTheme.colorScheme.background
    
        Scaffold(containerColor = backgroundColor) { innerPadding ->
            Box(modifier = Modifier.fillMaxSize()) {
                if (!playlistCover.isNullOrEmpty()) {
                    Box(modifier = Modifier.fillMaxWidth().height(500.dp)) {
                        AsyncImage(model = playlistCover, contentDescription = null, modifier = Modifier.fillMaxSize().blur(100.dp).alpha(0.6f), contentScale = ContentScale.Crop)
                        Box(modifier = Modifier.fillMaxSize().background(
                            Brush.verticalGradient(
                                colors = listOf(
                                    Color.Transparent,
                                    backgroundColor.copy(alpha = 0.3f),
                                    backgroundColor.copy(alpha = 0.8f),
                                    backgroundColor
                                )
                            )
                        ))
                    }
                } else {
                    Box(modifier = Modifier.fillMaxWidth().height(300.dp).background(Brush.verticalGradient(listOf(MaterialTheme.colorScheme.surfaceVariant, backgroundColor))))
                }
    
                LazyColumn(modifier = Modifier.fillMaxSize(), contentPadding = PaddingValues(bottom = 120.dp)) {
                    item {
                        Spacer(modifier = Modifier.statusBarsPadding().height(90.dp))
                        Column(modifier = Modifier.padding(horizontal = 24.dp).padding(bottom = 16.dp)) {
                            Box {
                                Card(shape = RoundedCornerShape(12.dp), elevation = CardDefaults.cardElevation(12.dp), modifier = Modifier.size(160.dp)) {
                                    if (!playlistCover.isNullOrEmpty()) AsyncImage(model = playlistCover, contentDescription = null, modifier = Modifier.fillMaxSize(), contentScale = ContentScale.Crop)
                                    else if (defaultIcon != null) Box(modifier = Modifier.fillMaxSize().background(MaterialTheme.colorScheme.surfaceContainerHigh), contentAlignment = Alignment.Center) { Icon(defaultIcon!!, null, modifier = Modifier.size(64.dp), tint = MaterialTheme.colorScheme.primary) }
                                    else Box(Modifier.fillMaxSize().background(MaterialTheme.colorScheme.surfaceVariant), contentAlignment = Alignment.Center) { Icon(Icons.Default.MusicNote, null, modifier = Modifier.size(64.dp), tint = MaterialTheme.colorScheme.onSurfaceVariant) }
                                }
                                if (isUserCreated) {
                                    Surface(shape = CircleShape, color = MaterialTheme.colorScheme.surface.copy(alpha = 0.7f), modifier = Modifier.align(Alignment.BottomEnd).offset(x = 8.dp, y = 8.dp).clickable { photoPickerLauncher.launch(PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly)) }) {
                                        Icon(Icons.Outlined.Image, stringResource(R.string.storage_change_btn), modifier = Modifier.padding(8.dp), tint = MaterialTheme.colorScheme.onSurface)
                                    }
                                }
                            }
                            Spacer(Modifier.height(20.dp))
                            Text(text = playlistTitle, style = MaterialTheme.typography.headlineMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onBackground, maxLines = 2, overflow = TextOverflow.Ellipsis)
                            if (playlistUser != null && playlistUser!!.id > 0) {
                                Text(text = stringResource(R.string.playlist_by_user, playlistUser!!.username ?: ""), style = MaterialTheme.typography.titleMedium, color = MaterialTheme.colorScheme.primary, modifier = Modifier.clickable { playerViewModel.navigateToArtist(playlistUser!!.id) })
                            } else {
                                Text(text = stringResource(R.string.playlist_by_user, playlistUser?.username ?: stringResource(R.string.me_artist)), style = MaterialTheme.typography.titleMedium, color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f))
                            }
                            Spacer(Modifier.height(8.dp))
    
                            val trackCountText = if (isLoading && playlistId != "likes") "..." else stringResource(R.string.playlist_num_tracks, tracksToDisplay.size)
                            Text(text = trackCountText, color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f), style = MaterialTheme.typography.bodyMedium)
    
                            Spacer(Modifier.height(16.dp))
    
                            Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Start) {
                                if (isUserCreated || isLocalPlaylist) {
                                    IconButton(onClick = { newPlaylistName = playlistTitle; showRenameDialog = true }) { Icon(Icons.Outlined.Edit, stringResource(R.string.profile_edit), tint = MaterialTheme.colorScheme.onBackground) }
                                }
    
                                if (playlistId != "downloads" && playlistId != "likes" && !playlistId.contains("station") && !isUserCreated) {
                                    IconButton(onClick = {
                                        if (isLocalPlaylist) showDeleteDialog = true
                                        else {
                                            val cleanId = currentIdLong
                                            if (cleanId != 0L && tracks.isNotEmpty()) {
                                                val fakePlaylist = Playlist(cleanId, playlistTitle, playlistCover, null, tracks.size, playlistUser, null)
                                                DownloadManager.importPlaylistToLibrary(fakePlaylist, tracks.toList())
                                            }
                                        }
                                    }) {
                                        if (isLocalPlaylist) Icon(Icons.Rounded.Favorite, stringResource(R.string.lib_liked_tracks), tint = MaterialTheme.colorScheme.primary)
                                        else Icon(Icons.Outlined.FavoriteBorder, stringResource(R.string.menu_add_playlist), tint = MaterialTheme.colorScheme.onBackground)
                                    }
                                }
    
                                if (isUserCreated) {
                                    IconButton(onClick = { showDeleteDialog = true }) { Icon(Icons.Default.Delete, stringResource(R.string.btn_delete), tint = MaterialTheme.colorScheme.error) }
                                }
    
                                if (playlistId != "downloads" && playlistId != "likes") {
                                    IconButton(onClick = {
                                        val cleanId = currentIdLong
                                        if (cleanId != 0L) {
                                            if (isFullyDownloaded) {
                                                showRemoveDownloadDialog = true
                                            } else {
                                                val fakePlaylist = Playlist(cleanId, playlistTitle, playlistCover, null, tracks.size, playlistUser, null)
                                                DownloadManager.downloadPlaylist(fakePlaylist, tracks.toList())
                                            }
                                        }
                                    }) {
                                        if (isFullyDownloaded) Icon(Icons.Rounded.DownloadDone, stringResource(R.string.btn_downloaded), tint = MaterialTheme.colorScheme.primary)
                                        else Icon(Icons.Rounded.Download, stringResource(R.string.btn_download), tint = MaterialTheme.colorScheme.onBackground)
                                    }
                                }
                            }
    
                            Spacer(Modifier.height(12.dp))
    
                            Row(modifier = Modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                                Button(
                                    onClick = { playerViewModel.playPlaylist(tracksToDisplay.toList(), 0, playbackContext) },
                                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary, contentColor = MaterialTheme.colorScheme.onPrimary),
                                    shape = RoundedCornerShape(50),
                                    modifier = Modifier.weight(1f).height(50.dp) // added weight
                                ) {
                                    Icon(Icons.Default.PlayArrow, null)
                                    Spacer(Modifier.width(8.dp))
                                    Text(
                                        stringResource(R.string.btn_play),
                                        style = MaterialTheme.typography.titleMedium,
                                        fontWeight = FontWeight.Bold,
                                        maxLines = 1, // added maxLines
                                        overflow = TextOverflow.Ellipsis // added overflow
                                    )
                                }
                                FilledTonalButton(
                                    onClick = { playerViewModel.playPlaylist(tracksToDisplay.toList().shuffled(), context = playbackContext) },
                                    colors = ButtonDefaults.filledTonalButtonColors(containerColor = MaterialTheme.colorScheme.surfaceContainerHighest, contentColor = MaterialTheme.colorScheme.onSurface),
                                    shape = RoundedCornerShape(50),
                                    modifier = Modifier.weight(1f).height(50.dp) // added weight
                                ) {
                                    Icon(Icons.Default.Shuffle, null)
                                    Spacer(Modifier.width(8.dp))
                                    Text(
                                        stringResource(R.string.btn_shuffle),
                                        style = MaterialTheme.typography.titleMedium,
                                        fontWeight = FontWeight.Bold,
                                        maxLines = 1, // added maxLines
                                        overflow = TextOverflow.Ellipsis // added overflow
                                    )
                                }
                            }
                        }
                    }
    
                    if (downloadProgress.isNotEmpty()) {
                        item { LinearProgressIndicator(progress = { 0.5f }, modifier = Modifier.fillMaxWidth().height(4.dp), color = MaterialTheme.colorScheme.primary, trackColor = MaterialTheme.colorScheme.surfaceVariant) }
                    }
    
                    if (isLoading && playlistId != "likes") {
                        items(15) {
                            TrackListItemShimmer()
                        }
                    } else {
                        itemsIndexed(items = tracksToDisplay, key = { index, t -> "${t.id}_$index" }) { index, track ->
                            val progress = downloadProgress[track.id]
                            val isDownloading = progress != null
                            val isDownloaded = remember(track.id, storageTrigger, localDownloadRefreshKey) {
                                File(context.filesDir, "track_${track.id}.mp3").exists()
                            }
    
                            var offsetY by remember { mutableFloatStateOf(0f) }
                            var isDragging by remember { mutableStateOf(false) }
                            val elevation by animateDpAsState(if (isDragging) 8.dp else 0.dp, label = "elevation")
                            val scale by animateFloatAsState(if (isDragging) 1.02f else 1f, label = "scale")
    
                            TrackListItem(
                                track = track,
                                currentlyPlayingTrack = playerViewModel.currentTrack,
                                index = index,
                                isDownloading = isDownloading,
                                isDownloaded = isDownloaded,
                                downloadProgress = progress ?: 0,
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .zIndex(if (isDragging) 1f else 0f)
                                    .graphicsLayer { translationY = offsetY; scaleX = scale; scaleY = scale; shadowElevation = elevation.toPx() }
                                    .background(if (isDragging) MaterialTheme.colorScheme.surfaceContainer else Color.Transparent)
                                    .pointerInput(Unit) {
                                        // only allow drag reordering on custom playlists
                                        if (isUserCreated) {
                                            detectDragGesturesAfterLongPress(
                                                onDragStart = { isDragging = true; view.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS) },
                                                onDragEnd = { isDragging = false; offsetY = 0f },
                                                onDragCancel = { isDragging = false; offsetY = 0f },
                                                onDrag = { change, dragAmount ->
                                                    change.consume()
                                                    offsetY += dragAmount.y
                                                    val itemHeight = 72.dp.toPx()
                                                    if (offsetY > itemHeight) {
                                                        val next = index + 1
                                                        if (next < tracks.size) {
                                                            val item = tracks.removeAt(index); tracks.add(next, item)
                                                            DownloadManager.swapTrackOrder(currentIdLong, track.id, tracks[index].id)
                                                            offsetY -= itemHeight; view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK)
                                                        }
                                                    } else if (offsetY < -itemHeight) {
                                                        val prev = index - 1
                                                        if (prev >= 0) {
                                                            val item = tracks.removeAt(index); tracks.add(prev, item)
                                                            DownloadManager.swapTrackOrder(currentIdLong, track.id, tracks[index].id)
                                                            offsetY += itemHeight; view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK)
                                                        }
                                                    }
                                                }
                                            )
                                        }
                                    },
                                onClick = { playerViewModel.playPlaylist(tracksToDisplay.toList(), index, playbackContext) },
                                onOptionClick = { playerViewModel.showTrackOptions(track, if(isUserCreated) currentIdLong else null) }
                            )
                        }
                    }
                }
    
                TopAppBar(
                    title = {},
                    navigationIcon = { IconButton(onClick = onBackClick, modifier = Modifier.background(Color.Black.copy(alpha = 0.3f), CircleShape)) { Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_close), tint = Color.White) } },
                    actions = {
                        IconButton(
                            onClick = { showPlaylistOptionsSheet = true },
                            modifier = Modifier.background(Color.Black.copy(alpha = 0.3f), CircleShape)
                        ) {
                            Icon(Icons.Default.MoreVert, stringResource(R.string.btn_options), tint = Color.White)
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(containerColor = Color.Transparent),
                    modifier = Modifier.statusBarsPadding().padding(horizontal = 8.dp)
                )
            }
    
            if (showPlaylistOptionsSheet) {
                ModalBottomSheet(
                    onDismissRequest = { showPlaylistOptionsSheet = false },
                    containerColor = MaterialTheme.colorScheme.surfaceContainer,
                    sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)
                ) {
                    PlaylistOptionsSheet(
                        playlistId = currentIdLong,
                        playlistTitle = playlistTitle,
                        playlistCover = playlistCover,
                        tracks = tracksToDisplay.toList(),
                        isLocal = isLocalPlaylist || playlistId == "downloads",
                        shareUrl = shareUrl,
                        playerViewModel = playerViewModel,
                        onDismiss = { showPlaylistOptionsSheet = false }
                    )
                }
            }
        }
    }
    
    data class DockOptionItem(val icon: ImageVector, val text: String, val onClick: () -> Unit)
    
    @Composable
    fun PlaylistOptionsSheet(
        playlistId: Long,
        playlistTitle: String,
        playlistCover: String?,
        tracks: List<Track>,
        isLocal: Boolean,
        shareUrl: String,
        playerViewModel: PlayerViewModel,
        onDismiss: () -> Unit
    ) {
        val context = LocalContext.current
    
        Column(modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp)) {
    
            Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.padding(bottom = 24.dp).padding(horizontal = 8.dp)) {
                AsyncImage(model = playlistCover, contentDescription = null, modifier = Modifier.size(56.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant), contentScale = ContentScale.Crop)
                Spacer(modifier = Modifier.width(16.dp))
                Text(text = playlistTitle, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, maxLines = 1, overflow = TextOverflow.Ellipsis)
            }
    
            val items = listOf(
                DockOptionItem(Icons.Rounded.PlayArrow, stringResource(R.string.btn_play)) { playerViewModel.playPlaylist(tracks, 0); onDismiss() },
                DockOptionItem(Icons.Default.Shuffle, stringResource(R.string.btn_shuffle)) { playerViewModel.playPlaylist(tracks.shuffled(), 0); onDismiss() },
                DockOptionItem(Icons.Default.Radio, stringResource(R.string.menu_track_radio)) { onDismiss() },
                DockOptionItem(Icons.Rounded.PlaylistPlay, stringResource(R.string.menu_play_next)) { playerViewModel.insertNext(tracks); onDismiss() },
                DockOptionItem(Icons.Rounded.QueueMusic, stringResource(R.string.menu_add_queue)) { playerViewModel.addToQueue(tracks); onDismiss() },
                DockOptionItem(Icons.Default.Add, stringResource(R.string.menu_add_playlist)) { playerViewModel.prepareBulkAdd(tracks); onDismiss() }
            )
    
            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                verticalArrangement = Arrangement.spacedBy(24.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                modifier = Modifier.padding(bottom = 24.dp)
            ) {
                items(items) { item ->
                    Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.clickable { item.onClick() }) {
                        Icon(item.icon, null, modifier = Modifier.size(32.dp), tint = MaterialTheme.colorScheme.onSurface)
                        Spacer(Modifier.height(8.dp))
                        Text(item.text, style = MaterialTheme.typography.labelMedium, textAlign = TextAlign.Center, color = MaterialTheme.colorScheme.onSurface)
                    }
                }
    
                item {
                    Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.clickable { /* TODO */ }) {
                        Icon(Icons.Rounded.Download, null, modifier = Modifier.size(32.dp), tint = MaterialTheme.colorScheme.onSurface)
                        Spacer(Modifier.height(8.dp))
                        Text(stringResource(R.string.btn_download), style = MaterialTheme.typography.labelMedium, textAlign = TextAlign.Center)
                    }
                }
    
                if (!isLocal && shareUrl.isNotEmpty()) {
                    item {
                        Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.clickable {
                            val shareIntent = Intent(Intent.ACTION_SEND).apply {
                                type = "text/plain"
                                putExtra(Intent.EXTRA_TEXT, shareUrl)
                            }
                            context.startActivity(Intent.createChooser(shareIntent, context.getString(R.string.btn_share)))
                            onDismiss()
                        }) {
                            Icon(Icons.Outlined.Share, null, modifier = Modifier.size(32.dp), tint = MaterialTheme.colorScheme.onSurface)
                            Spacer(Modifier.height(8.dp))
                            Text(stringResource(R.string.btn_share), style = MaterialTheme.typography.labelMedium, textAlign = TextAlign.Center)
                        }
                    }
                }
            }
        }
    }
    
    @Composable
    fun TrackListItem(
        track: Track,
        currentlyPlayingTrack: Track? = null,
        index: Int,
        isDownloading: Boolean,
        isDownloaded: Boolean,
        downloadProgress: Int,
        modifier: Modifier = Modifier,
        onClick: () -> Unit,
        onOptionClick: () -> Unit
    ) {
        val isCurrent = currentlyPlayingTrack?.id == track.id
        val titleColor = if (isCurrent) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurface
        val titleWeight = if (isCurrent) FontWeight.Bold else FontWeight.SemiBold
    
        Row(
            modifier = modifier
                .clickable(onClick = onClick)
                .padding(horizontal = 16.dp, vertical = 8.dp)
                .height(72.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(contentAlignment = Alignment.Center) {
                AsyncImage(
                    model = track.fullResArtwork,
                    contentDescription = null,
                    modifier = Modifier
                        .size(56.dp)
                        .clip(RoundedCornerShape(8.dp))
                        .background(MaterialTheme.colorScheme.surfaceVariant)
                        .alpha(if (isDownloading) 0.3f else 1f),
                    contentScale = ContentScale.Crop
                )
                if (isDownloading) CircularProgressIndicator(progress = { downloadProgress / 100f }, modifier = Modifier.size(28.dp), color = Color.White, strokeWidth = 3.dp, trackColor = Color.White.copy(alpha = 0.3f))
    
                if (isCurrent && !isDownloading) {
                    Box(modifier = Modifier.size(56.dp).clip(RoundedCornerShape(8.dp)).background(Color.Black.copy(alpha = 0.5f)), contentAlignment = Alignment.Center) {
                        Icon(imageVector = Icons.Rounded.GraphicEq, contentDescription = stringResource(R.string.player_playing_now), tint = MaterialTheme.colorScheme.primary, modifier = Modifier.size(24.dp))
                    }
                }
            }
            Spacer(Modifier.width(16.dp))
            Column(modifier = Modifier.weight(1f)) {
                Text(text = track.title ?: stringResource(R.string.untitled_track), maxLines = 1, overflow = TextOverflow.Ellipsis, fontWeight = titleWeight, color = titleColor)
                Row(verticalAlignment = Alignment.CenterVertically) {
                    if (isDownloaded && !isDownloading) { Icon(Icons.Rounded.DownloadDone, stringResource(R.string.btn_downloaded), modifier = Modifier.size(14.dp), tint = MaterialTheme.colorScheme.primary); Spacer(Modifier.width(4.dp)) }
                    Text(text = track.user?.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1, overflow = TextOverflow.Ellipsis)
                }
            }
            IconButton(onClick = onOptionClick, modifier = Modifier.size(48.dp)) { Icon(Icons.Default.MoreVert, stringResource(R.string.btn_options), tint = MaterialTheme.colorScheme.onSurfaceVariant) }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/login/LoginScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.login
    
    import android.annotation.SuppressLint
    import android.graphics.Bitmap
    import android.os.Message
    import android.view.ViewGroup
    import android.webkit.CookieManager
    import android.webkit.WebChromeClient
    import android.webkit.WebView
    import android.webkit.WebViewClient
    import androidx.compose.foundation.layout.Box
    import androidx.compose.foundation.layout.fillMaxSize
    import androidx.compose.foundation.layout.padding
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.Close
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.viewinterop.AndroidView
    import androidx.compose.ui.window.Dialog
    import androidx.compose.ui.window.DialogProperties
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.TokenManager
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LoginScreen(
        onLoginSuccess: () -> Unit,
        onBackClick: () -> Unit
    ) {
        val context = LocalContext.current
        val tokenManager = remember { TokenManager(context) }
        var isLoading by remember { mutableStateOf(true) }
    
        var popupWebView by remember { mutableStateOf<WebView?>(null) }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.login_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_cancel))
                        }
                    }
                )
            }
        ) { innerPadding ->
            Box(modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()) {
    
                AndroidView(
                    modifier = Modifier.fillMaxSize(),
                    factory = { ctx ->
                        WebView(ctx).apply {
                            layoutParams = ViewGroup.LayoutParams(
                                ViewGroup.LayoutParams.MATCH_PARENT,
                                ViewGroup.LayoutParams.MATCH_PARENT
                            )
                            configureWebView(this)
    
                            settings.setSupportMultipleWindows(true)
                            settings.javaScriptCanOpenWindowsAutomatically = true
    
                            webViewClient = object : WebViewClient() {
                                override fun onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) {
                                    isLoading = true
                                }
                                override fun onPageFinished(view: WebView?, url: String?) {
                                    isLoading = false
                                    checkCookies(url, CookieManager.getInstance(), tokenManager, onLoginSuccess)
                                }
                            }
    
                            webChromeClient = object : WebChromeClient() {
                                override fun onCreateWindow(
                                    view: WebView?,
                                    isDialog: Boolean,
                                    isUserGesture: Boolean,
                                    resultMsg: Message?
                                ): Boolean {
                                    val newWebView = WebView(ctx)
                                    configureWebView(newWebView)
    
                                    newWebView.webViewClient = object : WebViewClient() {
                                        override fun onPageFinished(view: WebView?, url: String?) {
                                            checkCookies(url, CookieManager.getInstance(), tokenManager, onLoginSuccess)
                                        }
                                    }
                                    newWebView.webChromeClient = object : WebChromeClient() {
                                        override fun onCloseWindow(window: WebView?) {
                                            popupWebView = null
                                        }
                                    }
    
                                    popupWebView = newWebView
    
                                    val transport = resultMsg?.obj as? WebView.WebViewTransport
                                    transport?.webView = newWebView
                                    resultMsg?.sendToTarget()
    
                                    return true
                                }
                            }
    
                            loadUrl("https://soundcloud.com/signin")
                        }
                    }
                )
    
                if (isLoading) {
                    CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))
                }
    
                if (popupWebView != null) {
                    Dialog(
                        onDismissRequest = { popupWebView = null },
                        properties = DialogProperties(usePlatformDefaultWidth = false)
                    ) {
                        Scaffold(
                            topBar = {
                                TopAppBar(
                                    title = { Text(stringResource(R.string.nav_login)) },
                                    navigationIcon = {
                                        IconButton(onClick = { popupWebView = null }) {
                                            Icon(Icons.Default.Close, contentDescription = stringResource(R.string.btn_close))
                                        }
                                    }
                                )
                            }
                        ) { popupPadding ->
                            Box(modifier = Modifier.padding(popupPadding).fillMaxSize()) {
                                AndroidView(
                                    factory = { popupWebView!! },
                                    modifier = Modifier.fillMaxSize()
                                )
                            }
                        }
                    }
                }
            }
        }
    }
    
    @SuppressLint("SetJavaScriptEnabled")
    private fun configureWebView(webView: WebView) {
        val cookieManager = CookieManager.getInstance()
        cookieManager.setAcceptCookie(true)
        cookieManager.setAcceptThirdPartyCookies(webView, true)
    
        webView.settings.apply {
            javaScriptEnabled = true
            domStorageEnabled = true
            databaseEnabled = true
            useWideViewPort = true
            loadWithOverviewMode = true
            userAgentString = "Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36"
        }
    }
    
    private fun checkCookies(
        url: String?,
        cookieManager: CookieManager,
        tokenManager: TokenManager,
        onSuccess: () -> Unit
    ) {
        val cookies = cookieManager.getCookie(url)
    
        if (cookies != null && cookies.contains("oauth_token")) {
            val accessToken = extractValueFromCookie(cookies, "oauth_token")
            val refreshToken = extractValueFromCookie(cookies, "refresh_token") ?: ""
    
            if (!accessToken.isNullOrEmpty()) {
                tokenManager.saveTokens(accessToken, refreshToken)
                onSuccess()
            }
        }
    }
    
    private fun extractValueFromCookie(cookies: String, key: String): String? {
        return cookies.split(";")
            .map { it.trim() }
            .find { it.startsWith("$key=") }
            ?.substringAfter("$key=")
            ?.replace("\"", "")
            ?.trim()
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/login/WelcomeScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.login
    
    import androidx.compose.animation.Crossfade
    import androidx.compose.animation.core.tween
    import androidx.compose.foundation.background
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.filled.MusicNote
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import com.alananasss.kittytune.R
    
    @Composable
    fun WelcomeScreen(
        onLoginClick: () -> Unit,
        onGuestClick: () -> Unit,
        isGuestLoading: Boolean
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
        ) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(
                        Brush.verticalGradient(
                            colors = listOf(
                                MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f),
                                MaterialTheme.colorScheme.background
                            )
                        )
                    )
            )
    
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(24.dp)
                    .systemBarsPadding(),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Spacer(modifier = Modifier.weight(1f))
    
                Surface(
                    shape = CircleShape,
                    color = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.size(120.dp)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            imageVector = Icons.Default.MusicNote,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onPrimary,
                            modifier = Modifier.size(64.dp)
                        )
                    }
                }
    
                Spacer(modifier = Modifier.height(40.dp))
    
                Text(
                    text = stringResource(R.string.welcome_title),
                    style = MaterialTheme.typography.displaySmall.copy(
                        fontWeight = FontWeight.Bold,
                        lineHeight = 40.sp
                    ),
                    textAlign = TextAlign.Center,
                    color = MaterialTheme.colorScheme.onBackground
                )
    
                Spacer(modifier = Modifier.height(16.dp))
    
                Text(
                    text = stringResource(R.string.welcome_subtitle),
                    style = MaterialTheme.typography.bodyLarge,
                    textAlign = TextAlign.Center,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
    
                Spacer(modifier = Modifier.weight(1f))
    
                Crossfade(
                    targetState = isGuestLoading,
                    modifier = Modifier.height(160.dp),
                    animationSpec = tween(500), label = "LoginState"
                ) { guestLoading ->
                    Column(
                        modifier = Modifier.fillMaxSize(),
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.Center
                    ) {
                        if (guestLoading) {
                            CircularProgressIndicator(color = MaterialTheme.colorScheme.primary)
                            Spacer(modifier = Modifier.height(16.dp))
                            Text(
                                stringResource(R.string.guest_loading),
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        } else {
                            Button(
                                onClick = onLoginClick,
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .height(56.dp),
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = MaterialTheme.colorScheme.primary,
                                    contentColor = MaterialTheme.colorScheme.onPrimary
                                )
                            ) {
                                Text(
                                    text = stringResource(R.string.login_soundcloud),
                                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold)
                                )
                            }
    
                            Spacer(modifier = Modifier.height(16.dp))
    
                            OutlinedButton(
                                onClick = onGuestClick,
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .height(56.dp)
                            ) {
                                Text(
                                    text = stringResource(R.string.login_guest),
                                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold)
                                )
                            }
                        }
                    }
                }
    
                Spacer(modifier = Modifier.height(32.dp))
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/MainScreen.kt
================================================================================
    package com.alananasss.kittytune.ui
    
    import android.annotation.SuppressLint
    import android.app.Activity
    import android.content.Context
    import android.content.ContextWrapper
    import android.view.View
    import android.view.WindowManager
    import android.webkit.WebView
    import androidx.activity.compose.BackHandler
    import androidx.compose.animation.*
    import androidx.compose.animation.core.FastOutLinearInEasing
    import androidx.compose.animation.core.FastOutSlowInEasing
    import androidx.compose.animation.core.tween
    import androidx.compose.foundation.background
    import androidx.compose.foundation.layout.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.blur
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.animation.core.Spring
    import androidx.compose.animation.core.spring
    import androidx.compose.animation.scaleIn
    import androidx.compose.animation.scaleOut
    import androidx.compose.ui.draw.shadow
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.viewinterop.AndroidView
    import androidx.compose.ui.zIndex
    import androidx.lifecycle.Lifecycle
    import androidx.lifecycle.LifecycleEventObserver
    import androidx.lifecycle.compose.LocalLifecycleOwner
    import androidx.lifecycle.viewmodel.compose.viewModel
    import androidx.navigation.NavDestination.Companion.hierarchy
    import androidx.navigation.NavGraph.Companion.findStartDestination
    import androidx.navigation.NavType
    import androidx.navigation.compose.NavHost
    import androidx.navigation.compose.composable
    import androidx.navigation.compose.currentBackStackEntryAsState
    import androidx.navigation.compose.rememberNavController
    import androidx.navigation.navArgument
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.AchievementManager
    import com.alananasss.kittytune.data.SessionManager
    import com.alananasss.kittytune.data.TokenManager
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.data.local.StartDestination
    import com.alananasss.kittytune.ui.common.AchievementNotification
    import com.alananasss.kittytune.ui.common.AchievementNotificationManager
    import com.alananasss.kittytune.ui.common.AchievementPopup
    import com.alananasss.kittytune.ui.common.UltimateCompletionOverlay
    import com.alananasss.kittytune.ui.home.HomeScreen
    import com.alananasss.kittytune.ui.home.HomeScreenShimmer
    import com.alananasss.kittytune.ui.home.HomeViewModel
    import com.alananasss.kittytune.ui.home.TagScreen
    import com.alananasss.kittytune.ui.library.LibraryScreen
    import com.alananasss.kittytune.ui.library.PlaylistDetailScreen
    import com.alananasss.kittytune.ui.login.LoginScreen
    import com.alananasss.kittytune.ui.login.WelcomeScreen
    import com.alananasss.kittytune.ui.navigation.Screen
    import com.alananasss.kittytune.ui.player.*
    import com.alananasss.kittytune.ui.player.lyrics.LyricsScreen
    import com.alananasss.kittytune.ui.profile.AboutScreen
    import com.alananasss.kittytune.ui.profile.AchievementsScreen
    import com.alananasss.kittytune.ui.profile.ProfileMenuSheet
    import com.alananasss.kittytune.ui.profile.ProfileScreen
    import com.alananasss.kittytune.ui.profile.SettingsScreen
    import com.alananasss.kittytune.ui.profile.StorageScreen
    import com.alananasss.kittytune.ui.track.TrackDetailScreen
    import kotlinx.coroutines.delay
    import kotlinx.coroutines.launch
    
    // helps finding the activity from context wrapper
    private fun Context.findActivity(): Activity? = when (this) {
        is Activity -> this
        is ContextWrapper -> baseContext.findActivity()
        else -> null
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @SuppressLint("UnusedMaterial3ScaffoldPaddingParameter")
    @Composable
    fun MainScreen() {
        val context = LocalContext.current
        val navController = rememberNavController()
        val playerViewModel: PlayerViewModel = viewModel()
        val homeViewModel: HomeViewModel = viewModel()
        val bottomNavItems = listOf(Screen.Home, Screen.Library)
        val lifecycleOwner = LocalLifecycleOwner.current
        val scope = rememberCoroutineScope()
    
        val prefs = remember { PlayerPreferences(context) }
    
        var isAppReady by remember { mutableStateOf(false) }
        var startDestination by remember { mutableStateOf(Screen.Home.route) }
        var isGuestLoading by remember { mutableStateOf(false) }
        var showProfileMenu by remember { mutableStateOf(false) }
    
        val isClientIdValid by SessionManager.isClientIdValid.collectAsState()
        val allAchievementsUnlocked by AchievementManager.isAllUnlocked.collectAsState()
        var showCompletionScreen by remember { mutableStateOf(false) }
    
        // 1. init state with current value
        var showPopups by remember { mutableStateOf(prefs.getAchievementPopupsEnabled()) }
    
        // 2. real-time listener for prefs changes
        DisposableEffect(Unit) {
            val sharedPrefs = context.getSharedPreferences("player_state", Context.MODE_PRIVATE)
            val listener = android.content.SharedPreferences.OnSharedPreferenceChangeListener { _, key ->
                // update state immediately if this key changes
                if (key == "achievement_popups_enabled") {
                    showPopups = prefs.getAchievementPopupsEnabled()
                }
            }
            sharedPrefs.registerOnSharedPreferenceChangeListener(listener)
            onDispose {
                sharedPrefs.unregisterOnSharedPreferenceChangeListener(listener)
            }
        }
    
        // --- fix: use two state vars to handle exit anim ---
        var currentNotification by remember { mutableStateOf<AchievementNotification?>(null) }
        var animatingNotification by remember { mutableStateOf<AchievementNotification?>(null) }
    
        // keep data alive during exit animation
        if (currentNotification != null) {
            animatingNotification = currentNotification
        }
        // --- end fix ---
    
        DisposableEffect(lifecycleOwner) {
            val observer = LifecycleEventObserver { _, event ->
                if (event == Lifecycle.Event.ON_RESUME) {
                    // refresh stuff when app comes back
                    SessionManager.reloadSession()
                    showPopups = prefs.getAchievementPopupsEnabled()
                    AchievementManager.checkDailyStreak()
                }
            }
            lifecycleOwner.lifecycle.addObserver(observer)
            onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }
        }
    
        LaunchedEffect(showPopups) {
            if (showPopups) {
                AchievementNotificationManager.notifications.collect { notification ->
                    currentNotification = notification
                    // show popup for 5s
                    delay(5000)
                    currentNotification = null
                }
            }
        }
    
        LaunchedEffect(allAchievementsUnlocked) {
            if (allAchievementsUnlocked) {
                showCompletionScreen = true
            }
        }
    
        // invisible webview to keep session alive
        AndroidView(
            factory = { ctx ->
                WebView(ctx).apply {
                    visibility = View.GONE
                    layoutParams = android.view.ViewGroup.LayoutParams(1, 1)
                    SessionManager.attachGhost(this, ctx)
                }
            },
            modifier = Modifier.size(1.dp)
        )
    
        // check login status on startup
        LaunchedEffect(Unit) {
            val tokenManager = TokenManager(context)
            delay(500)
    
            val hasToken = !tokenManager.getAccessToken().isNullOrEmpty()
            val isGuest = tokenManager.isGuestMode()
    
            if (hasToken) {
                playerViewModel.fetchUserProfile()
                SessionManager.reloadSession()
                val destPref = prefs.getStartDestination()
                startDestination = if (destPref == StartDestination.LIBRARY) Screen.Library.route else Screen.Home.route
            } else if (isGuest) {
                val destPref = prefs.getStartDestination()
                startDestination = if (destPref == StartDestination.LIBRARY) Screen.Library.route else Screen.Home.route
            } else {
                startDestination = Screen.Welcome.route
            }
            isAppReady = true
        }
    
        // wait for valid client id before letting guest in
        LaunchedEffect(isGuestLoading, isClientIdValid) {
            if (isGuestLoading && isClientIdValid) {
                val tm = TokenManager(context)
                tm.setGuestMode(true)
                homeViewModel.loadData()
                delay(500)
                isGuestLoading = false
                navController.navigate(Screen.Home.route) {
                    popUpTo(Screen.Welcome.route) { inclusive = true }
                }
            }
        }
    
        // keep screen awake for lyrics
        if (playerViewModel.showLyricsSheet) {
            DisposableEffect(Unit) {
                val window = context.findActivity()?.window
                window?.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)
                onDispose { window?.clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON) }
            }
        }
    
        // handle navigation requests from viewmodel
        LaunchedEffect(playerViewModel.navigateToPlaylistId) {
            playerViewModel.navigateToPlaylistId?.let { destinationId ->
                playerViewModel.isPlayerExpanded = false
                when {
                    destinationId.startsWith("profile:") -> navController.navigate("profile/${destinationId.removePrefix("profile:")}")
                    destinationId.startsWith("tag:") -> navController.navigate("tag/${destinationId.removePrefix("tag:")}")
                    destinationId.startsWith("track_detail:") -> navController.navigate("track_detail/${destinationId.removePrefix("track_detail:")}")
                    else -> navController.navigate("playlist_detail/$destinationId")
                }
                playerViewModel.onNavigationHandled()
            }
        }
    
        // close lyrics instead of app
        BackHandler(enabled = playerViewModel.showLyricsSheet) {
            playerViewModel.showLyricsSheet = false
            playerViewModel.isSearchingLyrics = false
        }
    
        val snackbarHostState = remember { SnackbarHostState() }
        LaunchedEffect(Unit) {
            playerViewModel.uiEvent.collect { message ->
                snackbarHostState.showSnackbar(message)
            }
        }
    
        if (!isAppReady) {
            Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {
                // show skeleton while loading
                Box(modifier = Modifier.statusBarsPadding()) { HomeScreenShimmer() }
            }
        } else {
            Box(modifier = Modifier.fillMaxSize()) {
                val showBottomUi = !playerViewModel.isPlayerExpanded
                val navBackStackEntry by navController.currentBackStackEntryAsState()
                val currentDestination = navBackStackEntry?.destination
                val isLoginOrWelcome = currentDestination?.route == Screen.Login.route || currentDestination?.route == Screen.Welcome.route
    
                Scaffold(
                    snackbarHost = { SnackbarHost(hostState = snackbarHostState) },
                    bottomBar = {
                        // hide nav bar if player is full screen
                        if (!isLoginOrWelcome) {
                            AnimatedVisibility(visible = showBottomUi, enter = slideInVertically { it }, exit = slideOutVertically { it }) {
                                NavigationBar(tonalElevation = 0.dp, containerColor = MaterialTheme.colorScheme.surface) {
                                    bottomNavItems.forEach { screen ->
                                        if (screen.icon != null) {
                                            val isSelected = currentDestination?.hierarchy?.any { it.route == screen.route } == true
                                            NavigationBarItem(
                                                icon = { Icon(screen.icon, contentDescription = stringResource(screen.titleResId)) },
                                                label = { Text(stringResource(screen.titleResId)) },
                                                selected = isSelected,
                                                onClick = {
                                                    if (screen.route == Screen.Home.route && homeViewModel.isSearching) {
                                                        homeViewModel.clearSearch()
                                                    } else {
                                                        navController.navigate(screen.route) {
                                                            popUpTo(navController.graph.findStartDestination().id)
                                                            launchSingleTop = true
                                                        }
                                                    }
                                                }
                                            )
                                        }
                                    }
                                }
                            }
                        }
                    }
                ) { innerPadding ->
                    // navigation graph
                    NavHost(navController = navController, startDestination = startDestination, modifier = Modifier.padding(innerPadding)) {
                        composable(Screen.Welcome.route) {
                            WelcomeScreen(
                                onLoginClick = { navController.navigate(Screen.Login.route) },
                                onGuestClick = {
                                    isGuestLoading = true
                                    scope.launch {
                                        delay(8000)
                                        if (isGuestLoading) {
                                            val tm = TokenManager(context)
                                            tm.setGuestMode(true)
                                            homeViewModel.loadData()
                                            isGuestLoading = false
                                            navController.navigate(Screen.Home.route) { popUpTo(Screen.Welcome.route) { inclusive = true } }
                                        }
                                    }
                                },
                                isGuestLoading = isGuestLoading
                            )
                        }
                        composable(Screen.Home.route) {
                            HomeScreen(playerViewModel, homeViewModel, onNavigate = { id ->
                                if (id == "login_required" || id == "my_profile_menu") {
                                    showProfileMenu = true
                                } else if (id.startsWith("profile:")) {
                                    navController.navigate("profile/${id.removePrefix("profile:")}")
                                } else {
                                    navController.navigate("playlist_detail/$id")
                                }
                            })
                        }
                        composable(Screen.Library.route) {
                            LibraryScreen(
                                onLoginClick = { navController.navigate(Screen.Login.route) },
                                onLogoutClick = { showProfileMenu = true },
                                onPlaylistClick = { id ->
                                    if (id.startsWith("profile:")) {
                                        val userId = id.removePrefix("profile:")
                                        navController.navigate("profile/$userId")
                                    } else {
                                        navController.navigate("playlist_detail/$id")
                                    }
                                },
                                onLikedTracksClick = { navController.navigate("playlist_detail/likes") },
                                playerViewModel = playerViewModel
                            )
                        }
                        composable(Screen.Login.route) {
                            LoginScreen({
                                playerViewModel.fetchUserProfile()
                                SessionManager.reloadSession()
                                homeViewModel.loadData()
                                navController.navigate(Screen.Home.route) { popUpTo(0) }
                            }, { navController.popBackStack() })
                        }
                        composable("playlist_detail/{playlistId}", arguments = listOf(navArgument("playlistId") { type = NavType.StringType })) {
                            PlaylistDetailScreen(it.arguments?.getString("playlistId") ?: "", { navController.popBackStack() }, playerViewModel)
                        }
                        composable("profile/{userId}", arguments = listOf(navArgument("userId") { type = NavType.StringType })) {
                            ProfileScreen(it.arguments?.getString("userId") ?: "", { navController.popBackStack() }, playerViewModel, onNavigate = { id ->
                                if (id.startsWith("profile:")) navController.navigate("profile/${id.removePrefix("profile:")}")
                                else navController.navigate("playlist_detail/$id")
                            })
                        }
                        composable("tag/{tagName}", arguments = listOf(navArgument("tagName") { type = NavType.StringType })) {
                            TagScreen(it.arguments?.getString("tagName") ?: "", { navController.popBackStack() }, playerViewModel)
                        }
                        composable("track_detail/{trackId}?tab={tabIndex}", arguments = listOf(navArgument("trackId") { type = NavType.LongType }, navArgument("tabIndex") { type = NavType.IntType; defaultValue = 0 })) {
                            TrackDetailScreen(it.arguments?.getLong("trackId") ?: 0L, it.arguments?.getInt("tabIndex") ?: 0, { navController.popBackStack() }, onNavigate = { id ->
                                if (id.startsWith("profile:")) navController.navigate("profile/${id.removePrefix("profile:")}")
                                else navController.navigate("playlist_detail/$id")
                            }, playerViewModel)
                        }
                        composable("achievements") { AchievementsScreen { navController.popBackStack() } }
                        composable("settings") { SettingsScreen(navController, { navController.popBackStack() }, playerViewModel) }
                        composable("backup_restore") { com.alananasss.kittytune.ui.profile.BackupRestoreScreen(onBackClick = { navController.popBackStack() }) }
                        composable("audio_settings") { com.alananasss.kittytune.ui.profile.AudioSettingsScreen { navController.popBackStack() } }
                        composable("lyrics_settings") { com.alananasss.kittytune.ui.profile.LyricsSettingsScreen({ navController.popBackStack() }, playerViewModel) }
                        composable("local_media_settings") { com.alananasss.kittytune.ui.profile.LocalMediaSettingsScreen { navController.popBackStack() } }
                        composable("appearance_settings") { com.alananasss.kittytune.ui.profile.AppearanceSettingsScreen { navController.popBackStack() } }
                        composable("about") { AboutScreen { navController.popBackStack() } }
                        composable("storage") { StorageScreen(onBackClick = { navController.popBackStack() }) }
                    }
    
                    // show miniplayer above nav bar
                    AnimatedVisibility(visible = showBottomUi && playerViewModel.currentTrack != null, enter = slideInVertically(initialOffsetY = { it }), exit = slideOutVertically(targetOffsetY = { it }), modifier = Modifier.align(Alignment.BottomCenter).padding(innerPadding)) {
                        MiniPlayer(viewModel = playerViewModel, onClick = { playerViewModel.isPlayerExpanded = true })
                    }
                }
    
                // slide up animation for full player
                AnimatedVisibility(visible = playerViewModel.isPlayerExpanded, enter = slideInVertically(initialOffsetY = { it }, animationSpec = tween(400, easing = FastOutSlowInEasing)) + fadeIn(animationSpec = tween(400)), exit = slideOutVertically(targetOffsetY = { it }, animationSpec = tween(350, easing = FastOutLinearInEasing)) + fadeOut(animationSpec = tween(350)), modifier = Modifier.fillMaxSize()) {
                    PlayerScreen(viewModel = playerViewModel, onClose = { playerViewModel.isPlayerExpanded = false })
                }
    
                // lyrics overlay
                AnimatedVisibility(visible = playerViewModel.showLyricsSheet, enter = slideInVertically(initialOffsetY = { it }, animationSpec = tween(300)) + fadeIn(animationSpec = tween(300)), exit = slideOutVertically(targetOffsetY = { it }, animationSpec = tween(300)) + fadeOut(animationSpec = tween(300)), modifier = Modifier.fillMaxSize().zIndex(10f)) {
                    Box(modifier = Modifier.fillMaxSize().background(MaterialTheme.colorScheme.background)) {
                        playerViewModel.currentTrack?.let { track ->
                            AsyncImage(
                                model = track.fullResArtwork,
                                contentDescription = "",
                                contentScale = ContentScale.Crop,
                                modifier = Modifier.fillMaxSize().blur(80.dp).alpha(0.4f)
                            )
                            Box(modifier = Modifier.fillMaxSize().background(Color.Black.copy(0.6f)))
                        }
                        LyricsScreen(viewModel = playerViewModel, onClose = { playerViewModel.showLyricsSheet = false; playerViewModel.isSearchingLyrics = false })
                    }
                }
    
                // various bottom sheets
                if (playerViewModel.showMenuSheet) { ModalBottomSheet(onDismissRequest = { playerViewModel.showMenuSheet = false }, containerColor = MaterialTheme.colorScheme.surfaceContainer, sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)) { MenuSheetContent(playerViewModel); Spacer(Modifier.height(32.dp)) } }
                if (playerViewModel.showAddToPlaylistSheet) { ModalBottomSheet(onDismissRequest = { playerViewModel.showAddToPlaylistSheet = false }, containerColor = MaterialTheme.colorScheme.surfaceContainer, sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)) { AddToPlaylistContent(playerViewModel); Spacer(Modifier.height(32.dp)) } }
                if (playerViewModel.showDetailsSheet) { ModalBottomSheet(onDismissRequest = { playerViewModel.showDetailsSheet = false }, containerColor = MaterialTheme.colorScheme.surface, sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = false)) { playerViewModel.selectedTrackForSheet?.let { DetailsSheetContent(it, { playerViewModel.showDetailsSheet = false }, { playerViewModel.openComments() }, playerViewModel) } } }
                if (playerViewModel.showCommentsSheet) { ModalBottomSheet(onDismissRequest = { playerViewModel.showCommentsSheet = false }, containerColor = MaterialTheme.colorScheme.surface, sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)) { CommentsSheetContent(playerViewModel, { playerViewModel.showCommentsSheet = false }) } }
    
                if (showProfileMenu) {
                    val tokenManager = remember { TokenManager(context) }
                    val isGuest = tokenManager.isGuestMode()
                    ModalBottomSheet(onDismissRequest = { showProfileMenu = false }, containerColor = MaterialTheme.colorScheme.surface, sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)) {
                        ProfileMenuSheet(homeViewModel.userProfile, isGuest, { showProfileMenu = false }, { homeViewModel.userProfile?.id?.let { navController.navigate("profile/$it") } }, { navController.navigate("achievements") }, { navController.navigate("settings") }, {
                            if (isGuest) {
                                navController.navigate(Screen.Login.route)
                            } else {
                                tokenManager.logout()
                                navController.navigate(Screen.Welcome.route) { popUpTo(0) { inclusive = true } }
                                homeViewModel.loadData()
                            }
                        })
                        Spacer(Modifier.height(32.dp))
                    }
                }
    
                if (showCompletionScreen) { UltimateCompletionOverlay(onDismiss = { showCompletionScreen = false }) }
    
                AnimatedVisibility(
                    visible = currentNotification != null,
                    enter = slideInVertically(
                        // drop from top
                        initialOffsetY = { -it },
                        // bouncy spring effect
                        animationSpec = spring(
                            dampingRatio = Spring.DampingRatioMediumBouncy,
                            stiffness = Spring.StiffnessLow
                        )
                    ) + fadeIn(
                        animationSpec = tween(300)
                    ) + scaleIn(
                        // slight zoom in
                        initialScale = 0.8f,
                        animationSpec = spring(
                            dampingRatio = Spring.DampingRatioMediumBouncy,
                            stiffness = Spring.StiffnessLow
                        )
                    ),
                    exit = slideOutVertically(
                        // slide back up fast
                        targetOffsetY = { -it },
                        animationSpec = tween(durationMillis = 300, easing = FastOutLinearInEasing)
                    ) + fadeOut(
                        animationSpec = tween(durationMillis = 200)
                    ) + scaleOut(
                        // shrink a bit
                        targetScale = 0.8f,
                        animationSpec = tween(durationMillis = 300)
                    ),
                    modifier = Modifier
                        .align(Alignment.TopCenter)
                        .statusBarsPadding()
                        .padding(top = 12.dp)
                        .zIndex(11f)
                        // shadow to make it pop
                        .shadow(elevation = 8.dp, shape = CircleShape, spotColor = Color.Black)
                ) {
                    // use stable var for exit anim
                    animatingNotification?.let {
                        AchievementPopup(notification = it)
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/navigation/Screen.kt
================================================================================
    package com.alananasss.kittytune.ui.navigation
    
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.filled.Home
    import androidx.compose.material.icons.filled.LibraryMusic
    import androidx.compose.ui.graphics.vector.ImageVector
    import com.alananasss.kittytune.R
    
    sealed class Screen(val route: String, val titleResId: Int, val icon: ImageVector?) {
        data object Welcome : Screen("welcome", R.string.nav_welcome, null)
        data object Home : Screen("home", R.string.nav_home, Icons.Default.Home)
        data object Library : Screen("library", R.string.nav_library, Icons.Default.LibraryMusic)
        data object Login : Screen("login", R.string.nav_login, null)
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/audio/AudioProcessors.kt
================================================================================
    package com.alananasss.kittytune.ui.player.audio
    
    import androidx.media3.common.audio.AudioProcessor
    import androidx.media3.common.audio.BaseAudioProcessor
    import java.nio.ByteBuffer
    import kotlin.math.PI
    import kotlin.math.cos
    import kotlin.math.sin
    
    // --- 1. 8D AUDIO (Auto-Pan) ---
    class EightDAudioProcessor : BaseAudioProcessor() {
        private var enabled = false
        private var time: Double = 0.0
    
        fun setEnabled(enabled: Boolean) {
            this.enabled = enabled
            if (!enabled) time = 0.0
        }
    
        override fun onConfigure(inputAudioFormat: AudioProcessor.AudioFormat): AudioProcessor.AudioFormat {
            return inputAudioFormat // no format change
        }
    
        override fun queueInput(inputBuffer: ByteBuffer) {
            val remaining = inputBuffer.remaining()
            if (remaining == 0) return
    
            // if disabled, just pass through
            if (!enabled) {
                val buffer = replaceOutputBuffer(remaining)
                buffer.put(inputBuffer)
                buffer.flip()
                return
            }
    
            // make sure we have room
            val buffer = replaceOutputBuffer(remaining)
    
            while (inputBuffer.hasRemaining()) {
                // stereo required for 8d effect
                if (inputAudioFormat.channelCount == 2) {
                    // read 16-bit pcm
                    val left = inputBuffer.getShort().toFloat()
                    val right = inputBuffer.getShort().toFloat()
    
                    // simple oscillator logic
                    time += 0.00001 // rotation speed
                    val pan = sin(time) // -1.0 to 1.0
    
                    // volume modulation
                    val leftVol = (1.0 - pan) / 2.0
                    val rightVol = (1.0 + pan) / 2.0
    
                    val newLeft = (left * leftVol).toInt().toShort()
                    val newRight = (right * rightVol).toInt().toShort()
    
                    buffer.putShort(newLeft)
                    buffer.putShort(newRight)
                } else {
                    // mono pass-through
                    buffer.putShort(inputBuffer.getShort())
                }
            }
            buffer.flip()
        }
    }
    
    // --- 2. MULTI-FX (Bass Boost + Muffled) ---
    class FxAudioProcessor : BaseAudioProcessor() {
    
        private var isMuffled = false
        private var isBassBoost = false
    
        // filter state variables
        private var x1 = 0f; private var x2 = 0f
        private var y1 = 0f; private var y2 = 0f
        private var b0 = 0f; private var b1 = 0f; private var b2 = 0f
        private var a1 = 0f; private var a2 = 0f
    
        fun setEffects(muffled: Boolean, bassBoost: Boolean) {
            if (this.isMuffled != muffled || this.isBassBoost != bassBoost) {
                this.isMuffled = muffled
                this.isBassBoost = bassBoost
                calculateCoefficients()
            }
        }
    
        override fun onConfigure(inputAudioFormat: AudioProcessor.AudioFormat): AudioProcessor.AudioFormat {
            calculateCoefficients()
            return inputAudioFormat
        }
    
        private fun calculateCoefficients() {
            val fs = inputAudioFormat.sampleRate.toFloat().coerceAtLeast(44100f)
    
            if (isMuffled) {
                // --- LOW PASS FILTER (Muffled) ---
                val f0 = 800f // cutoff freq
                val q = 0.707f
                val w0 = (2.0 * PI * f0 / fs).toFloat()
                val alpha = (sin(w0) / (2.0 * q)).toFloat()
                val cosW0 = cos(w0).toFloat()
    
                val a0 = 1f + alpha
                b0 = ((1f - cosW0) / 2f) / a0
                b1 = (1f - cosW0) / a0
                b2 = ((1f - cosW0) / 2f) / a0
                a1 = (-2f * cosW0) / a0
                a2 = (1f - alpha) / a0
    
            } else if (isBassBoost) {
                // --- LOW SHELF FILTER (Bass Boost) ---
                val f0 = 100f // boost freq
                val gain = 10f // gain in dB
                val S = 1f
                val A = Math.pow(10.0, gain / 40.0).toFloat()
                val w0 = (2.0 * PI * f0 / fs).toFloat()
                val sinW0 = sin(w0).toFloat()
                val cosW0 = cos(w0).toFloat()
                val alpha = sinW0 / 2f * Math.sqrt(((A + 1f / A) * (1f / S - 1f) + 2f).toDouble()).toFloat()
                val beta = 2f * Math.sqrt(A.toDouble()).toFloat() * alpha
    
                val a0 = (A + 1f) + (A - 1f) * cosW0 + beta
                b0 = (A * ((A + 1f) - (A - 1f) * cosW0 + beta)) / a0
                b1 = (2f * A * ((A - 1f) - (A + 1f) * cosW0)) / a0
                b2 = (A * ((A + 1f) - (A - 1f) * cosW0 - beta)) / a0
                a1 = (-2f * ((A - 1f) + (A + 1f) * cosW0)) / a0
                a2 = ((A + 1f) + (A - 1f) * cosW0 - beta) / a0
            } else {
                resetState()
            }
        }
    
        private fun resetState() {
            x1 = 0f; x2 = 0f; y1 = 0f; y2 = 0f
            b0 = 1f; b1 = 0f; b2 = 0f; a1 = 0f; a2 = 0f
        }
    
        override fun queueInput(inputBuffer: ByteBuffer) {
            val remaining = inputBuffer.remaining()
            if (remaining == 0) return
    
            // pass-through if no effects active
            if (!isMuffled && !isBassBoost) {
                val buffer = replaceOutputBuffer(remaining)
                buffer.put(inputBuffer)
                buffer.flip()
                return
            }
    
            val buffer = replaceOutputBuffer(remaining)
    
            while (inputBuffer.hasRemaining()) {
                val x = inputBuffer.getShort().toFloat()
    
                // biquad filter implementation
                val y = b0 * x + b1 * x1 + b2 * x2 - a1 * y1 - a2 * y2
    
                // update state
                x2 = x1
                x1 = x
                y2 = y1
                y1 = y
    
                // hard clipping to avoid overflow
                val out = y.coerceIn(Short.MIN_VALUE.toFloat(), Short.MAX_VALUE.toFloat()).toInt().toShort()
                buffer.putShort(out)
            }
            buffer.flip()
        }
    }
    // --- 3. REVERB (Simple Delay Line) ---
    class ReverbAudioProcessor : BaseAudioProcessor() {
        private var enabled = false
        private var buffer: ShortArray = ShortArray(0)
        private var cursor = 0
        // params: 150ms delay, 0.5 decay
        private val delayMs = 150
        private val decay = 0.5f
    
        fun setEnabled(enabled: Boolean) {
            if (this.enabled != enabled) {
                this.enabled = enabled
                // clear buffer on disable
                if (!enabled) buffer = ShortArray(0)
            }
        }
    
        override fun onConfigure(inputAudioFormat: AudioProcessor.AudioFormat): AudioProcessor.AudioFormat {
            // calculate buffer size based on sample rate
            val bufferSize = (inputAudioFormat.sampleRate * (delayMs / 1000.0) * inputAudioFormat.channelCount).toInt()
            buffer = ShortArray(bufferSize)
            cursor = 0
            return inputAudioFormat
        }
    
        override fun queueInput(inputBuffer: ByteBuffer) {
            val remaining = inputBuffer.remaining()
            if (remaining == 0) return
    
            if (!enabled) {
                val outputBuffer = replaceOutputBuffer(remaining)
                outputBuffer.put(inputBuffer)
                outputBuffer.flip()
                return
            }
    
            val outputBuffer = replaceOutputBuffer(remaining)
    
            while (inputBuffer.hasRemaining()) {
                val inputSample = inputBuffer.getShort()
    
                // get the past sample
                val delayedSample = buffer[cursor]
    
                // mix: input + (echo * decay)
                // clamp to avoid crackling
                val outputSample = (inputSample + delayedSample * decay).toInt().coerceIn(Short.MIN_VALUE.toInt(), Short.MAX_VALUE.toInt()).toShort()
    
                // write output
                outputBuffer.putShort(outputSample)
    
                // feed back into delay line
                buffer[cursor] = outputSample
    
                cursor++
                if (cursor >= buffer.size) cursor = 0
            }
            outputBuffer.flip()
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/lyrics/LyricsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.player.lyrics
    
    import androidx.compose.animation.core.animateFloatAsState
    import androidx.compose.animation.core.tween
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.interaction.MutableInteractionSource
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.lazy.rememberLazyListState
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.text.KeyboardActions
    import androidx.compose.foundation.text.KeyboardOptions
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.rounded.Close
    import androidx.compose.material.icons.rounded.Search
    import androidx.compose.material.icons.rounded.Timer
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.blur
    import androidx.compose.ui.draw.scale
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.platform.LocalFocusManager
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.input.ImeAction
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.LyricsAlignment
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import com.alananasss.kittytune.utils.makeTimeString
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LyricsScreen(
        viewModel: PlayerViewModel,
        onClose: () -> Unit
    ) {
        val currentPosition = viewModel.currentPosition
        val lyrics = viewModel.lyricsLines
        val listState = rememberLazyListState()
    
        val isSearching = viewModel.isSearchingLyrics
    
        val fontSize = viewModel.lyricsFontSize
        val alignment = when(viewModel.lyricsAlignment) {
            LyricsAlignment.LEFT -> TextAlign.Left
            LyricsAlignment.CENTER -> TextAlign.Center
            LyricsAlignment.RIGHT -> TextAlign.Right
        }
    
        val activeIndex = remember(currentPosition, lyrics) {
            lyrics.indexOfFirst { currentPosition >= it.startTime && currentPosition < it.endTime }
                .takeIf { it != -1 }
                ?: lyrics.indexOfLast { currentPosition >= it.startTime }
        }
    
        LaunchedEffect(activeIndex) {
            if (activeIndex >= 0 && !listState.isScrollInProgress && !isSearching) {
                listState.animateScrollToItem(index = activeIndex)
            }
        }
    
        Scaffold(
            containerColor = Color.Transparent,
            topBar = {
                if (!isSearching) {
                    CenterAlignedTopAppBar(
                        title = {
                            Text(
                                stringResource(R.string.player_lyrics),
                                style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold),
                                color = Color.White
                            )
                        },
                        navigationIcon = {
                            IconButton(onClick = onClose) {
                                Icon(Icons.Rounded.Close, stringResource(R.string.btn_close), tint = Color.White)
                            }
                        },
                        actions = {
                            IconButton(onClick = { viewModel.isSearchingLyrics = true }) {
                                Icon(Icons.Rounded.Search, stringResource(R.string.lyrics_manual_search), tint = Color.White)
                            }
                        },
                        colors = TopAppBarDefaults.topAppBarColors(containerColor = Color.Transparent)
                    )
                }
            }
        ) { innerPadding ->
    
            BoxWithConstraints(modifier = Modifier.fillMaxSize().padding(innerPadding)) {
                val screenHeight = maxHeight
                val halfHeight = screenHeight / 2
    
                if (isSearching) {
                    SearchLyricsView(
                        viewModel = viewModel,
                        onCloseSearch = { viewModel.isSearchingLyrics = false }
                    )
                }
                else {
                    if (lyrics.isEmpty()) {
                        Column(
                            modifier = Modifier.fillMaxSize(),
                            verticalArrangement = Arrangement.Center,
                            horizontalAlignment = Alignment.CenterHorizontally
                        ) {
                            Text(stringResource(R.string.lyrics_no_data), color = Color.White.copy(0.7f), style = MaterialTheme.typography.titleMedium)
                            Spacer(Modifier.height(16.dp))
                            Button(
                                onClick = { viewModel.isSearchingLyrics = true },
                                colors = ButtonDefaults.buttonColors(containerColor = Color.White.copy(alpha = 0.2f))
                            ) {
                                Icon(Icons.Rounded.Search, null)
                                Spacer(Modifier.width(8.dp))
                                Text(stringResource(R.string.lyrics_manual_search))
                            }
                        }
                    } else {
                        LazyColumn(
                            state = listState,
                            contentPadding = PaddingValues(top = halfHeight - 50.dp, bottom = halfHeight),
                            modifier = Modifier.fillMaxSize(),
                            verticalArrangement = Arrangement.spacedBy(24.dp)
                        ) {
                            itemsIndexed(lyrics) { index, line ->
                                val isActive = index == activeIndex
    
                                val targetScale = if (isActive) 1.05f else 0.95f
                                val targetAlpha = if (isActive) 1f else 0.5f
                                val blurRadius = if (isActive) 0.dp else 2.dp
    
                                val scale by animateFloatAsState(targetScale, tween(400), label = "scale")
                                val alpha by animateFloatAsState(targetAlpha, tween(400), label = "alpha")
    
                                Text(
                                    text = line.text,
                                    style = MaterialTheme.typography.headlineMedium.copy(
                                        fontWeight = FontWeight.Bold,
                                        fontSize = fontSize.sp,
                                        lineHeight = (fontSize * 1.4).sp
                                    ),
                                    color = Color.White,
                                    textAlign = alignment,
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .padding(horizontal = 24.dp)
                                        .scale(scale)
                                        .alpha(alpha)
                                        .blur(blurRadius)
                                        .clickable(
                                            interactionSource = remember { MutableInteractionSource() },
                                            indication = null
                                        ) { viewModel.seekTo(line.startTime) }
                                )
                            }
                        }
    
                        Box(modifier = Modifier.align(Alignment.BottomCenter).padding(bottom = 32.dp)) {
                            Surface(
                                onClick = { viewModel.isSearchingLyrics = true },
                                shape = CircleShape,
                                color = Color.Black.copy(alpha = 0.4f),
                                contentColor = Color.White.copy(alpha = 0.8f)
                            ) {
                                Text(
                                    stringResource(R.string.lyrics_wrong),
                                    style = MaterialTheme.typography.labelSmall,
                                    modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
                                )
                            }
                        }
                    }
                }
            }
        }
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun SearchLyricsView(
        viewModel: PlayerViewModel,
        onCloseSearch: () -> Unit
    ) {
        val focusManager = LocalFocusManager.current
        var query by remember { mutableStateOf(viewModel.manualSearchQuery) }
    
        Column(modifier = Modifier.fillMaxSize().background(Color.Black.copy(alpha = 0.9f))) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.fillMaxWidth().padding(16.dp)
            ) {
                IconButton(onClick = onCloseSearch) {
                    Icon(Icons.Rounded.Close, stringResource(R.string.btn_close), tint = Color.White)
                }
                OutlinedTextField(
                    value = query,
                    onValueChange = { query = it },
                    modifier = Modifier.weight(1f),
                    placeholder = { Text(stringResource(R.string.lyrics_search_hint), color = Color.White.copy(0.5f)) },
                    singleLine = true,
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedTextColor = Color.White,
                        unfocusedTextColor = Color.White,
                        cursorColor = Color.White,
                        focusedBorderColor = Color.White,
                        unfocusedBorderColor = Color.White.copy(0.5f)
                    ),
                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Search),
                    keyboardActions = KeyboardActions(onSearch = {
                        viewModel.searchLyricsManual(query)
                        focusManager.clearFocus()
                    })
                )
                IconButton(onClick = {
                    viewModel.searchLyricsManual(query)
                    focusManager.clearFocus()
                }) {
                    Icon(Icons.Rounded.Search, stringResource(R.string.search_hint), tint = Color.White)
                }
            }
    
            if (viewModel.isLyricsLoading) {
                LinearProgressIndicator(modifier = Modifier.fillMaxWidth(), color = Color.White)
            }
    
            LazyColumn(
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(viewModel.lyricSearchResults) { result ->
                    Card(
                        onClick = { viewModel.selectLyricResult(result) },
                        colors = CardDefaults.cardColors(containerColor = Color.White.copy(alpha = 0.1f)),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Row(
                            modifier = Modifier.padding(16.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column(modifier = Modifier.weight(1f)) {
                                Text(result.name, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = Color.White, maxLines = 1, overflow = TextOverflow.Ellipsis)
                                Text(result.artistName, style = MaterialTheme.typography.bodyMedium, color = Color.White.copy(0.7f))
                                if (!result.albumName.isNullOrEmpty()) {
                                    Text(result.albumName, style = MaterialTheme.typography.bodySmall, color = Color.White.copy(0.5f), maxLines = 1)
                                }
                            }
                            Spacer(Modifier.width(8.dp))
                            Column(horizontalAlignment = Alignment.End) {
                                Text(makeTimeString((result.duration * 1000).toLong()), style = MaterialTheme.typography.labelSmall, color = Color.White.copy(0.7f))
                                if (!result.syncedLyrics.isNullOrEmpty()) {
                                    Icon(Icons.Rounded.Timer, null, tint = Color.Green, modifier = Modifier.size(16.dp))
                                }
                            }
                        }
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/lyrics/LyricsUtils.kt
================================================================================
    package com.alananasss.kittytune.ui.player.lyrics
    
    import com.mpatric.mp3agic.Mp3File
    import java.io.File
    import java.util.regex.Pattern
    
    // basic holder for a timed line
    data class LyricLine(
        val text: String,
        val startTime: Long,
        val endTime: Long
    )
    
    object LyricsUtils {
    
        // standard lrc regex: [mm:ss.xx] lyrics
        private val LRC_PATTERN = Pattern.compile("\\[(\\d{2}):(\\d{2})\\.(\\d{2,3})\\](.*)")
    
        fun parseLrc(lrcContent: String, totalDurationMs: Long): List<LyricLine> {
            val lines = lrcContent.split("\n")
            val parsedLines = mutableListOf<ParsedLineTemp>()
    
            for (line in lines) {
                val matcher = LRC_PATTERN.matcher(line.trim())
                if (matcher.matches()) {
                    val min = matcher.group(1)?.toLong() ?: 0
                    val sec = matcher.group(2)?.toLong() ?: 0
                    val msStr = matcher.group(3) ?: "00"
                    // handle 2 digit vs 3 digit milliseconds
                    val ms = if (msStr.length == 2) msStr.toLong() * 10 else msStr.toLong()
    
                    val text = matcher.group(4)?.trim() ?: ""
                    val startTime = (min * 60 * 1000) + (sec * 1000) + ms
    
                    if (text.isNotEmpty()) {
                        parsedLines.add(ParsedLineTemp(text, startTime))
                    }
                }
            }
    
            if (parsedLines.isEmpty()) return emptyList()
    
            // calculate end times based on the next line
            return parsedLines.mapIndexed { index, current ->
                val nextTime = if (index < parsedLines.size - 1) {
                    parsedLines[index + 1].startTime
                } else {
                    totalDurationMs
                }
                LyricLine(current.text, current.startTime, nextTime)
            }
        }
    
        private data class ParsedLineTemp(val text: String, val startTime: Long)
    
        // --- local extraction ---
        fun extractLocalLyrics(filePath: String): String? {
            return try {
                val file = File(filePath)
                if (!file.exists()) return null
    
                val mp3file = Mp3File(filePath)
                if (mp3file.hasId3v2Tag()) {
                    val tag = mp3file.id3v2Tag
                    // mp3agic handles the uslt tag magic
                    tag.lyrics
                } else {
                    null
                }
            } catch (e: Exception) {
                e.printStackTrace()
                null
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/MiniPlayer.kt
================================================================================
    package com.alananasss.kittytune.ui.player
    
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.rounded.Pause
    import androidx.compose.material.icons.rounded.PlayArrow
    import androidx.compose.material.icons.rounded.SkipNext
    import androidx.compose.material3.*
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    
    @Composable
    fun MiniPlayer(
        viewModel: PlayerViewModel,
        onClick: () -> Unit,
        modifier: Modifier = Modifier
    ) {
        val track = viewModel.currentTrack ?: return
    
        val progress = if (viewModel.duration > 0) {
            viewModel.currentPosition.toFloat() / viewModel.duration.toFloat()
        } else 0f
    
        Box(
            modifier = modifier
                .fillMaxWidth()
                .height(64.dp)
                .clip(RoundedCornerShape(topStart = 16.dp, topEnd = 16.dp))
                .clickable(onClick = onClick)
                .background(MaterialTheme.colorScheme.surfaceContainer)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier
                    .fillMaxSize()
                    .padding(horizontal = 12.dp)
            ) {
                AsyncImage(
                    model = track.fullResArtwork,
                    contentDescription = null,
                    contentScale = ContentScale.Crop,
                    modifier = Modifier
                        .size(48.dp)
                        .clip(RoundedCornerShape(8.dp))
                        .background(MaterialTheme.colorScheme.surfaceVariant)
                )
    
                Spacer(modifier = Modifier.width(12.dp))
    
                Column(
                    modifier = Modifier
                        .weight(1f)
                        .padding(vertical = 8.dp),
                    verticalArrangement = Arrangement.Center
                ) {
                    Text(
                        text = track.title ?: stringResource(R.string.untitled_track),
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Bold,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = track.user?.username ?: stringResource(R.string.unknown_artist),
                        style = MaterialTheme.typography.bodySmall,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
    
                IconButton(onClick = { viewModel.togglePlayPause() }) {
                    Icon(
                        imageVector = if (viewModel.isPlaying) Icons.Rounded.Pause else Icons.Rounded.PlayArrow,
                        contentDescription = stringResource(if (viewModel.isPlaying) R.string.btn_pause else R.string.btn_play),
                        tint = MaterialTheme.colorScheme.onSurface
                    )
                }
    
                IconButton(onClick = { viewModel.playNext() }) {
                    Icon(
                        imageVector = Icons.Rounded.SkipNext,
                        contentDescription = stringResource(R.string.menu_play_next),
                        tint = MaterialTheme.colorScheme.onSurface
                    )
                }
            }
    
            LinearProgressIndicator(
                progress = { progress },
                modifier = Modifier
                    .fillMaxWidth()
                    .height(2.dp)
                    .align(Alignment.BottomCenter),
                color = MaterialTheme.colorScheme.primary,
                trackColor = Color.Transparent
            )
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/PlayerModels.kt
================================================================================
    package com.alananasss.kittytune.ui.player
    
    enum class RepeatMode { NONE, ALL, ONE }
    
    data class AudioEffectsState(
        val speed: Float = 1f,
        val isPitchEnabled: Boolean = true,
        val is8DEnabled: Boolean = false,
        val isMuffledEnabled: Boolean = false,
        val isBassBoostEnabled: Boolean = false,
        val isReverbEnabled: Boolean = false
    )
    
    data class PlaybackContext(
        val displayText: String,
        val navigationId: String,
        val imageUrl: String? = null
    )

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/PlayerScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.player
    
    import android.content.Context
    import android.content.Intent
    import android.net.Uri
    import android.provider.OpenableColumns
    import android.view.HapticFeedbackConstants
    import android.widget.Toast
    import androidx.activity.compose.BackHandler
    import androidx.compose.animation.*
    import androidx.compose.animation.core.*
    import androidx.compose.foundation.BorderStroke
    import androidx.compose.foundation.background
    import androidx.compose.foundation.basicMarquee
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.gestures.detectDragGesturesAfterLongPress
    import androidx.compose.foundation.gestures.detectTapGestures
    import androidx.compose.foundation.gestures.detectVerticalDragGestures
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.grid.GridCells
    import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
    import androidx.compose.foundation.lazy.grid.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.text.ClickableText
    import androidx.compose.foundation.text.KeyboardActions
    import androidx.compose.foundation.text.KeyboardOptions
    import androidx.compose.foundation.interaction.MutableInteractionSource
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.rounded.Comment
    import androidx.compose.material.icons.automirrored.rounded.PlaylistPlay
    import androidx.compose.material.icons.automirrored.rounded.QueueMusic
    import androidx.compose.material.icons.automirrored.rounded.Send
    import androidx.compose.material.icons.filled.*
    import androidx.compose.material.icons.outlined.Cancel
    import androidx.compose.material.icons.outlined.Delete
    import androidx.compose.material.icons.outlined.FavoriteBorder
    import androidx.compose.material.icons.outlined.Share
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.blur
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.draw.scale
    import androidx.compose.ui.draw.shadow
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.graphicsLayer
    import androidx.compose.ui.graphics.luminance
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.input.pointer.pointerInput
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalDensity
    import androidx.compose.ui.platform.LocalUriHandler
    import androidx.compose.ui.platform.LocalView
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.SpanStyle
    import androidx.compose.ui.text.buildAnnotatedString
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.input.ImeAction
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import androidx.compose.ui.zIndex
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.local.PlayerBackgroundStyle
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.domain.Comment
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.utils.makeTimeString
    import kotlinx.coroutines.launch
    import java.io.File
    import java.text.SimpleDateFormat
    import java.util.Date
    import java.util.Locale
    import java.util.regex.Pattern
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun PlayerScreen(
        viewModel: PlayerViewModel,
        onClose: () -> Unit
    ) {
        val track = viewModel.currentTrack ?: return
        // handle back press if lyrics sheet is open
        BackHandler(enabled = !viewModel.showLyricsSheet, onBack = onClose)
    
        val context = LocalContext.current
        val prefs = remember { PlayerPreferences(context) }
        val backgroundStyle = remember { prefs.getPlayerStyle() }
    
        val queueSheetState = rememberBottomSheetScaffoldState()
        var showEffectsSheet by remember { mutableStateOf(false) }
        val scope = rememberCoroutineScope()
    
        val isQueueOpen = queueSheetState.bottomSheetState.currentValue == SheetValue.Expanded
    
        BackHandler(enabled = isQueueOpen) {
            scope.launch { queueSheetState.bottomSheetState.partialExpand() }
        }
    
        val animatedColor by animateColorAsState(
            targetValue = viewModel.backgroundColor,
            animationSpec = tween(durationMillis = 1000, easing = LinearEasing),
            label = "backgroundColor"
        )
    
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .pointerInput(Unit) { detectTapGestures { } }
        ) {
            // dynamic background based on settings
            when (backgroundStyle) {
                PlayerBackgroundStyle.BLUR -> {
                    Crossfade(
                        targetState = track.fullResArtwork,
                        animationSpec = tween(durationMillis = 1000, easing = LinearEasing),
                        label = "BlurBackgroundTransition"
                    ) { artworkUrl ->
                        AsyncImage(
                            model = artworkUrl,
                            contentDescription = null,
                            contentScale = ContentScale.Crop,
                            modifier = Modifier.fillMaxSize().blur(80.dp).alpha(0.6f)
                        )
                    }
                    Box(Modifier.fillMaxSize().background(Color.Black.copy(alpha = 0.3f)))
                }
                PlayerBackgroundStyle.GRADIENT -> {
                    Box(
                        Modifier.fillMaxSize().background(
                            Brush.verticalGradient(
                                colors = listOf(
                                    animatedColor.copy(alpha = 0.7f),
                                    animatedColor.copy(alpha = 0.3f),
                                    MaterialTheme.colorScheme.background
                                )
                            )
                        )
                    )
                }
                PlayerBackgroundStyle.THEME -> {
                    Box(Modifier.fillMaxSize().background(MaterialTheme.colorScheme.surface))
                }
            }
    
            BottomSheetScaffold(
                scaffoldState = queueSheetState,
                sheetPeekHeight = 0.dp,
                sheetContainerColor = MaterialTheme.colorScheme.surfaceContainer,
                sheetShape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),
                sheetSwipeEnabled = false,
                sheetDragHandle = null,
                containerColor = Color.Transparent,
                sheetContent = {
                    QueueContent(
                        viewModel = viewModel,
                        onCloseQueue = { scope.launch { queueSheetState.bottomSheetState.partialExpand() } }
                    )
                }
            ) { paddingValues ->
                Box(modifier = Modifier.fillMaxSize().padding(paddingValues)) {
                    Column(
                        modifier = Modifier.fillMaxSize().padding(horizontal = 24.dp).systemBarsPadding(),
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        PlayerHeader(onClose, viewModel)
                        Spacer(modifier = Modifier.weight(1f))
    
                        // album art with shadow
                        AsyncImage(
                            model = track.fullResArtwork,
                            contentDescription = null,
                            contentScale = ContentScale.Crop,
                            modifier = Modifier.fillMaxWidth().aspectRatio(1f).shadow(24.dp, RoundedCornerShape(20.dp), spotColor = if (backgroundStyle == PlayerBackgroundStyle.THEME) Color.Black else animatedColor).clip(RoundedCornerShape(20.dp)).background(MaterialTheme.colorScheme.surfaceVariant)
                        )
                        Spacer(modifier = Modifier.height(32.dp))
    
                        // track info with marquee
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            Column(modifier = Modifier.weight(1f)) {
                                Text(text = track.title ?: stringResource(R.string.untitled_track), style = MaterialTheme.typography.headlineMedium.copy(fontWeight = FontWeight.Bold), color = MaterialTheme.colorScheme.onBackground, maxLines = 1, modifier = Modifier.basicMarquee())
                                Text(
                                    text = track.user?.username ?: stringResource(R.string.unknown_artist),
                                    style = MaterialTheme.typography.titleMedium,
                                    color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f),
                                    maxLines = 1,
                                    modifier = Modifier.basicMarquee().clickable { track.user?.id?.let { if (it > 0) viewModel.navigateToArtist(it) } }
                                )
                            }
                            IconButton(onClick = { viewModel.toggleLike() }) {
                                val heartColor by animateColorAsState(targetValue = if (viewModel.isLiked) Color(0xFFFF4081) else MaterialTheme.colorScheme.onSurfaceVariant, label = "heart")
                                Icon(imageVector = if (viewModel.isLiked) Icons.Filled.Favorite else Icons.Outlined.FavoriteBorder, contentDescription = stringResource(R.string.player_like_action), tint = heartColor, modifier = Modifier.size(32.dp))
                            }
                        }
                        Spacer(modifier = Modifier.weight(1f))
                        PlayerProgress(viewModel)
                        Spacer(modifier = Modifier.height(16.dp))
                        PlayerControls(viewModel = viewModel, animatedMainColor = animatedColor, onEffectsClick = { showEffectsSheet = true }, onQueueClick = { scope.launch { if (queueSheetState.bottomSheetState.currentValue == SheetValue.Expanded) queueSheetState.bottomSheetState.partialExpand() else queueSheetState.bottomSheetState.expand() } })
                        Spacer(modifier = Modifier.weight(1f))
                    }
    
                    // overlay to close queue when tapping outside
                    if (isQueueOpen) {
                        Box(
                            modifier = Modifier
                                .fillMaxSize()
                                .background(Color.Transparent)
                                .zIndex(2f) // keep above player controls
                                .clickable(
                                    interactionSource = remember { MutableInteractionSource() },
                                    indication = null
                                ) {
                                    scope.launch { queueSheetState.bottomSheetState.partialExpand() }
                                }
                        )
                    }
                }
            }
    
            if (showEffectsSheet) {
                ModalBottomSheet(
                    onDismissRequest = { showEffectsSheet = false },
                    containerColor = MaterialTheme.colorScheme.surfaceContainer,
                    sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)
                ) {
                    AudioControlDock(viewModel)
                    Spacer(Modifier.height(32.dp))
                }
            }
        }
    }
    
    @Composable
    fun PlayerHeader(onClose: () -> Unit, viewModel: PlayerViewModel) {
        val context = viewModel.currentContext
    
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(top = 16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onClose) {
                Icon(Icons.Default.KeyboardArrowDown, stringResource(R.string.btn_close), tint = MaterialTheme.colorScheme.onBackground)
            }
    
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                modifier = Modifier
                    .weight(1f)
                    .padding(horizontal = 8.dp)
            ) {
                Text(
                    stringResource(R.string.player_playing_now),
                    style = MaterialTheme.typography.labelSmall.copy(fontWeight = FontWeight.Bold, letterSpacing = 1.sp),
                    color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f)
                )
    
                if (context != null) {
                    Text(
                        text = context.displayText,
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.primary,
                        maxLines = 1,
                        modifier = Modifier
                            .basicMarquee()
                            .clickable { viewModel.navigateToContext() }
                    )
                }
            }
    
            IconButton(onClick = {
                viewModel.currentTrack?.let {
                    viewModel.showTrackOptions(it, fromPlayer = true)
                }
            }) {
                Icon(Icons.Default.MoreVert, stringResource(R.string.btn_options), tint = MaterialTheme.colorScheme.onBackground)
            }
        }
    }
    
    data class DockOptionItem(val icon: ImageVector, val text: String, val onClick: () -> Unit)
    
    @Composable
    fun MenuSheetContent(viewModel: PlayerViewModel) {
        val track = viewModel.trackForMenu ?: viewModel.currentTrack ?: return
        val context = LocalContext.current
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
        val storageTrigger by DownloadManager.storageTrigger.collectAsState()
    
        val isLocalFile = track.id < 0
        var showDeleteDialog by remember { mutableStateOf(false) }
    
        if (showDeleteDialog) {
            AlertDialog(
                onDismissRequest = { showDeleteDialog = false },
                title = { Text(if (isLocalFile) stringResource(R.string.menu_remove_local_q) else stringResource(R.string.menu_remove_download_q)) },
                text = { Text(if (isLocalFile) stringResource(R.string.menu_remove_local_body) else stringResource(R.string.menu_remove_download_body)) },
                confirmButton = {
                    TextButton(
                        onClick = {
                            DownloadManager.deleteTrack(track.id)
                            showDeleteDialog = false
                            viewModel.showMenuSheet = false
                        }
                    ) { Text(stringResource(R.string.btn_delete), color = MaterialTheme.colorScheme.error) }
                },
                dismissButton = { TextButton(onClick = { showDeleteDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        Column(modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp)) {
    
            Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.padding(bottom = 24.dp).padding(horizontal = 8.dp)) {
                AsyncImage(
                    model = track.fullResArtwork,
                    contentDescription = null,
                    modifier = Modifier.size(56.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant),
                    contentScale = ContentScale.Crop
                )
                Spacer(Modifier.width(16.dp))
                Column {
                    Text(
                        text = track.title ?: stringResource(R.string.untitled_track),
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                    Text(
                        text = track.user?.username ?: stringResource(R.string.unknown_artist),
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
    
            // build grid items list
            val gridItems = remember(viewModel.isMenuContextFromPlayer, isLocalFile, viewModel.menuContextPlaylistId) {
                mutableListOf<DockOptionItem>().apply {
                    if (viewModel.isMenuContextFromPlayer) {
                        add(DockOptionItem(Icons.Rounded.Shuffle, context.getString(R.string.menu_shuffle)) { viewModel.toggleShuffle(); viewModel.showMenuSheet = false })
                        add(DockOptionItem(Icons.Rounded.Repeat, context.getString(R.string.menu_repeat)) { viewModel.toggleRepeatMode() })
                    }
    
                    if (!viewModel.isMenuContextFromPlayer) {
                        add(DockOptionItem(Icons.AutoMirrored.Rounded.PlaylistPlay, context.getString(R.string.menu_play_next)) { viewModel.insertNext(listOf(track)); viewModel.showMenuSheet = false })
                        add(DockOptionItem(Icons.AutoMirrored.Rounded.QueueMusic, context.getString(R.string.menu_add_queue)) { viewModel.addToQueue(listOf(track)); viewModel.showMenuSheet = false })
                    }
    
                    if (!isLocalFile) {
                        add(DockOptionItem(Icons.AutoMirrored.Rounded.Comment, context.getString(R.string.menu_comments)) { viewModel.openComments(track) })
                    }
    
                    add(DockOptionItem(Icons.Rounded.Info, context.getString(R.string.menu_details)) { viewModel.openTrackDetails(track) })
                    add(DockOptionItem(Icons.Rounded.Description, context.getString(R.string.player_lyrics)) { viewModel.openLyrics(track) })
                    add(DockOptionItem(Icons.Default.Add, context.getString(R.string.menu_add_playlist)) { viewModel.showMenuSheet = false; viewModel.showAddToPlaylistSheet = true })
    
                    if (!isLocalFile) {
                        add(DockOptionItem(Icons.Default.Person, context.getString(R.string.menu_go_artist)) { track.user?.id?.let { viewModel.navigateToArtist(it) } })
                    }
    
                    if (viewModel.isMenuContextFromPlayer && !isLocalFile) {
                        add(DockOptionItem(Icons.Rounded.Radio, context.getString(R.string.menu_track_radio)) { viewModel.loadTrackStation() })
                    }
    
                    if (viewModel.menuContextPlaylistId != null && viewModel.menuContextPlaylistId!! < 0) {
                        add(DockOptionItem(Icons.Outlined.Delete, context.getString(R.string.menu_remove)) { viewModel.removeFromContextPlaylist(viewModel.menuContextPlaylistId!!, track) })
                    }
    
                    if (!viewModel.isMenuContextFromPlayer && track.id > 0 && !isLocalFile) {
                        add(DockOptionItem(Icons.Outlined.Share, context.getString(R.string.btn_share)) { viewModel.shareTrack(track) })
                    }
                }
            }
    
            LazyVerticalGrid(
                columns = GridCells.Fixed(3),
                verticalArrangement = Arrangement.spacedBy(24.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                modifier = Modifier.padding(bottom = 24.dp)
            ) {
                items(gridItems) { item ->
                    val activeColor = MaterialTheme.colorScheme.primary
                    val inactiveColor = MaterialTheme.colorScheme.onSurface
                    var tint = inactiveColor
                    var text = item.text
    
                    // highlight active states
                    if (item.text == stringResource(R.string.menu_shuffle) && viewModel.shuffleEnabled) {
                        tint = activeColor
                    }
                    if (item.text == stringResource(R.string.menu_repeat)) {
                        if (viewModel.repeatMode != RepeatMode.NONE) tint = activeColor
                        text = when (viewModel.repeatMode) {
                            RepeatMode.ALL -> stringResource(R.string.menu_repeat_all)
                            RepeatMode.ONE -> stringResource(R.string.menu_repeat_one)
                            else -> stringResource(R.string.menu_repeat)
                        }
                    }
    
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        modifier = Modifier.clickable { item.onClick() }
                    ) {
                        Icon(item.icon, null, modifier = Modifier.size(32.dp), tint = tint)
                        Spacer(Modifier.height(8.dp))
                        Text(
                            text = text,
                            style = MaterialTheme.typography.labelMedium,
                            textAlign = TextAlign.Center,
                            color = tint
                        )
                    }
                }
    
                if (!isLocalFile) {
                    item {
                        val trackId = track.id
                        val isDownloading = DownloadManager.isTrackDownloading(trackId)
                        val downloadProgressVal = downloadProgress[trackId]
                        val isDownloaded = remember(trackId, storageTrigger) {
                            File(context.filesDir, "track_${trackId}.mp3").exists()
                        }
    
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            modifier = Modifier.clickable {
                                if (isDownloaded) {
                                    showDeleteDialog = true
                                } else if (isDownloading) {
                                    DownloadManager.cancelDownload(trackId)
                                } else {
                                    DownloadManager.downloadTrack(track)
                                }
                            }
                        ) {
                            Box(contentAlignment = Alignment.Center, modifier = Modifier.size(32.dp)) {
                                if (isDownloading) {
                                    val animatedProgress by animateFloatAsState(targetValue = (downloadProgressVal ?: 0) / 100f, label = "progress")
                                    CircularProgressIndicator(progress = { animatedProgress }, modifier = Modifier.fillMaxSize(), strokeWidth = 3.dp)
                                    Icon(Icons.Outlined.Cancel, null, modifier = Modifier.size(18.dp))
                                } else {
                                    val icon = if (isDownloaded) Icons.Default.Delete else Icons.Rounded.Download
                                    val tint = if (isDownloaded) MaterialTheme.colorScheme.error else MaterialTheme.colorScheme.onSurface
                                    Icon(icon, null, modifier = Modifier.fillMaxSize(), tint = tint)
                                }
                            }
                            Spacer(Modifier.height(8.dp))
    
                            val textLabel = if (isDownloaded) stringResource(R.string.btn_delete) else if (isDownloading) stringResource(R.string.btn_cancel) else stringResource(R.string.btn_download)
                            val textColor = if (isDownloaded) MaterialTheme.colorScheme.error else MaterialTheme.colorScheme.onSurface
                            Text(textLabel, style = MaterialTheme.typography.labelMedium, textAlign = TextAlign.Center, color = textColor)
                        }
                    }
                }
            }
        }
    }
    @Composable
    fun AddToPlaylistContent(viewModel: PlayerViewModel) {
        val singleTrack = viewModel.trackForMenu
        val bulkTracks = viewModel.tracksToAddInBulk
        if (singleTrack == null && bulkTracks == null) return
    
        var showCreateInput by remember { mutableStateOf(false) }
        var newName by remember { mutableStateOf("") }
    
        Column(modifier = Modifier.fillMaxWidth().padding(horizontal = 24.dp)) {
            Text(
                if (bulkTracks != null) stringResource(R.string.add_to_playlist_title_multi, bulkTracks.size) else stringResource(R.string.add_to_playlist_title_single),
                style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold),
                modifier = Modifier.padding(bottom = 16.dp)
            )
    
            if (showCreateInput) {
                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth()) {
                    OutlinedTextField(
                        value = newName,
                        onValueChange = { newName = it },
                        label = { Text(stringResource(R.string.lib_create_playlist_hint)) },
                        modifier = Modifier.weight(1f),
                        singleLine = true
                    )
                    Spacer(Modifier.width(8.dp))
                    Button(onClick = {
                        if(newName.isNotBlank()) {
                            if (bulkTracks != null) viewModel.createAndAddTracksToPlaylist(newName, bulkTracks)
                            else if (singleTrack != null) viewModel.createAndAddToPlaylist(newName, singleTrack)
                        }
                    }) { Text(stringResource(R.string.btn_ok)) }
                }
                Spacer(Modifier.height(16.dp))
            } else {
                Surface(
                    onClick = { showCreateInput = true },
                    shape = RoundedCornerShape(12.dp),
                    color = MaterialTheme.colorScheme.primaryContainer,
                    modifier = Modifier.fillMaxWidth().height(56.dp)
                ) {
                    Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Center, modifier = Modifier.fillMaxSize()) {
                        Icon(Icons.Default.Add, null, tint = MaterialTheme.colorScheme.onPrimaryContainer)
                        Spacer(Modifier.width(8.dp))
                        Text(stringResource(R.string.add_to_playlist_new), style = MaterialTheme.typography.titleMedium, color = MaterialTheme.colorScheme.onPrimaryContainer, fontWeight = FontWeight.Bold)
                    }
                }
                Spacer(Modifier.height(16.dp))
            }
    
            LazyColumn(modifier = Modifier.fillMaxWidth().heightIn(max = 300.dp)) {
                itemsIndexed(items = viewModel.userPlaylists) { _, playlist ->
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable {
                                if (bulkTracks != null) viewModel.addTracksToPlaylist(playlist.id, bulkTracks)
                                else if (singleTrack != null) viewModel.addToPlaylist(playlist.id, singleTrack)
                            }
                            .padding(vertical = 12.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        AsyncImage(
                            model = playlist.localCoverPath ?: playlist.artworkUrl.ifEmpty { "https://picsum.photos/200" },
                            contentDescription = null,
                            modifier = Modifier.size(48.dp).clip(RoundedCornerShape(8.dp)).background(MaterialTheme.colorScheme.surfaceVariant),
                            contentScale = ContentScale.Crop
                        )
                        Spacer(Modifier.width(16.dp))
                        Column {
                            Text(playlist.title, style = MaterialTheme.typography.bodyLarge, fontWeight = FontWeight.Bold)
                            Text(stringResource(R.string.playlist_num_tracks, playlist.trackCount), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
                }
            }
        }
    }
    @Composable
    fun QueueContent(viewModel: PlayerViewModel, onCloseQueue: () -> Unit) {
        val itemHeight = 72.dp
        val itemHeightPx = with(LocalDensity.current) { itemHeight.toPx() }
        val view = LocalView.current
    
        Column(modifier = Modifier.fillMaxWidth().fillMaxHeight(0.6f).background(MaterialTheme.colorScheme.surfaceContainer).pointerInput(Unit) { detectTapGestures { } }) {
            Column(
                modifier = Modifier.fillMaxWidth().background(MaterialTheme.colorScheme.surfaceContainer)
                    .pointerInput(Unit) { detectVerticalDragGestures { change, dragAmount -> change.consume(); if (dragAmount > 10) onCloseQueue() } }
                    .padding(top = 24.dp, bottom = 16.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(text = stringResource(R.string.player_queue), style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold), modifier = Modifier.padding(horizontal = 24.dp))
            }
    
            LazyColumn(contentPadding = PaddingValues(bottom = 24.dp)) {
                itemsIndexed(items = viewModel.queueState, key = { index, track -> "${track.id}_$index" }) { index, track ->
                    val isCurrent = track.id == viewModel.currentTrack?.id
                    var offsetY by remember { mutableFloatStateOf(0f) }
                    var isDragging by remember { mutableStateOf(false) }
                    val elevation by animateDpAsState(if (isDragging) 8.dp else 0.dp, label = "elevation")
                    val scale by animateFloatAsState(if (isDragging) 1.02f else 1f, label = "scale")
                    val backgroundColor = if (isDragging) MaterialTheme.colorScheme.surfaceContainerHigh else MaterialTheme.colorScheme.surfaceContainer
    
                    Row(
                        modifier = Modifier.fillMaxWidth().height(itemHeight).zIndex(if (isDragging) 1f else 0f)
                            .graphicsLayer { translationY = offsetY; scaleX = scale; scaleY = scale; shadowElevation = elevation.toPx() }
                            .background(backgroundColor)
                            .clickable {
                                viewModel.skipToQueueItem(index)
                            }
                            .padding(horizontal = 24.dp, vertical = 8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        AsyncImage(
                            model = track.fullResArtwork, contentDescription = null, contentScale = ContentScale.Crop,
                            modifier = Modifier.size(56.dp).clip(RoundedCornerShape(12.dp)).background(MaterialTheme.colorScheme.surfaceVariant)
                        )
                        Spacer(modifier = Modifier.width(16.dp))
                        Column(modifier = Modifier.weight(1f)) {
                            Text(text = track.title ?: stringResource(R.string.generic_title), style = MaterialTheme.typography.bodyLarge, fontWeight = if (isCurrent) FontWeight.Bold else FontWeight.Medium, color = if (isCurrent) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurface, maxLines = 1)
                            Text(text = track.user?.username ?: stringResource(R.string.generic_artist), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant, maxLines = 1)
                        }
                        Icon(
                            imageVector = Icons.Rounded.DragHandle, contentDescription = "Move",
                            tint = if (isDragging) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f),
                            modifier = Modifier.size(32.dp).pointerInput(Unit) {
                                detectDragGesturesAfterLongPress(
                                    onDragStart = { isDragging = true; view.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS) },
                                    onDragEnd = { isDragging = false; offsetY = 0f },
                                    onDragCancel = { isDragging = false; offsetY = 0f },
                                    onDrag = { change, dragAmount ->
                                        change.consume()
                                        offsetY += dragAmount.y
                                        if (offsetY > itemHeightPx) {
                                            val nextIndex = index + 1
                                            if (nextIndex < viewModel.queueState.size) { viewModel.moveQueueItem(index, nextIndex); offsetY -= itemHeightPx; view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK) }
                                        } else if (offsetY < -itemHeightPx) {
                                            val prevIndex = index - 1
                                            if (prevIndex >= 0) { viewModel.moveQueueItem(index, prevIndex); offsetY += itemHeightPx; view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK) }
                                        }
                                    }
                                )
                            }
                        )
                    }
                }
            }
        }
    }
    @Composable
    fun PlayerProgress(viewModel: PlayerViewModel) {
        val view = LocalView.current
        var isDragging by remember { mutableStateOf(false) }
        var dragPosition by remember { mutableFloatStateOf(0f) }
        val totalDuration = viewModel.duration.coerceAtLeast(1L).toFloat()
        val currentPos = viewModel.currentPosition.coerceAtMost(viewModel.duration).toFloat()
    
        val progressState = remember { Animatable(0f) }
        val sliderPosition = if (isDragging) dragPosition else progressState.value
    
        LaunchedEffect(currentPos, isDragging) {
            if (!isDragging) {
                val target = currentPos
                val distance = kotlin.math.abs(progressState.value - target)
                // snap if too far
                if (distance > 2000f) {
                    progressState.animateTo(target, tween(400, easing = FastOutSlowInEasing))
                } else {
                    progressState.animateTo(target, tween(1000, easing = LinearEasing))
                }
            }
        }
    
        Column(modifier = Modifier.fillMaxWidth()) {
            val rangeEnd = kotlin.math.max(totalDuration, sliderPosition)
            Slider(
                value = sliderPosition.coerceIn(0f, rangeEnd),
                valueRange = 0f..rangeEnd,
                onValueChange = {
                    isDragging = true
                    dragPosition = it
                    view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK)
                },
                onValueChangeFinished = {
                    viewModel.seekTo(dragPosition.toLong())
                    isDragging = false
                },
                colors = SliderDefaults.colors(
                    thumbColor = MaterialTheme.colorScheme.onBackground,
                    activeTrackColor = MaterialTheme.colorScheme.onBackground,
                    inactiveTrackColor = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.2f)
                ),
                modifier = Modifier.fillMaxWidth()
            )
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Text(
                    text = makeTimeString(sliderPosition.toLong()),
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.6f)
                )
                Text(
                    text = makeTimeString(totalDuration.toLong()),
                    style = MaterialTheme.typography.labelSmall,
                    color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.6f)
                )
            }
        }
    }
    
    @OptIn(ExperimentalAnimationApi::class)
    @Composable
    fun PlayerControls(viewModel: PlayerViewModel, onEffectsClick: () -> Unit, onQueueClick: () -> Unit, animatedMainColor: Color = MaterialTheme.colorScheme.primary) {
        val buttonWidth by animateDpAsState(targetValue = if (viewModel.isPlaying) 110.dp else 72.dp, animationSpec = spring(dampingRatio = Spring.DampingRatioMediumBouncy, stiffness = Spring.StiffnessLow), label = "width")
        val buttonColor = if (viewModel.isPlaying) animatedMainColor else MaterialTheme.colorScheme.surfaceVariant
    
        val isButtonLight = buttonColor.luminance() > 0.4f
    
        val targetContentColor = if (viewModel.isPlaying) {
            if (isButtonLight) Color(0xFF1D1B20) else Color.White
        } else {
            MaterialTheme.colorScheme.onSurfaceVariant
        }
    
        val contentColor by animateColorAsState(targetValue = targetContentColor, label = "contentColor")
    
        Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
            IconButton(onClick = onEffectsClick) { Icon(Icons.Default.Equalizer, stringResource(R.string.player_effects), tint = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f), modifier = Modifier.size(28.dp)) }
            Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                IconButton(onClick = { viewModel.smartPrevious() }, modifier = Modifier.size(48.dp)) { Icon(Icons.Rounded.SkipPrevious, null, tint = MaterialTheme.colorScheme.onBackground, modifier = Modifier.size(36.dp)) }
    
                // bouncy play button
                Box(modifier = Modifier.height(72.dp).width(buttonWidth).clip(CircleShape).background(buttonColor).clickable { viewModel.togglePlayPause() }, contentAlignment = Alignment.Center) {
                    if (viewModel.isLoading) CircularProgressIndicator(color = contentColor, modifier = Modifier.size(24.dp), strokeWidth = 3.dp)
                    else AnimatedContent(targetState = viewModel.isPlaying, transitionSpec = { (scaleIn() + fadeIn()).togetherWith(scaleOut() + fadeOut()) }, label = "icon") { isPlaying ->
                        Icon(imageVector = if (isPlaying) Icons.Rounded.Pause else Icons.Rounded.PlayArrow, contentDescription = null, tint = contentColor, modifier = Modifier.size(32.dp))
                    }
                }
    
                IconButton(onClick = { viewModel.playNext() }, modifier = Modifier.size(48.dp)) { Icon(Icons.Rounded.SkipNext, null, tint = MaterialTheme.colorScheme.onBackground, modifier = Modifier.size(36.dp)) }
            }
            IconButton(onClick = onQueueClick) { Icon(Icons.AutoMirrored.Rounded.QueueMusic, stringResource(R.string.player_queue), tint = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f), modifier = Modifier.size(28.dp)) }
        }
    }
    
    @Composable
    fun AudioControlDock(viewModel: PlayerViewModel) {
        val view = LocalView.current
        Column(modifier = Modifier.fillMaxWidth().padding(horizontal = 24.dp)) {
            Text(stringResource(R.string.player_audio_settings), style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold), modifier = Modifier.padding(bottom = 24.dp))
            Column(modifier = Modifier.fillMaxWidth().clip(RoundedCornerShape(24.dp)).background(MaterialTheme.colorScheme.surfaceContainerHigh).padding(20.dp)) {
                Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        Icon(Icons.Default.Speed, null, tint = MaterialTheme.colorScheme.primary)
                        Spacer(Modifier.width(12.dp))
                        Text(text = "${viewModel.effectsState.speed}x", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                    }
                    FilterChip(
                        selected = viewModel.effectsState.isPitchEnabled,
                        onClick = { viewModel.togglePitchEnabled(!viewModel.effectsState.isPitchEnabled) },
                        label = { Text(stringResource(R.string.player_pitch)) },
                        leadingIcon = if (viewModel.effectsState.isPitchEnabled) { { Icon(Icons.Default.Check, null, modifier = Modifier.size(16.dp)) } } else null,
                        shape = CircleShape,
                        colors = FilterChipDefaults.filterChipColors(selectedContainerColor = MaterialTheme.colorScheme.primary, selectedLabelColor = MaterialTheme.colorScheme.onPrimary, selectedLeadingIconColor = MaterialTheme.colorScheme.onPrimary)
                    )
                }
                Spacer(Modifier.height(16.dp))
                Slider(
                    value = viewModel.effectsState.speed,
                    onValueChange = { if (it != viewModel.effectsState.speed) view.performHapticFeedback(HapticFeedbackConstants.CLOCK_TICK); viewModel.setCustomSpeed(it) },
                    valueRange = 0.5f..2.0f, steps = 14, modifier = Modifier.fillMaxWidth()
                )
            }
            Spacer(Modifier.height(24.dp))
            Text(stringResource(R.string.player_special_effects), style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurfaceVariant, modifier = Modifier.padding(bottom = 12.dp))
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                DockButton(stringResource(R.string.effect_bass_boost), Icons.Rounded.Bolt, viewModel.effectsState.isBassBoostEnabled, { viewModel.toggleBassBoost() }, Modifier.weight(1f))
                DockButton(stringResource(R.string.effect_8d), Icons.Rounded.SurroundSound, viewModel.effectsState.is8DEnabled, { viewModel.toggle8D() }, Modifier.weight(1f))
            }
            Spacer(Modifier.height(12.dp))
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                DockButton(stringResource(R.string.effect_muffled), Icons.Rounded.BlurOn, viewModel.effectsState.isMuffledEnabled, { viewModel.toggleMuffled() }, Modifier.weight(1f))
                DockButton(stringResource(R.string.effect_reverb), Icons.Rounded.GraphicEq, viewModel.effectsState.isReverbEnabled, { viewModel.toggleReverb() }, Modifier.weight(1f))
            }
        }
    }
    @Composable
    fun DockButton(label: String, icon: ImageVector, isActive: Boolean, onClick: () -> Unit, modifier: Modifier = Modifier) {
        val containerColor by animateColorAsState(if (isActive) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.surfaceContainerHigh, label = "Color")
        val contentColor by animateColorAsState(if (isActive) MaterialTheme.colorScheme.onPrimary else MaterialTheme.colorScheme.onSurface, label = "ContentColor")
        val cornerRadius by animateDpAsState(targetValue = if (isActive) 100.dp else 20.dp, animationSpec = spring(dampingRatio = Spring.DampingRatioMediumBouncy, stiffness = Spring.StiffnessLow), label = "Corner")
    
        Surface(onClick = onClick, modifier = modifier.height(80.dp), shape = RoundedCornerShape(cornerRadius), color = containerColor) {
            Column(verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.fillMaxSize()) {
                val iconScale by animateFloatAsState(if (isActive) 1.1f else 1f, label = "Scale")
                Icon(imageVector = icon, contentDescription = null, tint = contentColor, modifier = Modifier.size(28.dp).graphicsLayer { scaleX = iconScale; scaleY = iconScale })
                Spacer(modifier = Modifier.height(4.dp))
                Text(text = label, style = MaterialTheme.typography.labelMedium, color = contentColor, fontWeight = if (isActive) FontWeight.Bold else FontWeight.Medium)
            }
        }
    }
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun CommentsSheetContent(
        viewModel: PlayerViewModel,
        onClose: () -> Unit
    ) {
        val comments = viewModel.commentsList
        val isLoading = viewModel.isCommentsLoading
        val context = LocalContext.current
    
        var fakeCommentText by remember { mutableStateOf("") }
    
        Scaffold(
            topBar = {
                Column {
                    CenterAlignedTopAppBar(
                        title = {
                            Text(
                                stringResource(R.string.menu_comments),
                                style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                            )
                        },
                        navigationIcon = {
                            IconButton(onClick = onClose) {
                                Icon(Icons.Rounded.KeyboardArrowDown, stringResource(R.string.btn_close))
                            }
                        },
                        colors = TopAppBarDefaults.topAppBarColors(
                            containerColor = MaterialTheme.colorScheme.surface
                        )
                    )
                    HorizontalDivider(color = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f))
                }
            },
            bottomBar = {
                Surface(
                    color = MaterialTheme.colorScheme.surface,
                    tonalElevation = 16.dp,
                    shadowElevation = 16.dp,
                    modifier = Modifier
                        .imePadding()
                        .navigationBarsPadding()
                ) {
                    Row(
                        modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),
                        verticalAlignment = Alignment.Bottom
                    ) {
                        TextField(
                            value = fakeCommentText,
                            onValueChange = { fakeCommentText = it },
                            placeholder = { Text(stringResource(R.string.add_comment_hint)) },
                            modifier = Modifier.weight(1f),
                            shape = RoundedCornerShape(24.dp),
                            colors = TextFieldDefaults.colors(
                                focusedIndicatorColor = Color.Transparent,
                                unfocusedIndicatorColor = Color.Transparent,
                                focusedContainerColor = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f),
                                unfocusedContainerColor = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f)
                            ),
                            maxLines = 4,
                            enabled = true,
                            keyboardOptions = KeyboardOptions(imeAction = ImeAction.Send),
                            keyboardActions = KeyboardActions(onSend = {
                                Toast.makeText(context, context.getString(R.string.dialog_comment_soon), Toast.LENGTH_SHORT).show()
                            })
                        )
                        Spacer(Modifier.width(8.dp))
    
                        IconButton(
                            onClick = {
                                Toast.makeText(context, context.getString(R.string.dialog_comment_soon), Toast.LENGTH_SHORT).show()
                            },
                            modifier = Modifier
                                .size(48.dp)
                                .background(MaterialTheme.colorScheme.primary, CircleShape)
                        ) {
                            Icon(
                                Icons.AutoMirrored.Rounded.Send,
                                stringResource(R.string.comment_send_action),
                                tint = MaterialTheme.colorScheme.onPrimary,
                                modifier = Modifier.padding(start = 2.dp)
                            )
                        }
                    }
                }
            },
            containerColor = MaterialTheme.colorScheme.surface
        ) { innerPadding ->
            if (comments.isEmpty() && isLoading) {
                Box(Modifier.fillMaxSize().padding(innerPadding), contentAlignment = Alignment.Center) {
                    CircularProgressIndicator()
                }
            } else if (comments.isEmpty()) {
                Box(Modifier.fillMaxSize().padding(innerPadding), contentAlignment = Alignment.Center) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Icon(Icons.Rounded.ChatBubbleOutline, null, modifier = Modifier.size(80.dp), tint = MaterialTheme.colorScheme.surfaceVariant)
                        Spacer(Modifier.height(16.dp))
                        Text(stringResource(R.string.comment_no_comments), style = MaterialTheme.typography.titleMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
            } else {
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(innerPadding),
                    contentPadding = PaddingValues(top = 16.dp, bottom = 16.dp),
                ) {
                    items(
                        count = comments.size,
                        key = { index -> comments[index].id }
                    ) { index ->
                        val comment = comments[index]
                        val userId = comment.user?.id ?: 0L
                        CommentRowItem(
                            comment = comment,
                            onNavigateToProfile = { if (userId != 0L) viewModel.navigateToArtist(userId) },
                            onSeekTo = { pos ->
                                val trackForComment = viewModel.selectedTrackForSheet
                                if (trackForComment != null) {
                                    if (trackForComment.id == viewModel.currentTrack?.id) {
                                        viewModel.seekTo(pos)
                                    } else {
                                        viewModel.playTrackAtPosition(trackForComment, pos)
                                    }
                                }
                            }
                        )
                        HorizontalDivider(
                            modifier = Modifier.padding(start = 72.dp, end = 16.dp),
                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.2f)
                        )
                    }
    
                    if (viewModel.commentNextHref != null) {
                        item {
                            LaunchedEffect(Unit) { viewModel.loadComments() }
                            Box(Modifier.fillMaxWidth().padding(24.dp), contentAlignment = Alignment.Center) {
                                CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
                            }
                        }
                    }
                }
            }
        }
    }
    @Composable
    fun CommentRowItem(
        comment: Comment,
        onNavigateToProfile: () -> Unit,
        onSeekTo: (Long) -> Unit
    ) {
        val context = LocalContext.current
        val avatarUrl = comment.user?.avatarUrl
        val username = comment.user?.username ?: stringResource(R.string.comment_anonymous)
    
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp)
        ) {
            Box(
                modifier = Modifier
                    .size(48.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.surfaceVariant)
                    .clickable { onNavigateToProfile() },
                contentAlignment = Alignment.Center
            ) {
                if (!avatarUrl.isNullOrEmpty()) {
                    AsyncImage(
                        model = avatarUrl,
                        contentDescription = null,
                        modifier = Modifier.fillMaxSize(),
                        contentScale = ContentScale.Crop
                    )
                } else {
                    Icon(
                        Icons.Default.Person,
                        contentDescription = stringResource(R.string.comment_default_avatar),
                        modifier = Modifier.size(28.dp),
                        tint = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
    
            Spacer(Modifier.width(16.dp))
    
            Column(modifier = Modifier.weight(1f)) {
                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth()) {
                    Text(
                        text = username,
                        style = MaterialTheme.typography.bodyMedium.copy(fontWeight = FontWeight.Bold),
                        color = MaterialTheme.colorScheme.onSurface,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis,
                        modifier = Modifier.weight(1f, fill = false).clickable { onNavigateToProfile() }
                    )
                    Spacer(Modifier.width(8.dp))
                    Text(
                        text = getRelativeTime(comment.createdAt, context),
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
    
                Spacer(Modifier.height(4.dp))
    
                Text(
                    text = comment.body,
                    style = MaterialTheme.typography.bodyLarge.copy(lineHeight = 22.sp),
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.9f)
                )
    
                Spacer(Modifier.height(8.dp))
    
                Row(verticalAlignment = Alignment.CenterVertically) {
                    if (comment.trackTimestamp != null) {
                        Surface(
                            onClick = { onSeekTo(comment.trackTimestamp) },
                            shape = RoundedCornerShape(8.dp),
                            color = MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.5f),
                            contentColor = MaterialTheme.colorScheme.primary
                        ) {
                            Row(
                                modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Icon(Icons.Rounded.PlayArrow, null, modifier = Modifier.size(12.dp))
                                Spacer(Modifier.width(4.dp))
                                Text(
                                    text = makeTimeString(comment.trackTimestamp),
                                    style = MaterialTheme.typography.labelSmall.copy(fontWeight = FontWeight.Bold)
                                )
                            }
                        }
                    }
    
                    Spacer(modifier = Modifier.weight(1f))
    
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier
                            .clip(RoundedCornerShape(50))
                            .clickable {
                                Toast.makeText(context, context.getString(R.string.dialog_like_soon), Toast.LENGTH_SHORT).show()
                            }
                            .padding(4.dp)
                    ) {
                        Icon(
                            imageVector = Icons.Rounded.FavoriteBorder,
                            contentDescription = stringResource(R.string.player_like_action),
                            tint = MaterialTheme.colorScheme.onSurfaceVariant,
                            modifier = Modifier.size(18.dp)
                        )
    
                        if (comment.likesCount > 0) {
                            Spacer(Modifier.width(4.dp))
                            Text(
                                text = formatNumber(comment.likesCount),
                                style = MaterialTheme.typography.labelSmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            }
        }
    }
    fun formatNumber(count: Int): String {
        if (count < 1000) return count.toString()
        val k = count / 1000.0
        val m = count / 1000000.0
        return when {
            m >= 1.0 -> String.format(Locale.US, "%.1fM", m)
            k >= 1.0 -> String.format(Locale.US, "%.1fk", k)
            else -> count.toString()
        }
    }
    
    fun getRelativeTime(dateStr: String, context: Context): String {
        try {
            val format = SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'", Locale.US)
            val date = format.parse(dateStr) ?: return ""
            val diff = System.currentTimeMillis() - date.time
    
            val seconds = diff / 1000
            val minutes = seconds / 60
            val hours = minutes / 60
            val days = hours / 24
            val weeks = days / 7
            val months = days / 30
            val years = days / 365
    
            return when {
                seconds < 60 -> context.getString(R.string.time_now)
                minutes < 60 -> context.getString(R.string.time_minutes_ago, minutes)
                hours < 24 -> context.getString(R.string.time_hours_ago, hours)
                days < 7 -> context.getString(R.string.time_days_ago, days)
                weeks < 5 -> context.getString(R.string.time_weeks_ago, weeks)
                months < 12 -> context.getString(R.string.time_months_ago, months)
                years == 1L -> context.getString(R.string.time_one_year_ago)
                else -> context.getString(R.string.time_years_ago, years)
            }
        } catch (e: Exception) { return "" }
    }
    
    @OptIn(ExperimentalLayoutApi::class)
    @Composable
    fun DetailsSheetContent(
        track: Track,
        onClose: () -> Unit,
        onOpenComments: () -> Unit,
        viewModel: PlayerViewModel
    ) {
        val context = LocalContext.current
        val uriHandler = LocalUriHandler.current
        val dateFormat = SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'", Locale.US)
        val displayFormat = SimpleDateFormat("d MMMM yyyy", Locale.getDefault())
    
        val isLocalFile = track.id < 0
    
        val releaseDateStr = remember(track) {
            if (isLocalFile) context.getString(R.string.detail_local_file) else {
                try {
                    val dateStr = track.releaseDate ?: track.createdAt
                    if (dateStr != null) {
                        val date = dateFormat.parse(dateStr)
                        displayFormat.format(date ?: Date())
                    } else context.getString(R.string.detail_unknown)
                } catch (e: Exception) { context.getString(R.string.detail_unknown) }
            }
        }
    
        val tags = remember(track.tagList) { parseSoundCloudTags(track.tagList) }
    
        var fileSizeStr by remember { mutableStateOf("") }
        var fileFormatStr by remember { mutableStateOf("Audio") }
        var cleanPathStr by remember { mutableStateOf("") }
    
        LaunchedEffect(track) {
            if (isLocalFile && !track.description.isNullOrEmpty()) {
                val rawPath = track.description?.removePrefix("Fichier local: ") ?: ""
                try {
                    val uri = Uri.parse(rawPath)
                    val ext = uri.path?.substringAfterLast('.', "")?.uppercase()
                    fileFormatStr = if (!ext.isNullOrEmpty()) ext else "MP3/Audio"
    
                    // get local file size
                    val cursor = context.contentResolver.query(uri, null, null, null, null)
                    cursor?.use {
                        if (it.moveToFirst()) {
                            val sizeIndex = it.getColumnIndex(OpenableColumns.SIZE)
                            if (sizeIndex != -1) {
                                val sizeBytes = it.getLong(sizeIndex)
                                val sizeMb = sizeBytes / (1024.0 * 1024.0)
                                fileSizeStr = context.getString(R.string.detail_file_size_formatted, sizeMb)
                            }
                        }
                    }
                    cleanPathStr = uri.path?.substringAfter("primary:")?.replace("/", " > ") ?: context.getString(R.string.detail_external_storage)
                } catch (e: Exception) { fileSizeStr = context.getString(R.string.detail_unknown) }
            }
        }
    
        LazyColumn(modifier = Modifier.fillMaxWidth().padding(horizontal = 24.dp).navigationBarsPadding()) {
            item {
                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.padding(bottom = 24.dp, top = 16.dp)) {
                    AsyncImage(model = track.fullResArtwork, contentDescription = null, modifier = Modifier.size(80.dp).clip(RoundedCornerShape(12.dp)).background(MaterialTheme.colorScheme.surfaceVariant), contentScale = ContentScale.Crop)
                    Spacer(Modifier.width(16.dp))
                    Column {
                        Text(track.title ?: stringResource(R.string.untitled_track), style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, maxLines = 2, overflow = TextOverflow.Ellipsis)
                        Text(text = track.user?.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.bodyLarge, color = MaterialTheme.colorScheme.primary, modifier = Modifier.clickable { onClose(); if (!isLocalFile) track.user?.id?.let { if (it > 0) viewModel.navigateToArtist(it) } })
                    }
                }
                HorizontalDivider(color = MaterialTheme.colorScheme.outlineVariant)
                Spacer(Modifier.height(16.dp))
            }
    
            if (isLocalFile) {
                item {
                    Text(stringResource(R.string.detail_file_info), style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.primary)
                    Spacer(Modifier.height(16.dp))
                    DetailInfoRow(stringResource(R.string.detail_format), fileFormatStr)
                    if (fileSizeStr.isNotEmpty()) DetailInfoRow(stringResource(R.string.detail_size), fileSizeStr)
                    DetailInfoRow(stringResource(R.string.detail_duration), makeTimeString(track.durationMs ?: 0L))
                    Spacer(Modifier.height(16.dp))
                    HorizontalDivider(color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f))
                    Spacer(Modifier.height(16.dp))
                    Text(stringResource(R.string.detail_location), style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.primary)
                    Spacer(Modifier.height(8.dp))
                    Text(text = cleanPathStr.ifEmpty { stringResource(R.string.storage_internal_mem) }, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                    Spacer(Modifier.height(32.dp))
                }
            } else {
                item {
                    Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween) {
                        DetailStatItem(Icons.Rounded.PlayArrow, formatNumber(track.playbackCount), stringResource(R.string.detail_stats_plays))
                        DetailStatItem(Icons.Rounded.Favorite, formatNumber(track.likesCount), stringResource(R.string.detail_stats_likes), onClick = { viewModel.navigateToTrackDetails(track.id, 0) })
                        DetailStatItem(Icons.Rounded.Repeat, formatNumber(track.repostsCount), stringResource(R.string.detail_stats_reposts), onClick = { viewModel.navigateToTrackDetails(track.id, 1) })
                    }
                    Spacer(Modifier.height(24.dp))
                }
                item {
                    OutlinedButton(onClick = { onClose(); viewModel.navigateToTrackDetails(track.id) }, modifier = Modifier.fillMaxWidth().height(50.dp), shape = RoundedCornerShape(50), border = BorderStroke(1.dp, MaterialTheme.colorScheme.outline.copy(alpha = 0.3f)), colors = ButtonDefaults.outlinedButtonColors(contentColor = MaterialTheme.colorScheme.onSurface)) {
                        Icon(Icons.Rounded.Hub, null, modifier = Modifier.size(20.dp)); Spacer(Modifier.width(12.dp)); Text(stringResource(R.string.detail_see_similar), fontWeight = FontWeight.SemiBold)
                    }
                    Spacer(Modifier.height(16.dp))
                }
                item {
                    Button(onClick = onOpenComments, modifier = Modifier.fillMaxWidth().height(56.dp), shape = RoundedCornerShape(16.dp), colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.secondaryContainer, contentColor = MaterialTheme.colorScheme.onSecondaryContainer)) {
                        Icon(Icons.AutoMirrored.Rounded.Comment, null); Spacer(Modifier.width(12.dp)); Text(stringResource(R.string.detail_see_comments, formatNumber(track.commentCount)), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold))
                    }
                    Spacer(Modifier.height(24.dp))
                }
                item {
                    DetailInfoRow(stringResource(R.string.detail_release_date), releaseDateStr)
                    if (!track.genre.isNullOrBlank()) DetailInfoRow(stringResource(R.string.detail_genre), track.genre)
                    Spacer(Modifier.height(16.dp))
                }
                if (!track.description.isNullOrBlank()) {
                    item {
                        Text(stringResource(R.string.detail_description), style = MaterialTheme.typography.titleSmall, fontWeight = FontWeight.Bold)
                        Spacer(Modifier.height(8.dp))
                        ExpandableDescription(text = track.description, onUrlClick = { url -> uriHandler.openUri(url) }, onMentionClick = { username -> onClose(); viewModel.resolveAndNavigateToArtist(username) })
                        Spacer(Modifier.height(24.dp))
                    }
                }
                if (tags.isNotEmpty()) {
                    item {
                        Text(stringResource(R.string.detail_tags), style = MaterialTheme.typography.titleSmall, fontWeight = FontWeight.Bold)
                        Spacer(Modifier.height(8.dp))
                        FlowRow(horizontalArrangement = Arrangement.spacedBy(8.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            tags.forEach { tag ->
                                AssistChip(onClick = { onClose(); viewModel.navigateToTag(tag) }, label = { Text("#${tag.uppercase()}") }, colors = AssistChipDefaults.assistChipColors(containerColor = MaterialTheme.colorScheme.surfaceContainerHigh, labelColor = MaterialTheme.colorScheme.onSurface), border = null, shape = CircleShape)
                            }
                        }
                        Spacer(Modifier.height(32.dp))
                    }
                }
            }
        }
    }
    
    fun parseSoundCloudTags(tagList: String?): List<String> {
        if (tagList.isNullOrBlank()) return emptyList()
        val tags = mutableListOf<String>()
        val pattern = Pattern.compile("\"([^\"]*)\"|(\\S+)")
        val matcher = pattern.matcher(tagList)
        while (matcher.find()) {
            if (matcher.group(1) != null) {
                tags.add(matcher.group(1)!!)
            } else {
                tags.add(matcher.group(2)!!)
            }
        }
        return tags
    }
    
    @Composable
    fun DetailStatItem(icon: ImageVector, value: String, label: String, onClick: () -> Unit = {}) {
        Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.clickable(onClick = onClick).padding(8.dp)) {
            Icon(icon, null, tint = MaterialTheme.colorScheme.primary, modifier = Modifier.size(28.dp))
            Spacer(Modifier.height(4.dp))
            Text(value, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
            Text(label, style = MaterialTheme.typography.labelSmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
        }
    }
    
    @Composable
    fun DetailInfoRow(label: String, value: String) {
        Row(Modifier.fillMaxWidth().padding(vertical = 8.dp), horizontalArrangement = Arrangement.SpaceBetween) {
            Text(label, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
            Text(value, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.Medium)
        }
    }
    
    @Composable
    fun ExpandableDescription(
        text: String,
        onUrlClick: (String) -> Unit,
        onMentionClick: (String) -> Unit
    ) {
        var isExpanded by remember { mutableStateOf(false) }
        // regex for links and mentions
        val urlPattern = Pattern.compile("((https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|])")
        val mentionPattern = Pattern.compile("@[\\w-]+")
        val annotatedString = buildAnnotatedString {
            val fullText = text
            append(fullText)
            val urlMatcher = urlPattern.matcher(fullText)
            while (urlMatcher.find()) {
                addStringAnnotation(tag = "URL", annotation = urlMatcher.group(), start = urlMatcher.start(), end = urlMatcher.end())
                addStyle(style = SpanStyle(color = MaterialTheme.colorScheme.primary, fontWeight = FontWeight.Bold), start = urlMatcher.start(), end = urlMatcher.end())
            }
            val mentionMatcher = mentionPattern.matcher(fullText)
            while (mentionMatcher.find()) {
                addStringAnnotation(tag = "MENTION", annotation = mentionMatcher.group(), start = mentionMatcher.start(), end = mentionMatcher.end())
                addStyle(style = SpanStyle(color = MaterialTheme.colorScheme.tertiary, fontWeight = FontWeight.SemiBold), start = mentionMatcher.start(), end = mentionMatcher.end())
            }
        }
        Column(modifier = Modifier.animateContentSize()) {
            ClickableText(
                text = annotatedString,
                style = MaterialTheme.typography.bodyMedium.copy(color = MaterialTheme.colorScheme.onSurfaceVariant, lineHeight = 20.sp),
                maxLines = if (isExpanded) Int.MAX_VALUE else 5,
                overflow = TextOverflow.Ellipsis,
                onClick = { offset ->
                    var isAnnotationClicked = false
                    annotatedString.getStringAnnotations(start = offset, end = offset).firstOrNull()?.let { annotation ->
                        when (annotation.tag) {
                            "URL" -> { onUrlClick(annotation.item); isAnnotationClicked = true }
                            "MENTION" -> { onMentionClick(annotation.item); isAnnotationClicked = true }
                        }
                    }
                    if (!isAnnotationClicked) isExpanded = !isExpanded
                }
            )
            if (text.length > 200) {
                Text(text = if (isExpanded) stringResource(R.string.detail_show_less) else stringResource(R.string.detail_show_more), style = MaterialTheme.typography.labelLarge, color = MaterialTheme.colorScheme.primary, modifier = Modifier.padding(top = 4.dp).clickable { isExpanded = !isExpanded })
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/player/PlayerViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.player
    
    import android.app.Application
    import android.content.Intent
    import android.content.res.Configuration
    import android.graphics.Bitmap
    import android.graphics.drawable.BitmapDrawable
    import android.net.Uri
    import android.os.Build
    import androidx.compose.runtime.*
    import androidx.compose.ui.graphics.Color
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import androidx.media3.common.MediaItem
    import androidx.media3.common.MediaMetadata
    import androidx.media3.common.Player
    import androidx.media3.exoplayer.ExoPlayer
    import androidx.palette.graphics.Palette
    import coil.ImageLoader
    import coil.request.ImageRequest
    import coil.request.SuccessResult
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.*
    import com.alananasss.kittytune.data.local.LocalPlaylist
    import com.alananasss.kittytune.data.local.LyricsAlignment
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.data.network.LrcLibClient
    import com.alananasss.kittytune.data.network.LrcLibResponse
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.*
    import com.alananasss.kittytune.ui.player.lyrics.LyricLine
    import com.alananasss.kittytune.ui.player.lyrics.LyricsUtils
    import com.alananasss.kittytune.utils.Config
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.delay
    import kotlinx.coroutines.flow.MutableSharedFlow
    import kotlinx.coroutines.flow.asSharedFlow
    import kotlinx.coroutines.isActive
    import kotlinx.coroutines.launch
    import kotlinx.coroutines.withContext
    import okhttp3.OkHttpClient
    import okhttp3.Request
    import org.json.JSONObject
    import java.io.ByteArrayOutputStream
    import java.io.File
    import kotlin.math.abs
    import kotlin.math.roundToInt
    
    class PlayerViewModel(application: Application) : AndroidViewModel(application) {
    
        private val api = RetrofitClient.create(application)
        private val context = application.applicationContext
        private val playerPrefs = PlayerPreferences(context)
    
        private val _uiEvent = MutableSharedFlow<String>()
        val uiEvent = _uiEvent.asSharedFlow()
    
        // player ui states
        var currentUserId: Long = 0L
        var currentTrack by mutableStateOf<Track?>(null)
        var isPlaying by mutableStateOf(false)
        var isLoading by mutableStateOf(false)
        var duration by mutableLongStateOf(0L)
        var currentPosition by mutableLongStateOf(0L)
        var isPlayerExpanded by mutableStateOf(false)
        var isLiked by mutableStateOf(false)
        var backgroundColor by mutableStateOf(Color(0xFF1E1E1E))
    
        var currentContext by mutableStateOf<PlaybackContext?>(null)
    
        // audio effects
        var effectsState by mutableStateOf(playerPrefs.getLastEffects())
    
        // queue logic
        var repeatMode by mutableStateOf(playerPrefs.getLastRepeatMode())
        var shuffleEnabled by mutableStateOf(playerPrefs.getLastShuffleEnabled())
        private var isAutoplayRadioLoading by mutableStateOf(false)
    
        // bottom sheets states
        var showMenuSheet by mutableStateOf(false)
        var navigateToPlaylistId by mutableStateOf<String?>(null)
        var trackForMenu by mutableStateOf<Track?>(null)
        var menuContextPlaylistId by mutableStateOf<Long?>(null)
        var isMenuContextFromPlayer by mutableStateOf(false)
    
        var selectedTrackForSheet by mutableStateOf<Track?>(null)
    
        var showDetailsSheet by mutableStateOf(false)
        var showCommentsSheet by mutableStateOf(false)
        val commentsList = mutableStateListOf<Comment>()
        var isCommentsLoading by mutableStateOf(false)
        var commentNextHref: String? = null
    
        var showAddToPlaylistSheet by mutableStateOf(false)
        var tracksToAddInBulk by mutableStateOf<List<Track>?>(null)
        val userPlaylists = mutableStateListOf<LocalPlaylist>()
    
        // queue data
        private val _originalQueue = mutableListOf<Track>()
        private val _queue = mutableListOf<Track>()
        val queue: List<Track> get() = _queue
        val queueState = mutableStateListOf<Track>()
        private var currentQueueIndex = -1
    
        val exoPlayer: ExoPlayer
    
        // --- LYRICS ---
        var showLyricsSheet by mutableStateOf(false)
        var lyricsLines = mutableStateListOf<LyricLine>()
        var isLyricsLoading by mutableStateOf(false)
        var isSearchingLyrics by mutableStateOf(false)
        var manualSearchQuery by mutableStateOf("")
        val lyricSearchResults = mutableStateListOf<LrcLibResponse>()
    
        // lyrics settings
        var lyricsFontSize by mutableFloatStateOf(playerPrefs.getLyricsFontSize())
        var lyricsAlignment by mutableStateOf(playerPrefs.getLyricsAlignment())
    
        private var pendingSeekPosition: Long? = null
    
        // helper to get strings
        private fun getString(resId: Int): String = getApplication<Application>().getString(resId)
        private fun getString(resId: Int, vararg args: Any): String = getApplication<Application>().getString(resId, *args)
    
    
        init {
            MusicManager.init(context)
            exoPlayer = MusicManager.player
            MusicManager.applyEffects(effectsState)
    
            MusicManager.onNextClick = { playNext(manual = true) }
            MusicManager.onPreviousClick = { smartPrevious() }
    
            // sync like state
            viewModelScope.launch {
                LikeRepository.likedTracks.collect { likedList ->
                    currentTrack?.let { track ->
                        isLiked = likedList.any { it.id == track.id }
                    }
                }
            }
    
            exoPlayer.addListener(object : Player.Listener {
                override fun onIsPlayingChanged(isPlayingState: Boolean) {
                    isPlaying = isPlayingState
                    saveStateAsync()
                    if (isPlayingState) startProgressUpdate()
                }
                override fun onPlaybackStateChanged(state: Int) {
                    if (state == Player.STATE_READY) {
                        isLoading = false
                        if (exoPlayer.duration > 0) duration = exoPlayer.duration
                        pendingSeekPosition?.let { exoPlayer.seekTo(it); pendingSeekPosition = null }
                    }
                    if (state == Player.STATE_BUFFERING) isLoading = true
                    if (state == Player.STATE_ENDED) {
                        AchievementManager.increment("no_skip_50")
                        AchievementManager.increment("plays_1")
    
                        // handle repeat one vs next track
                        if (repeatMode == RepeatMode.ONE) {
                            AchievementManager.increment("obsessed_50")
                            AchievementManager.increment("obsessed_200")
                            exoPlayer.seekTo(0)
                            exoPlayer.play()
                        } else {
                            playNext(manual = false)
                        }
                    }
                }
                override fun onPlayerError(error: androidx.media3.common.PlaybackException) {
                    isLoading = false; isPlaying = false; playNext(manual = false)
                }
                override fun onMediaItemTransition(mediaItem: MediaItem?, reason: Int) {
                    saveStateAsync()
                }
            })
    
            // load user playlists for the add menu
            viewModelScope.launch {
                DownloadManager.getAllPlaylistsFlow().collect { playlists ->
                    userPlaylists.clear()
                    val sorted = playlists.sortedWith(compareByDescending<LocalPlaylist> { it.isUserCreated || it.id < 0 }.thenByDescending { it.addedAt })
                    userPlaylists.addAll(sorted)
                }
            }
            restoreSession()
        }
    
        // --- LYRICS SETTINGS ---
        fun updateLyricsFontSize(size: Float) {
            lyricsFontSize = size
            playerPrefs.setLyricsFontSize(size)
        }
    
        fun updateLyricsAlignment(alignment: LyricsAlignment) {
            lyricsAlignment = alignment
            playerPrefs.setLyricsAlignment(alignment)
        }
    
        // --- NAVIGATION & UI ---
    
        fun navigateToTrackDetails(trackId: Long, initialTab: Int = 0) { showMenuSheet = false; showDetailsSheet = false; navigateToPlaylistId = "track_detail:$trackId?tab=$initialTab" }
        fun shareTrack(track: Track) {
            val appContext = getApplication<Application>().applicationContext
            val sendIntent = Intent().apply { action = Intent.ACTION_SEND; putExtra(Intent.EXTRA_TEXT, "https://soundcloud.com/tracks/${track.id}"); type = "text/plain" }
            val shareIntent = Intent.createChooser(sendIntent, getString(R.string.btn_share)).apply { flags = Intent.FLAG_ACTIVITY_NEW_TASK }
            appContext.startActivity(shareIntent)
            showMenuSheet = false
            AchievementManager.increment("social_butterfly"); AchievementManager.increment("social_star")
        }
        fun openTrackDetails(targetTrack: Track? = null) { val target = targetTrack ?: selectedTrackForSheet ?: trackForMenu ?: currentTrack ?: return; selectedTrackForSheet = target; showMenuSheet = false; showDetailsSheet = true }
        fun openComments(targetTrack: Track? = null) { val target = targetTrack ?: selectedTrackForSheet ?: trackForMenu ?: currentTrack ?: return; selectedTrackForSheet = target; showMenuSheet = false; showDetailsSheet = false; showCommentsSheet = true; loadComments(true, target) }
        fun resolveAndNavigateToArtist(username: String) {
            showDetailsSheet = false; isPlayerExpanded = false
            val cleanName = username.replace("@", "").trim()
            if (cleanName.isBlank()) return
            viewModelScope.launch { try { val user = api.resolveUrl("https://soundcloud.com/$cleanName"); if (user.id > 0) navigateToPlaylistId = "profile:${user.id}" } catch (e: Exception) { emitUiEvent(getString(R.string.error_generic)) } }
        }
        fun navigateToTag(tagName: String) { showDetailsSheet = false; isPlayerExpanded = false; navigateToPlaylistId = "tag:$tagName" }
        fun loadComments(refresh: Boolean = false, specificTrack: Track? = null) {
            val t = specificTrack ?: selectedTrackForSheet ?: trackForMenu ?: currentTrack ?: return
            if (refresh) { commentsList.clear(); commentNextHref = null }
            if (!refresh && commentNextHref == null && commentsList.isNotEmpty()) return
            viewModelScope.launch { if (refresh) isCommentsLoading = true; try { val response = if (refresh) api.getTrackComments(t.id) else api.getCommentsNextPage(commentNextHref!!); commentNextHref = response.next_href; commentsList.addAll(response.collection.filter { c -> commentsList.none { it.id == c.id } }) } catch (e: Exception) { e.printStackTrace() } finally { isCommentsLoading = false } }
        }
        fun navigateToContext() { currentContext?.let { navigateToPlaylistId = it.navigationId } }
    
        // --- LYRICS ---
        private fun loadLyrics(track: Track) {
            lyricsLines.clear()
            isLyricsLoading = true
            isSearchingLyrics = false
    
            val cleanTitle = cleanTitleNoise(track.title ?: "")
            val query = "$cleanTitle ${track.user?.username ?: ""}"
            manualSearchQuery = query
    
            viewModelScope.launch(Dispatchers.IO) {
                val preferLocal = playerPrefs.getLyricsPreferLocal()
                var localLyricsFound = false
    
                if (preferLocal) {
                    // check for embedded lyrics in local file
                    if (track.id < 0) {
                        val localTrack = DownloadManager.getLocalTrack(track.id)
                        if (localTrack != null && File(localTrack.localAudioPath).exists()) {
                            val rawLyrics = LyricsUtils.extractLocalLyrics(localTrack.localAudioPath)
                            if (!rawLyrics.isNullOrBlank()) {
                                val parsed = LyricsUtils.parseLrc(rawLyrics, track.durationMs ?: 0L)
                                val finalLines = if (parsed.isNotEmpty()) parsed else listOf(LyricLine(rawLyrics, 0, track.durationMs ?: 0L))
                                withContext(Dispatchers.Main) {
                                    lyricsLines.addAll(finalLines)
                                    isLyricsLoading = false
                                }
                                localLyricsFound = true
                            }
                        }
                    }
                    else {
                        val file = File(context.filesDir, "track_${track.id}.mp3")
                        if (file.exists()) {
                            val rawLyrics = LyricsUtils.extractLocalLyrics(file.absolutePath)
                            if (!rawLyrics.isNullOrBlank()) {
                                val parsed = LyricsUtils.parseLrc(rawLyrics, track.durationMs ?: 0L)
                                val finalLines = if (parsed.isNotEmpty()) parsed else listOf(LyricLine(rawLyrics, 0, track.durationMs ?: 0L))
                                withContext(Dispatchers.Main) {
                                    lyricsLines.addAll(finalLines)
                                    isLyricsLoading = false
                                }
                                localLyricsFound = true
                            }
                        }
                    }
                }
    
                // fetch from web if no local lyrics
                if (!localLyricsFound) {
                    try {
                        val results = LrcLibClient.api.searchLyrics(query)
                        val trackDurationSec = (track.durationMs ?: 0L) / 1000.0
                        // try to match duration to find the best sync
                        val bestMatch = results.filter { abs(it.duration - trackDurationSec) < 4.0 }.find { !it.syncedLyrics.isNullOrEmpty() } ?: results.firstOrNull()
                        processLyricsResponse(bestMatch, track.durationMs ?: 0L)
                    } catch (e: Exception) {
                        withContext(Dispatchers.Main) { isLyricsLoading = false }
                    }
                }
            }
        }
    
        private suspend fun processLyricsResponse(response: LrcLibResponse?, trackDuration: Long) {
            val resultLines = when { response == null -> emptyList(); !response.syncedLyrics.isNullOrEmpty() -> LyricsUtils.parseLrc(response.syncedLyrics, trackDuration); !response.plainLyrics.isNullOrEmpty() -> { val lines = response.plainLyrics.split("\n").filter { it.isNotBlank() }; val durPerLine = trackDuration / lines.size.coerceAtLeast(1); lines.mapIndexed { i, txt -> LyricLine(txt, i * durPerLine, (i + 1) * durPerLine) } } else -> emptyList() }
            withContext(Dispatchers.Main) { lyricsLines.clear(); lyricsLines.addAll(resultLines); isLyricsLoading = false; if (resultLines.isNotEmpty()) isSearchingLyrics = false }
        }
        fun searchLyricsManual(query: String) { if (query.isBlank()) return; isLyricsLoading = true; lyricSearchResults.clear(); viewModelScope.launch(Dispatchers.IO) { try { val results = LrcLibClient.api.searchLyrics(query); withContext(Dispatchers.Main) { lyricSearchResults.addAll(results) } } catch (e: Exception) { e.printStackTrace() } finally { withContext(Dispatchers.Main) { isLyricsLoading = false } } } }
        fun selectLyricResult(result: LrcLibResponse) { viewModelScope.launch(Dispatchers.IO) { processLyricsResponse(result, duration) } }
        // remove junk like (official video) for better search
        private fun cleanTitleNoise(title: String): String = title.replace(Regex("\\(.*?\\)|\\[.*?\\]"), "").replace(Regex("(?i)(official video|lyrics|ft\\.|feat\\.|prod\\.)"), "").trim()
        fun openLyrics(targetTrack: Track? = null) { val target = targetTrack ?: currentTrack ?: return; if (target.id != currentTrack?.id) playPlaylist(listOf(target), 0); showMenuSheet = false; showLyricsSheet = true }
    
        // --- PLAYBACK CONTROL ---
        fun playPlaylist(tracks: List<Track>, startIndex: Int = 0, context: PlaybackContext? = null) {
            if (tracks.isEmpty()) return; isPlayerExpanded = false; _originalQueue.clear(); _originalQueue.addAll(tracks); _queue.clear(); this.currentContext = context; val effectiveStartIndex = if (startIndex in tracks.indices) startIndex else 0; if (shuffleEnabled) applyShuffle(effectiveStartIndex, tracks) else _queue.addAll(tracks); updateQueueState(); if (context != null) { val isStation = context.navigationId.contains("station"); val isProfile = context.navigationId.contains("profile"); val idLong = context.navigationId.substringAfter(":").toLongOrNull() ?: 0L; val historyPlaylist = Playlist(idLong, context.displayText.substringAfter("â€¢").trim(), context.imageUrl, null, tracks.size, null, null); HistoryRepository.addToHistory(historyPlaylist, isStation, isProfile) }; playTrackAtIndex(if(shuffleEnabled) 0 else effectiveStartIndex, addToHistory = (context == null))
        }
        fun playTrackAtPosition(track: Track, position: Long) { pendingSeekPosition = position; playPlaylist(listOf(track), 0); showCommentsSheet = false; isPlayerExpanded = true }
        fun skipToQueueItem(index: Int) { playTrackAtIndex(index, addToHistory = false); AchievementManager.trackSkipped(); AchievementManager.increment("skipper_100"); AchievementManager.increment("skipper_1000") }
        private fun playTrackAtIndex(index: Int, addToHistory: Boolean = true) {
            if (index < 0 || index >= _queue.size) { currentContext = null; return }
            currentQueueIndex = index; val trackToPlay = _queue[index]; isLoading = true; duration = trackToPlay.durationMs ?: 0L; currentPosition = 0L
            viewModelScope.launch {
                var finalTrack = trackToPlay
                // fetch full info if needed (missing stream url)
                if (trackToPlay.user?.id == 0L || trackToPlay.media == null) {
                    try { val fullTrackList = api.getTracksByIds(trackToPlay.id.toString()); if (fullTrackList.isNotEmpty()) { finalTrack = fullTrackList[0]; _queue[index] = finalTrack; if (!_originalQueue.contains(finalTrack)) { val originalIndex = _originalQueue.indexOfFirst { it.id == finalTrack.id }; if (originalIndex != -1) _originalQueue[originalIndex] = finalTrack }; updateQueueState() } } catch (e: Exception) { e.printStackTrace() }
                }
                currentTrack = finalTrack; isLiked = LikeRepository.isTrackLiked(finalTrack.id); loadLyrics(finalTrack)
                MusicManager.currentTrack = finalTrack
                AchievementManager.checkTrackNameSecret(finalTrack.title ?: "")
                AchievementManager.increment("plays_1"); AchievementManager.increment("plays_100"); AchievementManager.increment("plays_1000"); AchievementManager.increment("plays_5000"); AchievementManager.increment("plays_10000"); AchievementManager.increment("plays_20000"); AchievementManager.increment("plays_50000"); AchievementManager.increment("plays_100000")
                saveStateAsync(); playRobustly(finalTrack); if (addToHistory && currentContext?.navigationId?.startsWith("station:") != true) HistoryRepository.addToHistory(finalTrack)
            }
        }
        fun playNext(manual: Boolean = true) {
            if (isAutoplayRadioLoading) return; val nextIndex = currentQueueIndex + 1
            if (manual) { AchievementManager.trackSkipped(); AchievementManager.increment("skipper_100"); AchievementManager.increment("skipper_1000") }
    
            if (nextIndex < _queue.size) {
                playTrackAtIndex(nextIndex, addToHistory = false)
            } else {
                if (repeatMode == RepeatMode.ALL) {
                    playTrackAtIndex(0, addToHistory = false)
                } else {
                    val autoPlayEnabled = playerPrefs.getAutoplayEnabled()
                    if (autoPlayEnabled) {
                        viewModelScope.launch {
                            // try to fetch station for endless playback
                            fetchAndQueueRadio()
                            val newNextIndex = currentQueueIndex + 1
                            if (newNextIndex < _queue.size) playTrackAtIndex(newNextIndex, addToHistory = false)
                            else { exoPlayer.pause(); exoPlayer.seekTo(0); currentContext = null; saveStateAsync() }
                        }
                    } else {
                        exoPlayer.pause()
                        exoPlayer.seekTo(0)
                    }
                }
            }
        }
        private suspend fun fetchAndQueueRadio() {
            val lastTrack = currentTrack ?: return; isAutoplayRadioLoading = true; try { val station = api.getTrackStation(lastTrack.id); if (station.tracks != null && station.tracks.isNotEmpty()) { val newTracks = station.tracks.filter { t -> _queue.none { it.id == t.id } }; _queue.addAll(newTracks); _originalQueue.addAll(newTracks); updateQueueState(); if (currentContext == null) currentContext = PlaybackContext("Radio â€¢ ${lastTrack.title}", "station:${lastTrack.id}", lastTrack.fullResArtwork) } } catch (e: Exception) { e.printStackTrace() } finally { isAutoplayRadioLoading = false }
        }
        fun smartPrevious() { if (exoPlayer.currentPosition > 3000) exoPlayer.seekTo(0) else { val prev = currentQueueIndex - 1; if (prev >= 0) playTrackAtIndex(prev, addToHistory = false) else exoPlayer.seekTo(0) } }
        fun toggleShuffle() { shuffleEnabled = !shuffleEnabled; if (shuffleEnabled) applyShuffle() else revertShuffle(); updateQueueState(); saveStateAsync() }
        private fun applyShuffle(startIndex: Int = currentQueueIndex, sourceList: List<Track> = _originalQueue) { if (sourceList.isEmpty() || startIndex < 0 || startIndex >= _queue.size) return; val upcoming = _queue.subList(startIndex + 1, _queue.size).shuffled(); val played = _queue.subList(0, startIndex + 1).toList(); _queue.clear(); _queue.addAll(played); _queue.addAll(upcoming) }
        private fun revertShuffle() { val currentTrackId = currentTrack?.id ?: return; _queue.clear(); _queue.addAll(_originalQueue); currentQueueIndex = _queue.indexOfFirst { it.id == currentTrackId }.coerceAtLeast(0) }
        fun toggleRepeatMode() { repeatMode = when (repeatMode) { RepeatMode.NONE -> RepeatMode.ALL; RepeatMode.ALL -> RepeatMode.ONE; RepeatMode.ONE -> RepeatMode.NONE }; saveStateAsync() }
        private fun updateQueueState() { queueState.clear(); queueState.addAll(_queue) }
        fun moveQueueItem(from: Int, to: Int) { if (from == to) return; val item = _queue.removeAt(from); _queue.add(to, item); if (!shuffleEnabled && from < _originalQueue.size && to < _originalQueue.size + 1) { val originalItem = _originalQueue.removeAt(from); _originalQueue.add(to, originalItem) }; updateQueueState(); saveStateAsync() }
        fun insertNext(tracks: List<Track>) { if (tracks.isEmpty()) return; val insertIndex = currentQueueIndex + 1; _queue.addAll(insertIndex, tracks); _originalQueue.addAll(insertIndex, tracks); updateQueueState(); saveStateAsync(); emitUiEvent(getString(R.string.menu_play_next)) }
        fun togglePlayPause() { if (exoPlayer.isPlaying) exoPlayer.pause() else exoPlayer.play() }
        fun seekTo(position: Long) { exoPlayer.seekTo(position); currentPosition = position; saveStateAsync() }
    
        // complex logic to play from file, cache or network
        private suspend fun playRobustly(track: Track, autoPlay: Boolean = true, startPosition: Long = 0L) {
            viewModelScope.launch(Dispatchers.IO) {
                val bitmap = loadBitmap(track.fullResArtwork)
                if (bitmap != null) {
                    // extract vibe color from album art
                    Palette.from(bitmap).generate { palette ->
                        val nightModeFlags = context.resources.configuration.uiMode and Configuration.UI_MODE_NIGHT_MASK
                        val isDarkMode = nightModeFlags == Configuration.UI_MODE_NIGHT_YES
    
                        val bestColor = if (isDarkMode) {
                            palette?.lightVibrantSwatch?.rgb
                                ?: palette?.lightMutedSwatch?.rgb
                                ?: palette?.vibrantSwatch?.rgb
                                ?: run {
                                    val dom = palette?.dominantSwatch?.rgb ?: 0xFF1E1E1E.toInt()
                                    if (isColorDark(dom)) 0xFF424242.toInt() else dom
                                }
                        } else {
                            palette?.darkVibrantSwatch?.rgb
                                ?: palette?.vibrantSwatch?.rgb
                                ?: palette?.dominantSwatch?.rgb
                                ?: 0xFF1E1E1E.toInt()
                        }
    
                        backgroundColor = Color(bestColor)
                    }
                }
                withContext(Dispatchers.Main) {
                    exoPlayer.stop()
                    exoPlayer.clearMediaItems()
                    try {
                        resolveAndPlay(track, bitmap, true, autoPlay, startPosition)
                    } catch (e: Exception) {
                        try {
                            resolveAndPlay(track, bitmap, false, autoPlay, startPosition)
                        } catch (e2: Exception) {
                            if (autoPlay) playNext(manual = false)
                        }
                    }
                }
            }
        }
    
        private fun isColorDark(color: Int): Boolean {
            val darkness = 1 - (0.299 * android.graphics.Color.red(color) + 0.587 * android.graphics.Color.green(color) + 0.114 * android.graphics.Color.blue(color)) / 255
            return darkness >= 0.5
        }
    
        // finds the actual audio url
        private suspend fun resolveAndPlay(track: Track, artworkBitmap: Bitmap?, useToken: Boolean, autoPlay: Boolean = true, startPosition: Long = 0L) {
            val localFile = File(context.filesDir, "track_${track.id}.mp3")
            if (localFile.exists() && localFile.length() > 0) {
                val mediaItem = buildMediaItem(track, Uri.fromFile(localFile), artworkBitmap)
                preparePlayer(mediaItem, startPosition, autoPlay)
                return
            }
    
            if (track.id < 0) {
                val localTrack = DownloadManager.getLocalTrack(track.id)
                if (localTrack != null && localTrack.localAudioPath.isNotEmpty()) {
                    val mediaItem = buildMediaItem(track, Uri.parse(localTrack.localAudioPath), artworkBitmap)
                    preparePlayer(mediaItem, startPosition, autoPlay)
                    return
                }
            }
    
            var validTrack = track
            if (track.media == null || track.media.transcodings.isNullOrEmpty()) {
                val fetched = withContext(Dispatchers.IO) { try { api.getTracksByIds(track.id.toString()) } catch (e: Exception) { emptyList() } }
                if (fetched.isNotEmpty()) validTrack = fetched[0] else throw Exception("Impossible de rÃ©cupÃ©rer les infos")
            }
    
            // try to find the best quality stream
            val transcodings = validTrack.media?.transcodings ?: throw Exception("Aucun format")
            val qualityPref = playerPrefs.getAudioQuality()
            val target = if (qualityPref == "HIGH") {
                transcodings.find { it.format?.protocol == "progressive" } ?: transcodings.find { it.format?.protocol == "hls" }
            } else {
                transcodings.find { it.format?.mimeType?.contains("opus") == true } ?: transcodings.find { it.format?.protocol == "hls" } ?: transcodings.find { it.format?.protocol == "progressive" }
            } ?: throw Exception("Aucun format valide")
            val client = OkHttpClient(); val urlWithId = if (target.url.contains("?")) "${target.url}&client_id=${Config.CLIENT_ID}" else "${target.url}?client_id=${Config.CLIENT_ID}"; val requestBuilder = Request.Builder().url(urlWithId); if (useToken) { val token = TokenManager(context).getAccessToken(); if (!token.isNullOrEmpty() && token != "null") requestBuilder.header("Authorization", "OAuth $token") }; val response = withContext(Dispatchers.IO) { client.newCall(requestBuilder.build()).execute() }; if (!response.isSuccessful) throw Exception("Erreur Stream: ${response.code}"); val finalStreamUrl = JSONObject(response.body!!.string()).getString("url"); val mediaItem = buildMediaItem(validTrack, Uri.parse(finalStreamUrl), artworkBitmap); preparePlayer(mediaItem, startPosition, autoPlay)
        }
    
        private fun buildMediaItem(track: Track, uri: Uri, bitmap: Bitmap?): MediaItem { val metadataBuilder = MediaMetadata.Builder().setTitle(track.title ?: "Unknown").setArtist(track.user?.username ?: "Unknown").setArtworkUri(Uri.parse(track.fullResArtwork)); if (bitmap != null) { val stream = ByteArrayOutputStream(); bitmap.compress(Bitmap.CompressFormat.JPEG, 90, stream); metadataBuilder.setArtworkData(stream.toByteArray(), MediaMetadata.PICTURE_TYPE_FRONT_COVER) }; return MediaItem.Builder().setUri(uri).setMediaId(track.id.toString()).setMediaMetadata(metadataBuilder.build()).build() }
        private suspend fun preparePlayer(mediaItem: MediaItem, startPos: Long, autoPlay: Boolean) { withContext(Dispatchers.Main) { exoPlayer.setMediaItem(mediaItem); exoPlayer.prepare(); if (startPos > 0) exoPlayer.seekTo(startPos); if (autoPlay) { startPlaybackServiceSafe(); exoPlayer.play() }; MusicManager.applyEffects(effectsState) } }
        private fun startPlaybackServiceSafe() { try { val intent = Intent(context, PlaybackService::class.java); if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) context.startForegroundService(intent) else context.startService(intent) } catch (e: Exception) { e.printStackTrace() } }
    
        // audio effects toggles
        fun setCustomSpeed(speed: Float) { val r = (speed * 10).roundToInt() / 10f; effectsState = effectsState.copy(speed = r); applyEffectsAndSave() }
        fun togglePitchEnabled(e: Boolean) { effectsState = effectsState.copy(isPitchEnabled = e); applyEffectsAndSave() }
        fun toggle8D() { effectsState = effectsState.copy(is8DEnabled = !effectsState.is8DEnabled); applyEffectsAndSave() }
        fun toggleMuffled() { val n = !effectsState.isMuffledEnabled; effectsState = effectsState.copy(isMuffledEnabled = n, isBassBoostEnabled = if(n) false else effectsState.isBassBoostEnabled); applyEffectsAndSave() }
        fun toggleBassBoost() { val n = !effectsState.isBassBoostEnabled; effectsState = effectsState.copy(isBassBoostEnabled = n, isMuffledEnabled = if(n) false else effectsState.isMuffledEnabled); applyEffectsAndSave(); if (n) AchievementManager.increment("bass_lover", 1) }
        fun toggleReverb() { effectsState = effectsState.copy(isReverbEnabled = !effectsState.isReverbEnabled); applyEffectsAndSave() }
        private fun applyEffectsAndSave() { MusicManager.applyEffects(effectsState); viewModelScope.launch(Dispatchers.IO) { playerPrefs.saveEffects(effectsState) } }
        fun toggleLike() {
            val t = currentTrack ?: return; isLiked = !isLiked
            if (isLiked) { LikeRepository.addLike(t); AchievementManager.increment("liker_50"); AchievementManager.increment("liker_1000"); AchievementManager.increment("liker_5000") } else { LikeRepository.removeLike(t.id) }
            val tokenManager = TokenManager(context); if (!tokenManager.isGuestMode() && !tokenManager.getAccessToken().isNullOrEmpty()) { viewModelScope.launch(Dispatchers.IO) { try { if (isLiked) api.likeComment(t.id) } catch (e: Exception) { e.printStackTrace() } } }
        }
        fun showTrackOptions(track: Track, playlistContextId: Long? = null, fromPlayer: Boolean = false) { trackForMenu = track; menuContextPlaylistId = playlistContextId; isMenuContextFromPlayer = fromPlayer; showMenuSheet = true }
        fun prepareBulkAdd(tracks: List<Track>) { tracksToAddInBulk = tracks; trackForMenu = null; showAddToPlaylistSheet = true }
        fun addToPlaylist(playlistId: Long, track: Track) { DownloadManager.addTrackToPlaylist(playlistId, track); showAddToPlaylistSheet = false; emitUiEvent(getString(R.string.success_generic)) }
        fun addTracksToPlaylist(playlistId: Long, tracks: List<Track>) { viewModelScope.launch(Dispatchers.IO) { tracks.forEach { DownloadManager.addTrackToPlaylist(playlistId, it) }; withContext(Dispatchers.Main) { showAddToPlaylistSheet = false; emitUiEvent(getString(R.string.success_generic)); AchievementManager.increment("playlist_creator") } } }
        fun createAndAddToPlaylist(name: String, track: Track) { val id = DownloadManager.createUserPlaylist(name); DownloadManager.addTrackToPlaylist(id, track); showAddToPlaylistSheet = false; emitUiEvent(getString(R.string.success_generic)); AchievementManager.increment("playlist_creator") }
        fun createAndAddTracksToPlaylist(name: String, tracks: List<Track>) { viewModelScope.launch(Dispatchers.IO) { val id = DownloadManager.createUserPlaylist(name); tracks.forEach { DownloadManager.addTrackToPlaylist(id, it) }; withContext(Dispatchers.Main) { showAddToPlaylistSheet = false; emitUiEvent(getString(R.string.success_generic)); AchievementManager.increment("playlist_creator") } } }
        fun removeFromContextPlaylist(playlistId: Long, track: Track) { DownloadManager.removeTrackFromPlaylist(playlistId, track.id); showMenuSheet = false; emitUiEvent(getString(R.string.success_generic)) }
        fun addToQueue(tracks: List<Track>) { if (tracks.isEmpty()) return; _queue.addAll(tracks); _originalQueue.addAll(tracks); updateQueueState(); saveStateAsync(); emitUiEvent(getString(R.string.menu_add_queue)) }
        fun downloadTrack(track: Track) { if (DownloadManager.isTrackDownloading(track.id)) return; DownloadManager.downloadTrack(track); AchievementManager.increment("download_100"); AchievementManager.increment("download_1000") }
        fun fetchUserProfile() { viewModelScope.launch { try { currentUserId = api.getMe().id } catch (_: Exception) {} } }
        fun loadTrackStation() { val t = currentTrack ?: return; showMenuSheet = false; navigateToPlaylistId = "station:${t.id}"; HistoryRepository.addToHistory(Playlist(t.id, "Station: ${t.title}", t.artworkUrl, null, 0, t.user, null), isStation = true) }
        fun navigateToArtist(id: Long) { showMenuSheet = false; showCommentsSheet = false; showDetailsSheet = false; isPlayerExpanded = false; navigateToPlaylistId = "profile:$id" }
        fun onNavigationHandled() { navigateToPlaylistId = null }
        private fun emitUiEvent(msg: String) { viewModelScope.launch { _uiEvent.emit(msg) } }
        private fun saveStateAsync() { val t = currentTrack; val p = exoPlayer.currentPosition; val q = _queue.toList(); val c = currentContext; viewModelScope.launch(Dispatchers.IO) { playerPrefs.savePlaybackState(t, p, q, c, shuffleEnabled, repeatMode) } }
    
        private fun startProgressUpdate() {
            viewModelScope.launch {
                val tokenManager = TokenManager(context); val isGuest = tokenManager.isGuestMode()
                while (isActive && isPlaying) {
                    currentPosition = exoPlayer.currentPosition.coerceAtLeast(0L)
                    AchievementManager.addPlayTime(1, isGuest, effectsState.speed)
                    if (effectsState.isBassBoostEnabled) AchievementManager.increment("bass_addict", 1)
                    delay(1000)
                }
            }
        }
    
        // bring back the state from last time
        private fun restoreSession() {
            viewModelScope.launch(Dispatchers.IO) {
                try {
                    val lastQueue = playerPrefs.getLastQueue()
                    val lastTrack = playerPrefs.getLastTrack()
                    val lastPosition = playerPrefs.getLastPosition()
                    val lastContext = playerPrefs.getLastContext()
                    val lastShuffle = playerPrefs.getLastShuffleEnabled()
                    val lastRepeat = playerPrefs.getLastRepeatMode()
    
                    withContext(Dispatchers.Main) {
                        if (lastQueue.isNotEmpty()) {
                            _queue.clear()
                            _queue.addAll(lastQueue)
                            _originalQueue.clear()
                            _originalQueue.addAll(lastQueue)
                            updateQueueState()
                        }
    
                        if (lastTrack != null) {
                            shuffleEnabled = lastShuffle
                            repeatMode = lastRepeat
                            currentContext = lastContext
                            currentTrack = lastTrack
    
                            // crucial: let the service know what track we have immediately
                            // this fixes the notification and like button state
                            MusicManager.currentTrack = lastTrack
    
                            // check like status
                            isLiked = LikeRepository.isTrackLiked(lastTrack.id)
    
                            loadLyrics(lastTrack)
    
                            currentQueueIndex = _queue.indexOfFirst { it.id == lastTrack.id }
                            if (currentQueueIndex == -1) {
                                _queue.add(0, lastTrack)
                                _originalQueue.add(0, lastTrack)
                                updateQueueState()
                                currentQueueIndex = 0
                            }
    
                            val currentPlayerMediaId = exoPlayer.currentMediaItem?.mediaId
                            val isSameTrack = currentPlayerMediaId == lastTrack.id.toString()
    
                            if (isSameTrack) {
                                isPlaying = exoPlayer.isPlaying
                                duration = exoPlayer.duration.coerceAtLeast(lastTrack.durationMs ?: 0L)
                                currentPosition = exoPlayer.currentPosition
                                MusicManager.applyEffects(effectsState)
                            } else {
                                currentPosition = lastPosition
                                duration = lastTrack.durationMs ?: 0L
                                playRobustly(lastTrack, autoPlay = false, startPosition = lastPosition)
                            }
                            delay(200)
                            val intent = Intent(context, PlaybackService::class.java).apply {
                                action = PlaybackService.ACTION_FORCE_UPDATE
                            }
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                                context.startForegroundService(intent)
                            } else {
                                context.startService(intent)
                            }
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                }
            }
        }    private suspend fun loadBitmap(url: String): Bitmap? { return try { val loader = ImageLoader(context); val request = ImageRequest.Builder(context).data(url).allowHardware(false).build(); (loader.execute(request) as? SuccessResult)?.drawable.let { (it as? BitmapDrawable)?.bitmap } } catch (e: Exception) { null } }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/AboutScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.widget.Toast
    import androidx.compose.animation.AnimatedVisibility
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.rememberScrollState
    import androidx.compose.ui.graphics.graphicsLayer
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.verticalScroll
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.automirrored.filled.OpenInNew
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalUriHandler
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.ui.common.AchievementNotification
    import com.alananasss.kittytune.ui.common.AchievementNotificationManager
    import com.alananasss.kittytune.utils.AppUtils
    import kotlinx.coroutines.launch
    
    // helper model for credits list
    data class Contributor(
        val name: String,
        val roleResId: Int, // using resource id for translation
        val url: String
    )
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun AboutScreen(onBackClick: () -> Unit) {
        val context = LocalContext.current
        val uriHandler = LocalUriHandler.current
        val appVersion = AppUtils.getAppVersion(context)
        val scope = rememberCoroutineScope()
        var tapCount by remember { mutableIntStateOf(0) }
    
        var showLicensesDialog by remember { mutableStateOf(false) }
        var showCreditsSheet by remember { mutableStateOf(false) }
    
        // --- CONTRIBUTORS LIST ---
        // add people here
        val contributors = listOf(
            Contributor("alananasss", R.string.about_role_dev, "https://github.com/alan7383"),
            Contributor("mattdotcat", R.string.about_role_translation, "https://t.me/b37246")
            // Contributor("New", R.string.role, "url"),
        )
    
        if (showLicensesDialog) {
            LicensesScreen(onDismiss = { showLicensesDialog = false })
        }
    
        if (showCreditsSheet) {
            ModalBottomSheet(
                onDismissRequest = { showCreditsSheet = false },
                containerColor = MaterialTheme.colorScheme.surface,
                sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 32.dp)
                ) {
                    Text(
                        text = stringResource(R.string.about_credits),
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.Bold,
                        modifier = Modifier.padding(start = 24.dp, bottom = 16.dp)
                    )
                    LazyColumn {
                        items(contributors) { person ->
                            ListItem(
                                headlineContent = { Text(person.name, fontWeight = FontWeight.SemiBold) },
                                supportingContent = { Text(stringResource(person.roleResId)) },
                                leadingContent = {
                                    Surface(
                                        shape = CircleShape,
                                        color = MaterialTheme.colorScheme.primaryContainer,
                                        modifier = Modifier.size(40.dp)
                                    ) {
                                        Box(contentAlignment = Alignment.Center) {
                                            Text(
                                                text = person.name.take(1).uppercase(),
                                                fontWeight = FontWeight.Bold,
                                                color = MaterialTheme.colorScheme.onPrimaryContainer
                                            )
                                        }
                                    }
                                },
                                modifier = Modifier.clickable { uriHandler.openUri(person.url) }
                            )
                        }
                    }
                }
            }
        }
    
        Scaffold(
            topBar = {
                LargeTopAppBar(
                    title = { Text(stringResource(R.string.pref_about_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_close))
                        }
                    },
                    colors = TopAppBarDefaults.largeTopAppBarColors(
                        containerColor = MaterialTheme.colorScheme.surface,
                        scrolledContainerColor = MaterialTheme.colorScheme.surfaceContainer
                    )
                )
            },
            containerColor = MaterialTheme.colorScheme.surface
        ) { innerPadding ->
            Column(
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
                    .padding(horizontal = 16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // --- HEADER (CAT LOGO) ---
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 16.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Surface(
                        shape = CircleShape,
                        color = MaterialTheme.colorScheme.tertiaryContainer, // different color for fun
                        modifier = Modifier.size(88.dp)
                    ) {
                        Box(contentAlignment = Alignment.Center) {
                            Icon(
                                imageVector = Icons.Rounded.Pets,
                                contentDescription = null,
                                tint = MaterialTheme.colorScheme.onTertiaryContainer,
                                modifier = Modifier.size(44.dp)
                            )
                        }
                    }
                    Spacer(Modifier.height(16.dp))
                    Text(
                        text = stringResource(R.string.app_name),
                        style = MaterialTheme.typography.headlineMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Badge(
                        containerColor = MaterialTheme.colorScheme.surfaceContainerHighest,
                        contentColor = MaterialTheme.colorScheme.onSurfaceVariant,
                        modifier = Modifier
                            .padding(top = 8.dp)
                            .clickable {
                                tapCount++
                                if (tapCount >= 7) {
                                    tapCount = 0
                                    scope.launch {
                                        AchievementNotificationManager.showNotification(
                                            AchievementNotification(
                                                title = context.getString(R.string.achievement_unlocked),
                                                subtitle = "Meow Mode Activated ğŸ±",
                                                iconEmoji = "ğŸ§¶",
                                                xpReward = 1337
                                            )
                                        )
                                    }
                                    Toast.makeText(context, context.getString(R.string.test_notification_triggered), Toast.LENGTH_SHORT).show()
                                }
                            }
                    ) {
                        Text(
                            text = "v$appVersion",
                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp),
                            style = MaterialTheme.typography.labelMedium
                        )
                    }
                }
    
                // --- MAIN CARD ---
                Card(
                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerLow),
                    shape = RoundedCornerShape(24.dp)
                ) {
                    Column {
                        // credits button
                        SettingsLinkRow(
                            icon = Icons.Rounded.Groups,
                            title = stringResource(R.string.about_credits),
                            onClick = { showCreditsSheet = true }
                        )
    
                        HorizontalDivider(color = MaterialTheme.colorScheme.surface)
    
                        // github
                        SettingsLinkRow(
                            icon = Icons.Rounded.Code,
                            title = stringResource(R.string.about_github),
                            onClick = { uriHandler.openUri("https://github.com/alananasss/KittyTune") }
                        )
    
                        HorizontalDivider(color = MaterialTheme.colorScheme.surface)
    
                        // bug report
                        SettingsLinkRow(
                            icon = Icons.Rounded.BugReport,
                            title = stringResource(R.string.about_bug_report),
                            onClick = { uriHandler.openUri("https://github.com/alananasss/KittyTune/issues") }
                        )
    
                        HorizontalDivider(color = MaterialTheme.colorScheme.surface)
    
                        // licenses
                        SettingsLinkRow(
                            icon = Icons.AutoMirrored.Filled.OpenInNew,
                            title = stringResource(R.string.about_licenses),
                            onClick = { showLicensesDialog = true }
                        )
                    }
                }
    
                // --- TRANSLATION CARD ---
                Card(
                    onClick = { uriHandler.openUri("https://github.com/alananasss/KittyTune/pulls") },
                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.secondaryContainer),
                    shape = RoundedCornerShape(24.dp),
                    modifier = Modifier.fillMaxWidth() // ensure card takes full width
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth() // row takes full width available in card
                            .padding(16.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.Center // <--- FIX: centers content horizontally
                    ) {
                        Text(
                            text = "( â—•â–¿â—• )",
                            style = MaterialTheme.typography.headlineMedium,
                            color = MaterialTheme.colorScheme.onSecondaryContainer,
                            modifier = Modifier.padding(end = 16.dp)
                        )
                        Column(
                            horizontalAlignment = Alignment.Start // text aligns left relative to itself
                        ) {
                            Text(
                                text = stringResource(R.string.about_translate_title),
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold,
                                color = MaterialTheme.colorScheme.onSecondaryContainer
                            )
                            Text(
                                text = stringResource(R.string.about_translate_desc).substringAfter("\n"),
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSecondaryContainer.copy(alpha = 0.8f)
                            )
                        }
                    }
                }
    
                // --- TECH INFO (Hidden) ---
                ExpandableTechInfo(packageName = context.packageName)
    
                Spacer(Modifier.height(32.dp))
    
                // --- FOOTER ---
                Text(
                    text = stringResource(R.string.about_made_with),
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f),
                    modifier = Modifier.fillMaxWidth(),
                    textAlign = TextAlign.Center
                )
    
                Spacer(Modifier.height(32.dp))
            }
        }
    }
    
    // utility functions
    
    @Composable
    fun SettingsLinkRow(icon: ImageVector, title: String, onClick: () -> Unit) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(onClick = onClick)
                .padding(horizontal = 20.dp, vertical = 16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(icon, null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
            Spacer(Modifier.width(16.dp))
            Text(title, modifier = Modifier.weight(1f), style = MaterialTheme.typography.bodyLarge)
            Icon(
                Icons.AutoMirrored.Filled.ArrowBack, // using arrow back but flipped for right arrow
                null,
                modifier = Modifier.size(16.dp).graphicsLayer { rotationZ = 180f }, // simple hack for right arrow
                tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
            )
        }
    }
    
    @Composable
    fun ExpandableTechInfo(packageName: String) {
        var expanded by remember { mutableStateOf(false) }
    
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .clip(RoundedCornerShape(12.dp))
                .clickable { expanded = !expanded }
                .padding(8.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = if(expanded) stringResource(R.string.about_collapse) else stringResource(R.string.about_app_info),
                style = MaterialTheme.typography.labelMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
    
            AnimatedVisibility(visible = expanded) {
                Column(
                    modifier = Modifier.padding(top = 16.dp),
                    verticalArrangement = Arrangement.spacedBy(4.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Text(packageName, style = MaterialTheme.typography.bodySmall)
                    Text("Android ${android.os.Build.VERSION.RELEASE} (SDK ${android.os.Build.VERSION.SDK_INT})", style = MaterialTheme.typography.bodySmall)
                    Text("${android.os.Build.MANUFACTURER} ${android.os.Build.MODEL}", style = MaterialTheme.typography.bodySmall)
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/AchievementsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.widget.Toast
    import androidx.compose.animation.core.animateFloatAsState
    import androidx.compose.animation.core.tween
    import androidx.compose.foundation.Canvas
    import androidx.compose.foundation.background
    import androidx.compose.foundation.border
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.LazyRow
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.CheckCircle
    import androidx.compose.material.icons.rounded.DeleteForever
    import androidx.compose.material.icons.rounded.Lock
    import androidx.compose.material.icons.rounded.Warning
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.draw.scale
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.StrokeCap
    import androidx.compose.ui.graphics.drawscope.Stroke
    import androidx.compose.ui.input.nestedscroll.nestedScroll
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.Achievement
    import com.alananasss.kittytune.data.AchievementManager
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun AchievementsScreen(onBackClick: () -> Unit) {
        val progressMap by AchievementManager.progressFlow.collectAsState()
        val (level, currentXP, neededXP) = AchievementManager.getLevelInfo()
        val context = LocalContext.current
    
        val scrollBehavior = TopAppBarDefaults.exitUntilCollapsedScrollBehavior()
    
        val levelProgress = (currentXP.toFloat() / neededXP.toFloat()).coerceIn(0f, 1f)
        val animatedProgress by animateFloatAsState(targetValue = levelProgress, animationSpec = tween(1500), label = "progress")
    
        // organize by category for cleaner display
        val groupedAchievements = remember { AchievementManager.definitions.groupBy { it.category } }
    
        var showResetDialog1 by remember { mutableStateOf(false) }
        var showResetDialog2 by remember { mutableStateOf(false) }
    
        if (showResetDialog1) {
            AlertDialog(
                onDismissRequest = { showResetDialog1 = false },
                icon = { Icon(Icons.Rounded.Warning, null) },
                title = { Text(stringResource(R.string.dialog_reset_achievements_title)) },
                text = { Text(stringResource(R.string.dialog_reset_achievements_msg)) },
                confirmButton = { TextButton(onClick = { showResetDialog1 = false; showResetDialog2 = true }) { Text(stringResource(R.string.dialog_reset_achievements_confirm), color = MaterialTheme.colorScheme.error) } },
                dismissButton = { TextButton(onClick = { showResetDialog1 = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showResetDialog2) {
            AlertDialog(
                onDismissRequest = { showResetDialog2 = false },
                icon = { Icon(Icons.Rounded.DeleteForever, null, tint = MaterialTheme.colorScheme.error) },
                title = { Text(stringResource(R.string.dialog_reset_achievements_final_title)) },
                text = { Text(stringResource(R.string.dialog_reset_achievements_final_msg)) },
                confirmButton = {
                    Button(
                        onClick = {
                            AchievementManager.resetAll()
                            showResetDialog2 = false
                            Toast.makeText(context, context.getString(R.string.achievements_reset_success), Toast.LENGTH_SHORT).show()
                        },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error)
                    ) { Text(stringResource(R.string.dialog_reset_achievements_final_confirm)) }
                },
                dismissButton = { TextButton(onClick = { showResetDialog2 = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        Scaffold(
            modifier = Modifier.nestedScroll(scrollBehavior.nestedScrollConnection),
            topBar = {
                LargeTopAppBar(
                    title = {
                        Column {
                            Text(stringResource(R.string.achievements_title), fontWeight = FontWeight.Bold)
                            val unlockedCount = progressMap.values.count { it.isUnlocked }
                            val totalCount = AchievementManager.definitions.size
                            Text(stringResource(R.string.achievements_subtitle, unlockedCount, totalCount), style = MaterialTheme.typography.titleSmall, fontWeight = FontWeight.Normal)
                        }
                    },
                    navigationIcon = { IconButton(onClick = onBackClick) { Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_close)) } },
                    scrollBehavior = scrollBehavior,
                    colors = TopAppBarDefaults.largeTopAppBarColors(containerColor = MaterialTheme.colorScheme.background, scrolledContainerColor = MaterialTheme.colorScheme.surfaceContainer)
                )
            },
            containerColor = MaterialTheme.colorScheme.background
        ) { innerPadding ->
            LazyColumn(
                modifier = Modifier.padding(innerPadding),
                contentPadding = PaddingValues(bottom = 32.dp),
                verticalArrangement = Arrangement.spacedBy(24.dp)
            ) {
                // --- LEVEL CARD ---
                item {
                    Card(
                        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerLow),
                        modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp)
                    ) {
                        Row(
                            modifier = Modifier.padding(24.dp).fillMaxWidth(),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            Column(modifier = Modifier.weight(1f)) {
                                Text(stringResource(R.string.achievements_current_level), style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                                Text("$level", style = MaterialTheme.typography.displayLarge, fontWeight = FontWeight.Black, color = MaterialTheme.colorScheme.primary)
                                Spacer(Modifier.height(4.dp))
                                Text("$currentXP / $neededXP XP", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                                LinearProgressIndicator(
                                    progress = { animatedProgress },
                                    modifier = Modifier.padding(top = 8.dp).fillMaxWidth().height(8.dp).clip(RoundedCornerShape(4.dp)),
                                )
                            }
    
                            Spacer(Modifier.width(24.dp))
    
                            Box(contentAlignment = Alignment.Center, modifier = Modifier.size(80.dp)) {
                                Canvas(modifier = Modifier.fillMaxSize()) {
                                    drawCircle(
                                        brush = Brush.sweepGradient(listOf(Color(0xFFFFD700), Color(0xFFFFA500), Color(0xFFFFD700))),
                                        style = Stroke(width = 4.dp.toPx())
                                    )
                                }
                                Text("LVL\n$level", textAlign = TextAlign.Center, fontWeight = FontWeight.Black, style = MaterialTheme.typography.titleLarge)
                            }
                        }
                    }
                }
    
                // --- CATEGORIES ---
                for ((category, achievements) in groupedAchievements) {
                    item {
                        Column {
                            PaddingTitle(stringResource(category.titleResId))
                            LazyRow(
                                contentPadding = PaddingValues(horizontal = 16.dp),
                                horizontalArrangement = Arrangement.spacedBy(12.dp)
                            ) {
                                items(achievements) { def ->
                                    val progress = progressMap[def.id]
                                    val currentValue = progress?.currentValue ?: 0
                                    val isUnlocked = progress?.isUnlocked == true
    
                                    if (def.isSecret && !isUnlocked) {
                                        SecretAchievementCardHorizontal()
                                    } else {
                                        AchievementCardHorizontal(def, currentValue, isUnlocked)
                                    }
                                }
                            }
                        }
                    }
                }
    
                item {
                    Spacer(Modifier.height(16.dp))
                    Box(modifier = Modifier.padding(horizontal = 16.dp)) {
                        Button(
                            onClick = { showResetDialog1 = true },
                            colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.errorContainer, contentColor = MaterialTheme.colorScheme.onErrorContainer),
                            modifier = Modifier.fillMaxWidth().height(50.dp),
                            shape = RoundedCornerShape(12.dp)
                        ) {
                            Icon(Icons.Rounded.DeleteForever, null)
                            Spacer(Modifier.width(8.dp))
                            Text(stringResource(R.string.achievements_reset_progress))
                        }
                    }
                    Spacer(modifier = Modifier.height(80.dp))
                }
            }
        }
    }
    
    @Composable
    fun PaddingTitle(text: String) {
        Text(
            text = text,
            style = MaterialTheme.typography.titleLarge,
            fontWeight = FontWeight.Bold,
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
        )
    }
    
    @Composable
    fun AchievementCardHorizontal(def: Achievement, current: Int, isUnlocked: Boolean) {
        val progress = (current.toFloat() / def.targetValue.toFloat()).coerceIn(0f, 1f)
    
        val cardWidth = 160.dp
        val containerColor = if (isUnlocked) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.surfaceContainer
        val contentColor = if (isUnlocked) MaterialTheme.colorScheme.onPrimaryContainer else MaterialTheme.colorScheme.onSurface
        val borderColor = if (isUnlocked) MaterialTheme.colorScheme.primary else Color.Transparent
        val borderCheck = if (isUnlocked) 2.dp else 0.dp
    
        Card(
            colors = CardDefaults.cardColors(containerColor = containerColor),
            modifier = Modifier
                .width(cardWidth)
                .height(200.dp)
                .border(borderCheck, borderColor, RoundedCornerShape(16.dp)),
            shape = RoundedCornerShape(16.dp)
        ) {
            Column(
                modifier = Modifier.fillMaxSize().padding(12.dp),
                verticalArrangement = Arrangement.SpaceBetween
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.Top
                ) {
                    Text(
                        text = def.iconEmoji,
                        fontSize = 32.sp,
                        modifier = Modifier.alpha(if (isUnlocked) 1f else 0.5f)
                    )
                    if (isUnlocked) {
                        Icon(Icons.Default.CheckCircle, null, tint = MaterialTheme.colorScheme.primary, modifier = Modifier.size(20.dp))
                    } else {
                        Text(
                            "${def.xpReward} XP",
                            style = MaterialTheme.typography.labelSmall,
                            color = MaterialTheme.colorScheme.primary,
                            fontWeight = FontWeight.Bold
                        )
                    }
                }
    
                Column {
                    Text(
                        text = stringResource(def.titleResId),
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = contentColor,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                    Text(
                        text = stringResource(def.descriptionResId),
                        style = MaterialTheme.typography.bodySmall,
                        color = contentColor.copy(alpha = 0.7f),
                        maxLines = 2,
                        overflow = TextOverflow.Ellipsis,
                        lineHeight = 14.sp
                    )
                }
    
                Column {
                    val displayCurrent = formatValue(def.id, current)
                    val displayTarget = formatValue(def.id, def.targetValue)
    
                    Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween) {
                        Text(
                            text = if(isUnlocked) stringResource(R.string.achievements_status_done) else displayCurrent,
                            style = MaterialTheme.typography.labelSmall,
                            fontWeight = FontWeight.Bold,
                            color = contentColor
                        )
                        if (!isUnlocked) {
                            Text(
                                text = displayTarget,
                                style = MaterialTheme.typography.labelSmall,
                                color = contentColor.copy(alpha = 0.6f)
                            )
                        }
                    }
                    Spacer(Modifier.height(4.dp))
                    LinearProgressIndicator(
                        progress = { progress },
                        modifier = Modifier.fillMaxWidth().height(6.dp).clip(RoundedCornerShape(3.dp)),
                        color = MaterialTheme.colorScheme.primary,
                        trackColor = contentColor.copy(alpha = 0.2f),
                    )
                }
            }
        }
    }
    
    @Composable
    fun SecretAchievementCardHorizontal() {
        Card(
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainer.copy(alpha = 0.5f)),
            modifier = Modifier
                .width(160.dp)
                .height(200.dp)
                .border(1.dp, MaterialTheme.colorScheme.outline.copy(alpha = 0.2f), RoundedCornerShape(16.dp)),
            shape = RoundedCornerShape(16.dp)
        ) {
            Column(
                modifier = Modifier.fillMaxSize().padding(12.dp),
                verticalArrangement = Arrangement.Center,
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Box(
                    modifier = Modifier.size(48.dp).background(Color.Black.copy(alpha = 0.1f), CircleShape),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(Icons.Rounded.Lock, null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
                }
                Spacer(Modifier.height(16.dp))
                Text(
                    stringResource(R.string.achievements_secret_title),
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    stringResource(R.string.ach_secret_desc),
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
                )
            }
        }
    }
    
    // pretty format for big numbers or time
    fun formatValue(id: String, value: Int): String {
        return if (id.startsWith("time_")) {
            val h = value / 3600
            val m = (value % 3600) / 60
            if (h > 0) "${h}h${if(m>0) "${m}m" else ""}" else "${m}m"
        } else {
            if (value >= 1000) String.format("%.1fk", value / 1000f) else "$value"
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/AppearanceSettingsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.app.Activity
    import android.content.Context
    import android.content.Intent
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.rememberScrollState
    import androidx.compose.foundation.verticalScroll
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.AppLanguage
    import com.alananasss.kittytune.data.local.AppThemeMode
    import com.alananasss.kittytune.data.local.PlayerBackgroundStyle
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.data.local.StartDestination
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun AppearanceSettingsScreen(
        onBackClick: () -> Unit
    ) {
        val context = LocalContext.current
        val prefs = remember { PlayerPreferences(context) }
        // grab player vm to know if we need padding
        val playerViewModel: PlayerViewModel = viewModel()
    
        var startDestination by remember { mutableStateOf(prefs.getStartDestination()) }
        var dynamicTheme by remember { mutableStateOf(prefs.getDynamicTheme()) }
        var themeMode by remember { mutableStateOf(prefs.getThemeMode()) }
        var pureBlack by remember { mutableStateOf(prefs.getPureBlack()) }
        var playerStyle by remember { mutableStateOf(prefs.getPlayerStyle()) }
        var appLanguage by remember { mutableStateOf(prefs.getAppLanguage()) }
        var achievementPopupsEnabled by remember { mutableStateOf(prefs.getAchievementPopupsEnabled()) }
    
        var showThemeDialog by remember { mutableStateOf(false) }
        var showPlayerStyleDialog by remember { mutableStateOf(false) }
        var showStartDestDialog by remember { mutableStateOf(false) }
        var showLanguageDialog by remember { mutableStateOf(false) }
    
        if (showThemeDialog) {
            AlertDialog(
                onDismissRequest = { showThemeDialog = false },
                title = { Text(stringResource(R.string.pref_theme_mode)) },
                text = {
                    Column {
                        ThemeRadioButton(stringResource(R.string.theme_system), AppThemeMode.SYSTEM, themeMode) { themeMode = it; prefs.setThemeMode(it); showThemeDialog = false }
                        ThemeRadioButton(stringResource(R.string.theme_light), AppThemeMode.LIGHT, themeMode) { themeMode = it; prefs.setThemeMode(it); showThemeDialog = false }
                        ThemeRadioButton(stringResource(R.string.theme_dark), AppThemeMode.DARK, themeMode) { themeMode = it; prefs.setThemeMode(it); showThemeDialog = false }
                    }
                },
                confirmButton = { TextButton(onClick = { showThemeDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showStartDestDialog) {
            AlertDialog(
                onDismissRequest = { showStartDestDialog = false },
                title = { Text(stringResource(R.string.pref_start_screen)) },
                text = {
                    Column {
                        StartDestRadioButton(stringResource(R.string.nav_home), StartDestination.HOME, startDestination) { startDestination = it; prefs.setStartDestination(it); showStartDestDialog = false }
                        StartDestRadioButton(stringResource(R.string.nav_library), StartDestination.LIBRARY, startDestination) { startDestination = it; prefs.setStartDestination(it); showStartDestDialog = false }
                    }
                },
                confirmButton = { TextButton(onClick = { showStartDestDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showPlayerStyleDialog) {
            AlertDialog(
                onDismissRequest = { showPlayerStyleDialog = false },
                title = { Text(stringResource(R.string.pref_player_style)) },
                text = {
                    Column {
                        PlayerStyleRadioButton(stringResource(R.string.style_theme), PlayerBackgroundStyle.THEME, playerStyle) { playerStyle = it; prefs.setPlayerStyle(it); showPlayerStyleDialog = false }
                        PlayerStyleRadioButton(stringResource(R.string.style_gradient), PlayerBackgroundStyle.GRADIENT, playerStyle) { playerStyle = it; prefs.setPlayerStyle(it); showPlayerStyleDialog = false }
                        PlayerStyleRadioButton(stringResource(R.string.style_blur), PlayerBackgroundStyle.BLUR, playerStyle) { playerStyle = it; prefs.setPlayerStyle(it); showPlayerStyleDialog = false }
                    }
                },
                confirmButton = { TextButton(onClick = { showPlayerStyleDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        if (showLanguageDialog) {
            AlertDialog(
                onDismissRequest = { showLanguageDialog = false },
                title = { Text(stringResource(R.string.pref_language)) },
                text = {
                    Column {
                        LanguageRadioButton(stringResource(R.string.theme_system), AppLanguage.SYSTEM, appLanguage) { prefs.setAppLanguage(it); restartApp(context) }
                        LanguageRadioButton(stringResource(R.string.lang_french), AppLanguage.FRENCH, appLanguage) { prefs.setAppLanguage(it); restartApp(context) }
                        LanguageRadioButton(stringResource(R.string.lang_english), AppLanguage.ENGLISH, appLanguage) { prefs.setAppLanguage(it); restartApp(context) }
                        LanguageRadioButton(stringResource(R.string.lang_hungarian), AppLanguage.HUNGARIAN, appLanguage) { prefs.setAppLanguage(it); restartApp(context) }
                    }
                },
                confirmButton = { TextButton(onClick = { showLanguageDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_appearance_title)) },
                    navigationIcon = { IconButton(onClick = onBackClick) { Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_back)) } }
                )
            }
        ) { innerPadding ->
            Column(
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
            ) {
                SettingsCategoryHeader(stringResource(R.string.settings_cat_general))
    
                SettingsItemWithSubtitle(
                    icon = Icons.Rounded.Home,
                    title = stringResource(R.string.pref_start_screen),
                    subtitle = if (startDestination == StartDestination.HOME) stringResource(R.string.nav_home) else stringResource(R.string.nav_library),
                    onClick = { showStartDestDialog = true }
                )
    
                SettingsItemWithSubtitle(
                    icon = Icons.Rounded.Language,
                    title = stringResource(R.string.pref_language),
                    subtitle = stringResource(R.string.pref_language_sub),
                    onClick = { showLanguageDialog = true }
                )
    
                HorizontalDivider(Modifier.padding(vertical = 8.dp))
    
                SettingsCategoryHeader(stringResource(R.string.settings_cat_appearance))
    
                SwitchSettingItem(
                    icon = Icons.Rounded.ColorLens,
                    title = stringResource(R.string.pref_theme_dynamic),
                    subtitle = stringResource(R.string.pref_theme_dynamic_sub),
                    checked = dynamicTheme,
                    onCheckedChange = { dynamicTheme = it; prefs.setDynamicTheme(it) }
                )
    
                SettingsItemWithSubtitle(
                    icon = Icons.Rounded.DarkMode,
                    title = stringResource(R.string.pref_theme_mode),
                    subtitle = when(themeMode) {
                        AppThemeMode.SYSTEM -> stringResource(R.string.theme_system)
                        AppThemeMode.LIGHT -> stringResource(R.string.theme_light)
                        AppThemeMode.DARK -> stringResource(R.string.theme_dark)
                    },
                    onClick = { showThemeDialog = true }
                )
    
                SwitchSettingItem(
                    icon = Icons.Rounded.DarkMode,
                    title = stringResource(R.string.pref_theme_pure_black),
                    subtitle = stringResource(R.string.pref_theme_pure_black_sub),
                    checked = pureBlack,
                    enabled = themeMode != AppThemeMode.LIGHT,
                    onCheckedChange = { pureBlack = it; prefs.setPureBlack(it) }
                )
    
                HorizontalDivider(Modifier.padding(vertical = 8.dp))
    
                SettingsCategoryHeader(stringResource(R.string.settings_cat_playback))
    
                SettingsItemWithSubtitle(
                    icon = Icons.Rounded.Wallpaper,
                    title = stringResource(R.string.pref_player_style),
                    subtitle = when(playerStyle) {
                        PlayerBackgroundStyle.THEME -> stringResource(R.string.style_theme)
                        PlayerBackgroundStyle.GRADIENT -> stringResource(R.string.style_gradient)
                        PlayerBackgroundStyle.BLUR -> stringResource(R.string.style_blur)
                    },
                    onClick = { showPlayerStyleDialog = true }
                )
    
                // removed duplicate category here
    
                HorizontalDivider(Modifier.padding(vertical = 8.dp))
    
                SettingsCategoryHeader(stringResource(R.string.settings_cat_notifications))
    
                SwitchSettingItem(
                    icon = Icons.Rounded.EmojiEvents,
                    title = stringResource(R.string.pref_achievement_popups),
                    subtitle = stringResource(R.string.pref_achievement_popups_sub),
                    checked = achievementPopupsEnabled,
                    onCheckedChange = {
                        achievementPopupsEnabled = it
                        prefs.setAchievementPopupsEnabled(it)
                    }
                )
    
                // fix padding overlap with mini player
                if (playerViewModel.currentTrack != null) {
                    Spacer(modifier = Modifier.height(80.dp)) // 64dp player + 16dp margin
                }
            }
        }
    }
    
    fun restartApp(context: Context) {
        if (context is Activity) {
            context.recreate()
        } else {
            val packageManager = context.packageManager
            val intent = packageManager.getLaunchIntentForPackage(context.packageName)
            val componentName = intent?.component
            val mainIntent = Intent.makeRestartActivityTask(componentName)
            context.startActivity(mainIntent)
            Runtime.getRuntime().exit(0)
        }
    }
    
    @Composable
    fun ThemeRadioButton(text: String, mode: AppThemeMode, selected: AppThemeMode, onSelect: (AppThemeMode) -> Unit) {
        Row(Modifier.fillMaxWidth().clickable { onSelect(mode) }.padding(vertical = 12.dp), verticalAlignment = Alignment.CenterVertically) {
            RadioButton(selected = (mode == selected), onClick = null)
            Spacer(Modifier.width(8.dp))
            Text(text)
        }
    }
    
    @Composable
    fun PlayerStyleRadioButton(text: String, style: PlayerBackgroundStyle, selected: PlayerBackgroundStyle, onSelect: (PlayerBackgroundStyle) -> Unit) {
        Row(Modifier.fillMaxWidth().clickable { onSelect(style) }.padding(vertical = 12.dp), verticalAlignment = Alignment.CenterVertically) {
            RadioButton(selected = (style == selected), onClick = null)
            Spacer(Modifier.width(8.dp))
            Text(text)
        }
    }
    
    @Composable
    fun StartDestRadioButton(text: String, dest: StartDestination, selected: StartDestination, onSelect: (StartDestination) -> Unit) {
        Row(Modifier.fillMaxWidth().clickable { onSelect(dest) }.padding(vertical = 12.dp), verticalAlignment = Alignment.CenterVertically) {
            RadioButton(selected = (dest == selected), onClick = null)
            Spacer(Modifier.width(8.dp))
            Text(text)
        }
    }
    
    @Composable
    fun LanguageRadioButton(text: String, lang: AppLanguage, selected: AppLanguage, onSelect: (AppLanguage) -> Unit) {
        Row(Modifier.fillMaxWidth().clickable { onSelect(lang) }.padding(vertical = 12.dp), verticalAlignment = Alignment.CenterVertically) {
            RadioButton(selected = (lang == selected), onClick = null)
            Spacer(Modifier.width(8.dp))
            Text(text)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/AudioSettingsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.PlayerPreferences
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun AudioSettingsScreen(
        onBackClick: () -> Unit
    ) {
        val context = LocalContext.current
        val prefs = remember { PlayerPreferences(context) }
    
        var autoplayEnabled by remember { mutableStateOf(prefs.getAutoplayEnabled()) }
        var persistentQueueEnabled by remember { mutableStateOf(prefs.getPersistentQueueEnabled()) }
        var audioQuality by remember { mutableStateOf(prefs.getAudioQuality()) }
    
        var showQualityDialog by remember { mutableStateOf(false) }
    
        if (showQualityDialog) {
            AlertDialog(
                onDismissRequest = { showQualityDialog = false },
                title = { Text(stringResource(R.string.pref_quality)) },
                text = {
                    Column {
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .clickable {
                                    audioQuality = "HIGH"
                                    prefs.setAudioQuality("HIGH")
                                    showQualityDialog = false
                                }
                                .padding(vertical = 12.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            RadioButton(
                                selected = audioQuality == "HIGH",
                                onClick = null
                            )
                            Spacer(Modifier.width(8.dp))
                            Column {
                                Text(stringResource(R.string.quality_high), fontWeight = FontWeight.SemiBold)
                                Text(stringResource(R.string.quality_high_sub), style = MaterialTheme.typography.bodySmall)
                            }
                        }
    
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .clickable {
                                    audioQuality = "LOW"
                                    prefs.setAudioQuality("LOW")
                                    showQualityDialog = false
                                }
                                .padding(vertical = 12.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            RadioButton(
                                selected = audioQuality == "LOW",
                                onClick = null
                            )
                            Spacer(Modifier.width(8.dp))
                            Column {
                                Text(stringResource(R.string.quality_low), fontWeight = FontWeight.SemiBold)
                                Text(stringResource(R.string.quality_low_sub), style = MaterialTheme.typography.bodySmall)
                            }
                        }
                    }
                },
                confirmButton = {
                    TextButton(onClick = { showQualityDialog = false }) { Text(stringResource(R.string.btn_cancel)) }
                }
            )
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_audio_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_close))
                        }
                    }
                )
            }
        ) { innerPadding ->
            LazyColumn(
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
            ) {
                item {
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_playback))
    
                    SwitchSettingItem(
                        icon = Icons.Rounded.Radio,
                        title = stringResource(R.string.pref_autoplay),
                        subtitle = stringResource(R.string.pref_autoplay_sub),
                        checked = autoplayEnabled,
                        onCheckedChange = {
                            autoplayEnabled = it
                            prefs.setAutoplayEnabled(it)
                        }
                    )
    
                    SwitchSettingItem(
                        icon = Icons.Rounded.Save,
                        title = stringResource(R.string.pref_persist_queue),
                        subtitle = stringResource(R.string.pref_persist_queue_sub),
                        checked = persistentQueueEnabled,
                        onCheckedChange = {
                            persistentQueueEnabled = it
                            prefs.setPersistentQueueEnabled(it)
                        }
                    )
    
                    HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))
    
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_audio))
    
                    SettingsItemWithSubtitle(
                        icon = Icons.Rounded.HighQuality,
                        title = stringResource(R.string.pref_quality),
                        subtitle = if (audioQuality == "HIGH") stringResource(R.string.quality_high) else stringResource(R.string.quality_low),
                        onClick = { showQualityDialog = true }
                    )
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/BackupRestoreScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.content.Intent
    import androidx.activity.compose.rememberLauncherForActivityResult
    import androidx.activity.result.contract.ActivityResultContracts
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.Backup
    import androidx.compose.material.icons.filled.CloudUpload
    import androidx.compose.material.icons.filled.Info
    import androidx.compose.material.icons.filled.Restore
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.BackupManager
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun BackupRestoreScreen(
        onBackClick: () -> Unit,
        viewModel: BackupViewModel = viewModel()
    ) {
        val context = LocalContext.current
    
        val createDocumentLauncher = rememberLauncherForActivityResult(
            contract = ActivityResultContracts.CreateDocument("application/octet-stream")
        ) { uri ->
            uri?.let { viewModel.backup(it) }
        }
    
        val openDocumentLauncher = rememberLauncherForActivityResult(
            contract = ActivityResultContracts.OpenDocument()
        ) { uri ->
            uri?.let { viewModel.restore(it) }
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_backup_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_close))
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = MaterialTheme.colorScheme.surface,
                        scrolledContainerColor = MaterialTheme.colorScheme.surfaceContainer
                    )
                )
            }
        ) { innerPadding ->
            Box(modifier = Modifier.padding(innerPadding).fillMaxSize()) {
                Column(
                    modifier = Modifier
                        .padding(16.dp)
                        .fillMaxWidth(),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    BackupOptionCard(
                        icon = Icons.Default.CloudUpload,
                        title = stringResource(R.string.backup_action),
                        description = stringResource(R.string.backup_desc),
                        onClick = {
                            createDocumentLauncher.launch(BackupManager.getBackupFileName())
                        }
                    )
    
                    BackupOptionCard(
                        icon = Icons.Default.Restore,
                        title = stringResource(R.string.restore_action),
                        description = stringResource(R.string.restore_desc),
                        onClick = {
                            openDocumentLauncher.launch(arrayOf("*/*"))
                        }
                    )
    
                    Spacer(modifier = Modifier.height(16.dp))
    
                    InfoCard(text = stringResource(R.string.backup_info))
                    InfoCard(text = stringResource(R.string.backup_info_guest))
    
                    if (viewModel.statusMessage != null) {
                        Spacer(Modifier.height(16.dp))
                        Text(
                            text = viewModel.statusMessage!!,
                            color = MaterialTheme.colorScheme.primary,
                            fontWeight = FontWeight.Bold,
                            modifier = Modifier.align(Alignment.CenterHorizontally)
                        )
                    }
                }
    
                if (viewModel.isLoading) {
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .background(Color.Black.copy(alpha = 0.5f))
                            .clickable(enabled = false) {},
                        contentAlignment = Alignment.Center
                    ) {
                        Card(shape = RoundedCornerShape(16.dp)) {
                            Column(
                                modifier = Modifier.padding(24.dp),
                                horizontalAlignment = Alignment.CenterHorizontally
                            ) {
                                CircularProgressIndicator()
                                Spacer(Modifier.height(16.dp))
                                Text(stringResource(R.string.backup_in_progress))
                            }
                        }
                    }
                }
            }
        }
    }
    
    @Composable
    fun BackupOptionCard(
        icon: ImageVector,
        title: String,
        description: String,
        onClick: () -> Unit
    ) {
        Card(
            onClick = onClick,
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerHigh),
            modifier = Modifier.fillMaxWidth()
        ) {
            Row(
                modifier = Modifier.padding(20.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Icon(
                    imageVector = icon,
                    contentDescription = null,
                    modifier = Modifier.size(32.dp),
                    tint = MaterialTheme.colorScheme.primary
                )
                Spacer(modifier = Modifier.width(20.dp))
                Column {
                    Text(
                        text = title,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Spacer(modifier = Modifier.height(4.dp))
                    Text(
                        text = description,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }
    }
    
    @Composable
    fun InfoCard(text: String) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 8.dp),
            verticalAlignment = Alignment.Top
        ) {
            Icon(
                imageVector = Icons.Default.Info,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.7f),
                modifier = Modifier.size(20.dp).padding(top = 2.dp)
            )
            Spacer(modifier = Modifier.width(12.dp))
            Text(
                text = text,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.8f),
                lineHeight = 20.sp
            )
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/BackupViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.app.Application
    import android.net.Uri
    import android.widget.Toast
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.BackupManager
    import kotlinx.coroutines.launch
    
    class BackupViewModel(application: Application) : AndroidViewModel(application) {
    
        var isLoading by mutableStateOf(false)
        var statusMessage by mutableStateOf<String?>(null)
    
        fun backup(uri: Uri) {
            viewModelScope.launch {
                isLoading = true
                try {
                    BackupManager.createBackup(getApplication(), uri)
                    statusMessage = getApplication<Application>().getString(R.string.backup_success)
                    Toast.makeText(getApplication(), getApplication<Application>().getString(R.string.backup_toast_success), Toast.LENGTH_SHORT).show()
                } catch (e: Exception) {
                    e.printStackTrace()
                    statusMessage = getApplication<Application>().getString(R.string.backup_error, e.message ?: "")
                    Toast.makeText(getApplication(), getApplication<Application>().getString(R.string.backup_toast_error), Toast.LENGTH_LONG).show()
                } finally {
                    isLoading = false
                }
            }
        }
    
        fun restore(uri: Uri) {
            viewModelScope.launch {
                isLoading = true
                try {
                    BackupManager.restoreBackup(getApplication(), uri)
                    statusMessage = getApplication<Application>().getString(R.string.restore_success)
                    Toast.makeText(getApplication(), getApplication<Application>().getString(R.string.restore_toast_success), Toast.LENGTH_LONG).show()
                } catch (e: Exception) {
                    e.printStackTrace()
                    statusMessage = getApplication<Application>().getString(R.string.backup_error, e.message ?: "")
                    Toast.makeText(getApplication(), getApplication<Application>().getString(R.string.restore_toast_error), Toast.LENGTH_LONG).show()
                } finally {
                    isLoading = false
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/LicensesScreen.kt
================================================================================
    // CHEMIN : app/src/main/java/com/alananasss.kittytune.ui/profile/LicensesScreen.kt
    
    package com.alananasss.kittytune.ui.profile
    
    import android.content.Intent
    import android.net.Uri
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.rounded.Close
    import androidx.compose.material.icons.rounded.OpenInNew
    import androidx.compose.material3.*
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.input.nestedscroll.nestedScroll
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.window.Dialog
    import androidx.compose.ui.window.DialogProperties
    import com.alananasss.kittytune.R
    
    // just keeping it simple
    data class OpenSourceLibrary(
        val name: String,
        val author: String,
        val license: String = "Apache License 2.0",
        val url: String
    )
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LicensesScreen(onDismiss: () -> Unit) {
        val context = LocalContext.current
        val scrollBehavior = TopAppBarDefaults.pinnedScrollBehavior()
    
        // list of awesome stuff we use
        val libraries = listOf(
            // --- jetpack compose & ui ---
            OpenSourceLibrary("Jetpack Compose", "Google", url = "https://developer.android.com/jetpack/compose"),
            OpenSourceLibrary("Material Components for Android", "Google", url = "https://github.com/material-components/material-components-android"),
            OpenSourceLibrary("AndroidX Activity & Core", "Google", url = "https://developer.android.com/jetpack/androidx"),
            OpenSourceLibrary("AndroidX Lifecycle", "Google", url = "https://developer.android.com/jetpack/androidx/releases/lifecycle"),
            OpenSourceLibrary("AndroidX Navigation", "Google", url = "https://developer.android.com/jetpack/androidx/releases/navigation"),
            OpenSourceLibrary("Palette API", "Google", url = "https://developer.android.com/training/material/palette-colors"),
    
            // --- core & language ---
            OpenSourceLibrary("Kotlin", "JetBrains", url = "https://kotlinlang.org/"),
            OpenSourceLibrary("Kotlin Coroutines", "JetBrains", url = "https://github.com/Kotlin/kotlinx.coroutines"),
    
            // --- networking ---
            OpenSourceLibrary("Retrofit", "Square, Inc.", url = "https://square.github.io/retrofit/"),
            OpenSourceLibrary("OkHttp", "Square, Inc.", url = "https://square.github.io/okhttp/"),
            OpenSourceLibrary("Gson", "Google", url = "https://github.com/google/gson"),
    
            // --- database ---
            OpenSourceLibrary("Room", "Google", url = "https://developer.android.com/jetpack/androidx/releases/room"),
    
            // --- media & images ---
            OpenSourceLibrary("Media3 (ExoPlayer)", "Google", url = "https://developer.android.com/jetpack/androidx/releases/media3"),
            OpenSourceLibrary("Coil (Image Loading)", "Coil Contributors", url = "https://coil-kt.github.io/coil/"),
    
            // --- utils ---
            OpenSourceLibrary("OSS Licenses Plugin", "Google", license="The 3-Clause BSD License", url = "https://github.com/google/play-services-plugins/tree/master/oss-licenses-plugin")
        ).sortedBy { it.name }
    
        Dialog(
            onDismissRequest = onDismiss,
            properties = DialogProperties(usePlatformDefaultWidth = false)
        ) {
            Scaffold(
                topBar = {
                    TopAppBar(
                        title = { Text(stringResource(R.string.about_licenses_title), fontWeight = FontWeight.Bold) },
                        navigationIcon = {
                            IconButton(onClick = onDismiss) {
                                Icon(Icons.Rounded.Close, contentDescription = stringResource(R.string.btn_close))
                            }
                        },
                        colors = TopAppBarDefaults.topAppBarColors(
                            containerColor = MaterialTheme.colorScheme.surface,
                            scrolledContainerColor = MaterialTheme.colorScheme.surfaceContainer
                        ),
                        scrollBehavior = scrollBehavior
                    )
                },
                containerColor = MaterialTheme.colorScheme.surface
            ) { padding ->
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(padding)
                        .nestedScroll(scrollBehavior.nestedScrollConnection),
                    contentPadding = PaddingValues(16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    items(libraries) { lib ->
                        LicenseItem(library = lib) {
                            val intent = Intent(Intent.ACTION_VIEW, Uri.parse(lib.url))
                            context.startActivity(intent)
                        }
                    }
                    item { Spacer(Modifier.height(32.dp)) }
                }
            }
        }
    }
    
    @Composable
    fun LicenseItem(library: OpenSourceLibrary, onClick: () -> Unit) {
        Card(
            onClick = onClick,
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerLow, contentColor = MaterialTheme.colorScheme.onSurface),
            modifier = Modifier.fillMaxWidth()
        ) {
            Row(
                modifier = Modifier.padding(16.dp).fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(text = library.name, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                    Text(text = stringResource(R.string.license_author_prefix, library.author), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                    Spacer(Modifier.height(4.dp))
                    Text(text = library.license, style = MaterialTheme.typography.labelSmall, color = MaterialTheme.colorScheme.primary)
                }
                Icon(
                    imageVector = Icons.Rounded.OpenInNew,
                    contentDescription = stringResource(R.string.open_in_new),
                    tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.6f),
                    modifier = Modifier.size(20.dp)
                )
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/LocalMediaSettingsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.net.Uri
    import androidx.activity.compose.rememberLauncherForActivityResult
    import androidx.activity.result.contract.ActivityResultContracts
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.items
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.Add
    import androidx.compose.material.icons.filled.Delete
    import androidx.compose.material.icons.filled.Folder
    import androidx.compose.material.icons.filled.Refresh
    import androidx.compose.material.icons.filled.SdStorage
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.LocalMediaRepository
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import kotlinx.coroutines.launch
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LocalMediaSettingsScreen(
        onBackClick: () -> Unit
    ) {
        val context = LocalContext.current
        val prefs = remember { PlayerPreferences(context) }
        val scope = rememberCoroutineScope()
    
        var isEnabled by remember { mutableStateOf(prefs.getLocalMediaEnabled()) }
        var folderUris by remember { mutableStateOf(prefs.getLocalMediaUris().toList()) }
    
        val isScanning by LocalMediaRepository.isScanning.collectAsState()
        val scanProgress by LocalMediaRepository.scanProgress.collectAsState()
    
        val folderPicker = rememberLauncherForActivityResult(
            contract = ActivityResultContracts.OpenDocumentTree()
        ) { uri: Uri? ->
            if (uri != null) {
                val takeFlags = android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION or android.content.Intent.FLAG_GRANT_WRITE_URI_PERMISSION
                try {
                    context.contentResolver.takePersistableUriPermission(uri, takeFlags)
                } catch (e: Exception) { e.printStackTrace() }
    
                val uriString = uri.toString()
                prefs.addLocalMediaUri(uriString)
                folderUris = prefs.getLocalMediaUris().toList()
            }
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_local_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_back))
                        }
                    }
                )
            }
        ) { innerPadding ->
            LazyColumn(
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
            ) {
                item {
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_general))
    
                    SwitchSettingItem(
                        icon = Icons.Default.SdStorage,
                        title = stringResource(R.string.pref_local_enable),
                        subtitle = stringResource(R.string.pref_local_enable_sub),
                        checked = isEnabled,
                        onCheckedChange = {
                            isEnabled = it
                            prefs.setLocalMediaEnabled(it)
                        }
                    )
    
                    if (isEnabled) {
                        HorizontalDivider(Modifier.padding(vertical = 8.dp))
    
                        SettingsCategoryHeader(stringResource(R.string.pref_local_folders))
    
                        ListItem(
                            headlineContent = { Text(stringResource(R.string.pref_local_add), color = MaterialTheme.colorScheme.primary) },
                            leadingContent = { Icon(Icons.Default.Add, null, tint = MaterialTheme.colorScheme.primary) },
                            modifier = Modifier.clickable { folderPicker.launch(null) }
                        )
                    }
                }
    
                if (isEnabled) {
                    if (folderUris.isEmpty()) {
                        item {
                            Text(
                                stringResource(R.string.pref_local_no_folder),
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant,
                                modifier = Modifier.padding(16.dp)
                            )
                        }
                    } else {
                        items(folderUris) { uriString ->
                            val path = Uri.parse(uriString).path?.substringAfter("primary:") ?: uriString
    
                            ListItem(
                                headlineContent = { Text(path, maxLines = 1, overflow = TextOverflow.Ellipsis) },
                                leadingContent = { Icon(Icons.Default.Folder, null, tint = MaterialTheme.colorScheme.onSurfaceVariant) },
                                trailingContent = {
                                    IconButton(onClick = {
                                        prefs.removeLocalMediaUri(uriString)
                                        folderUris = prefs.getLocalMediaUris().toList()
                                    }) {
                                        Icon(Icons.Default.Delete, stringResource(R.string.btn_delete), tint = MaterialTheme.colorScheme.error)
                                    }
                                }
                            )
                        }
                    }
    
                    item {
                        Spacer(Modifier.height(24.dp))
    
                        Box(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(horizontal = 16.dp),
                            contentAlignment = Alignment.Center
                        ) {
                            Button(
                                onClick = { scope.launch { LocalMediaRepository.scanLocalMedia(context) } },
                                enabled = !isScanning && folderUris.isNotEmpty(),
                                modifier = Modifier.fillMaxWidth()
                            ) {
                                if (isScanning) {
                                    CircularProgressIndicator(modifier = Modifier.size(16.dp), color = MaterialTheme.colorScheme.onPrimary, strokeWidth = 2.dp)
                                    Spacer(Modifier.width(8.dp))
                                    Text(stringResource(R.string.pref_local_scanning))
                                } else {
                                    Icon(Icons.Default.Refresh, null)
                                    Spacer(Modifier.width(8.dp))
                                    Text(stringResource(R.string.pref_local_scan))
                                }
                            }
                        }
    
                        if (isScanning) {
                            Text(
                                text = scanProgress,
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.primary,
                                modifier = Modifier.padding(16.dp).fillMaxWidth(),
                                textAlign = TextAlign.Center
                            )
                        }
    
                        Spacer(Modifier.height(16.dp))
                        InfoCard(stringResource(R.string.pref_local_info))
                        Spacer(Modifier.height(32.dp))
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/LyricsSettingsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.rounded.Add
    import androidx.compose.material.icons.rounded.FormatAlignLeft
    import androidx.compose.material.icons.rounded.FormatSize
    import androidx.compose.material.icons.rounded.Remove
    import androidx.compose.material.icons.rounded.SdStorage
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.window.Dialog
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.local.LyricsAlignment
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import kotlin.math.roundToInt
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun LyricsSettingsScreen(
        onBackClick: () -> Unit,
        playerViewModel: PlayerViewModel
    ) {
        val context = LocalContext.current
        val prefs = remember { PlayerPreferences(context) }
    
        val fontSize = playerViewModel.lyricsFontSize
        val alignment = playerViewModel.lyricsAlignment
        var preferLocal by remember { mutableStateOf(prefs.getLyricsPreferLocal()) }
    
        var showAlignmentDialog by remember { mutableStateOf(false) }
        var showFontSizeDialog by remember { mutableStateOf(false) }
    
        // Dialog Taille Police
        if (showFontSizeDialog) {
            Dialog(onDismissRequest = { showFontSizeDialog = false }) {
                Card(
                    shape = RoundedCornerShape(28.dp),
                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerHigh),
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Column(modifier = Modifier.padding(24.dp)) {
                        Text(
                            stringResource(R.string.pref_lyrics_size),
                            style = MaterialTheme.typography.headlineSmall,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        Spacer(Modifier.height(24.dp))
    
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            Text(
                                "${fontSize.roundToInt()} sp",
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold,
                                modifier = Modifier.width(60.dp)
                            )
    
                            IconButton(
                                onClick = {
                                    val newSize = (fontSize - 2f).coerceAtLeast(12f)
                                    playerViewModel.updateLyricsFontSize(newSize)
                                },
                                modifier = Modifier.size(32.dp)
                            ) { Icon(Icons.Rounded.Remove, null) }
    
                            Slider(
                                value = fontSize,
                                onValueChange = {
                                    playerViewModel.updateLyricsFontSize(it)
                                },
                                valueRange = 12f..48f,
                                steps = 17,
                                modifier = Modifier.weight(1f).padding(horizontal = 8.dp)
                            )
    
                            IconButton(
                                onClick = {
                                    val newSize = (fontSize + 2f).coerceAtMost(48f)
                                    playerViewModel.updateLyricsFontSize(newSize)
                                },
                                modifier = Modifier.size(32.dp)
                            ) { Icon(Icons.Rounded.Add, null) }
                        }
    
                        Spacer(Modifier.height(24.dp))
    
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            TextButton(
                                onClick = {
                                    playerViewModel.updateLyricsFontSize(26f) // Valeur par dÃ©faut
                                }
                            ) { Text(stringResource(R.string.pref_lyrics_reset)) }
    
                            Row {
                                TextButton(onClick = { showFontSizeDialog = false }) { Text(stringResource(R.string.btn_close)) }
                            }
                        }
                    }
                }
            }
        }
    
        // Dialog Alignement
        if (showAlignmentDialog) {
            AlertDialog(
                onDismissRequest = { showAlignmentDialog = false },
                title = { Text(stringResource(R.string.pref_lyrics_align)) },
                text = {
                    Column {
                        AlignRadioButton(stringResource(R.string.align_left), LyricsAlignment.LEFT, alignment) {
                            playerViewModel.updateLyricsAlignment(it)
                            showAlignmentDialog = false
                        }
                        AlignRadioButton(stringResource(R.string.align_center), LyricsAlignment.CENTER, alignment) {
                            playerViewModel.updateLyricsAlignment(it)
                            showAlignmentDialog = false
                        }
                        AlignRadioButton(stringResource(R.string.align_right), LyricsAlignment.RIGHT, alignment) {
                            playerViewModel.updateLyricsAlignment(it)
                            showAlignmentDialog = false
                        }
                    }
                },
                confirmButton = { TextButton(onClick = { showAlignmentDialog = false }) { Text(stringResource(R.string.btn_cancel)) } }
            )
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_lyrics_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_back))
                        }
                    }
                )
            }
        ) { innerPadding ->
            LazyColumn(modifier = Modifier.padding(innerPadding)) {
                item {
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_source))
    
                    SwitchSettingItem(
                        icon = Icons.Rounded.SdStorage,
                        title = stringResource(R.string.pref_lyrics_local),
                        subtitle = stringResource(R.string.pref_lyrics_local_sub),
                        checked = preferLocal,
                        onCheckedChange = {
                            preferLocal = it
                            prefs.setLyricsPreferLocal(it)
                        }
                    )
    
                    HorizontalDivider(Modifier.padding(vertical = 8.dp))
    
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_appearance))
    
                    SettingsItemWithSubtitle(
                        icon = Icons.Rounded.FormatAlignLeft,
                        title = stringResource(R.string.pref_lyrics_align),
                        subtitle = when(alignment) {
                            LyricsAlignment.LEFT -> stringResource(R.string.align_left)
                            LyricsAlignment.CENTER -> stringResource(R.string.align_center_simple)
                            LyricsAlignment.RIGHT -> stringResource(R.string.align_right)
                        },
                        onClick = { showAlignmentDialog = true }
                    )
    
                    SettingsItemWithSubtitle(
                        icon = Icons.Rounded.FormatSize,
                        title = stringResource(R.string.pref_lyrics_size),
                        subtitle = "${fontSize.roundToInt()} sp",
                        onClick = { showFontSizeDialog = true }
                    )
                }
            }
        }
    }
    
    @Composable
    fun AlignRadioButton(text: String, mode: LyricsAlignment, selected: LyricsAlignment, onSelect: (LyricsAlignment) -> Unit) {
        Row(Modifier.fillMaxWidth().clickable { onSelect(mode) }.padding(vertical = 12.dp), verticalAlignment = Alignment.CenterVertically) {
            RadioButton(selected = (mode == selected), onClick = null)
            Spacer(Modifier.width(8.dp))
            Text(text)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/ProfileMenuSheet.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.rounded.Logout
    import androidx.compose.material.icons.rounded.Close
    import androidx.compose.material.icons.rounded.EmojiEvents
    import androidx.compose.material.icons.rounded.Settings
    import androidx.compose.material3.*
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.domain.User
    
    @Composable
    fun ProfileMenuSheet(
        user: User?,
        isGuest: Boolean,
        onDismiss: () -> Unit,
        onViewProfile: () -> Unit,
        onAchievementsClick: () -> Unit,
        onSettingsClick: () -> Unit,
        onLogoutClick: () -> Unit
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
                .navigationBarsPadding()
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.Center
            ) {
                Text(stringResource(id = R.string.app_name), style = MaterialTheme.typography.titleMedium, color = MaterialTheme.colorScheme.primary)
            }
    
            Spacer(Modifier.height(16.dp))
    
            Surface(
                shape = RoundedCornerShape(24.dp),
                color = MaterialTheme.colorScheme.surfaceContainerHigh,
                modifier = Modifier.fillMaxWidth()
            ) {
                Column(modifier = Modifier.padding(16.dp)) {
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        if (user?.avatarUrl != null && !isGuest) {
                            ArtistAvatar(
                                avatarUrl = user.avatarUrl,
                                modifier = Modifier.size(48.dp).clip(CircleShape)
                            )
                        } else {
                            Box(
                                modifier = Modifier
                                    .size(48.dp)
                                    .clip(CircleShape)
                                    .background(MaterialTheme.colorScheme.primaryContainer),
                                contentAlignment = Alignment.Center
                            ) {
                                Text(
                                    text = if(isGuest) "G" else user?.username?.take(1)?.uppercase() ?: "U",
                                    style = MaterialTheme.typography.titleMedium,
                                    color = MaterialTheme.colorScheme.onPrimaryContainer
                                )
                            }
                        }
    
                        Spacer(Modifier.width(16.dp))
    
                        Column(modifier = Modifier.weight(1f)) {
                            Text(
                                text = if (isGuest) stringResource(R.string.guest_user) else user?.username ?: stringResource(R.string.unknown_user),
                                style = MaterialTheme.typography.bodyLarge,
                                fontWeight = FontWeight.SemiBold,
                                maxLines = 1,
                                overflow = TextOverflow.Ellipsis
                            )
                            Text(
                                text = if (isGuest) stringResource(R.string.profile_menu_guest_desc) else "${user?.followersCount ?: 0} ${stringResource(R.string.profile_followers)}",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
    
                        IconButton(onClick = onDismiss) {
                            Icon(Icons.Rounded.Close, stringResource(R.string.btn_close))
                        }
                    }
    
                    Spacer(Modifier.height(16.dp))
    
                    if (!isGuest) {
                        OutlinedButton(
                            onClick = { onDismiss(); onViewProfile() },
                            modifier = Modifier.fillMaxWidth(),
                            shape = RoundedCornerShape(12.dp)
                        ) {
                            Text(stringResource(R.string.profile_menu_manage_account))
                        }
                    } else {
                        OutlinedButton(
                            onClick = { onDismiss(); onLogoutClick() },
                            modifier = Modifier.fillMaxWidth(),
                            shape = RoundedCornerShape(12.dp)
                        ) {
                            Text(stringResource(R.string.profile_menu_login))
                        }
                    }
                }
            }
    
            Spacer(Modifier.height(8.dp))
    
            Surface(
                shape = RoundedCornerShape(24.dp),
                color = MaterialTheme.colorScheme.surfaceContainerHigh,
                modifier = Modifier.fillMaxWidth()
            ) {
                Column {
                    MenuRowItem(
                        icon = Icons.Rounded.EmojiEvents,
                        label = stringResource(R.string.profile_menu_achievements),
                        onClick = { onDismiss(); onAchievementsClick() },
                        isNew = true
                    )
    
                    HorizontalDivider(color = MaterialTheme.colorScheme.surface, thickness = 1.dp)
    
                    MenuRowItem(
                        icon = Icons.Rounded.Settings,
                        label = stringResource(R.string.profile_menu_settings),
                        onClick = { onDismiss(); onSettingsClick() }
                    )
    
                    HorizontalDivider(color = MaterialTheme.colorScheme.surface, thickness = 1.dp)
    
                    if (!isGuest) {
                        MenuRowItem(
                            icon = Icons.AutoMirrored.Rounded.Logout,
                            label = stringResource(R.string.profile_menu_logout),
                            onClick = { onDismiss(); onLogoutClick() }
                        )
                    }
                }
            }
        }
    }
    
    @Composable
    fun MenuRowItem(
        icon: ImageVector,
        label: String,
        onClick: () -> Unit,
        isNew: Boolean = false
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(onClick = onClick)
                .padding(horizontal = 20.dp, vertical = 16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(icon, null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
            Spacer(Modifier.width(16.dp))
            Text(
                text = label,
                style = MaterialTheme.typography.bodyLarge,
                modifier = Modifier.weight(1f),
                fontWeight = FontWeight.Medium
            )
            if (isNew) {
                Badge(containerColor = MaterialTheme.colorScheme.primary) { Text(stringResource(R.string.profile_menu_badge_new)) }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/ProfileScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.content.Intent
    import androidx.activity.compose.BackHandler
    import androidx.compose.animation.*
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.LazyRow
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.lazy.rememberLazyListState
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.text.ClickableText
    import androidx.compose.foundation.text.KeyboardOptions
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.automirrored.filled.ArrowForward
    import androidx.compose.material.icons.filled.*
    import androidx.compose.material.icons.outlined.Edit
    import androidx.compose.material.icons.outlined.FavoriteBorder
    import androidx.compose.material.icons.outlined.LocationOn
    import androidx.compose.material.icons.outlined.Share
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.alpha
    import androidx.compose.ui.draw.blur
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.Brush
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalUriHandler
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.SpanStyle
    import androidx.compose.ui.text.buildAnnotatedString
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.input.ImeAction
    import androidx.compose.ui.text.style.TextAlign
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.Dp
    import androidx.compose.ui.unit.dp
    import androidx.compose.ui.unit.sp
    import androidx.compose.ui.zIndex
    import androidx.lifecycle.viewmodel.compose.viewModel
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.ui.common.ShimmerLine
    import com.alananasss.kittytune.ui.common.TrackListItemShimmer
    import com.alananasss.kittytune.ui.library.TrackListItem
    import com.alananasss.kittytune.ui.player.PlaybackContext
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import java.io.File
    import java.text.NumberFormat
    import java.util.Locale
    import java.util.regex.Pattern
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun ProfileScreen(
        userId: String,
        onBackClick: () -> Unit,
        playerViewModel: PlayerViewModel,
        onNavigate: (String) -> Unit = {},
        profileViewModel: ProfileViewModel = viewModel()
    ) {
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
        val listState = rememberLazyListState()
        var expandedSection by remember { mutableStateOf<String?>(null) }
        var showEditSheet by remember { mutableStateOf(false) }
        val uriHandler = LocalUriHandler.current
        val context = LocalContext.current
    
        LaunchedEffect(userId) {
            val id = userId.toLongOrNull()
            if (id != null) profileViewModel.loadProfile(id)
        }
    
        val user = profileViewModel.user
    
        // handle back press if a section is expanded
        BackHandler(enabled = expandedSection != null) {
            expandedSection = null
        }
    
        // create playback context for this artist
        val artistText = stringResource(R.string.generic_artist)
        val artistPlaybackContext = remember(user, artistText) {
            user?.let {
                PlaybackContext(
                    displayText = "$artistText â€¢ ${it.username}",
                    navigationId = "profile:${it.id}",
                    imageUrl = it.avatarUrl
                )
            }
        }
    
        Box(modifier = Modifier.fillMaxSize().background(MaterialTheme.colorScheme.background)) {
            if (profileViewModel.isLoading && user == null) {
                ProfileScreenShimmer(onBackClick)
            } else if (user != null) {
                // overlay for expanded sections
                AnimatedVisibility(
                    visible = expandedSection != null,
                    enter = slideInHorizontally { it },
                    exit = slideOutHorizontally { it },
                    modifier = Modifier.zIndex(2f)
                ) {
                    val (title, list) = when (expandedSection) {
                        "popular" -> stringResource(R.string.profile_tab_popular) to profileViewModel.popularTracks.toList()
                        "tracks" -> stringResource(R.string.profile_tab_tracks) to profileViewModel.allTracks.toList()
                        "reposts" -> stringResource(R.string.profile_tab_reposts) to profileViewModel.repostedTracks.toList()
                        "likes" -> stringResource(R.string.profile_tab_likes, user.username ?: "") to profileViewModel.likedTracks.toList()
                        else -> "" to emptyList<Track>()
                    }
    
                    // don't use artist context for liked tracks (confusing)
                    val contextForList = if (expandedSection == "likes") null else artistPlaybackContext
    
                    FullListScreen(
                        title = title,
                        tracks = list,
                        onBack = { expandedSection = null },
                        playerViewModel = playerViewModel,
                        downloadProgress = downloadProgress,
                        context = contextForList
                    )
                }
    
                LazyColumn(
                    state = listState,
                    contentPadding = PaddingValues(bottom = 120.dp),
                    modifier = Modifier.fillMaxSize()
                ) {
                    item {
                        ModernProfileHeader(
                            user = user,
                            isCurrentUser = profileViewModel.isCurrentUser,
                            onEditClick = { showEditSheet = true },
                            playerViewModel = playerViewModel,
                            onNavigate = onNavigate,
                            profileViewModel = profileViewModel,
                            artistContext = artistPlaybackContext
                        )
                    }
    
                    // bio section
                    if (!user.description.isNullOrBlank()) {
                        item {
                            Column(modifier = Modifier.padding(horizontal = 24.dp, vertical = 8.dp)) {
                                Text(
                                    text = stringResource(R.string.profile_about),
                                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                Spacer(Modifier.height(8.dp))
                                ExpandableDescription(
                                    text = user.description,
                                    onUrlClick = { url -> uriHandler.openUri(url) },
                                    onMentionClick = { username ->
                                        playerViewModel.resolveAndNavigateToArtist(username)
                                    }
                                )
                                Spacer(Modifier.height(16.dp))
                            }
                        }
                    }
    
                    if (profileViewModel.popularTracks.isNotEmpty()) {
                        item { SectionTitle(title = stringResource(R.string.profile_tab_popular), showMore = profileViewModel.popularTracks.size > 5, onMoreClick = { expandedSection = "popular" }) }
                        itemsIndexed(profileViewModel.popularTracks.take(5)) { index, track ->
                            ProfileTrackItem(track, index, playerViewModel, downloadProgress, profileViewModel.popularTracks, artistPlaybackContext)
                        }
                    }
    
                    if (profileViewModel.allTracks.isNotEmpty()) {
                        item { SectionTitle(title = stringResource(R.string.profile_latest_tracks), showMore = true, onMoreClick = { expandedSection = "tracks" }) }
                        itemsIndexed(profileViewModel.allTracks.take(5)) { index, track ->
                            ProfileTrackItem(track, index, playerViewModel, downloadProgress, profileViewModel.allTracks, artistPlaybackContext)
                        }
                    }
    
                    if (profileViewModel.albums.isNotEmpty()) {
                        item { SectionTitle(stringResource(R.string.profile_tab_albums)) }
                        item {
                            LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                                items(profileViewModel.albums) { playlist -> SquareCard(playlist) { onNavigate(playlist.id.toString()) } }
                            }
                        }
                    }
    
                    if (profileViewModel.playlists.isNotEmpty()) {
                        item {
                            val name = user.username ?: stringResource(R.string.generic_artist)
                            SectionTitle(stringResource(R.string.profile_playlists_by_user, name))
                        }
                        item {
                            LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                                items(profileViewModel.playlists) { playlist -> SquareCard(playlist) { onNavigate(playlist.id.toString()) } }
                            }
                        }
                    }
    
                    if (profileViewModel.likedTracks.isNotEmpty()) {
                        item {
                            val name = user.username ?: stringResource(R.string.generic_artist)
                            SectionTitle(title = stringResource(R.string.profile_likes_by_user, name), showMore = true, onMoreClick = { expandedSection = "likes" })
                        }
                        itemsIndexed(profileViewModel.likedTracks.take(3)) { index, track ->
                            ProfileTrackItem(track, index, playerViewModel, downloadProgress, profileViewModel.likedTracks, null)
                        }
                    }
    
                    if (profileViewModel.repostedTracks.isNotEmpty()) {
                        item {
                            SectionTitle(title = stringResource(R.string.profile_tab_reposts), showMore = true, onMoreClick = { expandedSection = "reposts" })
                        }
                        itemsIndexed(profileViewModel.repostedTracks.take(5)) { index, track ->
                            ProfileTrackItem(track, index, playerViewModel, downloadProgress, profileViewModel.repostedTracks, artistPlaybackContext)
                        }
                    }
    
                    if (profileViewModel.similarArtists.isNotEmpty()) {
                        item { Spacer(Modifier.height(24.dp)) }
                        item { SectionTitle(stringResource(R.string.profile_similar_artists)) }
                        item {
                            LazyRow(contentPadding = PaddingValues(horizontal = 16.dp), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                                items(profileViewModel.similarArtists) { artist -> ArtistCircle(artist) { onNavigate("profile:${artist.id}") } }
                            }
                        }
                    }
                }
    
                // dynamic app bar logic
                val showBarBackground by remember { derivedStateOf { listState.firstVisibleItemIndex > 0 || listState.firstVisibleItemScrollOffset > 300 } }
                val barColor by animateColorAsState(if (showBarBackground) MaterialTheme.colorScheme.surface.copy(alpha = 0.98f) else Color.Transparent, label = "bar")
                val contentColor by animateColorAsState(if (showBarBackground) MaterialTheme.colorScheme.onSurface else Color.White, label = "content")
    
                val isArtistSaved by DownloadManager.isArtistSavedFlow(user.id).collectAsState(initial = null)
    
                CenterAlignedTopAppBar(
                    title = {
                        AnimatedVisibility(visible = showBarBackground, enter = fadeIn(), exit = fadeOut()) {
                            Text(user.username ?: "", maxLines = 1, overflow = TextOverflow.Ellipsis, style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold))
                        }
                    },
                    navigationIcon = {
                        IconButton(onClick = onBackClick, colors = IconButtonDefaults.iconButtonColors(containerColor = if (showBarBackground) Color.Transparent else Color.Black.copy(alpha = 0.3f), contentColor = contentColor)) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_back))
                        }
                    },
                    actions = {
                        if (profileViewModel.isCurrentUser) {
                            AnimatedVisibility(visible = showBarBackground, enter = fadeIn(), exit = fadeOut()) {
                                IconButton(onClick = { showEditSheet = true }) {
                                    Icon(Icons.Outlined.Edit, stringResource(R.string.profile_edit), tint = contentColor)
                                }
                            }
                        } else {
                            IconButton(
                                onClick = { DownloadManager.toggleSaveArtist(user) },
                                colors = IconButtonDefaults.iconButtonColors(containerColor = if (showBarBackground) Color.Transparent else Color.Black.copy(alpha = 0.3f), contentColor = if(isArtistSaved != null) Color(0xFFFF4081) else contentColor)
                            ) {
                                Icon(if (isArtistSaved != null) Icons.Filled.Favorite else Icons.Outlined.FavoriteBorder, stringResource(R.string.btn_follow))
                            }
                        }
    
                        IconButton(
                            onClick = {
                                val cleanUsername = user.username?.replace(" ", "")?.lowercase() ?: "user"
                                val shareUrl = user.permalinkUrl ?: "https://soundcloud.com/$cleanUsername"
                                val sendIntent = Intent().apply {
                                    action = Intent.ACTION_SEND
                                    putExtra(Intent.EXTRA_TEXT, shareUrl)
                                    type = "text/plain"
                                }
                                context.startActivity(Intent.createChooser(sendIntent, context.getString(R.string.share_via)))
                            },
                            colors = IconButtonDefaults.iconButtonColors(containerColor = if (showBarBackground) Color.Transparent else Color.Black.copy(alpha = 0.3f), contentColor = contentColor)
                        ) {
                            Icon(Icons.Outlined.Share, stringResource(R.string.btn_share))
                        }
                    },
                    colors = TopAppBarDefaults.centerAlignedTopAppBarColors(containerColor = barColor, titleContentColor = MaterialTheme.colorScheme.onSurface, actionIconContentColor = MaterialTheme.colorScheme.onSurface),
                    modifier = Modifier.align(Alignment.TopCenter).zIndex(1f)
                )
    
                if (showEditSheet) {
                    EditProfileSheet(
                        user = user,
                        onDismiss = { showEditSheet = false },
                        onSave = { name, bio, city ->
                            profileViewModel.updateProfile(name, bio, city, "")
                            showEditSheet = false
                        }
                    )
                }
            }
        }
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun ProfileScreenShimmer(onBackClick: () -> Unit) {
        Box(modifier = Modifier.fillMaxSize()) {
            LazyColumn(userScrollEnabled = false) {
                item {
                    Box(modifier = Modifier
                        .fillMaxWidth()
                        .height(480.dp)) {
                        Box(modifier = Modifier
                            .fillMaxSize()
                            .background(MaterialTheme.colorScheme.surfaceVariant))
                        Box(modifier = Modifier
                            .fillMaxSize()
                            .background(Brush.verticalGradient(colors = listOf(Color.Transparent, MaterialTheme.colorScheme.background.copy(alpha = 0.5f), MaterialTheme.colorScheme.background, MaterialTheme.colorScheme.background), startY = 0f)))
    
                        Column(
                            modifier = Modifier
                                .align(Alignment.BottomCenter)
                                .padding(horizontal = 24.dp)
                                .padding(bottom = 24.dp),
                            horizontalAlignment = Alignment.CenterHorizontally
                        ) {
                            ArtistAvatar(avatarUrl = null, modifier = Modifier
                                .size(140.dp)
                                .clip(CircleShape))
                            Spacer(Modifier.height(20.dp))
                            ShimmerLine(Modifier.width(200.dp).height(30.dp))
                            Spacer(Modifier.height(12.dp))
                            ShimmerLine(Modifier.width(150.dp))
                        }
                    }
                }
                item { SectionTitle(title = "...") }
                items(5) {
                    TrackListItemShimmer()
                }
            }
            CenterAlignedTopAppBar(
                title = {},
                navigationIcon = {
                    IconButton(onClick = onBackClick, colors = IconButtonDefaults.iconButtonColors(containerColor = Color.Black.copy(alpha = 0.3f), contentColor = Color.White)) {
                        Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_back))
                    }
                },
                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(containerColor = Color.Transparent),
                modifier = Modifier.align(Alignment.TopCenter).zIndex(1f)
            )
        }
    }
    
    
    @Composable
    fun ArtistAvatar(modifier: Modifier = Modifier, avatarUrl: String?) {
        Box(
            modifier = modifier.background(MaterialTheme.colorScheme.surfaceVariant),
            contentAlignment = Alignment.Center
        ) {
            if (!avatarUrl.isNullOrEmpty()) {
                AsyncImage(
                    model = avatarUrl.replace("large", "t500x500"),
                    contentDescription = stringResource(R.string.profile_avatar),
                    contentScale = ContentScale.Crop,
                    modifier = Modifier.fillMaxSize()
                )
            } else {
                Icon(
                    Icons.Default.Person,
                    contentDescription = stringResource(R.string.profile_avatar),
                    modifier = Modifier.fillMaxSize(0.6f),
                    tint = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
    
    @Composable
    fun ModernProfileHeader(
        user: User,
        isCurrentUser: Boolean,
        onEditClick: () -> Unit,
        playerViewModel: PlayerViewModel,
        onNavigate: (String) -> Unit,
        profileViewModel: ProfileViewModel,
        artistContext: PlaybackContext?
    ) {
        Box(modifier = Modifier
            .fillMaxWidth()
            .height(480.dp)) {
            val bgModel = user.bannerUrl ?: user.avatarUrl
            AsyncImage(model = bgModel, contentDescription = null, contentScale = ContentScale.Crop, modifier = Modifier
                .fillMaxSize()
                .blur(60.dp)
                .alpha(0.6f))
            Box(modifier = Modifier
                .fillMaxSize()
                .background(Brush.verticalGradient(colors = listOf(Color.Transparent, MaterialTheme.colorScheme.background.copy(alpha = 0.5f), MaterialTheme.colorScheme.background, MaterialTheme.colorScheme.background), startY = 0f)))
    
            Column(modifier = Modifier
                .align(Alignment.BottomCenter)
                .padding(horizontal = 24.dp)
                .padding(bottom = 24.dp), horizontalAlignment = Alignment.CenterHorizontally) {
    
                Box {
                    Surface(shape = CircleShape, shadowElevation = 12.dp, color = Color.Transparent, modifier = Modifier.size(140.dp)) {
                        ArtistAvatar(
                            avatarUrl = user.avatarUrl,
                            modifier = Modifier.fillMaxSize()
                        )
                    }
                    if (isCurrentUser) {
                        Surface(
                            onClick = onEditClick,
                            shape = CircleShape,
                            color = MaterialTheme.colorScheme.primary,
                            modifier = Modifier
                                .align(Alignment.BottomEnd)
                                .offset(x = 4.dp, y = (-4).dp)
                        ) {
                            Icon(Icons.Outlined.Edit, stringResource(R.string.profile_edit), tint = MaterialTheme.colorScheme.onPrimary, modifier = Modifier
                                .padding(8.dp)
                                .size(20.dp))
                        }
                    }
                }
    
                Spacer(Modifier.height(20.dp))
                Text(text = user.username ?: stringResource(R.string.unknown_artist), style = MaterialTheme.typography.headlineLarge.copy(fontWeight = FontWeight.Bold, letterSpacing = (-0.5).sp), textAlign = TextAlign.Center, color = MaterialTheme.colorScheme.onBackground)
    
                if (!user.city.isNullOrBlank() || !user.countryCode.isNullOrBlank()) {
                    Spacer(Modifier.height(4.dp))
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        Icon(Icons.Outlined.LocationOn, null, tint = MaterialTheme.colorScheme.onSurfaceVariant, modifier = Modifier.size(14.dp))
                        Spacer(Modifier.width(4.dp))
                        Text(text = listOfNotNull(user.city, user.countryCode).joinToString(", "), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
    
                Spacer(Modifier.height(8.dp))
                Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Center) {
                    Text(text = "${NumberFormat.getNumberInstance(Locale.US).format(user.followersCount)} ${stringResource(R.string.profile_followers)}", style = MaterialTheme.typography.bodyMedium.copy(fontWeight = FontWeight.Medium), color = MaterialTheme.colorScheme.onSurfaceVariant)
                    Text(text = " â€¢ ", style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f))
                    Text(text = "${NumberFormat.getNumberInstance(Locale.US).format(user.trackCount)} ${stringResource(R.string.profile_tracks)}", style = MaterialTheme.typography.bodyMedium.copy(fontWeight = FontWeight.Medium), color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
    
                Spacer(Modifier.height(32.dp))
    
                if (isCurrentUser) {
                    Button(
                        onClick = onEditClick,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(50.dp),
                        shape = RoundedCornerShape(50),
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.surfaceVariant, contentColor = MaterialTheme.colorScheme.onSurfaceVariant)
                    ) {
                        Text(stringResource(R.string.profile_edit), fontWeight = FontWeight.SemiBold)
                    }
                } else {
                    if (user.trackCount > 0) {
                        Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                            Button(
                                onClick = {
                                    playerViewModel.playPlaylist(
                                        tracks = profileViewModel.allTracks.toList().shuffled(),
                                        startIndex = 0,
                                        context = artistContext
                                    )
                                },
                                modifier = Modifier
                                    .weight(1f)
                                    .height(56.dp), shape = RoundedCornerShape(50),
                                colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary, contentColor = MaterialTheme.colorScheme.onPrimary),
                                elevation = ButtonDefaults.buttonElevation(defaultElevation = 4.dp)
                            ) {
                                Icon(Icons.Default.Shuffle, null, modifier = Modifier.size(20.dp)); Spacer(Modifier.width(8.dp));
                                Text(
                                    stringResource(R.string.btn_shuffle),
                                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),
                                    maxLines = 1,
                                    overflow = TextOverflow.Ellipsis
                                )
                            }
                            FilledTonalButton(
                                onClick = { onNavigate("station_artist:${user.id}") },
                                modifier = Modifier
                                    .weight(1f)
                                    .height(56.dp), shape = RoundedCornerShape(50),
                                colors = ButtonDefaults.filledTonalButtonColors(containerColor = MaterialTheme.colorScheme.secondaryContainer, contentColor = MaterialTheme.colorScheme.onSecondaryContainer)
                            ) {
                                Icon(Icons.Default.Radio, null, modifier = Modifier.size(20.dp)); Spacer(Modifier.width(8.dp));
                                Text(
                                    stringResource(R.string.radio),
                                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),
                                    maxLines = 1,
                                    overflow = TextOverflow.Ellipsis
                                )
                            }
                        }
                    }
                }
            }
        }
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun EditProfileSheet(
        user: User,
        onDismiss: () -> Unit,
        onSave: (name: String, bio: String, city: String) -> Unit
    ) {
        var name by remember { mutableStateOf(user.username ?: "") }
        var bio by remember { mutableStateOf(user.description ?: "") }
        var city by remember { mutableStateOf(user.city ?: "") }
    
        ModalBottomSheet(
            onDismissRequest = onDismiss,
            sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true),
            containerColor = MaterialTheme.colorScheme.surface,
            dragHandle = null
        ) {
            Column(modifier = Modifier
                .fillMaxWidth()
                .navigationBarsPadding()
                .imePadding()
            ) {
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 24.dp, vertical = 16.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(stringResource(R.string.profile_edit_title), style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold))
                    IconButton(onClick = onDismiss) { Icon(Icons.Default.Close, stringResource(R.string.btn_close)) }
                }
    
                Box(modifier = Modifier
                    .fillMaxWidth()
                    .height(220.dp)) {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(160.dp)
                            .background(MaterialTheme.colorScheme.surfaceVariant)
                    ) {
                        val bannerModel = user.bannerUrl
                        AsyncImage(
                            model = bannerModel,
                            contentDescription = stringResource(R.string.profile_banner),
                            contentScale = ContentScale.Crop,
                            modifier = Modifier
                                .fillMaxSize()
                                .alpha(0.7f)
                        )
                    }
    
                    Box(
                        modifier = Modifier
                            .align(Alignment.BottomCenter)
                            .offset(y = 0.dp)
                    ) {
                        Box(
                            modifier = Modifier
                                .size(120.dp)
                                .clip(CircleShape)
                                .background(MaterialTheme.colorScheme.surface)
                                .padding(4.dp)
                        ) {
                            ArtistAvatar(
                                avatarUrl = user.avatarUrl,
                                modifier = Modifier
                                    .fillMaxSize()
                                    .clip(CircleShape)
                            )
                        }
                    }
                }
    
                Spacer(Modifier.height(24.dp))
    
                Column(modifier = Modifier.padding(horizontal = 24.dp)) {
                    OutlinedTextField(
                        value = name,
                        onValueChange = { name = it },
                        label = { Text(stringResource(R.string.profile_name)) },
                        modifier = Modifier.fillMaxWidth(),
                        singleLine = true,
                        shape = RoundedCornerShape(12.dp)
                    )
    
                    Spacer(Modifier.height(16.dp))
    
                    OutlinedTextField(
                        value = city,
                        onValueChange = { city = it },
                        label = { Text(stringResource(R.string.profile_city)) },
                        modifier = Modifier.fillMaxWidth(),
                        singleLine = true,
                        shape = RoundedCornerShape(12.dp)
                    )
    
                    Spacer(Modifier.height(16.dp))
    
                    OutlinedTextField(
                        value = bio,
                        onValueChange = { bio = it },
                        label = { Text(stringResource(R.string.profile_bio)) },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(120.dp),
                        shape = RoundedCornerShape(12.dp),
                        keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done)
                    )
    
                    Spacer(Modifier.height(24.dp))
    
                    Button(
                        onClick = { onSave(name, bio, city) },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(50.dp),
                        shape = RoundedCornerShape(50),
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                    ) {
                        Text(stringResource(R.string.btn_save_changes))
                    }
    
                    Spacer(Modifier.height(24.dp))
                }
            }
        }
    }
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun FullListScreen(
        title: String,
        tracks: List<Track>,
        onBack: () -> Unit,
        playerViewModel: PlayerViewModel,
        downloadProgress: Map<Long, Int>,
        context: PlaybackContext?
    ) {
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(title, fontWeight = FontWeight.Bold) },
                    navigationIcon = {
                        IconButton(onClick = onBack) { Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_back)) }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(containerColor = MaterialTheme.colorScheme.background)
                )
            },
            containerColor = MaterialTheme.colorScheme.background
        ) { innerPadding ->
            LazyColumn(
                contentPadding = PaddingValues(bottom = 120.dp),
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
            ) {
                item {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp),
                        horizontalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Button(
                            onClick = { playerViewModel.playPlaylist(tracks, context = context) },
                            modifier = Modifier.weight(1f),
                            colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                        ) {
                            Icon(Icons.Default.PlayArrow, null); Spacer(Modifier.width(8.dp)); Text(stringResource(R.string.btn_play))
                        }
                        FilledTonalButton(
                            onClick = { playerViewModel.playPlaylist(tracks.shuffled(), context = context) },
                            modifier = Modifier.weight(1f)
                        ) {
                            Icon(Icons.Default.Shuffle, null); Spacer(Modifier.width(8.dp)); Text(stringResource(R.string.btn_shuffle))
                        }
                    }
                }
                itemsIndexed(tracks) { index, track ->
                    ProfileTrackItem(track, index, playerViewModel, downloadProgress, tracks, context)
                }
            }
        }
    }
    
    @Composable
    fun ProfileTrackItem(
        track: Track,
        index: Int,
        playerViewModel: PlayerViewModel,
        downloadProgress: Map<Long, Int>,
        contextList: List<Track>,
        context: PlaybackContext?
    ) {
        val currentContext = LocalContext.current
        val progress = downloadProgress[track.id]
        val isDownloading = progress != null
        val isDownloaded = remember(track.id, downloadProgress) {
            File(currentContext.filesDir, "track_${track.id}.mp3").exists()
        }
    
        TrackListItem(
            track = track,
            currentlyPlayingTrack = playerViewModel.currentTrack,
            index = index,
            isDownloading = isDownloading,
            isDownloaded = isDownloaded,
            downloadProgress = progress ?: 0,
            onClick = {
                playerViewModel.playPlaylist(contextList, startIndex = index, context = context)
            },
            onOptionClick = { playerViewModel.showTrackOptions(track) }
        )
    }
    
    @Composable
    fun SectionTitle(title: String, showMore: Boolean = false, onMoreClick: () -> Unit = {}) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(text = title, style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold))
            if (showMore) {
                TextButton(onClick = onMoreClick) {
                    Text(stringResource(R.string.btn_see_all))
                    Icon(Icons.AutoMirrored.Filled.ArrowForward, null, modifier = Modifier.size(16.dp))
                }
            }
        }
    }
    
    @Composable
    fun SquareCard(playlist: Playlist, onClick: () -> Unit) {
        Column(modifier = Modifier
            .width(140.dp)
            .clickable { onClick() }) {
            AsyncImage(
                model = playlist.fullResArtwork,
                contentDescription = null,
                contentScale = ContentScale.Crop,
                modifier = Modifier
                    .size(140.dp)
                    .clip(RoundedCornerShape(12.dp))
                    .background(MaterialTheme.colorScheme.surfaceVariant)
            )
            Spacer(Modifier.height(8.dp))
            Text(
                text = playlist.title ?: stringResource(R.string.generic_title),
                style = MaterialTheme.typography.bodyLarge,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis,
                fontWeight = FontWeight.SemiBold
            )
            Text(
                text = stringResource(R.string.playlist_num_tracks, playlist.trackCount ?: 0),
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
    
    @Composable
    fun ArtistCircle(user: User, onClick: () -> Unit) {
        Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier
            .width(120.dp)
            .clickable { onClick() }) {
            ArtistAvatar(
                avatarUrl = user.avatarUrl,
                modifier = Modifier
                    .size(120.dp)
                    .clip(CircleShape)
            )
            Spacer(Modifier.height(8.dp))
            Text(text = user.username ?: stringResource(R.string.generic_artist), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold), maxLines = 1, overflow = TextOverflow.Ellipsis, textAlign = TextAlign.Center)
        }
    }
    
    @Composable
    fun ExpandableDescription(
        text: String,
        onUrlClick: (String) -> Unit,
        onMentionClick: (String) -> Unit
    ) {
        var isExpanded by remember { mutableStateOf(false) }
    
        val urlPattern = Pattern.compile("((https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|])")
        val mentionPattern = Pattern.compile("@[\\w-]+")
    
        val annotatedString = buildAnnotatedString {
            val fullText = text
            append(fullText)
    
            val urlMatcher = urlPattern.matcher(fullText)
            while (urlMatcher.find()) {
                addStringAnnotation(
                    tag = "URL",
                    annotation = urlMatcher.group(),
                    start = urlMatcher.start(),
                    end = urlMatcher.end()
                )
                addStyle(
                    style = SpanStyle(
                        color = MaterialTheme.colorScheme.primary,
                        fontWeight = FontWeight.Bold
                    ),
                    start = urlMatcher.start(),
                    end = urlMatcher.end()
                )
            }
    
            val mentionMatcher = mentionPattern.matcher(fullText)
            while (mentionMatcher.find()) {
                addStringAnnotation(
                    tag = "MENTION",
                    annotation = mentionMatcher.group(),
                    start = mentionMatcher.start(),
                    end = mentionMatcher.end()
                )
                addStyle(
                    style = SpanStyle(
                        color = MaterialTheme.colorScheme.tertiary,
                        fontWeight = FontWeight.SemiBold
                    ),
                    start = mentionMatcher.start(),
                    end = mentionMatcher.end()
                )
            }
        }
    
        Column(modifier = Modifier.animateContentSize()) {
            ClickableText(
                text = annotatedString,
                style = MaterialTheme.typography.bodyMedium.copy(
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    lineHeight = 20.sp
                ),
                maxLines = if (isExpanded) Int.MAX_VALUE else 5,
                overflow = TextOverflow.Ellipsis,
                onClick = { offset ->
                    var isAnnotationClicked = false
                    annotatedString.getStringAnnotations(start = offset, end = offset).firstOrNull()?.let { annotation ->
                        when (annotation.tag) {
                            "URL" -> { onUrlClick(annotation.item); isAnnotationClicked = true }
                            "MENTION" -> { onMentionClick(annotation.item); isAnnotationClicked = true }
                        }
                    }
                    if (!isAnnotationClicked) {
                        isExpanded = !isExpanded
                    }
                }
            )
    
            if (text.length > 200) {
                Text(
                    text = if (isExpanded) stringResource(R.string.detail_show_less) else stringResource(R.string.detail_show_more),
                    style = MaterialTheme.typography.labelLarge,
                    color = MaterialTheme.colorScheme.primary,
                    modifier = Modifier
                        .padding(top = 4.dp)
                        .clickable { isExpanded = !isExpanded }
                )
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/ProfileViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.app.Application
    import android.widget.Toast
    import androidx.annotation.StringRes
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateListOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.UpdateProfileRequest
    import com.alananasss.kittytune.domain.User
    import kotlinx.coroutines.async
    import kotlinx.coroutines.coroutineScope
    import kotlinx.coroutines.launch
    
    // tabs logic handled by view, title stripped
    enum class ProfileTab {
        POPULAR,
        TRACKS,
        ALBUMS,
        PLAYLISTS,
        LIKES,
        REPOSTS
    }
    
    class ProfileViewModel(application: Application) : AndroidViewModel(application) {
        private val api = RetrofitClient.create(application)
    
        var user by mutableStateOf<User?>(null)
        var isCurrentUser by mutableStateOf(false)
        var isLoading by mutableStateOf(true)
        var selectedTab by mutableStateOf(ProfileTab.POPULAR)
    
        // all the content lists
        val popularTracks = mutableStateListOf<Track>()
        val allTracks = mutableStateListOf<Track>()
        val repostedTracks = mutableStateListOf<Track>()
        val albums = mutableStateListOf<Playlist>()
        val playlists = mutableStateListOf<Playlist>()
        val likedTracks = mutableStateListOf<Track>()
        val similarArtists = mutableStateListOf<User>()
    
        var artistStationId: Long? = null
    
        // helper to get strings inside viewmodel
        private fun getString(@StringRes resId: Int): String = getApplication<Application>().getString(resId)
        private fun getString(@StringRes resId: Int, vararg formatArgs: Any): String = getApplication<Application>().getString(resId, *formatArgs)
    
    
        // helper to page through all tracks if needed
        private suspend fun fetchAllUserTracks(userId: Long): List<Track> {
            val allUserTracks = mutableListOf<Track>()
            try {
                val firstPage = api.getUserTracks(userId, limit = 200)
                allUserTracks.addAll(firstPage.collection.filterNotNull())
                var nextUrl = firstPage.next_href
                var pageCount = 0
                // safety limit to avoid infinite loops
                while (nextUrl != null && pageCount < 20) {
                    val nextPage = api.getUserTracksNextPage(nextUrl)
                    allUserTracks.addAll(nextPage.collection.filterNotNull())
                    nextUrl = nextPage.next_href
                    pageCount++
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
            return allUserTracks
        }
    
        fun loadProfile(userId: Long) {
            viewModelScope.launch {
                isLoading = true
                isCurrentUser = false
                try {
                    // check if it's me
                    try {
                        val me = api.getMe()
                        if (me.id == userId) {
                            isCurrentUser = true
                        }
                    } catch (e: Exception) { /* ignore */ }
    
                    // avoid flickering if we reload same user
                    if (user?.id != userId) {
                        user = api.getUser(userId)
                    } else {
                        val freshUser = api.getUser(userId)
                        user = freshUser
                    }
    
                    coroutineScope {
                        // parallel fetching of everything
                        val popDef = async { try { api.getUserTopTracks(userId).collection.filterNotNull() } catch (_: Exception) { emptyList() } }
                        val tracksDef = async { fetchAllUserTracks(userId) }
                        val repostsDef = async {
                            try {
                                api.getUserReposts(userId, limit = 50).collection
                                    .filter { it.type == "track-repost" && it.track != null }
                                    .mapNotNull { it.track }
                            } catch (_: Exception) { emptyList() }
                        }
                        val albumsDef = async { try { api.getUserAlbums(userId).collection.filterNotNull() } catch (_: Exception) { emptyList() } }
                        val playDef = async { try { api.getUserCreatedPlaylists(userId).collection.filterNotNull() } catch (_: Exception) { emptyList() } }
                        val likesDef = async {
                            val allLikes = mutableListOf<Track>()
                            try {
                                var nextUrl: String? = null
                                val firstPage = api.getUserTrackLikes(userId, limit = 50)
                                allLikes.addAll(firstPage.collection.mapNotNull { it.track })
                                nextUrl = firstPage.next_href
                                var safetyCount = 0
                                while (nextUrl != null && safetyCount < 10) {
                                    val page = api.getTrackLikesNextPage(nextUrl!!)
                                    allLikes.addAll(page.collection.mapNotNull { it.track })
                                    nextUrl = page.next_href
                                    safetyCount++
                                }
                            } catch (_: Exception) { }
                            allLikes
                        }
                        val simDef = async {
                            var artists = emptyList<User>()
                            try {
                                val station = try { api.getArtistStation(userId) } catch (e: Exception) { null }
                                if (station != null) artistStationId = station.id
                                // find related artists via tracks
                                val related = api.getRelatedTracks(station?.tracks?.firstOrNull()?.id ?: 0, limit = 20)
                                artists = related.collection.mapNotNull { it.user }.filter { it.id != userId }.distinctBy { it.id }.shuffled().take(10)
                            } catch (_: Exception) { }
                            artists
                        }
    
                        popularTracks.clear(); popularTracks.addAll(popDef.await())
                        allTracks.clear(); allTracks.addAll(tracksDef.await())
                        repostedTracks.clear(); repostedTracks.addAll(repostsDef.await())
                        albums.clear(); albums.addAll(albumsDef.await())
                        playlists.clear(); playlists.addAll(playDef.await())
                        likedTracks.clear(); likedTracks.addAll(likesDef.await())
                        similarArtists.clear(); similarArtists.addAll(simDef.await())
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    isLoading = false
                }
            }
        }
    
        fun updateProfile(
            username: String,
            bio: String,
            city: String,
            country: String
        ) {
            val oldUser = user ?: return
    
            viewModelScope.launch {
                // optimistic update
                user = oldUser.copy(username = username, description = bio, city = city)
    
                try {
                    val request = UpdateProfileRequest(
                        username = username,
                        description = bio,
                        city = city,
                        countryCode = null
                    )
                    val updatedUser = api.updateMe(request)
    
                    if (!updatedUser.username.isNullOrBlank()) {
                        user = updatedUser
                    }
    
                    Toast.makeText(getApplication(), getString(R.string.profile_update_success), Toast.LENGTH_SHORT).show()
    
                } catch (e: Exception) {
                    e.printStackTrace()
                    // rollback on error
                    user = oldUser
                    Toast.makeText(getApplication(), getString(R.string.profile_update_error, e.message ?: ""), Toast.LENGTH_LONG).show()
                }
            }
        }
    
        fun onTabSelected(tab: ProfileTab) { selectedTab = tab }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/SettingsScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.PaddingValues
    import androidx.compose.foundation.layout.padding
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.SdStorage
    import androidx.compose.material.icons.rounded.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.Composable
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.navigation.NavController
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun SettingsScreen(
        navController: NavController,
        onBackClick: () -> Unit,
        playerViewModel: PlayerViewModel // needed to check for mini player
    ) {
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.settings_title), fontWeight = FontWeight.Bold) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_close))
                        }
                    }
                )
            }
        ) { innerPadding ->
    
            // calculate padding so mini player doesn't hide the last item
            val miniPlayerHeight = if (playerViewModel.currentTrack != null) 64.dp else 0.dp
            val bottomPadding = miniPlayerHeight + 16.dp
    
            LazyColumn(
                modifier = Modifier.padding(innerPadding),
                contentPadding = PaddingValues(bottom = bottomPadding)
            ) {
                item {
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_appearance))
    
                    SettingsItem(
                        icon = Icons.Rounded.Palette,
                        title = stringResource(R.string.pref_appearance_title),
                        subtitle = stringResource(R.string.pref_appearance_subtitle),
                        onClick = { navController.navigate("appearance_settings") }
                    )
    
                    SettingsItem(
                        icon = Icons.Rounded.TextSnippet,
                        title = stringResource(R.string.pref_lyrics_title),
                        subtitle = stringResource(R.string.pref_lyrics_subtitle),
                        onClick = { navController.navigate("lyrics_settings") }
                    )
    
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_playback))
    
                    SettingsItem(
                        icon = Icons.Rounded.GraphicEq,
                        title = stringResource(R.string.pref_audio_title),
                        subtitle = stringResource(R.string.pref_audio_subtitle),
                        onClick = { navController.navigate("audio_settings") }
                    )
    
                    SettingsCategoryHeader(stringResource(R.string.settings_cat_general))
    
                    SettingsItem(
                        icon = Icons.Filled.SdStorage,
                        title = stringResource(R.string.pref_local_title),
                        subtitle = stringResource(R.string.pref_local_subtitle),
                        onClick = { navController.navigate("local_media_settings") }
                    )
    
                    SettingsItem(
                        icon = Icons.Rounded.Storage,
                        title = stringResource(R.string.pref_storage_title),
                        subtitle = stringResource(R.string.pref_storage_subtitle),
                        onClick = { navController.navigate("storage") }
                    )
    
                    SettingsItem(
                        icon = Icons.Rounded.Backup,
                        title = stringResource(R.string.pref_backup_title),
                        subtitle = stringResource(R.string.pref_backup_subtitle),
                        onClick = { navController.navigate("backup_restore") }
                    )
    
                    SettingsItem(
                        icon = Icons.Rounded.Info,
                        title = stringResource(R.string.pref_about_title),
                        subtitle = stringResource(R.string.pref_about_subtitle),
                        onClick = { navController.navigate("about") }
                    )
                }
            }
        }
    }
    
    @Composable
    fun SettingsCategoryHeader(title: String) {
        Text(
            text = title,
            style = MaterialTheme.typography.titleSmall,
            color = MaterialTheme.colorScheme.primary,
            fontWeight = FontWeight.Bold,
            modifier = Modifier.padding(start = 16.dp, end = 16.dp, top = 24.dp, bottom = 8.dp)
        )
    }
    
    @Composable
    fun SettingsItem(
        icon: ImageVector,
        title: String,
        subtitle: String? = null,
        onClick: () -> Unit,
        titleColor: Color = Color.Unspecified
    ) {
        ListItem(
            headlineContent = { Text(title, fontWeight = FontWeight.Medium, color = titleColor) },
            supportingContent = { if (subtitle != null) Text(subtitle) },
            leadingContent = {
                Icon(icon, contentDescription = null, tint = if (titleColor != Color.Unspecified) titleColor else MaterialTheme.colorScheme.onSurfaceVariant)
            },
            modifier = Modifier.clickable(onClick = onClick)
        )
    }
    
    @Composable
    fun SettingsItemWithSubtitle(icon: ImageVector, title: String, subtitle: String, onClick: () -> Unit) {
        ListItem(
            headlineContent = { Text(title, fontWeight = FontWeight.Medium) },
            supportingContent = { Text(subtitle) },
            leadingContent = { Icon(icon, null, tint = MaterialTheme.colorScheme.onSurfaceVariant) },
            modifier = Modifier.clickable(onClick = onClick)
        )
    }
    
    @Composable
    fun SwitchSettingItem(
        icon: ImageVector,
        title: String,
        subtitle: String,
        checked: Boolean,
        enabled: Boolean = true,
        onCheckedChange: (Boolean) -> Unit
    ) {
        ListItem(
            headlineContent = {
                Text(
                    title,
                    fontWeight = FontWeight.Medium,
                    color = if (enabled) Color.Unspecified else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.38f)
                )
            },
            supportingContent = {
                Text(
                    subtitle,
                    color = if (enabled) MaterialTheme.colorScheme.onSurfaceVariant else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.38f)
                )
            },
            leadingContent = {
                Icon(
                    icon,
                    contentDescription = null,
                    tint = if (enabled) MaterialTheme.colorScheme.onSurfaceVariant else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.38f)
                )
            },
            trailingContent = {
                Switch(
                    checked = checked,
                    onCheckedChange = onCheckedChange,
                    enabled = enabled
                )
            },
            modifier = Modifier.clickable(enabled = enabled) { onCheckedChange(!checked) }
        )
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/StorageScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.net.Uri
    import androidx.activity.compose.rememberLauncherForActivityResult
    import androidx.activity.result.contract.ActivityResultContracts
    import androidx.compose.animation.core.animateFloatAsState
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.rememberScrollState
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.foundation.verticalScroll
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.SdStorage
    import androidx.compose.material.icons.outlined.*
    import androidx.compose.material.icons.rounded.Folder
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.vector.ImageVector
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import com.alananasss.kittytune.R
    
    @OptIn(ExperimentalMaterial3Api::class)
    @Composable
    fun StorageScreen(
        onBackClick: () -> Unit,
        viewModel: StorageViewModel = viewModel()
    ) {
        val context = LocalContext.current
    
        val folderPicker = rememberLauncherForActivityResult(
            contract = ActivityResultContracts.OpenDocumentTree()
        ) { uri: Uri? ->
            if (uri != null) {
                viewModel.onFolderSelected(uri)
            }
        }
    
        var showDeleteDialog by remember { mutableStateOf<DeleteAction?>(null) }
    
        if (showDeleteDialog != null) {
            AlertDialog(
                onDismissRequest = { showDeleteDialog = null },
                icon = { Icon(Icons.Outlined.DeleteForever, null) },
                title = { Text(stringResource(R.string.dialog_clean_title)) },
                text = { Text(showDeleteDialog!!.message) },
                confirmButton = {
                    TextButton(
                        onClick = {
                            showDeleteDialog!!.action()
                            showDeleteDialog = null
                        },
                        colors = ButtonDefaults.textButtonColors(contentColor = MaterialTheme.colorScheme.error)
                    ) {
                        Text(stringResource(R.string.btn_delete))
                    }
                },
                dismissButton = {
                    TextButton(onClick = { showDeleteDialog = null }) { Text(stringResource(R.string.btn_cancel)) }
                },
                containerColor = MaterialTheme.colorScheme.surfaceContainerHigh
            )
        }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.pref_storage_title)) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = stringResource(R.string.btn_back))
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = MaterialTheme.colorScheme.surface,
                        scrolledContainerColor = MaterialTheme.colorScheme.surfaceContainer
                    )
                )
            }
        ) { innerPadding ->
            Column(
                modifier = Modifier
                    .padding(innerPadding)
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
            ) {
                val totalAppUsage = viewModel.audioSize + viewModel.imageSize + viewModel.cacheSize + viewModel.databaseSize
    
                StorageGaugeCard(
                    usedBytes = viewModel.usedSpace,
                    freeBytes = viewModel.freeSpace,
                    appBytes = totalAppUsage,
                    totalBytes = viewModel.totalSpace,
                    formatSize = viewModel::formatSize
                )
    
                Spacer(modifier = Modifier.height(24.dp))
    
                Text(
                    stringResource(R.string.storage_location),
                    style = MaterialTheme.typography.labelLarge,
                    color = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.padding(horizontal = 24.dp, vertical = 8.dp)
                )
    
                LocationSelectorCard(
                    currentPath = viewModel.currentPath,
                    isExternal = viewModel.isExternal,
                    onChangeClick = { folderPicker.launch(null) },
                    onResetClick = { viewModel.resetToDefault() }
                )
    
                Spacer(modifier = Modifier.height(24.dp))
    
                Text(
                    stringResource(R.string.detail_tags), // Note: Reuse of "Tags" string, could be more specific
                    style = MaterialTheme.typography.labelLarge,
                    color = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.padding(horizontal = 24.dp, vertical = 8.dp)
                )
    
                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp),
                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerLow),
                    shape = RoundedCornerShape(16.dp)
                ) {
                    Column {
                        StorageItemRow(
                            icon = Icons.Outlined.MusicNote,
                            title = stringResource(R.string.storage_cat_audio),
                            size = viewModel.audioSize,
                            formatSize = viewModel::formatSize,
                            color = MaterialTheme.colorScheme.primary,
                            isDeletable = true,
                            onClick = {
                                showDeleteDialog = DeleteAction(
                                    context.getString(R.string.dialog_clean_audio_msg),
                                    { viewModel.cleanAudio() }
                                )
                            }
                        )
    
                        HorizontalDivider(
                            modifier = Modifier.padding(start = 56.dp),
                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f)
                        )
    
                        StorageItemRow(
                            icon = Icons.Outlined.Image,
                            title = stringResource(R.string.storage_cat_images),
                            size = viewModel.imageSize,
                            formatSize = viewModel::formatSize,
                            color = MaterialTheme.colorScheme.tertiary,
                            isDeletable = true,
                            onClick = {
                                showDeleteDialog = DeleteAction(
                                    context.getString(R.string.dialog_clean_images_msg),
                                    { viewModel.cleanImages() }
                                )
                            }
                        )
    
                        HorizontalDivider(
                            modifier = Modifier.padding(start = 56.dp),
                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f)
                        )
    
                        StorageItemRow(
                            icon = Icons.Outlined.Cached,
                            title = stringResource(R.string.storage_cat_cache),
                            size = viewModel.cacheSize,
                            formatSize = viewModel::formatSize,
                            color = MaterialTheme.colorScheme.secondary,
                            isDeletable = true,
                            onClick = {
                                showDeleteDialog = DeleteAction(
                                    context.getString(R.string.dialog_clean_cache_msg),
                                    { viewModel.cleanCache() }
                                )
                            }
                        )
    
                        HorizontalDivider(
                            modifier = Modifier.padding(start = 56.dp),
                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f)
                        )
    
                        StorageItemRow(
                            icon = Icons.Outlined.Storage,
                            title = stringResource(R.string.storage_cat_db),
                            subtitle = stringResource(R.string.storage_db_subtitle),
                            size = viewModel.databaseSize,
                            formatSize = viewModel::formatSize,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            isDeletable = false,
                            onClick = {}
                        )
                    }
                }
                Spacer(modifier = Modifier.height(100.dp))
            }
        }
    }
    
    data class DeleteAction(val message: String, val action: () -> Unit)
    
    @Composable
    fun StorageGaugeCard(
        usedBytes: Long,
        freeBytes: Long,
        appBytes: Long,
        totalBytes: Long,
        formatSize: (Long) -> String
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainer),
            shape = RoundedCornerShape(24.dp)
        ) {
            Column(modifier = Modifier.padding(20.dp)) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.Bottom
                ) {
                    Column {
                        Text(stringResource(R.string.storage_usage), style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                        Text(
                            text = stringResource(R.string.storage_used_formatted, formatSize(appBytes)),
                            style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold),
                            color = MaterialTheme.colorScheme.primary
                        )
                    }
                    Text(
                        text = stringResource(R.string.storage_free_formatted, formatSize(freeBytes)),
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
    
                Spacer(modifier = Modifier.height(16.dp))
    
                val appRatio = (appBytes.toFloat() / totalBytes.toFloat()).coerceIn(0f, 1f)
                val usedRatio = (usedBytes.toFloat() / totalBytes.toFloat()).coerceIn(0f, 1f)
    
                val animatedAppRatio by animateFloatAsState(targetValue = appRatio, label = "app")
                val animatedUsedRatio by animateFloatAsState(targetValue = usedRatio, label = "used")
    
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(12.dp)
                        .clip(RoundedCornerShape(6.dp))
                        .background(MaterialTheme.colorScheme.surfaceVariant)
                ) {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth(animatedUsedRatio)
                            .fillMaxHeight()
                            .background(MaterialTheme.colorScheme.secondary.copy(alpha = 0.5f))
                    )
                    Box(
                        modifier = Modifier
                            .fillMaxWidth(animatedAppRatio)
                            .fillMaxHeight()
                            .background(MaterialTheme.colorScheme.primary)
                    )
                }
    
                Spacer(modifier = Modifier.height(12.dp))
    
                Row(verticalAlignment = Alignment.CenterVertically) {
                    Badge(containerColor = MaterialTheme.colorScheme.primary, modifier = Modifier.size(8.dp))
                    Spacer(Modifier.width(8.dp))
                    Text(stringResource(R.string.app_name), style = MaterialTheme.typography.labelSmall)
    
                    Spacer(Modifier.width(16.dp))
    
                    Badge(containerColor = MaterialTheme.colorScheme.secondary.copy(alpha = 0.5f), modifier = Modifier.size(8.dp))
                    Spacer(Modifier.width(8.dp))
                    Text(stringResource(R.string.storage_legend_system), style = MaterialTheme.typography.labelSmall)
                }
            }
        }
    }
    
    @Composable
    fun LocationSelectorCard(
        currentPath: String,
        isExternal: Boolean,
        onChangeClick: () -> Unit,
        onResetClick: () -> Unit
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerLow),
            shape = RoundedCornerShape(16.dp),
            onClick = onChangeClick
        ) {
            Row(
                modifier = Modifier.padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                val icon = if (isExternal) Icons.Default.SdStorage else Icons.Rounded.Folder
                val iconColor = if (isExternal) MaterialTheme.colorScheme.tertiary else MaterialTheme.colorScheme.primary
    
                Box(
                    modifier = Modifier
                        .size(48.dp)
                        .clip(CircleShape)
                        .background(iconColor.copy(alpha = 0.1f)),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(icon, null, tint = iconColor)
                }
    
                Spacer(Modifier.width(16.dp))
    
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = currentPath,
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = FontWeight.Medium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = stringResource(R.string.storage_change_cta),
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
    
                if (isExternal) {
                    IconButton(onClick = onResetClick) {
                        Icon(Icons.Outlined.Restore, stringResource(R.string.storage_reset), tint = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                } else {
                    Icon(Icons.Outlined.FolderOpen, null, tint = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
        }
    }
    
    @Composable
    fun StorageItemRow(
        icon: ImageVector,
        title: String,
        subtitle: String? = null,
        size: Long,
        formatSize: (Long) -> String,
        color: Color,
        isDeletable: Boolean,
        onClick: () -> Unit
    ) {
        ListItem(
            modifier = Modifier.clickable(enabled = isDeletable, onClick = onClick),
            leadingContent = {
                Box(
                    modifier = Modifier
                        .size(40.dp)
                        .clip(CircleShape)
                        .background(color.copy(alpha = 0.1f)),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(icon, null, tint = color)
                }
            },
            headlineContent = { Text(title, fontWeight = FontWeight.SemiBold) },
            supportingContent = {
                if (subtitle != null) Text(subtitle)
                else Text(formatSize(size), color = MaterialTheme.colorScheme.onSurfaceVariant)
            },
            trailingContent = {
                if (isDeletable) {
                    IconButton(onClick = onClick) {
                        Icon(
                            Icons.Outlined.DeleteOutline,
                            contentDescription = stringResource(R.string.btn_delete),
                            tint = MaterialTheme.colorScheme.error.copy(alpha = 0.8f)
                        )
                    }
                } else if (subtitle == null) {
                    Text(formatSize(size), style = MaterialTheme.typography.bodyMedium)
                }
            }
        )
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/profile/StorageViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.profile
    
    import android.app.Application
    import android.content.Intent
    import android.net.Uri
    import android.os.Environment
    import android.os.StatFs
    import android.text.format.Formatter
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableLongStateOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.documentfile.provider.DocumentFile
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import kotlinx.coroutines.Dispatchers
    import kotlinx.coroutines.launch
    import java.io.File
    
    class StorageViewModel(application: Application) : AndroidViewModel(application) {
        private val context = application.applicationContext
        private val prefs = PlayerPreferences(context)
    
        // global stats
        var usedSpace by mutableLongStateOf(0L)
        var freeSpace by mutableLongStateOf(0L)
        var totalSpace by mutableLongStateOf(0L)
    
        // detailed breakdown
        var audioSize by mutableLongStateOf(0L)
        var imageSize by mutableLongStateOf(0L)
        var cacheSize by mutableLongStateOf(0L)
        var databaseSize by mutableLongStateOf(0L)
    
        var currentPath by mutableStateOf(context.getString(R.string.storage_loading))
        var isExternal by mutableStateOf(false)
    
        init {
            refreshStorageInfo()
        }
    
        fun refreshStorageInfo() {
            viewModelScope.launch(Dispatchers.IO) {
                val uriStr = prefs.getDownloadLocation()
    
                val targetFile: File? = if (uriStr == null) context.filesDir else null
                val path = targetFile ?: Environment.getDataDirectory()
                val stat = StatFs(path.absolutePath)
    
                // disk stats
                totalSpace = stat.blockCountLong * stat.blockSizeLong
                freeSpace = stat.availableBlocksLong * stat.blockSizeLong
                usedSpace = totalSpace - freeSpace
    
                calculateDetailedUsage(uriStr)
                updatePathText(uriStr)
            }
        }
    
        private fun calculateDetailedUsage(uriStr: String?) {
            var aSize = 0L
            var iSize = 0L
    
            if (uriStr == null) {
                // internal storage scan
                context.filesDir.listFiles()?.forEach { file ->
                    when {
                        file.name.endsWith(".mp3") || file.name.startsWith("track_") -> aSize += file.length()
                        file.name.endsWith(".jpg") || file.name.startsWith("art_") -> iSize += file.length()
                    }
                }
            } else {
                // external/custom folder scan
                try {
                    val uri = Uri.parse(uriStr)
                    val docFile = DocumentFile.fromTreeUri(context, uri)
                    docFile?.listFiles()?.forEach { file ->
                        val name = file.name ?: ""
                        when {
                            name.endsWith(".mp3") || name.startsWith("track_") -> aSize += file.length()
                            name.endsWith(".jpg") || name.startsWith("art_") -> iSize += file.length()
                        }
                    }
                } catch (e: Exception) { e.printStackTrace() }
            }
    
            val cSize = getFolderSize(context.cacheDir) + getFolderSize(context.codeCacheDir)
            val dbFile = context.getDatabasePath("kittytune_db")
            val dbSize = if (dbFile.exists()) dbFile.length() else 0L
    
            audioSize = aSize
            imageSize = iSize
            cacheSize = cSize
            databaseSize = dbSize
        }
    
        private fun getFolderSize(dir: File): Long {
            var size = 0L
            dir.listFiles()?.forEach {
                size += if (it.isDirectory) getFolderSize(it) else it.length()
            }
            return size
        }
    
        fun cleanAudio() {
            viewModelScope.launch {
                DownloadManager.removeAllContent(includeAudio = true, includeImages = false)
                refreshStorageInfo()
            }
        }
    
        fun cleanImages() {
            viewModelScope.launch {
                DownloadManager.removeAllContent(includeAudio = false, includeImages = true)
                refreshStorageInfo()
            }
        }
    
        fun cleanCache() {
            viewModelScope.launch(Dispatchers.IO) {
                try {
                    context.cacheDir.deleteRecursively()
                    context.codeCacheDir.deleteRecursively()
                } catch (e: Exception) { e.printStackTrace() }
                refreshStorageInfo()
            }
        }
    
        private fun updatePathText(uriStr: String?) {
            currentPath = if (uriStr == null) {
                isExternal = false
                context.getString(R.string.storage_internal_mem)
            } else {
                isExternal = true
                try {
                    val uri = Uri.parse(uriStr)
                    val path = uri.path ?: uri.toString()
                    if (path.contains("primary:")) {
                        context.getString(R.string.storage_internal_mem_sub, path.substringAfter("primary:"))
                    } else {
                        context.getString(R.string.storage_sd_card)
                    }
                } catch (e: Exception) {
                    context.getString(R.string.storage_custom_folder)
                }
            }
        }
    
        fun onFolderSelected(uri: Uri) {
            val takeFlags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION
            try {
                // make sure we keep access after reboot
                context.contentResolver.takePersistableUriPermission(uri, takeFlags)
            } catch (e: Exception) { e.printStackTrace() }
            prefs.saveDownloadLocation(uri.toString())
            refreshStorageInfo()
        }
    
        fun resetToDefault() {
            val oldUriStr = prefs.getDownloadLocation()
            if (oldUriStr != null) {
                try {
                    // release permission if we don't use it anymore
                    context.contentResolver.releasePersistableUriPermission(
                        Uri.parse(oldUriStr),
                        Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION
                    )
                } catch (e: Exception) {}
            }
            prefs.saveDownloadLocation(null)
            refreshStorageInfo()
        }
    
        fun formatSize(size: Long): String = Formatter.formatFileSize(context, size)
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/theme/Color.kt
================================================================================
    package com.alananasss.kittytune.ui.theme
    
    import androidx.compose.ui.graphics.Color
    
    val Purple80 = Color(0xFFD0BCFF)
    val PurpleGrey80 = Color(0xFFCCC2DC)
    val Pink80 = Color(0xFFEFB8C8)
    
    val Purple40 = Color(0xFF6650a4)
    val PurpleGrey40 = Color(0xFF625b71)
    val Pink40 = Color(0xFF7D5260)

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/theme/Theme.kt
================================================================================
    package com.alananasss.kittytune.ui.theme
    
    import android.app.Activity
    import android.os.Build
    import androidx.compose.foundation.isSystemInDarkTheme
    import androidx.compose.material3.MaterialTheme
    import androidx.compose.material3.darkColorScheme
    import androidx.compose.material3.dynamicDarkColorScheme
    import androidx.compose.material3.dynamicLightColorScheme
    import androidx.compose.material3.lightColorScheme
    import androidx.compose.runtime.Composable
    import androidx.compose.runtime.SideEffect
    import androidx.compose.ui.graphics.Color
    import androidx.compose.ui.graphics.toArgb
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.platform.LocalView
    import androidx.core.view.WindowCompat
    import com.alananasss.kittytune.data.local.AppThemeMode
    
    private val DarkColorScheme = darkColorScheme(
        primary = Purple80,
        secondary = PurpleGrey80,
        tertiary = Pink80,
        background = Color(0xFF1E1E1E), // default dark grey
        surface = Color(0xFF1E1E1E)
    )
    
    private val LightColorScheme = lightColorScheme(
        primary = Purple40,
        secondary = PurpleGrey40,
        tertiary = Pink40
    )
    
    @Composable
    fun SoundTuneTheme(
        // params injected from main activity
        themeMode: AppThemeMode = AppThemeMode.SYSTEM,
        dynamicColor: Boolean = true,
        pureBlack: Boolean = false,
        content: @Composable () -> Unit
    ) {
        val systemInDark = isSystemInDarkTheme()
    
        // 1. figure out if we need dark mode
        val useDarkTheme = when (themeMode) {
            AppThemeMode.SYSTEM -> systemInDark
            AppThemeMode.LIGHT -> false
            AppThemeMode.DARK -> true
        }
    
        // 2. pick base scheme (monet if available)
        val baseColorScheme = when {
            dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
                val context = LocalContext.current
                if (useDarkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
            }
            useDarkTheme -> DarkColorScheme
            else -> LightColorScheme
        }
    
        // 3. apply amoled black if requested (dark mode only)
        val finalColorScheme = if (useDarkTheme && pureBlack) {
            baseColorScheme.copy(
                background = Color.Black,
                surface = Color.Black,
                surfaceContainer = Color.Black,
                surfaceContainerLow = Color.Black,
                surfaceContainerHigh = Color(0xFF121212) // slight tint for cards
            )
        } else {
            baseColorScheme
        }
    
        val view = LocalView.current
        if (!view.isInEditMode) {
            SideEffect {
                val window = (view.context as Activity).window
                window.statusBarColor = Color.Transparent.toArgb()
                window.navigationBarColor = Color.Transparent.toArgb()
    
                // handle status bar icons color
                val insetsController = WindowCompat.getInsetsController(window, view)
                insetsController.isAppearanceLightStatusBars = !useDarkTheme
                insetsController.isAppearanceLightNavigationBars = !useDarkTheme
            }
        }
    
        MaterialTheme(
            colorScheme = finalColorScheme,
            typography = Typography,
            content = content
        )
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/theme/Type.kt
================================================================================
    package com.alananasss.kittytune.ui.theme
    
    import androidx.compose.material3.Typography
    import androidx.compose.ui.text.TextStyle
    import androidx.compose.ui.text.font.FontFamily
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.unit.sp
    
    // Set of Material typography styles to start with
    val Typography = Typography(
        bodyLarge = TextStyle(
            fontFamily = FontFamily.Default,
            fontWeight = FontWeight.Normal,
            fontSize = 16.sp,
            lineHeight = 24.sp,
            letterSpacing = 0.5.sp
        )
        /* Other default text styles to override
        titleLarge = TextStyle(
            fontFamily = FontFamily.Default,
            fontWeight = FontWeight.Normal,
            fontSize = 22.sp,
            lineHeight = 28.sp,
            letterSpacing = 0.sp
        ),
        labelSmall = TextStyle(
            fontFamily = FontFamily.Default,
            fontWeight = FontWeight.Medium,
            fontSize = 11.sp,
            lineHeight = 16.sp,
            letterSpacing = 0.5.sp
        )
        */
    )

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/track/TrackDetailScreen.kt
================================================================================
    package com.alananasss.kittytune.ui.track
    
    import androidx.compose.foundation.ExperimentalFoundationApi
    import androidx.compose.foundation.background
    import androidx.compose.foundation.clickable
    import androidx.compose.foundation.layout.*
    import androidx.compose.foundation.lazy.LazyColumn
    import androidx.compose.foundation.lazy.items
    import androidx.compose.foundation.lazy.itemsIndexed
    import androidx.compose.foundation.pager.HorizontalPager
    import androidx.compose.foundation.pager.rememberPagerState
    import androidx.compose.foundation.shape.CircleShape
    import androidx.compose.foundation.shape.RoundedCornerShape
    import androidx.compose.material.icons.Icons
    import androidx.compose.material.icons.automirrored.filled.ArrowBack
    import androidx.compose.material.icons.filled.Person
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Alignment
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.draw.clip
    import androidx.compose.ui.layout.ContentScale
    import androidx.compose.ui.platform.LocalContext
    import androidx.compose.ui.res.stringResource
    import androidx.compose.ui.text.font.FontWeight
    import androidx.compose.ui.text.style.TextOverflow
    import androidx.compose.ui.unit.dp
    import androidx.lifecycle.viewmodel.compose.viewModel
    import coil.compose.AsyncImage
    import com.alananasss.kittytune.R
    import com.alananasss.kittytune.data.DownloadManager
    import com.alananasss.kittytune.domain.Playlist
    import com.alananasss.kittytune.domain.Track
    import com.alananasss.kittytune.domain.User
    import com.alananasss.kittytune.ui.library.TrackListItem
    import com.alananasss.kittytune.ui.player.PlayerViewModel
    import com.alananasss.kittytune.ui.profile.ArtistAvatar
    import kotlinx.coroutines.launch
    import java.io.File
    
    @OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
    @Composable
    fun TrackDetailScreen(
        trackId: Long,
        initialTab: Int = 0,
        onBackClick: () -> Unit,
        onNavigate: (String) -> Unit,
        playerViewModel: PlayerViewModel,
        detailViewModel: TrackDetailViewModel = viewModel()
    ) {
        val pagerState = rememberPagerState(initialPage = initialTab) { 4 }
        val scope = rememberCoroutineScope()
        val tabs = listOf(
            stringResource(R.string.detail_likers),
            stringResource(R.string.detail_reposters),
            stringResource(R.string.detail_in_playlists),
            stringResource(R.string.detail_related)
        )
    
        LaunchedEffect(trackId) {
            detailViewModel.loadTrackDetails(trackId)
        }
    
        val track = detailViewModel.track
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text(stringResource(R.string.detail_track_title), maxLines = 1, overflow = TextOverflow.Ellipsis) },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, stringResource(R.string.btn_close))
                        }
                    }
                )
            }
        ) { innerPadding ->
            if (detailViewModel.isLoading || track == null) {
                Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                    CircularProgressIndicator()
                }
            } else {
                Column(modifier = Modifier.padding(innerPadding)) {
                    Row(
                        modifier = Modifier.padding(16.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        AsyncImage(
                            model = track.fullResArtwork,
                            contentDescription = null,
                            modifier = Modifier.size(80.dp).clip(RoundedCornerShape(8.dp)),
                            contentScale = ContentScale.Crop
                        )
                        Spacer(Modifier.width(16.dp))
                        Column {
                            Text(track.title ?: "", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                            Text(track.user?.username ?: "", style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
    
                    TabRow(selectedTabIndex = pagerState.currentPage) {
                        tabs.forEachIndexed { index, title ->
                            Tab(
                                selected = pagerState.currentPage == index,
                                onClick = { scope.launch { pagerState.animateScrollToPage(index) } },
                                text = { Text(text = title) }
                            )
                        }
                    }
    
                    HorizontalPager(state = pagerState) { page ->
                        when (page) {
                            0 -> UserList(
                                users = detailViewModel.likers,
                                onNavigate = onNavigate,
                                onLoadMore = { detailViewModel.loadMoreLikers() },
                                isLoadingMore = detailViewModel.isLikersLoadingMore
                            )
                            1 -> UserList(
                                users = detailViewModel.reposters,
                                onNavigate = onNavigate,
                                onLoadMore = { detailViewModel.loadMoreReposters() },
                                isLoadingMore = detailViewModel.isRepostersLoadingMore
                            )
                            2 -> PlaylistList(
                                playlists = detailViewModel.inPlaylists,
                                onNavigate = onNavigate,
                                onLoadMore = { detailViewModel.loadMorePlaylists() },
                                isLoadingMore = detailViewModel.isPlaylistsLoadingMore
                            )
                            3 -> TrackList(
                                tracks = detailViewModel.relatedTracks,
                                playerViewModel = playerViewModel,
                                onLoadMore = { detailViewModel.loadMoreRelated() },
                                isLoadingMore = detailViewModel.isRelatedLoadingMore
                            )
                        }
                    }
                }
            }
        }
    }
    
    @Composable
    fun UserList(
        users: List<User>,
        onNavigate: (String) -> Unit,
        onLoadMore: () -> Unit,
        isLoadingMore: Boolean
    ) {
        if (users.isEmpty() && !isLoadingMore) {
            Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Text(stringResource(R.string.detail_no_one_yet), color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
        } else {
            LazyColumn(contentPadding = PaddingValues(bottom = 120.dp)) {
                itemsIndexed(users) { index, user ->
                    if (index >= users.size - 5) {
                        LaunchedEffect(Unit) { onLoadMore() }
                    }
    
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { onNavigate("profile:${user.id}") }
                            .padding(horizontal = 16.dp, vertical = 12.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        ArtistAvatar(avatarUrl = user.avatarUrl, modifier = Modifier.size(48.dp).clip(CircleShape))
                        Spacer(Modifier.width(16.dp))
                        Column {
                            Text(user.username ?: stringResource(R.string.unknown_artist), fontWeight = FontWeight.SemiBold)
                            Text(stringResource(R.string.profile_followers, user.followersCount), style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
                }
                if (isLoadingMore) {
                    item {
                        Box(Modifier.fillMaxWidth().padding(16.dp), contentAlignment = Alignment.Center) {
                            CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
                        }
                    }
                }
            }
        }
    }
    
    @Composable
    fun PlaylistList(
        playlists: List<Playlist>,
        onNavigate: (String) -> Unit,
        onLoadMore: () -> Unit,
        isLoadingMore: Boolean
    ) {
        if (playlists.isEmpty() && !isLoadingMore) {
            Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Text(stringResource(R.string.detail_no_public_playlist), color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
        } else {
            LazyColumn(contentPadding = PaddingValues(bottom = 120.dp)) {
                itemsIndexed(playlists) { index, playlist ->
                    if (index >= playlists.size - 5) {
                        LaunchedEffect(Unit) { onLoadMore() }
                    }
    
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { onNavigate("${playlist.id}") }
                            .padding(horizontal = 16.dp, vertical = 12.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        AsyncImage(
                            model = playlist.fullResArtwork,
                            contentDescription = null,
                            modifier = Modifier.size(48.dp).clip(RoundedCornerShape(4.dp)),
                            contentScale = ContentScale.Crop
                        )
                        Spacer(Modifier.width(16.dp))
                        Column {
                            Text(playlist.title ?: stringResource(R.string.lib_playlists), fontWeight = FontWeight.SemiBold, maxLines = 1, overflow = TextOverflow.Ellipsis)
                            Text(
                                stringResource(R.string.playlist_num_tracks, playlist.trackCount ?: 0) + " â€¢ " + stringResource(R.string.playlist_by_user, playlist.user?.username ?: ""),
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant,
                                maxLines = 1,
                                overflow = TextOverflow.Ellipsis
                            )
                        }
                    }
                }
                if (isLoadingMore) {
                    item {
                        Box(Modifier.fillMaxWidth().padding(16.dp), contentAlignment = Alignment.Center) {
                            CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
                        }
                    }
                }
            }
        }
    }
    
    @Composable
    fun TrackList(
        tracks: List<Track>,
        playerViewModel: PlayerViewModel,
        onLoadMore: () -> Unit,
        isLoadingMore: Boolean
    ) {
        val downloadProgress by DownloadManager.downloadProgress.collectAsState()
        val context = LocalContext.current
    
        if (tracks.isEmpty() && !isLoadingMore) {
            Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Text(stringResource(R.string.detail_no_similar), color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
        } else {
            LazyColumn(contentPadding = PaddingValues(bottom = 120.dp)) {
                itemsIndexed(tracks) { index, track ->
                    if (index >= tracks.size - 5) {
                        LaunchedEffect(Unit) { onLoadMore() }
                    }
    
                    val progress = downloadProgress[track.id]
                    val isDownloading = progress != null
                    val isDownloaded = remember(track.id, downloadProgress) {
                        File(context.filesDir, "track_${track.id}.mp3").exists()
                    }
    
                    TrackListItem(
                        track = track,
                        currentlyPlayingTrack = playerViewModel.currentTrack,
                        index = index,
                        isDownloading = isDownloading,
                        isDownloaded = isDownloaded,
                        downloadProgress = progress ?: 0,
                        onClick = { playerViewModel.playPlaylist(tracks, index) },
                        onOptionClick = { playerViewModel.showTrackOptions(track) }
                    )
                }
                if (isLoadingMore) {
                    item {
                        Box(Modifier.fillMaxWidth().padding(16.dp), contentAlignment = Alignment.Center) {
                            CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
                        }
                    }
                }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/ui/track/TrackDetailViewModel.kt
================================================================================
    package com.alananasss.kittytune.ui.track
    
    import android.app.Application
    import androidx.compose.runtime.getValue
    import androidx.compose.runtime.mutableStateListOf
    import androidx.compose.runtime.mutableStateOf
    import androidx.compose.runtime.setValue
    import androidx.lifecycle.AndroidViewModel
    import androidx.lifecycle.viewModelScope
    import com.alananasss.kittytune.data.network.RetrofitClient
    import com.alananasss.kittytune.domain.*
    import kotlinx.coroutines.async
    import kotlinx.coroutines.coroutineScope
    import kotlinx.coroutines.launch
    
    class TrackDetailViewModel(application: Application) : AndroidViewModel(application) {
        private val api = RetrofitClient.create(application)
    
        var track by mutableStateOf<Track?>(null)
        var isLoading by mutableStateOf(true)
    
        // data holders
        val likers = mutableStateListOf<User>()
        val reposters = mutableStateListOf<User>()
        val inPlaylists = mutableStateListOf<Playlist>()
        val relatedTracks = mutableStateListOf<Track>()
    
        // pagination cursors (next_href)
        private var likersNextUrl: String? = null
        private var repostersNextUrl: String? = null
        private var playlistsNextUrl: String? = null
        private var relatedNextUrl: String? = null
    
        // individual loading states for infinite scroll
        var isLikersLoadingMore by mutableStateOf(false)
        var isRepostersLoadingMore by mutableStateOf(false)
        var isPlaylistsLoadingMore by mutableStateOf(false)
        var isRelatedLoadingMore by mutableStateOf(false)
    
        fun loadTrackDetails(trackId: Long) {
            if (trackId == 0L) return
            viewModelScope.launch {
                isLoading = true
                // clean slate
                likers.clear(); likersNextUrl = null
                reposters.clear(); repostersNextUrl = null
                inPlaylists.clear(); playlistsNextUrl = null
                relatedTracks.clear(); relatedNextUrl = null
    
                try {
                    coroutineScope {
                        val trackDef = async { api.getTracksByIds(trackId.toString()).firstOrNull() }
    
                        // fetch full objects (not just collection) to get next_href
                        val likersResponseDef = async { try { api.getTrackLikers(trackId) } catch (e: Exception) { null } }
                        val repostersResponseDef = async { try { api.getTrackReposters(trackId) } catch (e: Exception) { null } }
                        val playlistsResponseDef = async { try { api.getTrackInPlaylists(trackId) } catch (e: Exception) { null } }
                        val relatedResponseDef = async { try { api.getRelatedTracks(trackId) } catch (e: Exception) { null } }
    
                        track = trackDef.await()
    
                        likersResponseDef.await()?.let {
                            likers.addAll(it.collection)
                            likersNextUrl = it.next_href
                        }
                        repostersResponseDef.await()?.let {
                            reposters.addAll(it.collection)
                            repostersNextUrl = it.next_href
                        }
                        playlistsResponseDef.await()?.let {
                            inPlaylists.addAll(it.collection)
                            playlistsNextUrl = it.next_href
                        }
                        relatedResponseDef.await()?.let {
                            relatedTracks.addAll(it.collection)
                            relatedNextUrl = it.next_href
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    isLoading = false
                }
            }
        }
    
        // --- load more functions ---
    
        fun loadMoreLikers() {
            if (isLikersLoadingMore || likersNextUrl == null) return
            viewModelScope.launch {
                isLikersLoadingMore = true
                try {
                    val res = api.getLikersNextPage(likersNextUrl!!)
                    likers.addAll(res.collection)
                    likersNextUrl = res.next_href
                } catch (e: Exception) { e.printStackTrace() }
                finally { isLikersLoadingMore = false }
            }
        }
    
        fun loadMoreReposters() {
            if (isRepostersLoadingMore || repostersNextUrl == null) return
            viewModelScope.launch {
                isRepostersLoadingMore = true
                try {
                    val res = api.getRepostersNextPage(repostersNextUrl!!)
                    reposters.addAll(res.collection)
                    repostersNextUrl = res.next_href
                } catch (e: Exception) { e.printStackTrace() }
                finally { isRepostersLoadingMore = false }
            }
        }
    
        fun loadMorePlaylists() {
            if (isPlaylistsLoadingMore || playlistsNextUrl == null) return
            viewModelScope.launch {
                isPlaylistsLoadingMore = true
                try {
                    val res = api.getInPlaylistsNextPage(playlistsNextUrl!!)
                    inPlaylists.addAll(res.collection)
                    playlistsNextUrl = res.next_href
                } catch (e: Exception) { e.printStackTrace() }
                finally { isPlaylistsLoadingMore = false }
            }
        }
    
        fun loadMoreRelated() {
            if (isRelatedLoadingMore || relatedNextUrl == null) return
            viewModelScope.launch {
                isRelatedLoadingMore = true
                try {
                    val res = api.getRelatedTracksNextPage(relatedNextUrl!!)
                    relatedTracks.addAll(res.collection)
                    relatedNextUrl = res.next_href
                } catch (e: Exception) { e.printStackTrace() }
                finally { isRelatedLoadingMore = false }
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/utils/AppUtils.kt
================================================================================
    package com.alananasss.kittytune.utils
    
    import android.content.Context
    import android.content.pm.PackageManager
    
    object AppUtils {
        fun getAppVersion(context: Context): String {
            return try {
                val packageInfo = context.packageManager.getPackageInfo(context.packageName, 0)
                packageInfo.versionName ?: "1.0.0"
            } catch (e: PackageManager.NameNotFoundException) {
                "1.0.0"
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/utils/Config.kt
================================================================================
    package com.alananasss.kittytune.utils
    
    import android.content.Context
    import android.content.SharedPreferences
    import android.util.Log
    
    object Config {
        private const val PREFS_NAME = "app_config"
        private const val KEY_CLIENT_ID = "dynamic_client_id"
    
        // keeping this public just in case
        const val FALLBACK_ID = "7K3no7iJj8d02d20Z26Z26Z26Z26Z26"
    
        const val BASE_URL = "https://api-v2.soundcloud.com/"
        const val USER_AGENT = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36"
    
        var CLIENT_ID: String = FALLBACK_ID
            private set
    
        fun init(context: Context) {
            val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
            // try to load saved id, otherwise default to fallback
            CLIENT_ID = prefs.getString(KEY_CLIENT_ID, FALLBACK_ID) ?: FALLBACK_ID
            Log.d("Config", "Client ID initialized: $CLIENT_ID")
        }
    
        fun updateClientId(context: Context, newId: String) {
            if (newId.isNotBlank() && newId != CLIENT_ID) {
                CLIENT_ID = newId
                val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
                prefs.edit().putString(KEY_CLIENT_ID, newId).apply()
                Log.d("Config", "ğŸ”¥ FRESH CLIENT ID SNAGGED: $newId")
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/utils/LocaleUtils.kt
================================================================================
    package com.alananasss.kittytune.utils
    
    import android.content.Context
    import android.content.res.Configuration
    import com.alananasss.kittytune.data.local.AppLanguage
    import com.alananasss.kittytune.data.local.PlayerPreferences
    import java.util.Locale
    
    object LocaleUtils {
        fun updateBaseContextLocale(context: Context): Context {
            // grab the language pref
            val prefs = PlayerPreferences(context)
            val language = prefs.getAppLanguage()
    
            // if system default, don't touch anything
            if (language == AppLanguage.SYSTEM) return context
    
            // otherwise force the locale
            val locale = Locale(language.code)
            Locale.setDefault(locale)
    
            // create a new config with this locale
            val config = Configuration(context.resources.configuration)
            config.setLocale(locale)
            config.setLayoutDirection(locale)
    
            // return the modded context
            return context.createConfigurationContext(config)
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/utils/NetworkUtils.kt
================================================================================
    package com.alananasss.kittytune.utils
    
    import android.content.Context
    import android.net.ConnectivityManager
    import android.net.NetworkCapabilities
    
    object NetworkUtils {
        fun isInternetAvailable(context: Context): Boolean {
            val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
            val network = connectivityManager.activeNetwork ?: return false
            val activeNetwork = connectivityManager.getNetworkCapabilities(network) ?: return false
            return when {
                activeNetwork.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) -> true
                activeNetwork.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) -> true
                activeNetwork.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET) -> true
                else -> false
            }
        }
    }

================================================================================
FICHIER : ./java/com/alananasss/kittytune/utils/TimeUtils.kt
================================================================================
    package com.alananasss.kittytune.utils
    
    import java.util.Locale
    
    fun makeTimeString(duration: Long): String {
        val totalSeconds = duration / 1000
        val hours = totalSeconds / 3600
        val minutes = (totalSeconds % 3600) / 60
        val seconds = totalSeconds % 60
    
        return if (hours > 0) {
            // long stuff format (like 2h 14min)
            String.format(Locale.getDefault(), "%dh %02dmin", hours, minutes)
        } else {
            // standard song format (03:45)
            String.format(Locale.getDefault(), "%02d:%02d", minutes, seconds)
        }
    }

================================================================================
FICHIER : ./res/drawable/ic_heart_filled.xml
================================================================================
    <vector xmlns:android="http://schemas.android.com/apk/res/android"
        android:width="24dp"
        android:height="24dp"
        android:viewportWidth="24"
        android:viewportHeight="24">
        <path
            android:fillColor="#FFFF4081"
            android:pathData="M12,21.35l-1.45,-1.32C5.4,15.36 2,12.28 2,8.5 2,5.42 4.42,3 7.5,3c1.74,0 3.41,0.81 4.5,2.09C13.09,3.81 14.76,3 16.5,3 19.58,3 22,5.42 22,8.5c0,3.78 -3.4,6.86 -8.55,11.54L12,21.35z"/>
    </vector>

================================================================================
FICHIER : ./res/drawable/ic_heart_outline.xml
================================================================================
    <vector xmlns:android="http://schemas.android.com/apk/res/android"
        android:width="24dp"
        android:height="24dp"
        android:viewportWidth="24"
        android:viewportHeight="24">
        <path
            android:fillColor="#FFFFFFFF"
            android:pathData="M16.5,3c-1.74,0 -3.41,0.81 -4.5,2.09C10.91,3.81 9.24,3 7.5,3 4.42,3 2,5.42 2,8.5c0,3.78 3.4,6.86 8.55,11.54L12,21.35l1.45,-1.32C18.6,15.36 22,12.28 22,8.5 22,5.42 19.58,3 16.5,3zM12.1,18.55l-0.1,0.1 -0.1,-0.1C7.14,14.24 4,11.39 4,8.5 4,6.5 5.5,5 7.5,5c1.54,0 3.04,0.99 3.57,2.36h1.87C13.46,5.99 14.96,5 16.5,5c2,0 3.5,1.5 3.5,3.5 0,2.89 -3.14,5.74 -7.9,10.05z"/>
    </vector>

================================================================================
FICHIER : ./res/drawable/ic_launcher_background.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <vector
        android:height="108dp"
        android:width="108dp"
        android:viewportHeight="108"
        android:viewportWidth="108"
        xmlns:android="http://schemas.android.com/apk/res/android">
        <path android:fillColor="#3DDC84"
              android:pathData="M0,0h108v108h-108z"/>
        <path android:fillColor="#00000000" android:pathData="M9,0L9,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,0L19,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M29,0L29,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M39,0L39,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M49,0L49,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M59,0L59,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M69,0L69,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M79,0L79,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M89,0L89,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M99,0L99,108"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,9L108,9"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,19L108,19"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,29L108,29"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,39L108,39"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,49L108,49"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,59L108,59"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,69L108,69"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,79L108,79"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,89L108,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M0,99L108,99"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,29L89,29"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,39L89,39"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,49L89,49"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,59L89,59"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,69L89,69"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M19,79L89,79"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M29,19L29,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M39,19L39,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M49,19L49,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M59,19L59,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M69,19L69,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
        <path android:fillColor="#00000000" android:pathData="M79,19L79,89"
              android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    </vector>


================================================================================
FICHIER : ./res/drawable/ic_launcher_foreground.xml
================================================================================
    <vector xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:aapt="http://schemas.android.com/aapt"
        android:width="108dp"
        android:height="108dp"
        android:viewportWidth="108"
        android:viewportHeight="108">
        <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
            <aapt:attr name="android:fillColor">
                <gradient
                    android:endX="85.84757"
                    android:endY="92.4963"
                    android:startX="42.9492"
                    android:startY="49.59793"
                    android:type="linear">
                    <item
                        android:color="#44000000"
                        android:offset="0.0" />
                    <item
                        android:color="#00000000"
                        android:offset="1.0" />
                </gradient>
            </aapt:attr>
        </path>
        <path
            android:fillColor="#FFFFFF"
            android:fillType="nonZero"
            android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
            android:strokeWidth="1"
            android:strokeColor="#00000000" />
    </vector>

================================================================================
FICHIER : ./res/drawable/ic_launcher_monochrome.xml
================================================================================
    <vector
        xmlns:android="http://schemas.android.com/apk/res/android"
        android:width="108dp"
        android:height="108dp"
        android:viewportWidth="1024"
        android:viewportHeight="1024">
    
        <group
            android:pivotX="512"
            android:pivotY="512"
            android:translateX="17"
            android:translateY="-25"
            android:scaleX="1"
            android:scaleY="1">
    
            <path
                android:fillColor="#ffffff"
                android:pathData="m534.5,688.7 l-100.8,0.3 -0.6,-0.6 -0.6,-0.6v-7.8,-7.8h-15.3,-15.3v-8,-8l-23,-0.4 -23,-0.4 -0.1,-4.7 -0.1,-4.7 -0.2,-3 -0.2,-3h-22,-22v8,8L286.6,656.3 261.9,656.3v-25.3,-25.3h8,8v-8,-8h40,40v8,8h6.7,6.7v-24,-24h8.7,8.7v4.7,4.7h3.2,3.2l2.1,0.8 2.1,0.8v5.2,5.2h5.3,5.3v5.3,5.3h21.3,21.3v-5.3,-5.3h5.3,5.3v-5.5,-5.5l2.7,-0.7 2.7,-0.7v-21.2,-21.2h13.3,13.3v-8,-8h7.3,7.3v-14.7,-14.7l-6.3,-0 -6.3,-0v7.7,7.7l-7.7,0.4 -7.7,0.4v7.9,7.9h-6.7,-6.7v-4,-4h-4.7,-4.7v32.7,32.7h-5.3,-5.3l-0.4,5.7 -0.4,5.7 -17,0.4 -17,0.4v-6,-6L408.6,568.3 403.3,568.3v-5.3,-5.3L397.9,557.7 392.6,557.7v-22.7,-22.7h5.3,5.3v-5.3,-5.3h5.3,5.3v-5.3,-5.3h5.3,5.3v-15.3,-15.3h5.3,5.3v-10.7,-10.7h6,6v-5.3,-5.3h5.3,5.3v-5.3,-5.3h8,8v-5.3,-5.3h74,74v5.3,5.3h8,8v5.3,5.3h6,6v5.3,5.3h5.3,5.3v10.7,10.7h5.3,5.3v20.7,20.7h5.3,5.3v5.3,5.3l5.7,0.4 5.7,0.4v22,22l-5.7,0.4 -5.7,0.4v5.3,5.3h-5.3,-5.3l-0.4,5.7 -0.4,5.7h-5.3,-5.3l-0.3,-58.3 -0.3,-58.3h-5.3,-5.3v-11.3,-11.3h-6,-6v-5.3,-5.3h-10.7,-10.7v-5.3,-5.3h-67.3,-67.3v5.3,5.3h-10.7,-10.7v5.3,5.3l-5.7,0.4 -5.7,0.4 -0.4,11 -0.4,11h-5.3,-5.3v13.9,13.9l5.7,0.4 5.7,0.4 0.4,5 0.4,5h4.6,4.6v-4.7,-4.7h3.5,3.5l-0.5,-7.7 -0.5,-7.7 7.7,-0.4 7.7,-0.4v-7.9,-7.9h7.2,7.2l0.8,-3 0.8,-3 -0.8,-5 -0.8,-5h9.5,9.5v8,8h7.3,7.3v16,16h8,8v8,8h14.7,14.7v-8,-8h7.3,7.3v-8,-8h7.2,7.2l0.8,-5 0.8,-5 -0.8,-3 -0.8,-3h8.2,8.2v-8,-8h8.7,8.7v8,8h3.3,3.3v8,8h4.7,4.7v56.7,56.7h8,8v33.3,33.3h-8,-8v8,8h-8,-8v8,8zM503.9,621.7h22v-6.7,-6.7h-22,-22v6.7,6.7zM611.9,621.7h22v-6.7,-6.7h-22,-22v6.7,6.7zM627.3,524.3h6.7v-22.7,-22.7h-6.7,-6.7v8,8h-8,-8v6.7,6.7h8,8v8,8zM294.6,533.7h-6v-3.3,-3.3h-2.7,-2.7v-6,-6h2.7,2.7v-2.7,-2.7h5.3,5.3v-20,-20L321.9,469.7 344.6,469.7v28.7,28.7h-2,-2l-1.3,3.4 -1.3,3.4 -5.7,-0.4 -5.7,-0.4 -0.4,-3 -0.4,-3L323.2,527 320.6,527v-6,-6h2.7,2.7v-2.7,-2.7h6,6v-11.3,-11.3h-16,-16v20.1,20.1l-2.7,0.7 -2.7,0.7v2.5,2.5zM733.3,503h-6v-2.7,-2.7h-2.7,-2.7v-6,-6l1.7,-0.2 1.7,-0.2 1,0.2 1,0.2v-3.3,-3.3h5.3,5.3l0.4,-21.7 0.4,-21.7 3.7,-0.4 3.7,-0.4v2.8,2.8h2.7,2.7v2.7,2.7h2.7,2.7v2.7,2.7h2.7,2.7l-0.4,9 -0.4,9 -3,0.4 -3,0.4v-6.1,-6.1h-4.6,-4.6l-0.4,19.7 -0.4,19.7 -3,0.4 -3,0.4v2.6,2.6zM382.6,436.3h-6v-2.7,-2.7h-2.7,-2.7v-6.7,-6.7h2.7,2.7v-2.7,-2.7h5.3,5.3v-22,-22h3.3,3.3v2.7,2.7h2.7,2.7l0.2,1.7 0.2,1.7 -0.2,1 -0.2,1h2.8,2.8l0.7,2.5 0.7,2.5 2.6,0.7 2.6,0.7 -0.4,8.4 -0.4,8.4h-3.3,-3.3l-0.4,-5.7 -0.4,-5.7h-4.6,-4.6v20,20L391.3,431 388.6,431v2.7,2.7zM675.9,403h-6v-2.7,-2.7h-2.7,-2.7v-6,-6h2.7,2.7v-2.7,-2.7h6,6v-22.7,-22.7h2.8,2.8l0.7,2.7 0.7,2.7h2.5,2.5v3.3,3.3h2.7,2.7v2.7,2.7h2.7,2.7v8.7,8.7h-3.3,-3.3v-5.3,-5.3h-4.7,-4.7v19.3,19.3h-3.3,-3.3v2.7,2.7z" />
        </group>
    </vector>

================================================================================
FICHIER : ./res/drawable/ic_notification.xml
================================================================================
    <vector xmlns:android="http://schemas.android.com/apk/res/android"
        android:width="24dp"
        android:height="24dp"
        android:viewportWidth="24"
        android:viewportHeight="24">
    
        <path
            android:fillColor="#FFFFFFFF"
            android:pathData="M12,3v10.55c-0.59,-0.34 -1.27,-0.55 -2,-0.55 -2.21,0 -4,1.79 -4,4s1.79,4 4,4 4,-1.79 4,-4V7h4V3h-6z"/>
    </vector>

================================================================================
FICHIER : ./res/mipmap-anydpi-v26/ic_launcher_round.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
        <background android:drawable="@color/ic_launcher_background"/>
        <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
    
        <monochrome android:drawable="@drawable/ic_launcher_monochrome"/>
    </adaptive-icon>

================================================================================
FICHIER : ./res/mipmap-anydpi-v26/ic_launcher.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
        <background android:drawable="@color/ic_launcher_background"/>
        <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
    
        <monochrome android:drawable="@drawable/ic_launcher_monochrome"/>
    </adaptive-icon>

================================================================================
FICHIER : ./res/values/colors.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
        <color name="purple_200">#FFBB86FC</color>
        <color name="purple_500">#FF6200EE</color>
        <color name="purple_700">#FF3700B3</color>
        <color name="teal_200">#FF03DAC5</color>
        <color name="teal_700">#FF018786</color>
        <color name="black">#FF000000</color>
        <color name="white">#FFFFFFFF</color>
    </resources>

================================================================================
FICHIER : ./res/values-fr/strings.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
        <string name="app_name">KittyTune</string>
    
        <!-- Navigation -->
        <string name="nav_home">Accueil</string>
        <string name="nav_library">BibliothÃ¨que</string>
        <string name="nav_welcome">Bienvenue</string>
        <string name="nav_login">Connexion</string>
    
        <!-- General Actions -->
        <string name="btn_cancel">Annuler</string>
        <string name="btn_confirm">Confirmer</string>
        <string name="btn_save">Enregistrer</string>
        <string name="btn_delete">Supprimer</string>
        <string name="btn_create">CrÃ©er</string>
        <string name="btn_close">Fermer</string>
        <string name="btn_play">Lecture</string>
        <string name="btn_pause">Pause</string>
        <string name="btn_shuffle">AlÃ©atoire</string>
        <string name="btn_download">TÃ©lÃ©charger</string>
        <string name="btn_downloaded">TÃ©lÃ©chargÃ©</string>
        <string name="btn_share">Partager</string>
        <string name="btn_options">Options</string>
        <string name="btn_ok">OK</string>
        <string name="loading">Chargement...</string>
        <string name="error_generic">Une erreur est survenue</string>
        <string name="success_generic">OpÃ©ration rÃ©ussie</string>
        <string name="all_filters">Tout</string>
    
        <!-- Welcome & Login -->
        <string name="welcome_title">Bienvenue sur\nSoundTune</string>
        <string name="welcome_subtitle">DÃ©couvrez, streamez et tÃ©lÃ©chargez vos musiques prÃ©fÃ©rÃ©es sans limite.</string>
        <string name="login_soundcloud">Se connecter avec SoundCloud</string>
        <string name="login_guest">Continuer en tant qu\'invitÃ©</string>
        <string name="guest_loading">Initialisation de la session invitÃ©...</string>
        <string name="login_title">Connexion SoundCloud</string>
    
        <!-- Home -->
        <string name="search_hint">Rechercher titres, artistes...</string>
        <string name="search_library_hint">Rechercher dans la bibliothÃ¨que</string>
        <string name="home_recently_played">Ã‰coutÃ©s rÃ©cemment</string>
        <string name="home_section_similar">Similaire Ã  %1$s</string>
        <string name="home_section_similar_sub">Parce que vous avez Ã©coutÃ© ce titre</string>
        <string name="home_section_new_crew">New Crew</string>
        <string name="home_section_new_crew_sub">Artistes Ã  dÃ©couvrir basÃ©s sur vos goÃ»ts</string>
        <string name="home_trending">Tendances Mondiales</string>
        <string name="home_charts">Classements</string>
        <string name="no_results">Aucun rÃ©sultat</string>
        <string name="radio">Radio</string>
        <string name="untitled_track">Titre inconnu</string>
        <string name="unknown_artist">Artiste inconnu</string>
        <string name="unknown_user">Utilisateur</string>
    
        <!-- Library -->
        <string name="lib_playlists">Playlists</string>
        <string name="lib_artists">Artistes</string>
        <string name="lib_liked_tracks">Titres aimÃ©s</string>
        <string name="lib_liked_subtitle">Playlist â€¢ Automatique</string>
        <string name="lib_liked_subtitle_local">Local â€¢ Sur cet appareil</string>
        <string name="lib_liked_subtitle_syncing">Mise Ã  jour...</string>
        <string name="lib_downloads">Titres tÃ©lÃ©chargÃ©s</string>
        <string name="lib_downloads_subtitle">Hors ligne â€¢ Automatique</string>
        <string name="lib_local_media">MÃ©dias Locaux</string>
        <string name="lib_local_media_subtitle">Tous vos fichiers audio</string>
        <string name="lib_create_playlist_title">Nouvelle Playlist</string>
        <string name="lib_create_playlist_hint">Nom de la playlist</string>
        <string name="lib_offline_mode">Mode Hors Ligne â€¢ AccÃ¨s aux tÃ©lÃ©chargements</string>
        <string name="lib_guest_mode">Mode InvitÃ© â€¢ Se connecter pour synchroniser</string>
        <string name="sort_date_added">Date d\'ajout</string>
        <string name="me_artist">Moi</string>
        <string name="guest_user">InvitÃ©</string>
        <string name="logout_guest">Quitter le mode invitÃ©</string>
    
        <!-- Player -->
        <string name="player_playing_now">LECTURE EN COURS</string>
        <string name="player_queue">File d\'attente</string>
        <string name="player_lyrics">Paroles</string>
        <string name="player_audio_settings">RÃ©glages Audio</string>
        <string name="player_special_effects">Effets SpÃ©ciaux</string>
        <string name="player_pitch">Pitch</string>
        <string name="player_speed">Vitesse</string>
        <string name="effect_bass_boost">Bass Boost</string>
        <string name="effect_8d">Audio 8D</string>
        <string name="effect_muffled">Ã‰touffÃ©</string>
        <string name="effect_reverb">Reverb</string>
        <string name="menu_play_next">Lire ensuite</string>
        <string name="menu_add_queue">Ajouter Ã  la file</string>
        <string name="menu_add_playlist">Ajouter Ã  une playlist</string>
        <string name="menu_go_artist">Artiste</string>
        <string name="menu_track_radio">Radio liÃ©e</string>
        <string name="menu_details">DÃ©tails</string>
        <string name="menu_comments">Commentaires</string>
        <string name="context_playlist">Playlist â€¢ %1$s</string>
        <string name="context_station">Station â€¢ %1$s</string>
        <string name="menu_shuffle">MÃ©langer</string>
        <string name="menu_repeat">RÃ©pÃ©ter</string>
        <string name="menu_repeat_all">RÃ©pÃ©ter (Tout)</string>
        <string name="menu_repeat_one">RÃ©pÃ©ter (1)</string>
        <string name="menu_remove">Retirer</string>
        <string name="menu_cancel_download">Annuler</string>
        <string name="menu_delete_download">Supprimer</string>
    
        <!-- Lyrics -->
        <string name="lyrics_no_data">Aucune parole disponible</string>
        <string name="lyrics_manual_search">Rechercher manuellement</string>
        <string name="lyrics_wrong">Mauvaises paroles ?</string>
        <string name="lyrics_search_hint">Titre artiste...</string>
    
        <!-- Profile & Details -->
        <string name="profile_followers">AbonnÃ©s</string>
        <string name="profile_tracks">Titres</string>
        <string name="profile_edit">Modifier le profil</string>
        <string name="profile_edit_title">Modifier le profil</string>
        <string name="profile_name">Nom d\'affichage</string>
        <string name="profile_bio">Bio</string>
        <string name="profile_city">Ville / Pays</string>
        <string name="profile_tab_popular">Populaires</string>
        <string name="profile_tab_tracks">Derniers titres</string>
        <string name="profile_tab_albums">Albums</string>
        <string name="profile_tab_playlists">Playlists</string>
        <string name="profile_tab_likes">J\'aime de %1$s</string>
        <string name="profile_tab_reposts">Reposts</string>
        <string name="profile_about">Ã€ propos</string>
        <string name="profile_similar_artists">Vous aimerez peut-Ãªtre aussi</string>
        <string name="detail_track_title">DÃ©tails du titre</string>
        <string name="detail_likers">J\'aime</string>
        <string name="detail_reposters">Reposts</string>
        <string name="detail_in_playlists">Dans les playlists</string>
        <string name="detail_related">Titres similaires</string>
        <string name="detail_no_one_yet">Personne pour le moment.</string>
        <string name="detail_no_public_playlist">Aucune playlist publique trouvÃ©e.</string>
        <string name="detail_no_similar">Aucun titre similaire trouvÃ©.</string>
        <string name="detail_file_info">Informations du fichier</string>
        <string name="detail_format">Format</string>
        <string name="detail_size">Taille</string>
        <string name="detail_duration">DurÃ©e</string>
        <string name="detail_location">Emplacement</string>
        <string name="detail_external_storage">Stockage Externe</string>
        <string name="detail_local_file">Fichier Local</string>
        <string name="detail_unknown">Inconnue</string>
        <string name="detail_stats_plays">Lectures</string>
        <string name="detail_stats_likes">J\'aime</string>
        <string name="detail_stats_reposts">Reposts</string>
        <string name="detail_show_more">Voir plus</string>
        <string name="detail_show_less">Voir moins</string>
        <string name="detail_see_similar">Voir titres similaires &amp; fans</string>
        <string name="detail_see_comments">Voir les commentaires (%1$s)</string>
        <string name="detail_release_date">Sortie</string>
        <string name="detail_genre">Genre</string>
        <string name="detail_description">Description</string>
        <string name="detail_tags">Tags</string>
    
        <!-- Settings Categories -->
        <string name="settings_title">ParamÃ¨tres</string>
        <string name="settings_cat_appearance">Apparence</string>
        <string name="settings_cat_playback">Lecture</string>
        <string name="settings_cat_audio">Audio</string>
        <string name="settings_cat_general">GÃ©nÃ©ral</string>
        <string name="settings_cat_source">Source</string>
    
        <!-- Appearance Settings -->
        <string name="pref_appearance_title">Apparence</string>
        <string name="pref_appearance_subtitle">ThÃ¨me, Ã©cran de dÃ©marrage, lecteur, langue</string>
        <string name="pref_start_screen">Ã‰cran de dÃ©marrage</string>
        <string name="pref_theme_dynamic">ThÃ¨me Dynamique (Material You)</string>
        <string name="pref_theme_dynamic_sub">Utiliser les couleurs de votre fond d\'Ã©cran.</string>
        <string name="pref_theme_mode">Mode de thÃ¨me</string>
        <string name="pref_theme_pure_black">Noir Profond (AMOLED)</string>
        <string name="pref_theme_pure_black_sub">Ã‰conomise la batterie sur les Ã©crans OLED.</string>
        <string name="pref_player_style">ArriÃ¨re-plan du lecteur</string>
        <string name="pref_language">Langue</string>
        <string name="pref_language_sub">Changer la langue de l\'application</string>
    
        <!-- Theme Modes -->
        <string name="theme_system">Par dÃ©faut (SystÃ¨me)</string>
        <string name="theme_light">Clair</string>
        <string name="theme_dark">Sombre</string>
        <string name="lang_french">FranÃ§ais</string>
        <string name="lang_english">English</string>
        <string name="lang_hungarian">Magyar</string>
    
        <!-- Player Styles -->
        <string name="style_theme">ThÃ¨me (Couleur unie)</string>
        <string name="style_gradient">DÃ©gradÃ© dynamique</string>
        <string name="style_blur">Pochette floue</string>
    
        <!-- Lyrics Settings -->
        <string name="pref_lyrics_title">Paroles</string>
        <string name="pref_lyrics_subtitle">Taille, alignement, source</string>
        <string name="pref_lyrics_local">PrÃ©fÃ©rer les fichiers locaux</string>
        <string name="pref_lyrics_local_sub">PrioritÃ© aux paroles intÃ©grÃ©es (ID3).</string>
        <string name="pref_lyrics_align">Position du texte</string>
        <string name="pref_lyrics_size">Taille de la police</string>
        <string name="align_left">Gauche</string>
        <string name="align_center">CentrÃ© (Par dÃ©faut)</string>
        <string name="align_right">Droite</string>
        <string name="pref_lyrics_reset">RÃ©initialiser</string>
    
        <!-- Audio Settings -->
        <string name="pref_audio_title">Lecteur et Audio</string>
        <string name="pref_audio_subtitle">Autoplay, qualitÃ© et persistance</string>
        <string name="pref_autoplay">Radio Automatique</string>
        <string name="pref_autoplay_sub">Ajouter des titres similaires Ã  la fin.</string>
        <string name="pref_persist_queue">File d\'attente persistante</string>
        <string name="pref_persist_queue_sub">Sauvegarder la file aprÃ¨s redÃ©marrage.</string>
        <string name="pref_quality">QualitÃ© de streaming</string>
        <string name="quality_high">Haute (Par dÃ©faut)</string>
        <string name="quality_low">Ã‰conomie de donnÃ©es</string>
        <string name="quality_high_sub">Meilleure qualitÃ© possible (128kbps+)</string>
        <string name="quality_low_sub">PrioritÃ© aux formats lÃ©gers (Opus/HLS)</string>
    
        <!-- Local Media Settings -->
        <string name="pref_local_title">MÃ©dias Locaux</string>
        <string name="pref_local_subtitle">GÃ©rer tous les fichiers audio locaux</string>
        <string name="pref_local_enable">Activer les mÃ©dias locaux</string>
        <string name="pref_local_enable_sub">Afficher les fichiers audio de l\'appareil.</string>
        <string name="pref_local_folders">Dossiers sources</string>
        <string name="pref_local_add">Ajouter un dossier</string>
        <string name="pref_local_scan">Analyser la bibliothÃ¨que</string>
        <string name="pref_local_scanning">Analyse en cours...</string>
        <string name="pref_local_info">Les fichiers de tous les dossiers listÃ©s seront scannÃ©s.</string>
        <string name="pref_local_no_folder">Aucun dossier sÃ©lectionnÃ©.</string>
        <string name="pref_local_scan_status_waiting">En attente</string>
        <string name="pref_local_scan_status_prep">PrÃ©paration...</string>
        <string name="pref_local_scan_status_searching">Recherche des fichiers...</string>
        <string name="pref_local_scan_status_no_folder">Aucun dossier sÃ©lectionnÃ©</string>
        <string name="pref_local_scan_status_no_files">Aucun fichier audio trouvÃ©</string>
        <string name="pref_local_scan_status_found">%1$d fichiers trouvÃ©s. Analyse...</string>
        <string name="pref_local_scan_status_analyzing">Analyse %1$d / %2$d</string>
        <string name="pref_local_scan_status_saving">Enregistrement...</string>
        <string name="pref_local_scan_status_done">TerminÃ© !</string>
        <string name="pref_local_scan_status_error">Erreur: %1$s</string>
    
    
        <!-- Storage Settings -->
        <string name="pref_storage_title">Stockage &amp; DonnÃ©es</string>
        <string name="pref_storage_subtitle">GÃ©rer les tÃ©lÃ©chargements et le cache</string>
        <string name="storage_usage">Utilisation</string>
        <string name="storage_used">utilisÃ©s</string>
        <string name="storage_free">libres</string>
        <string name="storage_location">Emplacement des tÃ©lÃ©chargements</string>
        <string name="storage_reset">RÃ©initialiser</string>
        <string name="storage_cat_audio">Musiques</string>
        <string name="storage_cat_images">Pochettes &amp; Images</string>
        <string name="storage_cat_cache">Cache temporaire</string>
        <string name="storage_cat_db">Base de donnÃ©es</string>
        <string name="storage_legend_app">SoundTune</string>
        <string name="storage_legend_system">SystÃ¨me &amp; Autres</string>
        <string name="storage_internal_mem">MÃ©moire interne</string>
        <string name="storage_internal_mem_sub">/ %1$s</string>
        <string name="storage_sd_card">Carte SD / Externe</string>
        <string name="storage_custom_folder">Dossier personnalisÃ©</string>
        <string name="storage_change_btn">Changer</string>
        <string name="storage_db_subtitle">Index et paramÃ¨tres</string>
        <string name="storage_loading">Chargement...</string>
        <string name="dialog_clean_title">Nettoyer le stockage ?</string>
        <string name="dialog_clean_audio_msg">Voulez-vous supprimer toutes les musiques tÃ©lÃ©chargÃ©es ? Elles devront Ãªtre retÃ©lÃ©chargÃ©es pour Ãªtre Ã©coutÃ©es hors ligne.</string>
        <string name="dialog_clean_images_msg">Supprimer les images ? Les pochettes d\'album disparaÃ®tront jusqu\'Ã  la prochaine synchronisation.</string>
        <string name="dialog_clean_cache_msg">Vider le cache de l\'application ? Cela libÃ¨re de l\'espace sans affecter vos tÃ©lÃ©chargements.</string>
    
        <!-- Backup Settings -->
        <string name="pref_backup_title">Sauvegarder et Restaurer</string>
        <string name="pref_backup_subtitle">Exporter ou importer vos donnÃ©es</string>
        <string name="backup_action">Sauvegarder</string>
        <string name="restore_action">Restaurer</string>
        <string name="backup_desc">Exporter vos playlists, favoris, historique et prÃ©fÃ©rences dans un fichier.</string>
        <string name="restore_desc">Importer un fichier .backup pour rÃ©cupÃ©rer vos donnÃ©es.</string>
        <string name="backup_info">La sauvegarde inclut vos playlists locales, vos titres \'J\'aime\', votre historique d\'Ã©coute, vos succÃ¨s et vos prÃ©fÃ©rences.\n\nLes fichiers audio tÃ©lÃ©chargÃ©s ne sont PAS inclus dans le fichier de sauvegarde pour Ã©conomiser de l\'espace, mais les rÃ©fÃ©rences sont conservÃ©es.</string>
        <string name="backup_info_guest">Fonctionne mÃªme en mode InvitÃ©. Utile pour transfÃ©rer vos donnÃ©es vers un autre appareil.</string>
        <string name="backup_success">Sauvegarde rÃ©ussie !</string>
        <string name="restore_success">Restauration rÃ©ussie ! RedÃ©marrez l\'application.</string>
        <string name="backup_error">Erreur : %1$s</string>
        <string name="backup_in_progress">Traitement en cours...</string>
        <string name="backup_toast_success">Sauvegarde terminÃ©e</string>
        <string name="backup_toast_error">Erreur de sauvegarde</string>
        <string name="restore_toast_success">Restauration terminÃ©e. Veuillez redÃ©marrer.</string>
        <string name="restore_toast_error">Erreur de restauration</string>
    
        <!-- About -->
        <string name="pref_about_title">Ã€ propos</string>
        <string name="pref_about_subtitle">Version, licences et informations</string>
        <string name="about_version">Version</string>
        <string name="about_github">Voir sur GitHub</string>
        <string name="about_licenses">Licences open source</string>
        <string name="about_bug_report">Soumettre un rapport de bug</string>
        <string name="about_help">Aide et support</string>
        <string name="about_contact">Autres demandes</string>
        <string name="about_contact_copy">Appuyez pour copier l\'e-mail</string>
        <string name="about_contact_copied">E-mail copiÃ© !</string>
        <string name="about_app_info">Informations sur l\'application</string>
        <string name="about_device_info">Informations sur l\'appareil</string>
        <string name="about_package_name">Nom du paquet</string>
        <string name="about_device_model">ModÃ¨le</string>
        <string name="about_android_version">Version Android (API %1$d)</string>
        <string name="about_expand">Ã‰tendre</string>
        <string name="about_collapse">RÃ©duire</string>
    
        <!-- Achievements -->
        <string name="achievements_title">SuccÃ¨s</string>
        <string name="achievements_subtitle">%1$d / %2$d dÃ©bloquÃ©s</string>
        <string name="achievements_current_level">Niveau Actuel</string>
        <string name="achievements_reset_progress">RÃ©initialiser la progression</string>
        <string name="achievements_status_done">TerminÃ©</string>
        <string name="achievements_secret_title">Secret</string>
    
        <!-- Achievement Categories -->
        <string name="ach_cat_time">â³ Endurance &amp; Temps</string>
        <string name="ach_cat_volume">ğŸ“Š Volume de Lecture</string>
        <string name="ach_cat_loyalty">ğŸ”¥ SÃ©ries (Streaks)</string>
        <string name="ach_cat_collection">ğŸ“š BibliothÃ¨que</string>
        <string name="ach_cat_player">ğŸ›ï¸ MaÃ®trise du Lecteur</string>
        <string name="ach_cat_hardcore">ğŸ’€ Mode Titan</string>
        <string name="ach_cat_secret">ğŸ”’ MystÃ¨res</string>
    
        <!-- Dialogs -->
        <string name="dialog_reset_achievements_title">RÃ©initialiser les succÃ¨s ?</string>
        <string name="dialog_reset_achievements_msg">Attention ! Vous allez perdre toute votre progression, votre niveau et vos badges. Cette action est irrÃ©versible.</string>
        <string name="dialog_reset_achievements_confirm">Continuer</string>
        <string name="dialog_reset_achievements_final_title">ÃŠtes-vous VRAIMENT sÃ»r ?</string>
        <string name="dialog_reset_achievements_final_msg">C\'est votre derniÃ¨re chance. Tout sera effacÃ© pour toujours.</string>
        <string name="dialog_reset_achievements_final_confirm">TOUT EFFACER</string>
        <string name="dialog_logout_title">Se dÃ©connecter ?</string>
        <string name="dialog_logout_msg">Vous retournerez Ã  l\'Ã©cran de bienvenue.</string>
        <string name="dialog_delete_playlist_title">Supprimer la playlist ?</string>
        <string name="dialog_delete_playlist_from_lib_title">Retirer de la bibliothÃ¨que ?</string>
        <string name="dialog_delete_playlist_msg">Cette action est irrÃ©versible.</string>
        <string name="dialog_remove_download_title">Supprimer le tÃ©lÃ©chargement ?</string>
        <string name="dialog_remove_download_msg">Les fichiers audio seront supprimÃ©s, mais la playlist restera dans votre bibliothÃ¨que.</string>
        <string name="dialog_rename_playlist_title">Renommer la playlist</string>
        <string name="dialog_rename_playlist_hint">Nouveau nom</string>
        <string name="dialog_comment_soon">L\'envoi de commentaires arrive bientÃ´t !</string>
        <string name="dialog_like_soon">Les likes arrivent bientÃ´t !</string>
    
        <!-- Miscellaneous -->
        <string name="playlist_num_tracks">%1$d titres</string>
        <string name="playlist_by_user">Par %1$s</string>
        <string name="add_to_playlist_title_single">Ajouter Ã  une playlist</string>
        <string name="add_to_playlist_title_multi">Ajouter %1$d titres Ã ...</string>
        <string name="add_to_playlist_new">Nouvelle playlist</string>
        <string name="add_comment_hint">Ajouter un commentaire...</string>
        <string name="comment_no_comments">Aucun commentaire pour le moment</string>
        <string name="comment_relative_time_now">Ã€ l\'instant</string>
        <string name="comment_relative_time_minutes_ago">"il y a %1$d min"</string>
        <string name="comment_relative_time_hours_ago">"il y a %1$d h"</string>
        <string name="comment_relative_time_days_ago">"il y a %1$d j"</string>
        <string name="comment_relative_time_weeks_ago">"il y a %1$d sem."</string>
        <string name="comment_relative_time_months_ago">"il y a %1$d mois"</string>
        <string name="comment_relative_time_years_ago">"il y a %1$d an(s)"</string>
        <string name="profile_menu_title">SoundTune</string>
        <string name="profile_menu_manage_account">Voir mon profil</string>
        <string name="profile_menu_login">Se connecter Ã  un compte</string>
        <string name="profile_menu_achievements">SuccÃ¨s &amp; RÃ©compenses</string>
        <string name="profile_menu_settings">ParamÃ¨tres</string>
        <string name="profile_menu_logout">Se dÃ©connecter</string>
        <string name="profile_menu_guest_desc">DonnÃ©es locales uniquement</string>
        <string name="profile_menu_badge_new">Nouveau</string>
    
        <string name="completion_legend">LÃ‰GENDE</string>
        <string name="completion_message">Vous avez terminÃ© SoundTune.</string>
        <string name="completion_thanks">Merci.</string>
        <string name="completion_thanks_message">"Terminer tous les succÃ¨s est un exploit que peu accompliront. Votre dÃ©vouement et votre passion pour la musique sont la raison d\'Ãªtre de cette application.\n\nMerci d\'avoir fait ce voyage avec nous.\n\n~ Alan :3"</string>
        <string name="completion_continue">Appuyez n\'importe oÃ¹ pour continuer</string>
    
        <!-- AJOUTS POUR L'Ã‰CRAN DE PROFIL -->
        <string name="profile_playlists_by_user">Playlists de %1$s</string>
        <string name="profile_likes_by_user">%1$s a aimÃ©</string>
        <string name="profile_latest_tracks">Derniers titres</string>
        <string name="profile_update_success">Profil mis Ã  jour</string>
        <string name="profile_update_error">Erreur: %1$s</string>
        <string name="btn_back">Retour</string>
        <string name="btn_follow">Suivre</string>
        <string name="share_via">Partager via</string>
        <string name="profile_banner">BanniÃ¨re</string>
        <string name="profile_avatar">Avatar</string>
        <string name="btn_save_changes">Enregistrer les modifications</string>
        <string name="btn_see_all">Voir tout</string>
        <string name="generic_title">Titre</string>
        <string name="generic_artist">Artiste</string>
    
        <!-- Achievements -->
        <string name="ach_time_1h_title">Ã‰chauffement</string>
        <string name="ach_time_1h_desc">1 heure d\'Ã©coute</string>
        <string name="ach_time_24h_title">24 Chrono</string>
        <string name="ach_time_24h_desc">24 heures d\'Ã©coute cumulÃ©es</string>
        <string name="ach_time_100h_title">SoundCloud Addict</string>
        <string name="ach_time_100h_desc">100 heures d\'Ã©coute</string>
        <string name="ach_time_500h_title">Demi-Mille</string>
        <string name="ach_time_500h_desc">500 heures (20 jours) d\'Ã©coute</string>
        <string name="ach_time_1000h_title">VÃ©tÃ©ran</string>
        <string name="ach_time_1000h_desc">1000 heures d\'Ã©coute</string>
        <string name="ach_time_2500h_title">Grand MaÃ®tre</string>
        <string name="ach_time_2500h_desc">2500 heures d\'Ã©coute</string>
        <string name="ach_time_5000h_title">L\'Ã‰ternel</string>
        <string name="ach_time_5000h_desc">5000 heures d\'Ã©coute</string>
        <string name="ach_time_10000h_title">Transcendance</string>
        <string name="ach_time_10000h_desc">10 000 heures. La rÃ¨gle de la maÃ®trise.</string>
    
        <string name="ach_plays_1_title">Premier Pas</string>
        <string name="ach_plays_1_desc">Ã‰couter 1 titre</string>
        <string name="ach_plays_100_title">Curieux</string>
        <string name="ach_plays_100_desc">100 lectures</string>
        <string name="ach_plays_1000_title">Explorateur</string>
        <string name="ach_plays_1000_desc">1 000 lectures</string>
        <string name="ach_plays_5000_title">MÃ©lomane</string>
        <string name="ach_plays_5000_desc">5 000 lectures</string>
        <string name="ach_plays_10000_title">Machine</string>
        <string name="ach_plays_10000_desc">10 000 lectures</string>
        <string name="ach_plays_20000_title">Visionnaire</string>
        <string name="ach_plays_20000_desc">20 000 lectures</string>
        <string name="ach_plays_50000_title">Oracle</string>
        <string name="ach_plays_50000_desc">50 000 lectures</string>
        <string name="ach_plays_100000_title">Dieu du Son</string>
        <string name="ach_plays_100000_desc">100 000 lectures. Le boss final.</string>
    
        <string name="ach_streak_7_title">Semaine complÃ¨te</string>
        <string name="ach_streak_7_desc">7 jours consÃ©cutifs</string>
        <string name="ach_streak_30_title">HabituÃ©</string>
        <string name="ach_streak_30_desc">1 mois (30 jours) consÃ©cutifs</string>
        <string name="ach_streak_100_title">Centenaire</string>
        <string name="ach_streak_100_desc">100 jours consÃ©cutifs.</string>
        <string name="ach_streak_200_title">Double Centenaire</string>
        <string name="ach_streak_200_desc">200 jours consÃ©cutifs.</string>
        <string name="ach_streak_365_title">AnnÃ©e Parfaite</string>
        <string name="ach_streak_365_desc">365 jours consÃ©cutifs.</string>
        <string name="ach_streak_500_title">Invincible</string>
        <string name="ach_streak_500_desc">500 jours consÃ©cutifs.</string>
        <string name="ach_early_bird_title">LÃ¨ve-tÃ´t</string>
        <string name="ach_early_bird_desc">Ã‰couter 10 fois entre 5h et 8h</string>
        <string name="ach_night_owl_title">Oiseau de Nuit</string>
        <string name="ach_night_owl_desc">Ã‰couter 10 fois entre 3h et 5h</string>
        <string name="ach_lunch_break_title">Pause DÃ©j</string>
        <string name="ach_lunch_break_desc">Ã‰couter 10 fois entre 12h et 13h</string>
    
        <string name="ach_liker_50_title">PassionnÃ©</string>
        <string name="ach_liker_50_desc">Liker 50 titres</string>
        <string name="ach_liker_1000_title">CÅ“ur d\'Or</string>
        <string name="ach_liker_1000_desc">Liker 1000 titres</string>
        <string name="ach_liker_5000_title">Amour Infini</string>
        <string name="ach_liker_5000_desc">Liker 5000 titres</string>
        <string name="ach_playlist_creator_title">Selecta</string>
        <string name="ach_playlist_creator_desc">CrÃ©er 5 playlists locales</string>
        <string name="ach_playlist_god_title">Architecte</string>
        <string name="ach_playlist_god_desc">CrÃ©er 50 playlists locales</string>
        <string name="ach_download_100_title">Data Hoarder</string>
        <string name="ach_download_100_desc">TÃ©lÃ©charger 100 titres</string>
        <string name="ach_download_1000_title">Serveur</string>
        <string name="ach_download_1000_desc">TÃ©lÃ©charger 1000 titres</string>
    
        <string name="ach_skipper_100_title">Zappeur</string>
        <string name="ach_skipper_100_desc">Passer 100 titres</string>
        <string name="ach_skipper_1000_title">Jamais Satisfait</string>
        <string name="ach_skipper_1000_desc">Passer 1000 titres</string>
        <string name="ach_bass_addict_title">Bass Addict</string>
        <string name="ach_bass_addict_desc">Ã‰couter 10h avec le Bass Boost</string>
        <string name="ach_speed_demon_title">Nightcore Fan</string>
        <string name="ach_speed_demon_desc">Ã‰couter 1h en vitesse > 1.2x</string>
        <string name="ach_social_star_title">Viral</string>
        <string name="ach_social_star_desc">Partager 50 titres</string>
    
        <string name="ach_obsessed_50_title">ObsÃ©dÃ©</string>
        <string name="ach_obsessed_50_desc">Ã‰couter le MÃŠME titre 50 fois</string>
        <string name="ach_obsessed_200_title">Folie Pure</string>
        <string name="ach_obsessed_200_desc">Ã‰couter le MÃŠME titre 200 fois</string>
        <string name="ach_night_shift_pro_title">Vampire</string>
        <string name="ach_night_shift_pro_desc">Ã‰couter 500 heures la nuit (22h-06h)</string>
        <string name="ach_marathon_title">Marathonien</string>
        <string name="ach_marathon_desc">Ã‰couter 8h d\'affilÃ©e sans fermer l\'app</string>
        <string name="ach_no_skip_50_title">Concentration</string>
        <string name="ach_no_skip_50_desc">Ã‰couter 50 titres sans skip</string>
        <string name="achievements_reset_success">SuccÃ¨s rÃ©initialisÃ©s.</string>
        <string name="ach_secret_desc">\?</string>
        <string name="ach_developer_title">Hacker</string>
        <string name="ach_weekend_warrior_title">Weekend Warrior</string>
        <string name="ach_ghost_title">FantÃ´me</string>
        <string name="ach_lucky7_title">Jackpot</string>
        <string name="ach_glitch_title">Glitch in the Matrix</string>
        <string name="align_center_simple">CentrÃ©</string>
    
        <string name="storage_used_formatted">%1$s utilisÃ©s</string>
        <string name="storage_free_formatted">%1$s libres</string>
        <string name="storage_change_cta">Appuyer pour changer</string>
    
        <!-- Licenses Screen -->
        <string name="about_licenses_title">Licences Open Source</string>
        <string name="license_author_prefix">par %1$s</string>
        <string name="open_in_new">Ouvrir dans une nouvelle fenÃªtre</string>
    
        <!-- Player Screen & Associated Sheets -->
        <string name="player_like_action">Aimer</string>
        <string name="player_effects">Effets</string>
        <string name="menu_remove_local_q">Retirer ?</string>
        <string name="menu_remove_local_body">Ce fichier ne sera plus listÃ© dans l\'application (le fichier ne sera pas effacÃ© du tÃ©lÃ©phone).</string>
        <string name="menu_remove_download_q">Supprimer le tÃ©lÃ©chargement ?</string>
        <string name="menu_remove_download_body">Ce titre sera retirÃ© de votre stockage local.</string>
        <string name="comment_anonymous">Anonyme</string>
        <string name="comment_default_avatar">Avatar par dÃ©faut</string>
        <string name="comment_send_action">Envoyer</string>
        <string name="time_now">Ã€ l\'instant</string>
        <string name="time_minutes_ago">il y a %1$d min</string>
        <string name="time_hours_ago">il y a %1$d h</string>
        <string name="time_days_ago">il y a %1$d j</string>
        <string name="time_weeks_ago">il y a %1$d sem.</string>
        <string name="time_months_ago">il y a %1$d mois</string>
        <string name="time_one_year_ago">il y a 1 an</string>
        <string name="time_years_ago">il y a %1$d ans</string>
        <string name="detail_file_size_formatted">%.2f Mo</string>
    
        <!-- Notifications -->
        <string name="settings_cat_notifications">Notifications</string>
        <string name="pref_achievement_popups">Pop-ups de succÃ¨s</string>
        <string name="pref_achievement_popups_sub">Afficher une notification lors d\'un succÃ¨s.</string>
        <string name="achievement_unlocked">SuccÃ¨s dÃ©verrouillÃ©</string>
        <string name="achievement_xp">%1$d XP</string>
        <string name="streak_popup_title">SÃ©rie quotidienne</string>
        <string name="streak_popup_subtitle">%1$d Jour(s)</string>
        <string name="test_notification_triggered">Notification de test dÃ©clenchÃ©e !</string>
    
        <!-- Credits & Community -->
        <string name="about_credits">CrÃ©dits</string>
        <string name="about_role_dev">CrÃ©ateur &amp; DÃ©veloppeur Principal</string>
        <string name="about_role_translation">Traduction hongroise &amp; relecture</string>
        <string name="about_translate_title">Traduire KittyTune</string>
        <string name="about_translate_desc">Vous voulez l\'appli dans votre langue ? ( â—•â–¿â—• )\nOuvrez une Pull Request sur GitHub !</string>
        <string name="about_made_with">Fait avec ( Ë˜ Â³Ë˜)â™¥ par Alan</string>
    </resources>

================================================================================
FICHIER : ./res/values-hu/strings.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
        <string name="app_name">KittyTune</string>
    
        <!-- Navigation -->
        <string name="nav_home">KezdÅ‘lap</string>
        <string name="nav_library">KÃ¶nyvtÃ¡r</string>
        <string name="nav_welcome">ÃœdvÃ¶zÃ¶ljÃ¼k</string>
        <string name="nav_login">BelÃ©pÃ©s</string>
    
        <!-- General Actions -->
        <string name="btn_cancel">MÃ©gse</string>
        <string name="btn_confirm">MegerÅ‘sÃ­tÃ©s</string>
        <string name="btn_save">MentÃ©s</string>
        <string name="btn_delete">TÃ¶rlÃ©s</string>
        <string name="btn_create">LÃ©trehozÃ¡s</string>
        <string name="btn_close">BezÃ¡rÃ¡s</string>
        <string name="btn_play">LejÃ¡tszÃ¡s</string>
        <string name="btn_pause">SzÃ¼net</string>
        <string name="btn_shuffle">VÃ©letlenszerÅ±</string>
        <string name="btn_download">LetÃ¶ltÃ©s</string>
        <string name="btn_downloaded">LetÃ¶ltve</string>
        <string name="btn_share">MegosztÃ¡s</string>
        <string name="btn_options">OpciÃ³k</string>
        <string name="btn_ok">OK</string>
        <string name="loading">BetÃ¶ltÃ©s...</string>
        <string name="error_generic">Hiba tÃ¶rtÃ©nt</string>
        <string name="success_generic">Sikeres mÅ±velet</string>
        <string name="all_filters">Minden</string>
    
        <!-- Welcome & Login -->
        <string name="welcome_title">ÃœdvÃ¶zli a\nKittyTune</string>
        <string name="welcome_subtitle">Fedezze fel, streamelje Ã©s tÃ¶ltse le kedvenc zenÃ©it korlÃ¡tok nÃ©lkÃ¼l.</string>
        <string name="login_soundcloud">BelÃ©pÃ©s SoundCloud fiÃ³kkal</string>
        <string name="login_guest">FolytatÃ¡s vendÃ©gkÃ©nt</string>
        <string name="guest_loading">VendÃ©g munkamenet indÃ­tÃ¡sa...</string>
        <string name="login_title">SoundCloud BelÃ©pÃ©s</string>
    
        <!-- Home -->
        <string name="search_hint">KeresÃ©s szÃ¡mok, elÅ‘adÃ³k...</string>
        <string name="search_library_hint">KeresÃ©s a kÃ¶nyvtÃ¡rban</string>
        <string name="home_recently_played">NemrÃ©g jÃ¡tszott</string>
        <string name="home_section_similar">HasonlÃ³ ehhez: %1$s</string>
        <string name="home_section_similar_sub">Mert tetszett ez a szÃ¡m</string>
        <string name="home_section_new_crew">Ãšj felfedezÃ©sek</string>
        <string name="home_section_new_crew_sub">ElÅ‘adÃ³k az Ã­zlÃ©sed alapjÃ¡n</string>
        <string name="home_trending">NÃ©pszerÅ± ZenÃ©k</string>
        <string name="home_charts">SlÃ¡gerlistÃ¡k</string>
        <string name="no_results">Nincs talÃ¡lat</string>
        <string name="radio">RÃ¡diÃ³</string>
        <string name="untitled_track">NÃ©vtelen szÃ¡m</string>
        <string name="unknown_artist">Ismeretlen elÅ‘adÃ³</string>
        <string name="unknown_user">FelhasznÃ¡lÃ³</string>
    
        <!-- Library -->
        <string name="lib_playlists">LejÃ¡tszÃ¡si listÃ¡k</string>
        <string name="lib_artists">ElÅ‘adÃ³k</string>
        <string name="lib_liked_tracks">Kedvelt szÃ¡mok</string>
        <string name="lib_liked_subtitle">Lista â€¢ Automatikus</string>
        <string name="lib_liked_subtitle_local">Helyi â€¢ Ezen az eszkÃ¶zÃ¶n</string>
        <string name="lib_liked_subtitle_syncing">FrissÃ­tÃ©s...</string>
        <string name="lib_downloads">LetÃ¶ltÃ¶tt szÃ¡mok</string>
        <string name="lib_downloads_subtitle">Offline â€¢ Automatikus</string>
        <string name="lib_local_media">Helyi fÃ¡jlok</string>
        <string name="lib_local_media_subtitle">Minden hangfÃ¡jl</string>
        <string name="lib_create_playlist_title">Ãšj lejÃ¡tszÃ¡si lista</string>
        <string name="lib_create_playlist_hint">Lista neve</string>
        <string name="lib_offline_mode">Offline mÃ³d â€¢ HozzÃ¡fÃ©rÃ©s a letÃ¶ltÃ©sekhez</string>
        <string name="lib_guest_mode">VendÃ©g mÃ³d â€¢ Jelentkezzen be a szinkronizÃ¡lÃ¡shoz</string>
        <string name="sort_date_added">HozzÃ¡adÃ¡s dÃ¡tuma</string>
        <string name="me_artist">Ã‰n</string>
        <string name="guest_user">VendÃ©g</string>
        <string name="logout_guest">KilÃ©pÃ©s a vendÃ©g mÃ³dbÃ³l</string>
    
        <!-- Player -->
        <string name="player_playing_now">MOST JÃTSZOTT</string>
        <string name="player_queue">VÃ¡rÃ³lista</string>
        <string name="player_lyrics">DalszÃ¶veg</string>
        <string name="player_audio_settings">HangbeÃ¡llÃ­tÃ¡sok</string>
        <string name="player_special_effects">SpeciÃ¡lis effektek</string>
        <string name="player_pitch">HangmagassÃ¡g</string>
        <string name="player_speed">SebessÃ©g</string>
        <string name="effect_bass_boost">BasszuskiemelÃ©s</string>
        <string name="effect_8d">8D Audio</string>
        <string name="effect_muffled">TompÃ­tott</string>
        <string name="effect_reverb">Visszhang</string>
        <string name="menu_play_next">KÃ¶vetkezÅ‘nek jÃ¡tszik</string>
        <string name="menu_add_queue">HozzÃ¡adÃ¡s a sorhoz</string>
        <string name="menu_add_playlist">HozzÃ¡adÃ¡s listÃ¡hoz</string>
        <string name="menu_go_artist">ElÅ‘adÃ³</string>
        <string name="menu_track_radio">SzÃ¡m RÃ¡diÃ³</string>
        <string name="menu_details">RÃ©szletek</string>
        <string name="menu_comments">Kommentek</string>
        <string name="context_playlist">Lista â€¢ %1$s</string>
        <string name="context_station">RÃ¡diÃ³ â€¢ %1$s</string>
        <string name="menu_shuffle">KeverÃ©s</string>
        <string name="menu_repeat">IsmÃ©tlÃ©s</string>
        <string name="menu_repeat_all">IsmÃ©tlÃ©s (Mind)</string>
        <string name="menu_repeat_one">IsmÃ©tlÃ©s (1)</string>
        <string name="menu_remove">EltÃ¡volÃ­tÃ¡s</string>
        <string name="menu_cancel_download">MÃ©gse</string>
        <string name="menu_delete_download">TÃ¶rlÃ©s</string>
    
        <!-- Lyrics -->
        <string name="lyrics_no_data">Nincs elÃ©rhetÅ‘ dalszÃ¶veg</string>
        <string name="lyrics_manual_search">KÃ©zi keresÃ©s</string>
        <string name="lyrics_wrong">Rossz szÃ¶veg?</string>
        <string name="lyrics_search_hint">SzÃ¡m elÅ‘adÃ³...</string>
    
        <!-- Profile & Details -->
        <string name="profile_followers">KÃ¶vetÅ‘k</string>
        <string name="profile_tracks">SzÃ¡mok</string>
        <string name="profile_edit">Profil szerkesztÃ©se</string>
        <string name="profile_edit_title">Profil mÃ³dosÃ­tÃ¡sa</string>
        <string name="profile_name">MegjelenÃ­tÃ©si nÃ©v</string>
        <string name="profile_bio">BemutatkozÃ¡s</string>
        <string name="profile_city">VÃ¡ros / OrszÃ¡g</string>
        <string name="profile_tab_popular">NÃ©pszerÅ±</string>
        <string name="profile_tab_tracks">LegutÃ³bbi szÃ¡mok</string>
        <string name="profile_tab_albums">Albumok</string>
        <string name="profile_tab_playlists">ListÃ¡k</string>
        <string name="profile_tab_likes">%1$s kedvelÃ©sei</string>
        <string name="profile_tab_reposts">MegosztÃ¡sok</string>
        <string name="profile_about">NÃ©vjegy</string>
        <string name="profile_similar_artists">TalÃ¡n ez is tetszeni fog</string>
        <string name="detail_track_title">SzÃ¡m RÃ©szletei</string>
        <string name="detail_likers">KedvelÃ©sek</string>
        <string name="detail_reposters">MegosztÃ¡sok</string>
        <string name="detail_in_playlists">LejÃ¡tszÃ¡si listÃ¡kon</string>
        <string name="detail_related">HasonlÃ³ szÃ¡mok</string>
        <string name="detail_no_one_yet">MÃ©g senki.</string>
        <string name="detail_no_public_playlist">Nincs nyilvÃ¡nos lejÃ¡tszÃ¡si lista.</string>
        <string name="detail_no_similar">Nincs hasonlÃ³ szÃ¡m.</string>
        <string name="detail_file_info">FÃ¡jl InformÃ¡ciÃ³</string>
        <string name="detail_format">FormÃ¡tum</string>
        <string name="detail_size">MÃ©ret</string>
        <string name="detail_duration">IdÅ‘tartam</string>
        <string name="detail_location">Hely</string>
        <string name="detail_external_storage">KÃ¼lsÅ‘ TÃ¡rhely</string>
        <string name="detail_local_file">Helyi FÃ¡jl</string>
        <string name="detail_unknown">Ismeretlen</string>
        <string name="detail_stats_plays">LejÃ¡tszÃ¡s</string>
        <string name="detail_stats_likes">KedvelÃ©s</string>
        <string name="detail_stats_reposts">MegosztÃ¡s</string>
        <string name="detail_show_more">TÃ¶bb</string>
        <string name="detail_show_less">Kevesebb</string>
        <string name="detail_see_similar">HasonlÃ³ szÃ¡mok Ã©s rajongÃ³k</string>
        <string name="detail_see_comments">Kommentek megtekintÃ©se (%1$s)</string>
        <string name="detail_release_date">KiadÃ¡s</string>
        <string name="detail_genre">MÅ±faj</string>
        <string name="detail_description">LeÃ­rÃ¡s</string>
        <string name="detail_tags">CÃ­mkÃ©k</string>
    
        <!-- Settings Categories -->
        <string name="settings_title">BeÃ¡llÃ­tÃ¡sok</string>
        <string name="settings_cat_appearance">MegjelenÃ©s</string>
        <string name="settings_cat_playback">LejÃ¡tszÃ¡s</string>
        <string name="settings_cat_audio">Hang</string>
        <string name="settings_cat_general">ÃltalÃ¡nos</string>
        <string name="settings_cat_source">ForrÃ¡s</string>
    
        <!-- Appearance Settings -->
        <string name="pref_appearance_title">MegjelenÃ©s</string>
        <string name="pref_appearance_subtitle">TÃ©ma, kezdÅ‘kÃ©pernyÅ‘, lejÃ¡tszÃ³, nyelv</string>
        <string name="pref_start_screen">KezdÅ‘kÃ©pernyÅ‘</string>
        <string name="pref_theme_dynamic">Dinamikus tÃ©ma (Material You)</string>
        <string name="pref_theme_dynamic_sub">A hÃ¡ttÃ©rkÃ©p szÃ­neinek hasznÃ¡lata.</string>
        <string name="pref_theme_mode">TÃ©ma mÃ³d</string>
        <string name="pref_theme_pure_black">Tiszta fekete (AMOLED)</string>
        <string name="pref_theme_pure_black_sub">AkkumulÃ¡torkÃ­mÃ©lÅ‘ OLED kijelzÅ‘kÃ¶n.</string>
        <string name="pref_player_style">LejÃ¡tszÃ³ hÃ¡ttÃ©r</string>
        <string name="pref_language">Nyelv</string>
        <string name="pref_language_sub">AlkalmazÃ¡s nyelvÃ©nek mÃ³dosÃ­tÃ¡sa</string>
    
        <!-- Theme Modes -->
        <string name="theme_system">AlapÃ©rtelmezett (Rendszer)</string>
        <string name="theme_light">VilÃ¡gos</string>
        <string name="theme_dark">SÃ¶tÃ©t</string>
        <string name="lang_french">FranÃ§ais</string>
        <string name="lang_english">English</string>
        <string name="lang_hungarian">Magyar</string>
    
        <!-- Player Styles -->
        <string name="style_theme">TÃ©ma (EgyszÃ­nÅ±)</string>
        <string name="style_gradient">Dinamikus szÃ­nÃ¡tmenet</string>
        <string name="style_blur">HomÃ¡lyos borÃ­tÃ³kÃ©p</string>
    
        <!-- Lyrics Settings -->
        <string name="pref_lyrics_title">DalszÃ¶veg</string>
        <string name="pref_lyrics_subtitle">MÃ©ret, igazÃ­tÃ¡s, forrÃ¡s</string>
        <string name="pref_lyrics_local">Helyi fÃ¡jlok elÅ‘nyben rÃ©szesÃ­tÃ©se</string>
        <string name="pref_lyrics_local_sub">BeÃ¡gyazott szÃ¶vegek (ID3) prioritÃ¡sa.</string>
        <string name="pref_lyrics_align">SzÃ¶veg igazÃ­tÃ¡sa</string>
        <string name="pref_lyrics_size">BetÅ±mÃ©ret</string>
        <string name="align_left">Balra</string>
        <string name="align_center">KÃ¶zÃ©pre (AlapÃ©rtelmezett)</string>
        <string name="align_right">Jobbra</string>
        <string name="pref_lyrics_reset">VisszaÃ¡llÃ­tÃ¡s</string>
    
        <!-- Audio Settings -->
        <string name="pref_audio_title">LejÃ¡tszÃ³ Ã©s Hang</string>
        <string name="pref_audio_subtitle">Autoplay, minÅ‘sÃ©g Ã©s sorrend</string>
        <string name="pref_autoplay">Automatikus RÃ¡diÃ³</string>
        <string name="pref_autoplay_sub">HasonlÃ³ szÃ¡mok hozzÃ¡adÃ¡sa a vÃ©gÃ©n.</string>
        <string name="pref_persist_queue">VÃ¡rÃ³lista megÅ‘rzÃ©se</string>
        <string name="pref_persist_queue_sub">PozÃ­ciÃ³ Ã©s sor mentÃ©se ÃºjraindÃ­tÃ¡skor.</string>
        <string name="pref_quality">Streaming minÅ‘sÃ©g</string>
        <string name="quality_high">Magas (AlapÃ©rtelmezett)</string>
        <string name="quality_low">AdattakarÃ©kos</string>
        <string name="quality_high_sub">Legjobb minÅ‘sÃ©g (128kbps+)</string>
        <string name="quality_low_sub">KÃ¶nnyÅ± formÃ¡tumok (Opus/HLS) elÅ‘nyben rÃ©szesÃ­tÃ©se</string>
    
        <!-- Local Media Settings -->
        <string name="pref_local_title">Helyi MÃ©dia</string>
        <string name="pref_local_subtitle">Helyi hangfÃ¡jlok kezelÃ©se</string>
        <string name="pref_local_enable">Helyi mÃ©dia engedÃ©lyezÃ©se</string>
        <string name="pref_local_enable_sub">HangfÃ¡jlok megjelenÃ­tÃ©se az eszkÃ¶zrÅ‘l.</string>
        <string name="pref_local_folders">ForrÃ¡s mappÃ¡k</string>
        <string name="pref_local_add">Mappa hozzÃ¡adÃ¡sa</string>
        <string name="pref_local_scan">KÃ¶nyvtÃ¡r beolvasÃ¡sa</string>
        <string name="pref_local_scanning">BeolvasÃ¡s...</string>
        <string name="pref_local_info">A listÃ¡zott mappÃ¡k fÃ¡jljai beolvasÃ¡sra kerÃ¼lnek.</string>
        <string name="pref_local_no_folder">Nincs mappa kivÃ¡lasztva.</string>
        <string name="pref_local_scan_status_waiting">VÃ¡rakozÃ¡s</string>
        <string name="pref_local_scan_status_prep">ElÅ‘kÃ©szÃ­tÃ©s...</string>
        <string name="pref_local_scan_status_searching">FÃ¡jlok keresÃ©se...</string>
        <string name="pref_local_scan_status_no_folder">Nincs mappa kivÃ¡lasztva</string>
        <string name="pref_local_scan_status_no_files">Nem talÃ¡lhatÃ³ hangfÃ¡jl</string>
        <string name="pref_local_scan_status_found">%1$d fÃ¡jl talÃ¡lhatÃ³. ElemzÃ©s...</string>
        <string name="pref_local_scan_status_analyzing">ElemzÃ©s %1$d / %2$d</string>
        <string name="pref_local_scan_status_saving">MentÃ©s...</string>
        <string name="pref_local_scan_status_done">KÃ©sz!</string>
        <string name="pref_local_scan_status_error">Hiba: %1$s</string>
    
    
        <!-- Storage Settings -->
        <string name="pref_storage_title">TÃ¡rhely &amp; Adatok</string>
        <string name="pref_storage_subtitle">LetÃ¶ltÃ©sek Ã©s gyorsÃ­tÃ³tÃ¡r kezelÃ©se</string>
        <string name="storage_usage">HasznÃ¡lat</string>
        <string name="storage_used">hasznÃ¡lt</string>
        <string name="storage_free">szabad</string>
        <string name="storage_location">LetÃ¶ltÃ©s helye</string>
        <string name="storage_reset">VisszaÃ¡llÃ­tÃ¡s</string>
        <string name="storage_cat_audio">ZenÃ©k</string>
        <string name="storage_cat_images">BorÃ­tÃ³k &amp; KÃ©pek</string>
        <string name="storage_cat_cache">Ideiglenes gyorsÃ­tÃ³tÃ¡r</string>
        <string name="storage_cat_db">AdatbÃ¡zis</string>
        <string name="storage_legend_app">KittyTune</string>
        <string name="storage_legend_system">Rendszer &amp; EgyÃ©b</string>
        <string name="storage_internal_mem">BelsÅ‘ MemÃ³ria</string>
        <string name="storage_internal_mem_sub">/ %1$s</string>
        <string name="storage_sd_card">SD KÃ¡rtya / KÃ¼lsÅ‘</string>
        <string name="storage_custom_folder">EgyÃ©ni mappa</string>
        <string name="storage_change_btn">VÃ¡ltÃ¡s</string>
        <string name="storage_db_subtitle">Index Ã©s beÃ¡llÃ­tÃ¡sok</string>
        <string name="storage_loading">BetÃ¶ltÃ©s...</string>
        <string name="dialog_clean_title">TÃ¡rhely tisztÃ­tÃ¡sa?</string>
        <string name="dialog_clean_audio_msg">TÃ¶rÃ¶lni szeretnÃ© az Ã¶sszes letÃ¶ltÃ¶tt zenÃ©t? Offline hallgatÃ¡shoz Ãºjra le kell tÃ¶lteni Å‘ket.</string>
        <string name="dialog_clean_images_msg">KÃ©pek tÃ¶rlÃ©se? Az album borÃ­tÃ³k a kÃ¶vetkezÅ‘ szinkronizÃ¡lÃ¡sig eltÅ±nnek.</string>
        <string name="dialog_clean_cache_msg">AlkalmazÃ¡s gyorsÃ­tÃ³tÃ¡r Ã¼rÃ­tÃ©se? Ez helyet szabadÃ­t fel a letÃ¶ltÃ©sek Ã©rintÃ©se nÃ©lkÃ¼l.</string>
    
        <!-- Backup Settings -->
        <string name="pref_backup_title">BiztonsÃ¡gi mentÃ©s Ã©s visszaÃ¡llÃ­tÃ¡s</string>
        <string name="pref_backup_subtitle">Adatok exportÃ¡lÃ¡sa vagy importÃ¡lÃ¡sa</string>
        <string name="backup_action">MentÃ©s</string>
        <string name="restore_action">VisszaÃ¡llÃ­tÃ¡s</string>
        <string name="backup_desc">ListÃ¡k, kedvencek, elÅ‘zmÃ©nyek Ã©s beÃ¡llÃ­tÃ¡sok exportÃ¡lÃ¡sa.</string>
        <string name="restore_desc">.backup fÃ¡jl importÃ¡lÃ¡sa az adatok visszaÃ¡llÃ­tÃ¡sÃ¡hoz.</string>
        <string name="backup_info">A mentÃ©s tartalmazza a helyi listÃ¡kat, kedvelt szÃ¡mokat, hallgatÃ¡si elÅ‘zmÃ©nyeket, sikereket Ã©s beÃ¡llÃ­tÃ¡sokat.\n\nA hangfÃ¡jlok helytakarÃ©kossÃ¡gi okokbÃ³l NEM kerÃ¼lnek mentÃ©sre.</string>
        <string name="backup_info_guest">VendÃ©g mÃ³dban is mÅ±kÃ¶dik. Hasznos az adatok mÃ¡sik eszkÃ¶zre valÃ³ Ã¡tvitelÃ©hez.</string>
        <string name="backup_success">Sikeres mentÃ©s!</string>
        <string name="restore_success">Sikeres visszaÃ¡llÃ­tÃ¡s! KÃ©rjÃ¼k, indÃ­tsa Ãºjra az alkalmazÃ¡st.</string>
        <string name="backup_error">Hiba: %1$s</string>
        <string name="backup_in_progress">Folyamatban...</string>
        <string name="backup_toast_success">MentÃ©s kÃ©sz</string>
        <string name="backup_toast_error">MentÃ©si hiba</string>
        <string name="restore_toast_success">VisszaÃ¡llÃ­tÃ¡s kÃ©sz. KÃ©rjÃ¼k, indÃ­tsa Ãºjra.</string>
        <string name="restore_toast_error">VisszaÃ¡llÃ­tÃ¡si hiba</string>
    
        <!-- About -->
        <string name="pref_about_title">NÃ©vjegy</string>
        <string name="pref_about_subtitle">VerziÃ³, licencek Ã©s informÃ¡ciÃ³k</string>
        <string name="about_version">VerziÃ³</string>
        <string name="about_github">MegtekintÃ©s GitHub-on</string>
        <string name="about_licenses">NyÃ­lt forrÃ¡skÃ³dÃº licencek</string>
        <string name="about_bug_report">Hiba jelentÃ©se</string>
        <string name="about_help">SÃºgÃ³ Ã©s tÃ¡mogatÃ¡s</string>
        <string name="about_contact">EgyÃ©b megkeresÃ©sek</string>
        <string name="about_contact_copy">Koppintson az e-mail mÃ¡solÃ¡sÃ¡hoz</string>
        <string name="about_contact_copied">E-mail mÃ¡solva!</string>
        <string name="about_app_info">AlkalmazÃ¡s informÃ¡ciÃ³k</string>
        <string name="about_device_info">EszkÃ¶z informÃ¡ciÃ³k</string>
        <string name="about_package_name">Csomag neve</string>
        <string name="about_device_model">Modell</string>
        <string name="about_android_version">Android VerziÃ³ (API %1$d)</string>
        <string name="about_expand">BÅ‘vÃ­tÃ©s</string>
        <string name="about_collapse">Ã–sszecsukÃ¡s</string>
    
        <!-- Achievements -->
        <string name="achievements_title">Sikerek</string>
        <string name="achievements_subtitle">%1$d / %2$d feloldva</string>
        <string name="achievements_current_level">Jelenlegi Szint</string>
        <string name="achievements_reset_progress">HaladÃ¡s TÃ¶rlÃ©se</string>
        <string name="achievements_status_done">KÃ©sz</string>
        <string name="achievements_secret_title">Titok</string>
    
        <!-- Achievement Categories -->
        <string name="ach_cat_time">â³ KitartÃ¡s &amp; IdÅ‘</string>
        <string name="ach_cat_volume">ğŸ“Š LejÃ¡tszÃ¡si MennyisÃ©g</string>
        <string name="ach_cat_loyalty">ğŸ”¥ Sorozatok</string>
        <string name="ach_cat_collection">ğŸ“š KÃ¶nyvtÃ¡r</string>
        <string name="ach_cat_player">ğŸ›ï¸ LejÃ¡tszÃ³ Mester</string>
        <string name="ach_cat_hardcore">ğŸ’€ TitÃ¡n MÃ³d</string>
        <string name="ach_cat_secret">ğŸ”’ RejtÃ©lyek</string>
    
        <!-- Dialogs -->
        <string name="dialog_reset_achievements_title">Sikerek alaphelyzetbe Ã¡llÃ­tÃ¡sa?</string>
        <string name="dialog_reset_achievements_msg">Figyelem! Minden elÅ‘rehaladÃ¡s, szint Ã©s jelvÃ©ny elveszik. Ez a mÅ±velet nem visszavonhatÃ³.</string>
        <string name="dialog_reset_achievements_confirm">FolytatÃ¡s</string>
        <string name="dialog_reset_achievements_final_title">TÃ‰NYLEG biztos benne?</string>
        <string name="dialog_reset_achievements_final_msg">Ez az utolsÃ³ esÃ©lye. Minden Ã¶rÃ¶kre tÃ¶rlÅ‘dik.</string>
        <string name="dialog_reset_achievements_final_confirm">MINDENT TÃ–RÃ–L</string>
        <string name="dialog_logout_title">KijelentkezÃ©s?</string>
        <string name="dialog_logout_msg">VisszatÃ©rsz az Ã¼dvÃ¶zlÅ‘ kÃ©pernyÅ‘re.</string>
        <string name="dialog_delete_playlist_title">Lista tÃ¶rlÃ©se?</string>
        <string name="dialog_delete_playlist_from_lib_title">EltÃ¡volÃ­tÃ¡s a kÃ¶nyvtÃ¡rbÃ³l?</string>
        <string name="dialog_delete_playlist_msg">Ez a mÅ±velet nem visszavonhatÃ³.</string>
        <string name="dialog_remove_download_title">LetÃ¶ltÃ©s tÃ¶rlÃ©se?</string>
        <string name="dialog_remove_download_msg">A hangfÃ¡jlok tÃ¶rlÅ‘dnek, de a lista a kÃ¶nyvtÃ¡rban marad.</string>
        <string name="dialog_rename_playlist_title">Lista Ã¡tnevezÃ©se</string>
        <string name="dialog_rename_playlist_hint">Ãšj nÃ©v</string>
        <string name="dialog_comment_soon">A hozzÃ¡szÃ³lÃ¡sok kÃ¼ldÃ©se hamarosan elÃ©rhetÅ‘ lesz!</string>
        <string name="dialog_like_soon">A kedvelÃ©sek hamarosan elÃ©rhetÅ‘ek lesznek!</string>
    
        <!-- Miscellaneous -->
        <string name="playlist_num_tracks">%1$d szÃ¡m</string>
        <string name="playlist_by_user">ElÅ‘adÃ³: %1$s</string>
        <string name="add_to_playlist_title_single">HozzÃ¡adÃ¡s listÃ¡hoz</string>
        <string name="add_to_playlist_title_multi">%1$d szÃ¡m hozzÃ¡adÃ¡sa...</string>
        <string name="add_to_playlist_new">Ãšj lista</string>
        <string name="add_comment_hint">HozzÃ¡szÃ³lÃ¡s...</string>
        <string name="comment_no_comments">MÃ©g nincsenek hozzÃ¡szÃ³lÃ¡sok</string>
        <string name="comment_relative_time_now">Most</string>
        <string name="comment_relative_time_minutes_ago">"%1$d perce"</string>
        <string name="comment_relative_time_hours_ago">"%1$d Ã³rÃ¡ja"</string>
        <string name="comment_relative_time_days_ago">"%1$d napja"</string>
        <string name="comment_relative_time_weeks_ago">"%1$d hete"</string>
        <string name="comment_relative_time_months_ago">"%1$d hÃ³napja"</string>
        <string name="comment_relative_time_years_ago">"%1$d Ã©ve"</string>
        <string name="profile_menu_title">KittyTune</string>
        <string name="profile_menu_manage_account">Profilom megtekintÃ©se</string>
        <string name="profile_menu_login">BejelentkezÃ©s fiÃ³kba</string>
        <string name="profile_menu_achievements">Sikerek &amp; Jutalmak</string>
        <string name="profile_menu_settings">BeÃ¡llÃ­tÃ¡sok</string>
        <string name="profile_menu_logout">KijelentkezÃ©s</string>
        <string name="profile_menu_guest_desc">Csak helyi adatok</string>
        <string name="profile_menu_badge_new">Ãšj</string>
    
        <string name="completion_legend">LEGENDA</string>
        <string name="completion_message">Befejezted a KittyTune-t.</string>
        <string name="completion_thanks">KÃ¶szÃ¶njÃ¼k.</string>
        <string name="completion_thanks_message">"Minden siker teljesÃ­tÃ©se olyan tett, amit kevesen Ã©rnek el. Az Ã–n elkÃ¶telezettsÃ©ge Ã©s zene irÃ¡nti szenvedÃ©lye az oka ennek az alkalmazÃ¡snak.\n\nKÃ¶szÃ¶njÃ¼k, hogy velÃ¼nk tartott ezen az Ãºton.\n\n~ Alan :3"</string>
        <string name="completion_continue">Koppintson bÃ¡rhova a folytatÃ¡shoz</string>
        <string name="profile_playlists_by_user">%1$s lejÃ¡tszÃ¡si listÃ¡i</string>
        <string name="profile_likes_by_user">%1$s kedvelte</string>
        <string name="profile_latest_tracks">LegutÃ³bbi szÃ¡mok</string>
        <string name="profile_update_success">Profil frissÃ­tve</string>
        <string name="profile_update_error">Hiba: %1$s</string>
        <string name="btn_back">Vissza</string>
        <string name="btn_follow">KÃ¶vetÃ©s</string>
        <string name="share_via">MegosztÃ¡s ezen keresztÃ¼l</string>
        <string name="profile_banner">Banner</string>
        <string name="profile_avatar">AvatÃ¡r</string>
        <string name="btn_save_changes">VÃ¡ltoztatÃ¡sok mentÃ©se</string>
        <string name="btn_see_all">Ã–sszes</string>
        <string name="generic_title">CÃ­m</string>
        <string name="generic_artist">ElÅ‘adÃ³</string>
    
        <!-- Achievements -->
        <string name="achievements_reset_success">Sikerek visszaÃ¡llÃ­tva.</string>
        <string name="ach_secret_desc">\?</string>
        <string name="ach_time_1h_title">BemelegÃ­tÃ©s</string>
        <string name="ach_time_1h_desc">1 Ã³ra zenehallgatÃ¡s</string>
        <string name="ach_time_24h_title">24/7</string>
        <string name="ach_time_24h_desc">24 Ã³ra Ã¶sszesÃ­tett zenehallgatÃ¡s</string>
        <string name="ach_time_100h_title">SoundCloud FÃ¼ggÅ‘</string>
        <string name="ach_time_100h_desc">100 Ã³ra zenehallgatÃ¡s</string>
        <string name="ach_time_500h_title">FÃ©l Ezer</string>
        <string name="ach_time_500h_desc">500 Ã³ra (20 nap) zenehallgatÃ¡s</string>
        <string name="ach_time_1000h_title">VeterÃ¡n</string>
        <string name="ach_time_1000h_desc">1000 Ã³ra zenehallgatÃ¡s</string>
        <string name="ach_time_2500h_title">Nagymester</string>
        <string name="ach_time_2500h_desc">2500 Ã³ra zenehallgatÃ¡s</string>
        <string name="ach_time_5000h_title">Az Ã–rÃ¶kkÃ©valÃ³</string>
        <string name="ach_time_5000h_desc">5000 Ã³ra zenehallgatÃ¡s</string>
        <string name="ach_time_10000h_title">Transzcendencia</string>
        <string name="ach_time_10000h_desc">10 000 Ã³ra. A mesterrÃ© vÃ¡lÃ¡s szabÃ¡lya.</string>
    
        <string name="ach_plays_1_title">ElsÅ‘ LÃ©pÃ©s</string>
        <string name="ach_plays_1_desc">Hallgass meg 1 szÃ¡mot</string>
        <string name="ach_plays_100_title">KÃ­vÃ¡ncsi</string>
        <string name="ach_plays_100_desc">100 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_1000_title">FelfedezÅ‘</string>
        <string name="ach_plays_1000_desc">1 000 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_5000_title">ZeneimÃ¡dÃ³</string>
        <string name="ach_plays_5000_desc">5 000 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_10000_title">GÃ©p</string>
        <string name="ach_plays_10000_desc">10 000 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_20000_title">LÃ¡tnok</string>
        <string name="ach_plays_20000_desc">20 000 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_50000_title">JÃ³s</string>
        <string name="ach_plays_50000_desc">50 000 lejÃ¡tszÃ¡s</string>
        <string name="ach_plays_100000_title">A Hang Istene</string>
        <string name="ach_plays_100000_desc">100 000 lejÃ¡tszÃ¡s. A vÃ©gsÅ‘ fÅ‘nÃ¶k.</string>
    
        <string name="ach_streak_7_title">Teljes HÃ©t</string>
        <string name="ach_streak_7_desc">7 egymÃ¡st kÃ¶vetÅ‘ nap</string>
        <string name="ach_streak_30_title">TÃ¶rzsvendÃ©g</string>
        <string name="ach_streak_30_desc">1 hÃ³nap (30 nap) egyhuzamban</string>
        <string name="ach_streak_100_title">SzÃ¡zados</string>
        <string name="ach_streak_100_desc">100 egymÃ¡st kÃ¶vetÅ‘ nap.</string>
        <string name="ach_streak_200_title">Dupla SzÃ¡zad</string>
        <string name="ach_streak_200_desc">200 egymÃ¡st kÃ¶vetÅ‘ nap.</string>
        <string name="ach_streak_365_title">TÃ¶kÃ©letes Ã‰v</string>
        <string name="ach_streak_365_desc">365 egymÃ¡st kÃ¶vetÅ‘ nap.</string>
        <string name="ach_streak_500_title">LegyÅ‘zhetetlen</string>
        <string name="ach_streak_500_desc">500 egymÃ¡st kÃ¶vetÅ‘ nap.</string>
        <string name="ach_early_bird_title">KorÃ¡nkelÅ‘</string>
        <string name="ach_early_bird_desc">Hallgass zenÃ©t 10-szer 5 Ã©s 8 Ã³ra kÃ¶zÃ¶tt</string>
        <string name="ach_night_owl_title">Ã‰jjeli Bagoly</string>
        <string name="ach_night_owl_desc">Hallgass zenÃ©t 10-szer 3 Ã©s 5 Ã³ra kÃ¶zÃ¶tt</string>
        <string name="ach_lunch_break_title">EbÃ©dszÃ¼net</string>
        <string name="ach_lunch_break_desc">Hallgass zenÃ©t 10-szer 12 Ã©s 13 Ã³ra kÃ¶zÃ¶tt</string>
    
        <string name="ach_liker_50_title">SzenvedÃ©lyes</string>
        <string name="ach_liker_50_desc">Kedvelj 50 szÃ¡mot</string>
        <string name="ach_liker_1000_title">AranyszÃ­v</string>
        <string name="ach_liker_1000_desc">Kedvelj 1000 szÃ¡mot</string>
        <string name="ach_liker_5000_title">VÃ©gtelen Szerelem</string>
        <string name="ach_liker_5000_desc">Kedvelj 5000 szÃ¡mot</string>
        <string name="ach_playlist_creator_title">VÃ¡logatÃ³</string>
        <string name="ach_playlist_creator_desc">Hozz lÃ©tre 5 helyi lejÃ¡tszÃ¡si listÃ¡t</string>
        <string name="ach_playlist_god_title">Ã‰pÃ­tÃ©sz</string>
        <string name="ach_playlist_god_desc">Hozz lÃ©tre 50 helyi lejÃ¡tszÃ¡si listÃ¡t</string>
        <string name="ach_download_100_title">AdatgyÅ±jtÅ‘</string>
        <string name="ach_download_100_desc">TÃ¶lts le 100 szÃ¡mot</string>
        <string name="ach_download_1000_title">Szerver</string>
        <string name="ach_download_1000_desc">TÃ¶lts le 1000 szÃ¡mot</string>
    
        <string name="ach_skipper_100_title">UgrÃ¡lÃ³</string>
        <string name="ach_skipper_100_desc">Ugorj Ã¡t 100 szÃ¡mot</string>
        <string name="ach_skipper_1000_title">Soha Nem ElÃ©gedett</string>
        <string name="ach_skipper_1000_desc">Ugorj Ã¡t 1000 szÃ¡mot</string>
        <string name="ach_bass_addict_title">BasszusfÃ¼ggÅ‘</string>
        <string name="ach_bass_addict_desc">Hallgass 10 Ã³rÃ¡t Bass Boost-tal</string>
        <string name="ach_speed_demon_title">Nightcore RajongÃ³</string>
        <string name="ach_speed_demon_desc">Hallgass 1 Ã³rÃ¡t >1.2x sebessÃ©ggel</string>
        <string name="ach_social_star_title">VirÃ¡lis</string>
        <string name="ach_social_star_desc">Ossz meg 50 szÃ¡mot</string>
    
        <string name="ach_obsessed_50_title">MegszÃ¡llott</string>
        <string name="ach_obsessed_50_desc">Hallgasd UGYANAZT a szÃ¡mot 50-szer</string>
        <string name="ach_obsessed_200_title">Tiszta ÅrÃ¼let</string>
        <string name="ach_obsessed_200_desc">Hallgasd UGYANAZT a szÃ¡mot 200-szor</string>
        <string name="ach_night_shift_pro_title">VÃ¡mpÃ­r</string>
        <string name="ach_night_shift_pro_desc">Hallgass 500 Ã³rÃ¡t Ã©jjel (22-06h)</string>
        <string name="ach_marathon_title">Maratonista</string>
        <string name="ach_marathon_desc">Hallgass zenÃ©t 8 Ã³rÃ¡n Ã¡t az app bezÃ¡rÃ¡sa nÃ©lkÃ¼l</string>
        <string name="ach_no_skip_50_title">FÃ³kusz</string>
        <string name="ach_no_skip_50_desc">Hallgass meg 50 szÃ¡mot ugrÃ¡s nÃ©lkÃ¼l</string>
    
        <string name="ach_developer_title">Hacker</string>
        <string name="ach_weekend_warrior_title">HÃ©tvÃ©gi Harcos</string>
        <string name="ach_ghost_title">Szellem</string>
        <string name="ach_lucky7_title">Jackpot</string>
        <string name="ach_glitch_title">Hiba a MÃ¡trixban</string>
    
        <!-- AJOUTS POUR LYRICS SETTINGS -->
        <string name="align_center_simple">KÃ¶zÃ©pre</string>
    
        <string name="storage_used_formatted">%1$s hasznÃ¡lt</string>
        <string name="storage_free_formatted">%1$s szabad</string>
        <string name="storage_change_cta">Ã‰rintse meg a vÃ¡ltÃ¡shoz</string>
    
        <!-- Licenses Screen -->
        <string name="about_licenses_title">NyÃ­lt ForrÃ¡skÃ³dÃº Licencek</string>
        <string name="license_author_prefix">%1$s Ã¡ltal</string>
        <string name="open_in_new">MegnyitÃ¡s Ãºj ablakban</string>
    
        <!-- Player Screen & Associated Sheets -->
        <string name="player_like_action">KedvelÃ©s</string>
        <string name="player_effects">Effektek</string>
        <string name="menu_remove_local_q">EltÃ¡volÃ­tÃ¡s?</string>
        <string name="menu_remove_local_body">Ez a fÃ¡jl tÃ¶bbÃ© nem lesz listÃ¡zva az alkalmazÃ¡sban (a fÃ¡jl nem tÃ¶rlÅ‘dik a telefonrÃ³l).</string>
        <string name="menu_remove_download_q">TÃ¶rli a letÃ¶ltÃ©st?</string>
        <string name="menu_remove_download_body">Ez a szÃ¡m tÃ¶rlÅ‘dik a helyi tÃ¡rhelyrÅ‘l.</string>
        <string name="comment_anonymous">NÃ©vtelen</string>
        <string name="comment_default_avatar">AlapÃ©rtelmezett avatÃ¡r</string>
        <string name="comment_send_action">KÃ¼ldÃ©s</string>
        <string name="time_now">Ã‰pp most</string>
        <string name="time_minutes_ago">%1$d perce</string>
        <string name="time_hours_ago">%1$d Ã³rÃ¡ja</string>
        <string name="time_days_ago">%1$d napja</string>
        <string name="time_weeks_ago">%1$d hete</string>
        <string name="time_months_ago">%1$d hÃ³napja</string>
        <string name="time_one_year_ago">1 Ã©ve</string>
        <string name="time_years_ago">%1$d Ã©ve</string>
        <string name="detail_file_size_formatted">%.2f MB</string>
    
        <!-- Notifications -->
        <string name="settings_cat_notifications">Ã‰rtesÃ­tÃ©sek</string>
        <string name="pref_achievement_popups">Siker FelugrÃ³ Ablakok</string>
        <string name="pref_achievement_popups_sub">Ã‰rtesÃ­tÃ©s megjelenÃ­tÃ©se siker feloldÃ¡sakor.</string>
        <string name="achievement_unlocked">Siker feloldva</string>
        <string name="achievement_xp">%1$d XP</string>
        <string name="streak_popup_title">Napi sorozat</string>
        <string name="streak_popup_subtitle">%1$d Nap(ok)</string>
        <string name="test_notification_triggered">Tesztes Ã©rtesÃ­tÃ©s elindÃ­tva!</string>
    
        <!-- Credits & Community -->
        <string name="about_credits">KÃ©szÃ­tÅ‘k</string>
        <string name="about_role_dev">FÅ‘ fejlesztÅ‘ Ã©s KÃ©szÃ­tÅ‘</string>
        <string name="about_role_translation">Magyar fordÃ­tÃ¡s Ã©s ellenÅ‘rzÃ©s</string>
        <string name="about_translate_title">KittyTune FordÃ­tÃ¡sa</string>
        <string name="about_translate_desc">SzeretnÃ©d az alkalmazÃ¡st a sajÃ¡t nyelveden lÃ¡tni? ( â—•â–¿â—• )\nKÃ¼ldj egy Pull Request-et GitHub-on!</string>
        <string name="about_made_with">Szeretettel ( Ë˜ Â³Ë˜)â™¥ Alan Ã¡ltal</string>
    </resources>

================================================================================
FICHIER : ./res/values/ic_launcher_background.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
        <color name="ic_launcher_background">#000000</color>
    </resources>

================================================================================
FICHIER : ./res/values/strings.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
        <string name="app_name">KittyTune</string>
    
        <!-- Navigation -->
        <string name="nav_home">Home</string>
        <string name="nav_library">Library</string>
        <string name="nav_welcome">Welcome</string>
        <string name="nav_login">Login</string>
    
        <!-- General Actions -->
        <string name="btn_cancel">Cancel</string>
        <string name="btn_confirm">Confirm</string>
        <string name="btn_save">Save</string>
        <string name="btn_delete">Delete</string>
        <string name="btn_create">Create</string>
        <string name="btn_close">Close</string>
        <string name="btn_play">Play</string>
        <string name="btn_pause">Pause</string>
        <string name="btn_shuffle">Shuffle</string>
        <string name="btn_download">Download</string>
        <string name="btn_downloaded">Downloaded</string>
        <string name="btn_share">Share</string>
        <string name="btn_options">Options</string>
        <string name="btn_ok">OK</string>
        <string name="loading">Loading...</string>
        <string name="error_generic">An error occurred</string>
        <string name="success_generic">Operation successful</string>
        <string name="all_filters">All</string>
    
        <!-- Welcome & Login -->
        <string name="welcome_title">Welcome to\nSoundTune</string>
        <string name="welcome_subtitle">Discover, stream, and download your favorite music without limits.</string>
        <string name="login_soundcloud">Connect with SoundCloud</string>
        <string name="login_guest">Continue as Guest</string>
        <string name="guest_loading">Initializing guest session...</string>
        <string name="login_title">SoundCloud Login</string>
    
        <!-- Home -->
        <string name="search_hint">Search tracks, artists...</string>
        <string name="search_library_hint">Search in library</string>
        <string name="home_recently_played">Recently Played</string>
        <string name="home_section_similar">Similar to %1$s</string>
        <string name="home_section_similar_sub">Because you liked this track</string>
        <string name="home_section_new_crew">New Crew</string>
        <string name="home_section_new_crew_sub">Artists to discover based on your taste</string>
        <string name="home_trending">Global Trends</string>
        <string name="home_charts">Charts</string>
        <string name="no_results">No results</string>
        <string name="radio">Radio</string>
        <string name="untitled_track">Untitled Track</string>
        <string name="unknown_artist">Unknown Artist</string>
        <string name="unknown_user">User</string>
    
        <!-- Library -->
        <string name="lib_playlists">Playlists</string>
        <string name="lib_artists">Artists</string>
        <string name="lib_liked_tracks">Liked Tracks</string>
        <string name="lib_liked_subtitle">Playlist â€¢ Automatic</string>
        <string name="lib_liked_subtitle_local">Local â€¢ On this device</string>
        <string name="lib_liked_subtitle_syncing">Updating...</string>
        <string name="lib_downloads">Downloaded Tracks</string>
        <string name="lib_downloads_subtitle">Offline â€¢ Automatic</string>
        <string name="lib_local_media">Local Media</string>
        <string name="lib_local_media_subtitle">All your audio files</string>
        <string name="lib_create_playlist_title">New Playlist</string>
        <string name="lib_create_playlist_hint">Playlist name</string>
        <string name="lib_offline_mode">Offline Mode â€¢ Access to downloads</string>
        <string name="lib_guest_mode">Guest Mode â€¢ Login to sync</string>
        <string name="sort_date_added">Date Added</string>
        <string name="me_artist">Me</string>
        <string name="guest_user">Guest</string>
        <string name="logout_guest">Exit guest mode</string>
    
        <!-- Player -->
        <string name="player_playing_now">NOW PLAYING</string>
        <string name="player_queue">Queue</string>
        <string name="player_lyrics">Lyrics</string>
        <string name="player_audio_settings">Audio Settings</string>
        <string name="player_special_effects">Special Effects</string>
        <string name="player_pitch">Pitch</string>
        <string name="player_speed">Speed</string>
        <string name="effect_bass_boost">Bass Boost</string>
        <string name="effect_8d">8D Audio</string>
        <string name="effect_muffled">Muffled</string>
        <string name="effect_reverb">Reverb</string>
        <string name="menu_play_next">Play next</string>
        <string name="menu_add_queue">Add to queue</string>
        <string name="menu_add_playlist">Add to playlist</string>
        <string name="menu_go_artist">Artist</string>
        <string name="menu_track_radio">Track Radio</string>
        <string name="menu_details">Details</string>
        <string name="menu_comments">Comments</string>
        <string name="context_playlist">Playlist â€¢ %1$s</string>
        <string name="context_station">Station â€¢ %1$s</string>
        <string name="menu_shuffle">Shuffle</string>
        <string name="menu_repeat">Repeat</string>
        <string name="menu_repeat_all">Repeat (All)</string>
        <string name="menu_repeat_one">Repeat (1)</string>
        <string name="menu_remove">Remove</string>
        <string name="menu_cancel_download">Cancel</string>
        <string name="menu_delete_download">Delete</string>
    
        <!-- Lyrics -->
        <string name="lyrics_no_data">No lyrics available</string>
        <string name="lyrics_manual_search">Manual Search</string>
        <string name="lyrics_wrong">Wrong lyrics?</string>
        <string name="lyrics_search_hint">Track artist...</string>
    
        <!-- Profile & Details -->
        <string name="profile_followers">Followers</string>
        <string name="profile_tracks">Tracks</string>
        <string name="profile_edit">Edit Profile</string>
        <string name="profile_edit_title">Edit Profile</string>
        <string name="profile_name">Display Name</string>
        <string name="profile_bio">Bio</string>
        <string name="profile_city">City / Country</string>
        <string name="profile_tab_popular">Popular</string>
        <string name="profile_tab_tracks">Latest Tracks</string>
        <string name="profile_tab_albums">Albums</string>
        <string name="profile_tab_playlists">Playlists</string>
        <string name="profile_tab_likes">Likes by %1$s</string>
        <string name="profile_tab_reposts">Reposts</string>
        <string name="profile_about">About</string>
        <string name="profile_similar_artists">You might also like</string>
        <string name="detail_track_title">Track Details</string>
        <string name="detail_likers">Likes</string>
        <string name="detail_reposters">Reposts</string>
        <string name="detail_in_playlists">In Playlists</string>
        <string name="detail_related">Similar Tracks</string>
        <string name="detail_no_one_yet">No one yet.</string>
        <string name="detail_no_public_playlist">No public playlists found.</string>
        <string name="detail_no_similar">No similar tracks found.</string>
        <string name="detail_file_info">File Information</string>
        <string name="detail_format">Format</string>
        <string name="detail_size">Size</string>
        <string name="detail_duration">Duration</string>
        <string name="detail_location">Location</string>
        <string name="detail_external_storage">External Storage</string>
        <string name="detail_local_file">Local File</string>
        <string name="detail_unknown">Unknown</string>
        <string name="detail_stats_plays">Plays</string>
        <string name="detail_stats_likes">Likes</string>
        <string name="detail_stats_reposts">Reposts</string>
        <string name="detail_show_more">Show more</string>
        <string name="detail_show_less">Show less</string>
        <string name="detail_see_similar">See similar tracks &amp; fans</string>
        <string name="detail_see_comments">See comments (%1$s)</string>
        <string name="detail_release_date">Release date</string>
        <string name="detail_genre">Genre</string>
        <string name="detail_description">Description</string>
        <string name="detail_tags">Tags</string>
    
        <!-- Settings Categories -->
        <string name="settings_title">Settings</string>
        <string name="settings_cat_appearance">Appearance</string>
        <string name="settings_cat_playback">Playback</string>
        <string name="settings_cat_audio">Audio</string>
        <string name="settings_cat_general">General</string>
        <string name="settings_cat_source">Source</string>
    
        <!-- Appearance Settings -->
        <string name="pref_appearance_title">Appearance</string>
        <string name="pref_appearance_subtitle">Theme, start screen, player, language</string>
        <string name="pref_start_screen">Start Screen</string>
        <string name="pref_theme_dynamic">Dynamic Theme (Material You)</string>
        <string name="pref_theme_dynamic_sub">Use your wallpaper colors.</string>
        <string name="pref_theme_mode">Theme Mode</string>
        <string name="pref_theme_pure_black">Pure Black (AMOLED)</string>
        <string name="pref_theme_pure_black_sub">Saves battery on OLED screens.</string>
        <string name="pref_player_style">Player Background</string>
        <string name="pref_language">Language</string>
        <string name="pref_language_sub">Change app language</string>
    
        <!-- Theme Modes -->
        <string name="theme_system">Default (System)</string>
        <string name="theme_light">Light</string>
        <string name="theme_dark">Dark</string>
        <string name="lang_french">FranÃ§ais</string>
        <string name="lang_english">English</string>
        <string name="lang_hungarian">Magyar</string>
    
        <!-- Player Styles -->
        <string name="style_theme">Theme (Solid Color)</string>
        <string name="style_gradient">Dynamic Gradient</string>
        <string name="style_blur">Blurred Artwork</string>
    
        <!-- Lyrics Settings -->
        <string name="pref_lyrics_title">Lyrics</string>
        <string name="pref_lyrics_subtitle">Size, alignment, source</string>
        <string name="pref_lyrics_local">Prefer local files</string>
        <string name="pref_lyrics_local_sub">Priority to embedded lyrics (ID3).</string>
        <string name="pref_lyrics_align">Text Alignment</string>
        <string name="pref_lyrics_size">Font Size</string>
        <string name="align_left">Left</string>
        <string name="align_center">Center (Default)</string>
        <string name="align_right">Right</string>
        <string name="pref_lyrics_reset">Reset</string>
    
        <!-- Audio Settings -->
        <string name="pref_audio_title">Player &amp; Audio</string>
        <string name="pref_audio_subtitle">Autoplay, quality, and persistence</string>
        <string name="pref_autoplay">Autoplay Station</string>
        <string name="pref_autoplay_sub">Add similar tracks when music ends.</string>
        <string name="pref_persist_queue">Persistent Queue</string>
        <string name="pref_persist_queue_sub">Save position and queue after restart.</string>
        <string name="pref_quality">Streaming Quality</string>
        <string name="quality_high">High (Default)</string>
        <string name="quality_low">Data Saver</string>
        <string name="quality_high_sub">Best possible quality (128kbps+)</string>
        <string name="quality_low_sub">Prioritize lightweight formats (Opus/HLS)</string>
    
        <!-- Local Media Settings -->
        <string name="pref_local_title">Local Media</string>
        <string name="pref_local_subtitle">Manage local audio files</string>
        <string name="pref_local_enable">Enable Local Media</string>
        <string name="pref_local_enable_sub">Show audio files from device.</string>
        <string name="pref_local_folders">Source Folders</string>
        <string name="pref_local_add">Add Folder</string>
        <string name="pref_local_scan">Scan Library</string>
        <string name="pref_local_scanning">Scanning...</string>
        <string name="pref_local_info">Files from all listed folders will be scanned.</string>
        <string name="pref_local_no_folder">No folder selected.</string>
        <string name="pref_local_scan_status_waiting">Waiting</string>
        <string name="pref_local_scan_status_prep">Preparing...</string>
        <string name="pref_local_scan_status_searching">Searching for files...</string>
        <string name="pref_local_scan_status_no_folder">No folder selected</string>
        <string name="pref_local_scan_status_no_files">No audio files found</string>
        <string name="pref_local_scan_status_found">Found %1$d files. Analyzing...</string>
        <string name="pref_local_scan_status_analyzing">Analyzing %1$d / %2$d</string>
        <string name="pref_local_scan_status_saving">Saving...</string>
        <string name="pref_local_scan_status_done">Done!</string>
        <string name="pref_local_scan_status_error">Error: %1$s</string>
    
    
        <!-- Storage Settings -->
        <string name="pref_storage_title">Storage &amp; Data</string>
        <string name="pref_storage_subtitle">Manage downloads and cache</string>
        <string name="storage_usage">Usage</string>
        <string name="storage_used">used</string>
        <string name="storage_free">free</string>
        <string name="storage_location">Download Location</string>
        <string name="storage_reset">Reset</string>
        <string name="storage_cat_audio">Music</string>
        <string name="storage_cat_images">Covers &amp; Images</string>
        <string name="storage_cat_cache">Temporary Cache</string>
        <string name="storage_cat_db">Database</string>
        <string name="storage_legend_app">SoundTune</string>
        <string name="storage_legend_system">System &amp; Others</string>
        <string name="storage_internal_mem">Internal Memory</string>
        <string name="storage_internal_mem_sub">/ %1$s</string>
        <string name="storage_sd_card">SD Card / External</string>
        <string name="storage_custom_folder">Custom Folder</string>
        <string name="storage_change_btn">Change</string>
        <string name="storage_db_subtitle">Index and settings</string>
        <string name="storage_loading">Loading...</string>
        <string name="dialog_clean_title">Clean Storage?</string>
        <string name="dialog_clean_audio_msg">Do you want to delete all downloaded music? They will need to be re-downloaded for offline listening.</string>
        <string name="dialog_clean_images_msg">Delete images? Album covers will disappear until the next sync.</string>
        <string name="dialog_clean_cache_msg">Clear app cache? This frees up space without affecting your downloads.</string>
    
        <!-- Backup Settings -->
        <string name="pref_backup_title">Backup &amp; Restore</string>
        <string name="pref_backup_subtitle">Export or import your data</string>
        <string name="backup_action">Backup</string>
        <string name="restore_action">Restore</string>
        <string name="backup_desc">Export playlists, favorites, history, and preferences.</string>
        <string name="restore_desc">Import a .backup file to retrieve your data.</string>
        <string name="backup_info">Backup includes local playlists, liked tracks, listening history, achievements, and preferences.\n\nAudio files are NOT included in the backup file to save space, but references are kept.</string>
        <string name="backup_info_guest">Works even in Guest mode. Useful for transferring data to another device.</string>
        <string name="backup_success">Backup successful!</string>
        <string name="restore_success">Restore successful! Please restart the application.</string>
        <string name="backup_error">Error: %1$s</string>
        <string name="backup_in_progress">Processing...</string>
        <string name="backup_toast_success">Backup complete</string>
        <string name="backup_toast_error">Backup error</string>
        <string name="restore_toast_success">Restore complete. Please restart.</string>
        <string name="restore_toast_error">Restore error</string>
    
        <!-- About -->
        <string name="pref_about_title">About</string>
        <string name="pref_about_subtitle">Version, licenses, and info</string>
        <string name="about_version">Version</string>
        <string name="about_github">View on GitHub</string>
        <string name="about_licenses">Open Source Licenses</string>
        <string name="about_bug_report">Submit Bug Report</string>
        <string name="about_help">Help &amp; Support</string>
        <string name="about_contact">Other inquiries</string>
        <string name="about_contact_copy">Tap to copy email</string>
        <string name="about_contact_copied">Email copied!</string>
        <string name="about_app_info">App Info</string>
        <string name="about_device_info">Device Info</string>
        <string name="about_package_name">Package Name</string>
        <string name="about_device_model">Model</string>
        <string name="about_android_version">Android Version (API %1$d)</string>
        <string name="about_expand">Expand</string>
        <string name="about_collapse">Collapse</string>
    
        <!-- Achievements -->
        <string name="achievements_title">Achievements</string>
        <string name="achievements_subtitle">%1$d / %2$d unlocked</string>
        <string name="achievements_current_level">Current Level</string>
        <string name="achievements_reset_progress">Reset Progress</string>
        <string name="achievements_status_done">Completed</string>
        <string name="achievements_secret_title">Secret</string>
    
        <!-- Achievement Categories -->
        <string name="ach_cat_time">â³ Endurance &amp; Time</string>
        <string name="ach_cat_volume">ğŸ“Š Play Volume</string>
        <string name="ach_cat_loyalty">ğŸ”¥ Streaks</string>
        <string name="ach_cat_collection">ğŸ“š Library</string>
        <string name="ach_cat_player">ğŸ›ï¸ Player Mastery</string>
        <string name="ach_cat_hardcore">ğŸ’€ Titan Mode</string>
        <string name="ach_cat_secret">ğŸ”’ Mysteries</string>
    
        <!-- Dialogs -->
        <string name="dialog_reset_achievements_title">Reset Achievements?</string>
        <string name="dialog_reset_achievements_msg">Warning! You will lose all your progress, level, and badges. This action is irreversible.</string>
        <string name="dialog_reset_achievements_confirm">Continue</string>
        <string name="dialog_reset_achievements_final_title">Are you REALLY sure?</string>
        <string name="dialog_reset_achievements_final_msg">This is your last chance. Everything will be erased forever.</string>
        <string name="dialog_reset_achievements_final_confirm">DELETE EVERYTHING</string>
        <string name="dialog_logout_title">Log Out?</string>
        <string name="dialog_logout_msg">You will return to the welcome screen.</string>
        <string name="dialog_delete_playlist_title">Delete playlist?</string>
        <string name="dialog_delete_playlist_from_lib_title">Remove from library?</string>
        <string name="dialog_delete_playlist_msg">This action is irreversible.</string>
        <string name="dialog_remove_download_title">Delete download?</string>
        <string name="dialog_remove_download_msg">Audio files will be deleted, but the playlist will remain in your library.</string>
        <string name="dialog_rename_playlist_title">Rename playlist</string>
        <string name="dialog_rename_playlist_hint">New name</string>
        <string name="dialog_comment_soon">Sending comments will be available soon!</string>
        <string name="dialog_like_soon">Likes will be available soon!</string>
    
        <!-- Miscellaneous -->
        <string name="playlist_num_tracks">%1$d tracks</string>
        <string name="playlist_by_user">By %1$s</string>
        <string name="add_to_playlist_title_single">Add to playlist</string>
        <string name="add_to_playlist_title_multi">Add %1$d tracks to...</string>
        <string name="add_to_playlist_new">New playlist</string>
        <string name="add_comment_hint">Add a comment...</string>
        <string name="comment_no_comments">No comments yet</string>
        <string name="comment_relative_time_now">Just now</string>
        <string name="comment_relative_time_minutes_ago">"%1$d min ago"</string>
        <string name="comment_relative_time_hours_ago">"%1$d h ago"</string>
        <string name="comment_relative_time_days_ago">"%1$d d ago"</string>
        <string name="comment_relative_time_weeks_ago">"%1$d wk ago"</string>
        <string name="comment_relative_time_months_ago">"%1$d mo ago"</string>
        <string name="comment_relative_time_years_ago">"%1$d y ago"</string>
        <string name="profile_menu_title">SoundTune</string>
        <string name="profile_menu_manage_account">View my profile</string>
        <string name="profile_menu_login">Login to an account</string>
        <string name="profile_menu_achievements">Achievements &amp; Rewards</string>
        <string name="profile_menu_settings">Settings</string>
        <string name="profile_menu_logout">Log out</string>
        <string name="profile_menu_guest_desc">Local data only</string>
        <string name="profile_menu_badge_new">New</string>
    
        <string name="completion_legend">LEGEND</string>
        <string name="completion_message">You have completed SoundTune.</string>
        <string name="completion_thanks">Thank you.</string>
        <string name="completion_thanks_message">"Completing all achievements is a feat few will accomplish. Your dedication and passion for music are the reason this app exists.\n\nThank you for taking this journey with us.\n\n~ Alan :3"</string>
        <string name="completion_continue">Tap anywhere to continue</string>
    
        <!-- AJOUTS POUR L'Ã‰CRAN DE PROFIL -->
        <string name="profile_playlists_by_user">Playlists by %1$s</string>
        <string name="profile_likes_by_user">%1$s liked</string>
        <string name="profile_latest_tracks">Latest tracks</string>
        <string name="profile_update_success">Profile updated</string>
        <string name="profile_update_error">Error: %1$s</string>
        <string name="btn_back">Back</string>
        <string name="btn_follow">Follow</string>
        <string name="share_via">Share via</string>
        <string name="profile_banner">Banner</string>
        <string name="profile_avatar">Avatar</string>
        <string name="btn_save_changes">Save changes</string>
        <string name="btn_see_all">See all</string>
        <string name="generic_title">Title</string>
        <string name="generic_artist">Artist</string>
    
        <!-- Achievements -->
        <string name="achievements_reset_success">Achievements reset.</string>
        <string name="ach_secret_desc">\?</string>
        <string name="ach_time_1h_title">Warm-up</string>
        <string name="ach_time_1h_desc">1 hour of listening</string>
        <string name="ach_time_24h_title">24/7</string>
        <string name="ach_time_24h_desc">24 hours of cumulative listening</string>
        <string name="ach_time_100h_title">SoundCloud Addict</string>
        <string name="ach_time_100h_desc">100 hours of listening</string>
        <string name="ach_time_500h_title">Half-Mille</string>
        <string name="ach_time_500h_desc">500 hours (20 days) of listening</string>
        <string name="ach_time_1000h_title">Veteran</string>
        <string name="ach_time_1000h_desc">1000 hours of listening</string>
        <string name="ach_time_2500h_title">Grand Master</string>
        <string name="ach_time_2500h_desc">2500 hours of listening</string>
        <string name="ach_time_5000h_title">The Eternal</string>
        <string name="ach_time_5000h_desc">5000 hours of listening</string>
        <string name="ach_time_10000h_title">Transcendence</string>
        <string name="ach_time_10000h_desc">10,000 hours. The mastery rule.</string>
    
        <string name="ach_plays_1_title">First Step</string>
        <string name="ach_plays_1_desc">Listen to 1 track</string>
        <string name="ach_plays_100_title">Curious</string>
        <string name="ach_plays_100_desc">100 plays</string>
        <string name="ach_plays_1000_title">Explorer</string>
        <string name="ach_plays_1000_desc">1,000 plays</string>
        <string name="ach_plays_5000_title">Music Lover</string>
        <string name="ach_plays_5000_desc">5,000 plays</string>
        <string name="ach_plays_10000_title">Machine</string>
        <string name="ach_plays_10000_desc">10,000 plays</string>
        <string name="ach_plays_20000_title">Visionary</string>
        <string name="ach_plays_20000_desc">20,000 plays</string>
        <string name="ach_plays_50000_title">Oracle</string>
        <string name="ach_plays_50000_desc">50,000 plays</string>
        <string name="ach_plays_100000_title">God of Sound</string>
        <string name="ach_plays_100000_desc">100,000 plays. The final boss.</string>
    
        <string name="ach_streak_7_title">Full Week</string>
        <string name="ach_streak_7_desc">7 consecutive days</string>
        <string name="ach_streak_30_title">Regular</string>
        <string name="ach_streak_30_desc">1 month (30 days) in a row</string>
        <string name="ach_streak_100_title">Centenarian</string>
        <string name="ach_streak_100_desc">100 consecutive days.</string>
        <string name="ach_streak_200_title">Double Century</string>
        <string name="ach_streak_200_desc">200 consecutive days.</string>
        <string name="ach_streak_365_title">Perfect Year</string>
        <string name="ach_streak_365_desc">365 consecutive days.</string>
        <string name="ach_streak_500_title">Invincible</string>
        <string name="ach_streak_500_desc">500 consecutive days.</string>
        <string name="ach_early_bird_title">Early Bird</string>
        <string name="ach_early_bird_desc">Listen 10 times between 5am and 8am</string>
        <string name="ach_night_owl_title">Night Owl</string>
        <string name="ach_night_owl_desc">Listen 10 times between 3am and 5am</string>
        <string name="ach_lunch_break_title">Lunch Break</string>
        <string name="ach_lunch_break_desc">Listen 10 times between 12pm and 1pm</string>
    
        <string name="ach_liker_50_title">Passionate</string>
        <string name="ach_liker_50_desc">Like 50 tracks</string>
        <string name="ach_liker_1000_title">Heart of Gold</string>
        <string name="ach_liker_1000_desc">Like 1000 tracks</string>
        <string name="ach_liker_5000_title">Infinite Love</string>
        <string name="ach_liker_5000_desc">Like 5000 tracks</string>
        <string name="ach_playlist_creator_title">Selector</string>
        <string name="ach_playlist_creator_desc">Create 5 local playlists</string>
        <string name="ach_playlist_god_title">Architect</string>
        <string name="ach_playlist_god_desc">Create 50 local playlists</string>
        <string name="ach_download_100_title">Data Hoarder</string>
        <string name="ach_download_100_desc">Download 100 tracks</string>
        <string name="ach_download_1000_title">Server</string>
        <string name="ach_download_1000_desc">Download 1000 tracks</string>
    
        <string name="ach_skipper_100_title">Zapper</string>
        <string name="ach_skipper_100_desc">Skip 100 tracks</string>
        <string name="ach_skipper_1000_title">Never Satisfied</string>
        <string name="ach_skipper_1000_desc">Skip 1000 tracks</string>
        <string name="ach_bass_addict_title">Bass Addict</string>
        <string name="ach_bass_addict_desc">Listen for 10h with Bass Boost</string>
        <string name="ach_speed_demon_title">Nightcore Fan</string>
        <string name="ach_speed_demon_desc">Listen for 1h at speed > 1.2x</string>
        <string name="ach_social_star_title">Viral</string>
        <string name="ach_social_star_desc">Share 50 tracks</string>
    
        <string name="ach_obsessed_50_title">Obsessed</string>
        <string name="ach_obsessed_50_desc">Listen to the SAME track 50 times</string>
        <string name="ach_obsessed_200_title">Pure Madness</string>
        <string name="ach_obsessed_200_desc">Listen to the SAME track 200 times</string>
        <string name="ach_night_shift_pro_title">Vampire</string>
        <string name="ach_night_shift_pro_desc">Listen for 500 hours at night (10pm-6am)</string>
        <string name="ach_marathon_title">Marathon Runner</string>
        <string name="ach_marathon_desc">Listen for 8h straight without closing the app</string>
        <string name="ach_no_skip_50_title">Focus</string>
        <string name="ach_no_skip_50_desc">Listen to 50 tracks without skipping</string>
    
        <string name="ach_developer_title">Hacker</string>
        <string name="ach_weekend_warrior_title">Weekend Warrior</string>
        <string name="ach_ghost_title">Ghost</string>
        <string name="ach_lucky7_title">Jackpot</string>
        <string name="ach_glitch_title">Glitch in the Matrix</string>
        <string name="align_center_simple">Center</string>
    
        <string name="storage_used_formatted">%1$s used</string>
        <string name="storage_free_formatted">%1$s free</string>
        <string name="storage_change_cta">Tap to change</string>
    
        <!-- Licenses Screen -->
        <string name="about_licenses_title">Open Source Licenses</string>
        <string name="license_author_prefix">by %1$s</string>
        <string name="open_in_new">Open in new window</string>
    
        <!-- Player Screen & Associated Sheets -->
        <string name="player_like_action">Like</string>
        <string name="player_effects">Effects</string>
        <string name="menu_remove_local_q">Remove?</string>
        <string name="menu_remove_local_body">This file will no longer be listed in the app (the file will not be deleted from the phone).</string>
        <string name="menu_remove_download_q">Delete the download?</string>
        <string name="menu_remove_download_body">This track will be removed from your local storage.</string>
        <string name="comment_anonymous">Anonymous</string>
        <string name="comment_default_avatar">Default Avatar</string>
        <string name="comment_send_action">Send</string>
        <string name="time_now">Just now</string>
        <string name="time_minutes_ago">%1$d min ago</string>
        <string name="time_hours_ago">%1$d h ago</string>
        <string name="time_days_ago">%1$d d ago</string>
        <string name="time_weeks_ago">%1$d wk ago</string>
        <string name="time_months_ago">%1$d mo ago</string>
        <string name="time_one_year_ago">1 year ago</string>
        <string name="time_years_ago">%1$d years ago</string>
        <string name="detail_file_size_formatted">%.2f MB</string>
    
        <!-- Notifications -->
        <string name="settings_cat_notifications">Notifications</string>
        <string name="pref_achievement_popups">Achievement Pop-ups</string>
        <string name="pref_achievement_popups_sub">Show a notification when unlocking an achievement.</string>
        <string name="achievement_unlocked">Achievement Unlocked</string>
        <string name="achievement_xp">%1$d XP</string>
        <string name="streak_popup_title">Daily Streak</string>
        <string name="streak_popup_subtitle">%1$d Day(s)</string>
        <string name="test_notification_triggered">Test notification triggered!</string>
    
        <!-- Credits & Community -->
        <string name="about_credits">Credits</string>
        <string name="about_role_dev">Lead Developer &amp; Creator</string>
        <string name="about_role_translation">Hungarian translation &amp; review</string>
        <string name="about_translate_title">Translate KittyTune</string>
        <string name="about_translate_desc">Want to see the app in your language? ( â—•â–¿â—• )\nOpen a Pull Request on GitHub!</string>
        <string name="about_made_with">Made with ( Ë˜ Â³Ë˜)â™¥ by Alan</string>
    </resources>

================================================================================
FICHIER : ./res/values/themes.xml
================================================================================
    <resources>
        <!-- ThÃ¨me principal de l'application pour Compose -->
        <style name="Theme.SoundTune" parent="android:Theme.Material.Light.NoActionBar">
            <item name="android:statusBarColor">@android:color/transparent</item>
            <item name="android:navigationBarColor">@android:color/transparent</item>
        </style>
    
    </resources>

================================================================================
FICHIER : ./res/xml/backup_rules.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?><!--
       Sample backup rules file; uncomment and customize as necessary.
       See https://developer.android.com/guide/topics/data/autobackup
       for details.
       Note: This file is ignored for devices older than API 31
       See https://developer.android.com/about/versions/12/backup-restore
    -->
    <full-backup-content>
        <!--
       <include domain="sharedpref" path="."/>
       <exclude domain="sharedpref" path="device.xml"/>
    -->
    </full-backup-content>

================================================================================
FICHIER : ./res/xml/data_extraction_rules.xml
================================================================================
    <?xml version="1.0" encoding="utf-8"?><!--
       Sample data extraction rules file; uncomment and customize as necessary.
       See https://developer.android.com/about/versions/12/backup-restore#xml-changes
       for details.
    -->
    <data-extraction-rules>
        <cloud-backup>
            <!-- TODO: Use <include> and <exclude> to control what is backed up.
            <include .../>
            <exclude .../>
            -->
        </cloud-backup>
        <!--
        <device-transfer>
            <include .../>
            <exclude .../>
        </device-transfer>
        -->
    </data-extraction-rules>

